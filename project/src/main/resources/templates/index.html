<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
  <head>
    <meta charset="UTF-8" />
    <title th:text="${banner.get('title')}">Trang ch·ªß</title>
    <link rel="stylesheet" th:href="@{/css/hover-card.css}" />
    <link rel="stylesheet" href="/css/footer.css" />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
    />
    <link rel="stylesheet" th:href="@{/css/ai-agent.css}" />
    <link rel="stylesheet" href="/css/style.css" />
  </head>
  <body>
    <div th:replace="fragments/header :: header"></div>

    <section
      class="hero-banner"
      id="heroBanner"
      th:attr="data-movie-id=${banner.id}, 
                  data-title=${banner.title},
                  data-trailer-key=${banner.trailerKey},
                  data-logo-path=${banner.logoPath}"
      th:style="'background-image: url(' + ${banner.backdrop} + ')'"
    >
      <div class="hero-video-container" id="heroVideoContainer">
        <div id="heroPlayer"></div>
      </div>
      <div class="hero-overlay"></div>

      <div class="hero-content">
        <div class="hero-title-container">
          <img
            class="hero-logo-image"
            id="heroLogo"
            src=""
            alt="Movie Logo"
            style="display: none"
          />
          <h1 class="hero-title" id="heroTitleText" th:text="${banner.title}">
            Movie Title
          </h1>
        </div>

        <div class="hero-meta">
          <div class="content-rating" id="contentRating">
            <span>T13+</span>
          </div>
          <div class="rating">
            <i class="fas fa-star"></i>
            <span th:text="${banner.rating}">8.5</span>
          </div>
          <div class="year" th:text="${banner.year}">2025</div>

          <div
            class="duration"
            id="heroDuration"
            th:text="${banner.runtime == '‚Äî' ? '‚Äî' : banner.runtime + ' ph√∫t'}"
          >
            ‚Äî ph√∫t
          </div>

          <div class="country" id="heroCountry" th:text="${banner.country}">
            Qu·ªëc gia
          </div>
        </div>

        <button class="description-toggle" id="descToggle">
          <i class="fas fa-chevron-down"></i>
        </button>

        <p class="hero-description" id="heroDesc" th:text="${banner.overview}">
          Movie description here...
        </p>

        <div class="hero-actions">
          <a th:href="@{'/movie/detail/' + ${banner.id}}" class="btn-play">
            <i class="fas fa-play"></i>
            Xem ngay
          </a>

          <div class="action-buttons-group">
            <button
              class="btn-circle hero-action-icon hover-like-btn"
              id="heroLikeBtn"
              type="button"
              th:data-movie-id="${banner.id}"
              th:attr="data-movie-id=${tmdbId}"
              th:onclick="'event.stopPropagation(); toggleHoverLike(this)'"
              title="Th√™m v√†o danh s√°ch"
            >
              <i class="far fa-heart"></i>
            </button>

            <button
              class="btn-circle hero-action-icon hover-share-btn"
              id="heroShareBtn"
              type="button"
              th:data-movie-id="${banner.id}"
              th:data-movie-title="${banner.title}"
              th:onclick="'event.stopPropagation(); showShareModal(this)'"
              title="Chia s·∫ª"
            >
              <i class="fas fa-share-alt"></i>
            </button>

            <div class="action-divider"></div>

            <button
              class="btn-circle volume-btn"
              id="volumeBtn"
              title="B·∫≠t/T·∫Øt ti·∫øng"
            >
              <i class="fas fa-volume-mute"></i>
            </button>
          </div>
        </div>
      </div>

      <div class="mini-carousel">
        <div class="mini-carousel-track" id="miniCarousel">
          <div
            th:each="movie, iterStat : ${hotMovies}"
            class="mini-card"
            th:classappend="${iterStat.index == 0 ? 'active' : ''}"
            th:attr="data-movie-id=${movie.id}, 
                        data-title=${movie.title}, 
                        data-overview=${movie.overview},
                        data-backdrop=${movie.backdrop},  
                        data-rating=${movie.rating},
                        data-year=${movie.year},
                        data-runtime=${movie.runtime},
                        data-country=${movie.country},
                        data-content-rating=${movie.contentRating}"
            onclick="switchBanner(this)"
          >
            <img
              th:src="@{${#strings.replace(movie.backdrop, '/original', '/w500')}}"
              th:alt="${movie.title}"
              onerror="this.src='/images/placeholder.jpg'"
            />

            <div class="mini-card-overlay"></div>
          </div>
        </div>
      </div>
    </section>

    <section class="movies movie-list-section">
      <div class="section-header">
        <div class="section-title-wrapper">
          <h2 class="section-title">üî• Phim Hot</h2>
          <a href="/discover?quickFilter=trending" class="view-more-link">
            Xem th√™m <i class="fas fa-chevron-right"></i>
          </a>
        </div>
        <div class="carousel-nav">
          <button class="nav-btn prev-btn" id="hotPrevBtn">
            <i class="fas fa-chevron-left"></i>
          </button>
          <button class="nav-btn next-btn" id="hotNextBtn">
            <i class="fas fa-chevron-right"></i>
          </button>
        </div>
      </div>

      <div class="movie-carousel">
        <div class="movie-slider" id="hotSlider">
          <div
            th:each="movie, iterStat : ${hotMovies}"
            class="movie-card"
            th:classappend="'ranked rank-' + (((${iterStat.index}) % 5) + 1)"
            th:attr="data-movie-id=${movie.id}"
          >
            <div class="movie-poster">
              <img
                th:src="${movie.poster}"
                th:alt="${movie.title}"
                onerror="this.src='/images/placeholder.jpg'"
              />

              <div class="ranking-overlay"></div>
              <div class="ranking-number" th:text="${iterStat.index + 1}"></div>
            </div>

            <div class="movie-info">
              <h3 th:text="${movie.title}">Movie Title</h3>
              <p class="movie-rating">
                ‚≠ê <span th:text="${movie.rating}">8.5</span>
              </p>
            </div>

            <div
              th:replace="~{fragments/hover-card :: hoverCard(${movie})}"
            ></div>
          </div>
        </div>
      </div>
    </section>

    <section class="movies movie-list-section">
      <div class="section-header">
        <div class="section-title-wrapper">
          <h2 class="section-title">üÜï Phim M·ªõi Ra M·∫Øt</h2>
          <a href="/discover?quickFilter=new" class="view-more-link">
            Xem th√™m <i class="fas fa-chevron-right"></i>
          </a>
        </div>
        <div class="carousel-nav">
          <button class="nav-btn prev-btn" id="newPrevBtn">
            <i class="fas fa-chevron-left"></i>
          </button>
          <button class="nav-btn next-btn" id="newNextBtn">
            <i class="fas fa-chevron-right"></i>
          </button>
        </div>
      </div>
      <div class="movie-carousel">
        <div class="movie-slider" id="newSlider">
          <div
            th:each="movie : ${newMovies}"
            class="movie-card"
            th:attr="data-movie-id=${movie.id}"
          >
            <div class="movie-poster">
              <img
                th:src="${movie.poster}"
                th:alt="${movie.title}"
                onerror="this.src='/images/placeholder.jpg'"
              />
            </div>
            <div class="movie-info">
              <h3 th:text="${movie.title}">Movie Title</h3>
              <p class="movie-rating">
                ‚≠ê <span th:text="${movie.rating}">8.5</span>
              </p>
            </div>

            <div
              th:replace="~{fragments/hover-card :: hoverCard(${movie})}"
            ></div>
          </div>
        </div>
      </div>
    </section>

    <section class="movies movie-list-section">
      <div class="section-header">
        <div class="section-title-wrapper">
          <h2 class="section-title">üéå Anime Hot</h2>
          <a href="/discover?genres=16" class="view-more-link">
            Xem th√™m <i class="fas fa-chevron-right"></i>
          </a>
        </div>
        <div class="carousel-nav">
          <button class="nav-btn prev-btn" id="animePrevBtn">
            <i class="fas fa-chevron-left"></i>
          </button>
          <button class="nav-btn next-btn" id="animeNextBtn">
            <i class="fas fa-chevron-right"></i>
          </button>
        </div>
      </div>
      <div class="movie-carousel">
        <div class="movie-slider" id="animeSlider">
          <div
            th:each="movie : ${animeMovies}"
            class="movie-card"
            th:attr="data-movie-id=${movie.id}"
          >
            <div class="movie-poster">
              <img
                th:src="${movie.poster}"
                th:alt="${movie.title}"
                onerror="this.src='/images/placeholder.jpg'"
              />
            </div>
            <div class="movie-info">
              <h3 th:text="${movie.title}">Movie Title</h3>
              <p class="movie-rating">
                ‚≠ê <span th:text="${movie.rating}">8.5</span>
              </p>
            </div>

            <div
              th:replace="~{fragments/hover-card :: hoverCard(${movie})}"
            ></div>
          </div>
        </div>
      </div>
    </section>

    <section class="movies movie-list-section">
      <div class="section-header">
        <div class="section-title-wrapper">
          <h2 class="section-title">üë∂ Phim Cho Tr·∫ª Em</h2>
          <a href="/discover?genres=10751" class="view-more-link">
            Xem th√™m <i class="fas fa-chevron-right"></i>
          </a>
        </div>
        <div class="carousel-nav">
          <button class="nav-btn prev-btn" id="kidsPrevBtn">
            <i class="fas fa-chevron-left"></i>
          </button>
          <button class="nav-btn next-btn" id="kidsNextBtn">
            <i class="fas fa-chevron-right"></i>
          </button>
        </div>
      </div>
      <div class="movie-carousel">
        <div class="movie-slider" id="kidsSlider">
          <div
            th:each="movie : ${kidsMovies}"
            class="movie-card"
            th:attr="data-movie-id=${movie.id}"
          >
            <div class="movie-poster">
              <img
                th:src="${movie.poster}"
                th:alt="${movie.title}"
                onerror="this.src='/images/placeholder.jpg'"
              />
            </div>
            <div class="movie-info">
              <h3 th:text="${movie.title}">Movie Title</h3>
              <p class="movie-rating">
                ‚≠ê <span th:text="${movie.rating}">8.5</span>
              </p>
            </div>

            <div
              th:replace="~{fragments/hover-card :: hoverCard(${movie})}"
            ></div>
          </div>
        </div>
      </div>
    </section>

    <section class="movies movie-list-section">
      <div class="section-header">
        <div class="section-title-wrapper">
          <h2 class="section-title">üí• Phim H√†nh ƒê·ªông Hot</h2>
          <a href="/discover?genres=28" class="view-more-link">
            Xem th√™m <i class="fas fa-chevron-right"></i>
          </a>
        </div>
        <div class="carousel-nav">
          <button class="nav-btn prev-btn" id="actionPrevBtn">
            <i class="fas fa-chevron-left"></i>
          </button>
          <button class="nav-btn next-btn" id="actionNextBtn">
            <i class="fas fa-chevron-right"></i>
          </button>
        </div>
      </div>
      <div class="movie-carousel">
        <div class="movie-slider" id="actionSlider">
          <div
            th:each="movie : ${actionMovies}"
            class="movie-card"
            th:attr="data-movie-id=${movie.id}"
          >
            <div class="movie-poster">
              <img
                th:src="${movie.poster}"
                th:alt="${movie.title}"
                onerror="this.src='/images/placeholder.jpg'"
              />
            </div>
            <div class="movie-info">
              <h3 th:text="${movie.title}">Movie Title</h3>
              <p class="movie-rating">
                ‚≠ê <span th:text="${movie.rating}">8.5</span>
              </p>
            </div>

            <div
              th:replace="~{fragments/hover-card :: hoverCard(${movie})}"
            ></div>
          </div>
        </div>
      </div>
    </section>

    <footer>
      <div th:replace="fragments/footer :: footer"></div>
    </footer>

    <script th:inline="javascript">
      /**
       * ==============================================================
       * T·ªêI ∆ØU PERFORMANCE: T·∫£i b·∫•t ƒë·ªìng b·ªô 4 carousel
       * ==============================================================
       */
      document.addEventListener("DOMContentLoaded", () => {
        // T·∫£i 4 carousel song song
        loadAsyncCarousel("/api/movie/home/new", "newSlider");
        loadAsyncCarousel("/api/movie/home/anime", "animeSlider");
        loadAsyncCarousel("/api/movie/home/kids", "kidsSlider");
        loadAsyncCarousel("/api/movie/home/action", "actionSlider");
      });

      /**
       * H√†m helper: T·∫£i 1 carousel b·∫±ng AJAX
       */
      async function loadAsyncCarousel(apiUrl, targetSliderId) {
        const slider = document.getElementById(targetSliderId);
        if (!slider) return;

        try {
          const response = await fetch(apiUrl);
          if (!response.ok) throw new Error("API failed");

          const movies = await response.json();

          if (movies && movies.length > 0) {
            // Render HTML
            slider.innerHTML = movies
              .map((movie) => createMovieCardHTML(movie))
              .join("");

            // K√≠ch ho·∫°t l·∫°i Hover Cards (t·ª´ script.js)
            if (typeof initHoverCards === "function") {
              initHoverCards();
            }

            // K√≠ch ho·∫°t l·∫°i Carousels (t·ª´ script.js)
            // Ph·∫£i g·ªçi initializeAllCarousels() v√¨ c√°c n√∫t b·∫•m ƒë√£ c√≥ trong DOM
            if (typeof initializeAllCarousels === "function") {
              initializeAllCarousels();
            }
          } else {
            // ·∫®n c·∫£ section n·∫øu kh√¥ng c√≥ phim
            if (slider.closest(".movie-list-section")) {
              slider.closest(".movie-list-section").style.display = "none";
            }
          }
        } catch (error) {
          console.error(`L·ªói t·∫£i ${targetSliderId}:`, error);
          if (slider.closest(".movie-list-section")) {
            slider.closest(".movie-list-section").style.display = "none";
          }
        }
      }

      /**
       * H√†m helper: T·∫°o HTML cho 1 movie card (d√πng JSON)
       * (T√°i s·ª≠ d·ª•ng logic t·ª´ hover-card.html v√† script.js)
       */
      function createMovieCardHTML(movie) {
        const movieId = movie.id;
        // H√†m escape HTML an to√†n
        const escapeHtml = (str) =>
          (str || "").replace(
            /[&<>"']/g,
            (m) =>
              ({
                "&": "&amp;",
                "<": "&lt;",
                ">": "&gt;",
                '"': "&quot;",
                "'": "&#39;",
              }[m])
          );

        const safeTitle = escapeHtml(movie.title || "Unknown");
        const safeOverview = escapeHtml(movie.overview || "ƒêang t·∫£i m√¥ t·∫£...");
        const poster = movie.poster || "/images/placeholder.jpg";
        const backdrop = movie.backdrop || "/images/placeholder.jpg";
        const rating = movie.rating || "‚Äî";
        const year = movie.year || "‚Äî";

        // [M·ªöI] L·∫•y d·ªØ li·ªáu chi ti·∫øt ngay l·∫≠p t·ª©c
        const runtime = movie.runtime || "‚Äî";
        const contentRating = movie.contentRating || "T";
        const country = movie.country || "Qu·ªëc t·∫ø";

        // [CODE M·ªöI] X·ª≠ l√Ω Genre c√≥ Tooltip chu·∫©n
        let genresHtml = '<span class="genre-tag">Kh√¥ng c√≥</span>';
        if (movie.genres && movie.genres.length > 0) {
          // 1. Hai th·∫ª ƒë·∫ßu ti√™n
          genresHtml = movie.genres
            .slice(0, 2)
            .map((g) => `<span class="genre-tag">${escapeHtml(g)}</span>`)
            .join("");

          // 2. C√°c th·∫ª c√≤n l·∫°i (Tooltip)
          if (movie.genres.length > 2) {
            const remaining = movie.genres.slice(2);
            const tooltipHtml = remaining
              .map((g) => `<div class="genre-bubble">${escapeHtml(g)}</div>`)
              .join("");

            genresHtml += `
                    <span class="genre-tag genre-tag-more" 
                        onmouseenter="if(window.showGenreTooltip) window.showGenreTooltip(this)" 
                        onmouseleave="if(window.hideGenreTooltip) window.hideGenreTooltip(this)">
                        +${remaining.length}
                        <div class="custom-genre-tooltip">${tooltipHtml}</div>
                    </span>
                `;
          }
        }

        const playerId = `hover-player-async-${movieId}`;

        // [QUAN TR·ªåNG] onclick cho n√∫t b·∫•m ƒë√£ ƒë∆∞·ª£c th√™m ƒë·∫ßy ƒë·ªß
        return `
        <div class="movie-card" data-movie-id="${movieId}">
            <div class="movie-poster">
                <img src="${poster}" alt="${safeTitle}" onerror="this.src='/images/placeholder.jpg'">
            </div>
            <div class="movie-info">
                <h3>${safeTitle}</h3>
                <p class="movie-rating">‚≠ê <span>${rating}</span></p>
            </div>
            
            <div class="movie-hover-card" data-movie-id="${movieId}">
                <div class="hover-card-media">
                    <img class="hover-card-image" src="${backdrop}" alt="${safeTitle}" onerror="this.src='/images/placeholder.jpg'">
                    <div class="hover-player-container"><div class="hover-player" id="${playerId}"></div></div>
                    <button class="hover-volume-btn" type="button" title="B·∫≠t/T·∫Øt ti·∫øng" onclick="event.stopPropagation();"><i class="fas fa-volume-mute"></i></button>
                </div>
                <div class="hover-card-content">
                    <div class="hover-card-actions">
                        <button class="hover-play-btn" type="button" 
                                data-movie-id="${movieId}" 
                                onclick="event.stopPropagation(); window.goToMovieDetail(this)">
                            <i class="fas fa-play"></i> Xem ngay
                        </button>
                        <button class="hover-action-icon hover-like-btn" type="button" 
                                data-movie-id="${movieId}" data-tmdb-id="${
          movie.tmdbId || movieId
        }"
                                onclick="event.stopPropagation(); window.toggleHoverLike(this)" 
                                title="Th√™m v√†o danh s√°ch">
                            <i class="far fa-heart"></i>
                        </button>
                        <button class="hover-action-icon hover-share-btn" type="button"
                                data-movie-id="${movieId}" data-movie-title="${safeTitle}"
                                onclick="event.stopPropagation(); window.showShareModal(this)" 
                                title="Chia s·∫ª">
                            <i class="fas fa-share-alt"></i>
                        </button>
                    </div>
                    <h3 class="hover-card-title">${safeTitle}</h3>
                    <div class="hover-card-meta">
                        <span class="meta-rating"><i class="fas fa-star"></i> <span>${rating}</span></span>
                        <span class="meta-year">${year}</span>
                        <span class="meta-quality">HD</span>
                    </div>
                    <div class="hover-card-meta-extra">
                        <span class="meta-extra-rating">${contentRating}</span>
                        <span class="meta-extra-runtime" style="white-space: nowrap;">${runtime}</span>
                        <span class="meta-extra-country">${country}</span>
                    </div>
                    <div class="hover-card-genres">${genresHtml}</div>
                    <p class="hover-card-description">${safeOverview}</p>
                </div>
            </div>
        </div>
        `;
      }
    </script>

    <script src="https://www.youtube.com/iframe_api"></script>

    
    <script src="/js/movie/share-modal.js"></script>
    <script src="/js/script.js"></script>

    <div th:replace="fragments/share-modal :: shareModal"></div>
  </body>
</html>
