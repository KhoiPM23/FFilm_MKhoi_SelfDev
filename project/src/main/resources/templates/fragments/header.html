<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
  <head>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
    />
  </head>
  <body>
    <header class="main-header" th:fragment="header" style="--accent: #e50914">
      <div class="logo">
        <img src="/images/footer/logo.jpg" alt="" />
        <span>FFilm</span>
      </div>

      <nav class="main-nav">
        <a href="/" class="active"><i class="fas fa-home"></i>Trang chủ</a>
        <a href="/discover?isFree=true" class="genre-item-flat" th:classappend="${isFree == true} ? 'active'">
          <i class="fas fa-gift"></i> Phim Miễn Phí
        </a>

        <div class="genre-nav-wrapper">
          <a href="#" class="genre-toggle">
            <i class="fas fa-layer-group" style="margin-right: 5px;"></i> Thể loại <i class="fas fa-caret-down" style="margin-left: 5px;"></i>
          </a>
          <div class="genre-dropdown" id="genreDropdown">
            <div class="genre-grid">
              <a href="/discover?genres=28" class="genre-item" data-genre="28"><i class="fas fa-fist-raised"></i> Hành động</a>
              <a href="/discover?genres=12" class="genre-item" data-genre="12"><i class="fas fa-compass"></i> Phiêu lưu</a>
              <a href="/discover?genres=16" class="genre-item" data-genre="16"><i class="fas fa-palette"></i> Hoạt hình</a>
              <a href="/discover?genres=35" class="genre-item" data-genre="35"><i class="fas fa-laugh-beam"></i> Hài</a>
              
              <a href="/discover?genres=80" class="genre-item" data-genre="80"><i class="fas fa-user-secret"></i> Hình sự</a>
              <a href="/discover?genres=99" class="genre-item" data-genre="99"><i class="fas fa-book-open"></i> Tài liệu</a>
              <a href="/discover?genres=18" class="genre-item" data-genre="18"><i class="fas fa-theater-masks"></i> Chính kịch</a>
              <a href="/discover?genres=10751" class="genre-item" data-genre="10751"><i class="fas fa-home"></i> Gia đình</a>
              
              <a href="/discover?genres=14" class="genre-item" data-genre="14"><i class="fas fa-dragon"></i> Giả tưởng</a>
              <a href="/discover?genres=36" class="genre-item" data-genre="36"><i class="fas fa-landmark"></i> Lịch sử</a>
              <a href="/discover?genres=27" class="genre-item" data-genre="27"><i class="fas fa-ghost"></i> Kinh dị</a>
              <a href="/discover?genres=10402" class="genre-item" data-genre="10402"><i class="fas fa-music"></i> Nhạc</a>
              
              <a href="/discover?genres=9648" class="genre-item" data-genre="9648"><i class="fas fa-search"></i> Bí ẩn</a>
              <a href="/discover?genres=10749" class="genre-item" data-genre="10749"><i class="fas fa-heart"></i> Lãng mạn</a>
              <a href="/discover?genres=878" class="genre-item" data-genre="878"><i class="fas fa-rocket"></i> Khoa học viễn tưởng</a>
              <a href="/discover?genres=53" class="genre-item" data-genre="53"><i class="fas fa-exclamation-triangle"></i> Gây cấn</a>
            </div>
          </div>
        </div>
      </nav>

      <div class="header-actions">
        <div class="notification-box" id="notiContainer" th:if="${session.user != null}">
            <div class="bell-wrapper" onclick="toggleNotiDropdown(event)">
                <i class="fas fa-bell" id="bellIcon"></i>
                <span id="notiBadge" class="noti-badge" style="display:none">0</span>
            </div>
            
            <div class="noti-dropdown" id="notiDropdown">
                <div class="noti-header-row">
                    <h3>Thông báo</h3>
                    <span style="color:#aaa; cursor:pointer;" onclick="markAllRead()" title="Đánh dấu tất cả đã đọc">
                        <i class="fas fa-check-double"></i>
                    </span>
                </div>
                
                <div class="noti-tabs">
                    <button class="noti-tab active" onclick="filterNoti('all', this)">Tất cả</button>
                    <button class="noti-tab" onclick="filterNoti('unread', this)">Chưa đọc</button>
                </div>

                <div class="noti-scroll-area custom-scrollbar" id="notiList">
                    <div class="noti-empty">Đang tải thông báo...</div>
                </div>
                
                <div class="noti-footer" id="loadMoreBtn" onclick="loadMoreNoti()" style="display:none;">
                    Xem cũ hơn
                </div>
            </div>
        </div>
        <div class="search-box">
          <a
            href="/search"
            class="search-toggle"
            aria-label="Tìm kiếm"
            title="Tìm kiếm"
          >
            <i class="fas fa-search"></i>
          </a>
        </div>

        <a th:if="${session.user}" th:href="@{/favorites/my-list}" class="btn-buy">Yêu thích</a>
        <a th:unless="${session.user}" th:href="@{/login}" class="btn-buy">Yêu thích</a>

        <a th:href="@{/subscriptionPlan}" class="btn-buy">Mua gói</a>

        <div th:unless="${session.user}" class="auth-buttons">
          <a th:href="@{/login}" class="btn-login">Đăng nhập</a>
          <a th:href="@{/register}" class="btn-register">Đăng ký</a>
        </div>

        <div th:if="${session.user}" class="user-dropdown-wrapper">
          <div class="user-avatar-btn" id="userAvatarBtn" role="button" tabindex="0">
            <span class="avatar-initials" th:text="${@userService.getInitials(session.user.userName)}"></span>
          </div>

          <div class="user-dropdown-menu" id="userDropdownMenu" hidden>
            <div class="dropdown-header">
              Xin chào, <span th:text="${session.user.userName}">Minh Cường</span>
            </div>
            <a th:href="@{/profile}" class="dropdown-item"><i class="fas fa-user-circle"></i> Profile</a>
            <a th:href="@{/payment/history}" class="dropdown-item"><i class="fas fa-file-invoice-dollar"></i> Gói & Thanh toán</a>
            <a th:href="@{/history}" class="dropdown-item"><i class="fas fa-history"></i> Lịch sử xem</a>
            <a th:href="@{/recommnended}" class="dropdown-item"><i class="fas fa-film"></i> Gợi ý phim</a>
            <div class="dropdown-divider"></div>
            <a href="/watch-party" class="dropdown-item" style="color: #46d369;"><i class="fas fa-users"></i> Sảnh Xem Chung</a>
            <a href="/my-rooms" class="dropdown-item" style="color: #e50914;"><i class="fas fa-video"></i> Quản Lý Phòng</a>
            <div class="dropdown-divider"></div>
            <a th:href="@{/logout}" class="dropdown-item logout-item"><i class="fas fa-sign-out-alt"></i> Đăng xuất</a>
          </div>
        </div>
      </div>

      <style>
          /* Bell Icon & Badge */
          .bell-wrapper { position: relative; cursor: pointer; padding: 5px; transition: 0.2s; }
          .bell-wrapper i { font-size: 1.3rem; color: #ddd; }
          .bell-wrapper:hover i { color: #fff; }
          
          .noti-badge {
              position: absolute; top: -2px; right: -2px;
              background-color: #e50914; color: white;
              font-size: 0.7rem; font-weight: bold;
              padding: 2px 5px; border-radius: 50%;
              border: 2px solid #141414; /* Border trùng màu nền header để cắt góc đẹp */
              min-width: 18px; text-align: center;
          }

          /* Dropdown Menu */
          .noti-dropdown {
              width: 360px; background: #242526; border: 1px solid #333;
              box-shadow: 0 4px 20px rgba(0,0,0,0.5); padding: 0;
          }
          .dropdown-header {
              display: flex; justify-content: space-between; align-items: center;
              padding: 10px 15px; border-bottom: 1px solid #333;
              background: #242526; color: #fff; font-weight: bold;
          }

          /* Notification Item Style */
          .noti-item {
              display: flex; align-items: center; gap: 12px;
              padding: 10px 15px; color: #e4e6eb; text-decoration: none;
              border-bottom: 1px solid #2f3031; transition: background 0.2s;
          }
          .noti-item:hover { background-color: #3a3b3c; color: #fff; }
          
          /* [QUAN TRỌNG] Style tin chưa đọc (Nền đậm hơn/khác biệt) */
          .noti-item.unread {
              background-color: #2f3542; /* Màu xanh đen nhẹ hoặc sáng hơn nền */
              border-left: 3px solid #e50914; /* Vạch đỏ đánh dấu */
          }
          .noti-item.unread .noti-content { font-weight: 600; color: #fff; }
          
          .noti-avatar { width: 40px; height: 40px; border-radius: 50%; object-fit: cover; }
          .noti-content { font-size: 0.9rem; line-height: 1.3; }
          .noti-time { font-size: 0.75rem; color: #b0b3b8; display: block; margin-top: 2px; }

          





          /* --- NOTIFICATION BELL (FACEBOOK STYLE) --- */
        .notification-box { position: relative; }
        .bell-wrapper { 
            width: 40px; height: 40px; border-radius: 50%; background: #333;
            display: flex; align-items: center; justify-content: center;
            cursor: pointer; transition: 0.2s; position: relative; color: #fff;
        }
        .bell-wrapper:hover, .bell-wrapper.active { background: #444; color: #e50914; }
        
        .noti-badge {
            position: absolute; top: -5px; right: -5px;
            background: #e50914; color: white;
            font-size: 0.7rem; font-weight: bold;
            padding: 2px 6px; border-radius: 10px;
            box-shadow: 0 0 0 2px #141414; display: none;
        }

        /* Noti Dropdown */
        .noti-dropdown {
            position: absolute; top: 55px; right: -80px; width: 360px;
            background: #242526; border: 1px solid #333; border-radius: 8px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.5);
            display: none; flex-direction: column; overflow: hidden;
        }
        .noti-dropdown.show { display: flex; animation: fadeIn 0.2s ease; }

        .noti-header-row {
            padding: 15px; border-bottom: 1px solid #333;
            display: flex; justify-content: space-between; align-items: center;
        }
        .noti-header-row h3 { margin: 0; font-size: 1.2rem; color: #fff; }
        
        .noti-tabs { display: flex; padding: 10px 15px; gap: 10px; }
        .noti-tab {
            background: transparent; border: none; color: #bbb;
            font-weight: 600; font-size: 0.9rem; cursor: pointer;
            padding: 5px 10px; border-radius: 15px; transition: 0.2s;
        }
        .noti-tab.active { background: rgba(229, 9, 20, 0.2); color: #e50914; }
        
        .noti-scroll-area { max-height: 400px; overflow-y: auto; }
        
        /* Noti Item */
        .noti-item {
            display: flex; gap: 12px; padding: 12px 15px;
            text-decoration: none; color: #fff; transition: 0.2s; position: relative;
        }
        .noti-item:hover { background: #3a3b3c; }
        .noti-item.unread { background: #2a2d35; }
        .noti-item.unread::after {
            content: ''; position: absolute; right: 15px; top: 50%; transform: translateY(-50%);
            width: 10px; height: 10px; background: #e50914; border-radius: 50%;
        }
        
        .noti-avatar img { width: 50px; height: 50px; border-radius: 50%; object-fit: cover; }
        .noti-info { flex: 1; padding-right: 15px; }
        .noti-text { font-size: 0.9rem; margin-bottom: 4px; line-height: 1.3; }
        .noti-time { font-size: 0.75rem; color: #e50914; font-weight: 600; }
        .noti-time.old { color: #888; font-weight: 400; }

        .noti-footer { 
            text-align: center; padding: 12px; border-top: 1px solid #333;
            color: #e50914; font-weight: 600; cursor: pointer; transition: 0.2s;
        }
        .noti-footer:hover { background: #333; }
        .noti-empty { padding: 30px; text-align: center; color: #888; }
      </style>

      <style>
        /* CSS CHO DROPDOWN THỂ LOẠI (GIỐNG CODE CŨ) */
        .genre-nav-wrapper {
          position: relative;
        }

        .genre-toggle {
          padding: 8px 12px;
          cursor: pointer;
          transition: color 0.3s;
          /* Match other nav links */
          color: #ddd;
          text-decoration: none;
          font-size: 15px;
          font-weight: 500;
          white-space: nowrap;
          display: flex;
          align-items: center;
          gap: 5px;
        }
        .genre-toggle:hover,
        .main-nav a.active {
          /* Thêm .active cho trang chủ */
          color: #e50914;
        }

        .genre-dropdown {
          position: absolute;
          top: 100%;
          left: 50%;
          transform: translateX(-50%);
          background: rgba(20, 20, 20, 0.98);
          border: 1px solid rgba(255, 255, 255, 0.1);
          border-radius: 12px;
          padding: 20px;
          min-width: 750px;
          box-shadow: 0 10px 40px rgba(0, 0, 0, 0.8);
          backdrop-filter: blur(20px);
          opacity: 0;
          visibility: hidden;
          transition: all 0.3s;
          z-index: 1000;
          margin-top: 10px;
        }

        .genre-nav-wrapper:hover .genre-dropdown {
          opacity: 1;
          visibility: visible;
        }

        .genre-grid {
          display: grid;
          grid-template-columns: repeat(4, 1fr);
          gap: 12px;
        }

        .genre-item {
          display: flex;
          align-items: center;
          gap: 10px;
          padding: 12px 16px;
          background: rgba(255, 255, 255, 0.03);
          border: 1px solid rgba(255, 255, 255, 0.08);
          border-radius: 8px;
          transition: all 0.3s;
          color: rgba(255, 255, 255, 0.9);
          text-decoration: none;
          font-size: 0.9rem;
        }

        .genre-item:hover {
          background: #e50914;
          border-color: #e50914;
          color: white;
          transform: translateY(-2px);
        }

        .genre-item i {
          font-size: 1.1rem;
          width: 20px;
          text-align: center;
        }

        @media (max-width: 768px) {
          .genre-dropdown {
            position: fixed;
            left: 10px;
            right: 10px;
            transform: translateX(0);
            width: auto;
            min-width: auto;
          }
          .genre-grid {
            grid-template-columns: repeat(2, 1fr);
          }
        }
      </style>

      <style>
        /* CSS CHO ICON SEARCH ĐÃ ĐIỀU CHỈNH */
        .search-box a.search-toggle {
          cursor: pointer;
          font-size: 18px !important;
          color: #fff !important;
          padding: 8px;
          border-radius: 4px;
          transition: all 0.3s;
          display: flex !important;
          align-items: center;
          justify-content: center;
          min-width: 34px;
          min-height: 34px;
          text-decoration: none;
        }
        .search-box a.search-toggle:hover {
          color: #e50914 !important;
          background: rgba(229, 9, 20, 0.1);
        }
      </style>

      <style>
        /* CSS CHO USER AVATAR VÀ AUTH (GIỮ NGUYÊN) */
        .user-avatar-btn {
          width: 40px;
          height: 40px;
          background-color: #e50914;
          border-radius: 50%;
          display: flex;
          justify-content: center;
          align-items: center;
          cursor: pointer;
          font-size: 16px;
          font-weight: 700;
          color: white;
          box-shadow: 0 0 10px rgba(229, 9, 20, 0.4);
        }
        .user-dropdown-wrapper {
          position: relative;
          z-index: 1000;
        }
        .user-dropdown-menu {
          position: absolute;
          top: 100%;
          right: 0;
          min-width: 150px;
          background: #111;
          border: 1px solid #333;
          border-radius: 8px;
          margin-top: 10px;
          box-shadow: 0 8px 16px rgba(0, 0, 0, 0.5);
        }
        .user-dropdown-menu[hidden] {
          display: none;
        }
        .dropdown-header {
          padding: 10px 15px;
          color: #e50914;
          font-weight: 600;
          border-bottom: 1px solid #333;
          font-size: 0.95rem;
        }
        .dropdown-item {
          padding: 10px 15px;
          display: flex;
          align-items: center;
          gap: 10px;
          color: #ccc;
          text-decoration: none;
          transition: background 0.2s;
          font-size: 0.9rem;
        }
        .dropdown-item:hover {
          background: #e50914;
          color: white;
        }
        .logout-item {
          border-top: 1px solid #333;
          margin-top: 5px;
        }

        .auth-buttons {
          display: flex;
          align-items: center;
          gap: 15px;
        }

        .auth-buttons a {
          color: #fff;
          text-decoration: none;
          font-size: 16px;
          font-weight: 500;
          transition: color 0.3s ease;
          padding: 5px 0;
        }

        .auth-buttons a:hover {
          color: #e50914;
        }

        /* CSS CHO CÁC LINK THỂ LOẠI PHẲNG (ĐÃ BỔ SUNG) */
        .main-nav a.genre-item-flat {
          display: flex;
          align-items: center;
          gap: 8px;
          color: #ddd; /* Màu giống .genre-toggle */
          text-decoration: none;
          padding: 8px 12px;
          font-weight: 500;
          font-size: 15px; /* Kích thước giống .genre-toggle */
          transition: color 0.3s;
          white-space: nowrap;
        }

        .main-nav a.genre-item-flat:hover,
        .main-nav a.genre-item-flat.active {
          color: #e50914; /* var(--accent) */
        }

        .main-nav a.genre-item-flat i {
          font-size: 1rem;
          width: 18px;
          text-align: center;
        }

        /* --- THÊM HIỆU ỨNG VIPRO CHO CHUÔNG --- */
        .bell-wrapper i {
            transition: all 0.3s ease;
        }
        
        /* 1. Chuông vàng khi có thông báo mới */
        .bell-wrapper.has-new i {
            color: #ffd700 !important; /* Vàng kim */
            text-shadow: 0 0 10px rgba(255, 215, 0, 0.6);
        }

        /* 2. Hiệu ứng rung lắc */
        @keyframes bellShake {
            0% { transform: rotate(0); }
            15% { transform: rotate(5deg); }
            30% { transform: rotate(-5deg); }
            45% { transform: rotate(4deg); }
            60% { transform: rotate(-4deg); }
            75% { transform: rotate(2deg); }
            85% { transform: rotate(-2deg); }
            100% { transform: rotate(0); }
        }
        
        .bell-wrapper.shaking i {
            animation: bellShake 0.5s cubic-bezier(.36,.07,.19,.97) both;
        }

        /* 3. Style cho nút Kết bạn trong dropdown */
        .friend-request-actions {
            display: flex; gap: 10px; margin-top: 5px;
        }
        .btn-accept-fr {
            background: #0084ff; border: none; padding: 4px 12px; 
            border-radius: 4px; color: white; font-size: 12px; cursor: pointer;
        }
        .btn-reject-fr {
            background: #3a3b3c; border: none; padding: 4px 12px; 
            border-radius: 4px; color: white; font-size: 12px; cursor: pointer;
        }


      </style>

      <style>
        /* Avatar người gửi trong thông báo */
        .noti-item-avatar {
            width: 48px;
            height: 48px;
            border-radius: 50%;
            object-fit: cover;
            margin-right: 12px;
            border: 2px solid #333;
        }
        
        /* Bố cục item thông báo */
        .noti-item {
            display: flex;
            align-items: flex-start;
            padding: 12px;
            border-bottom: 1px solid rgba(255,255,255,0.05);
            color: #fff;
            text-decoration: none !important;
            transition: background 0.2s;
        }
        .noti-item:hover { background: rgba(255,255,255,0.05); }
        .noti-item.unread { background: rgba(229, 9, 20, 0.1); border-left: 3px solid #e50914; }
        
        /* Nội dung text */
        .noti-content-wrapper { flex: 1; }
        .noti-text { font-size: 0.9rem; margin-bottom: 4px; line-height: 1.4; color: #e5e5e5; }
        .noti-text strong { color: #fff; font-weight: 600; }
        .noti-time { font-size: 0.75rem; color: #999; display: block; margin-top: 2px; }
        
        /* Nút hành động (Kết bạn) */
        .noti-actions { display: flex; gap: 8px; margin-top: 8px; }
        .btn-noti-action {
            padding: 6px 16px;
            border-radius: 6px;
            font-size: 0.8rem;
            font-weight: 600;
            cursor: pointer;
            border: none;
            transition: 0.2s;
        }
        .btn-accept { background: #e50914; color: #fff; }
        .btn-accept:hover { background: #b20710; }
        .btn-deny { background: #333; color: #fff; }
        .btn-deny:hover { background: #555; }

        /* Hiệu ứng chuông rung lắc */
        @keyframes bellSwing { 
            0% { transform: rotate(0deg); } 20% { transform: rotate(15deg); } 
            40% { transform: rotate(-10deg); } 60% { transform: rotate(5deg); } 
            80% { transform: rotate(-5deg); } 100% { transform: rotate(0deg); } 
        }
        .bell-ringing { animation: bellSwing 2s infinite ease-in-out; color: #e50914 !important; }
    </style>

      <script>
        // Giữ lại: Logic cuộn header
        document.addEventListener("DOMContentLoaded", function () {
          // ---------- small helpers ----------
          const safeQuery = (s) => document.querySelector(s);

          // ---------- Header scroll (guarded) ----------
          try {
            const header = safeQuery(".main-header");
            const hero = safeQuery(".hero-banner");
            if (header && hero) {
              window.addEventListener("scroll", () => {
                const heroHeight = hero.offsetHeight || 450;
                if (window.scrollY > heroHeight - 100)
                  header.classList.add("scrolled");
                else header.classList.remove("scrolled");
              });
            }
          } catch (e) {
            console.error("header scroll error", e);
          }
        });
      </script>

      <script>
        // Giữ lại: Logic dropdown avatar
        document.addEventListener("DOMContentLoaded", function () {
          const avatarBtn = document.getElementById("userAvatarBtn");
          const dropdownMenu = document.getElementById("userDropdownMenu");

          if (avatarBtn && dropdownMenu) {
            avatarBtn.addEventListener("click", (e) => {
              e.stopPropagation();
              dropdownMenu.toggleAttribute("hidden");
            });

            // Đóng dropdown khi nhấp vào nơi khác
            document.addEventListener("click", (e) => {
              if (
                !avatarBtn.contains(e.target) &&
                !dropdownMenu.contains(e.target)
              ) {
                dropdownMenu.hidden = true;
              }
            });
          }
        });
      </script>
      <script th:inline="javascript">
              /*<![CDATA[*/
              /* Biến toàn cục kiểm tra đăng nhập cho AI Agent */
              window.isUserLoggedIn = /*[[${session.user != null}]]*/ false;
              /*]]>*/
      </script>
      <script th:if="${session.user != null}">
            let stompClient = null;
            let allNotifications = [];
            let currentFilter = 'all';
            let visibleCount = 6;
            
            // Lấy danh sách ID đã "nhìn thấy" từ LocalStorage
            function getSeenIds() {
                const stored = localStorage.getItem('vipro_seen_notis');
                return stored ? JSON.parse(stored) : [];
            }

            // Lưu danh sách ID đã "nhìn thấy"
            function addSeenIds(ids) {
                if (!ids || ids.length === 0) return;
                let seen = getSeenIds();
                // Merge và loại bỏ trùng lặp
                seen = [...new Set([...seen, ...ids])];
                localStorage.setItem('vipro_seen_notis', JSON.stringify(seen));
                
                // Cập nhật lại số trên chuông ngay lập tức
                updateBadgeUI();
            }

            // --- 1. TOGGLE LOGIC ---
            function toggleNotiDropdown(e) {
                e.stopPropagation();
                const dd = document.getElementById('notiDropdown');
                const bell = document.querySelector('.bell-wrapper');
                
                // Đóng menu user nếu đang mở
                document.getElementById('userDropdownMenu').classList.remove('show'); 
                
                dd.classList.toggle('show');
                bell.classList.toggle('active');

                // Nếu mở ra -> Đánh dấu các tin nhắn ĐANG HIỂN THỊ là "Đã thấy" (để giảm số badge)
                if (dd.classList.contains('show')) {
                    document.getElementById('bellIcon').classList.remove('bell-ringing');
                    markVisibleAsSeen();
                }
            }
            
            // Hàm logic cốt lõi: Đánh dấu các item đang hiển thị là "Seen"
            function markVisibleAsSeen() {
                // Lấy danh sách đang hiển thị
                let filtered = (currentFilter === 'unread') ? allNotifications.filter(n => !n.read) : allNotifications;
                const visibleItems = filtered.slice(0, visibleCount);
                
                // Lọc ra các ID chưa đọc để lưu vào Seen
                const unreadIds = visibleItems.filter(n => !n.read).map(n => n.id);
                
                if (unreadIds.length > 0) {
                    addSeenIds(unreadIds);
                }
            }

            function toggleUserDropdown(e) {
                e.stopPropagation();
                document.getElementById('notiDropdown').classList.remove('show');
                document.querySelector('.bell-wrapper').classList.remove('active');
                document.getElementById('userDropdownMenu').classList.toggle('show');
            }

            window.onclick = function(e) {
                if (!e.target.closest('#notiContainer')) {
                    document.getElementById('notiDropdown')?.classList.remove('show');
                    document.querySelector('.bell-wrapper')?.classList.remove('active');
                }
                if (!e.target.closest('#userWrapper')) {
                    document.getElementById('userDropdownMenu')?.classList.remove('show');
                }
            }

            // --- 2. NOTIFICATION DATA ---
            document.addEventListener('DOMContentLoaded', function() {
                connectSocket();
                fetchNotifications();
            });

            function connectSocket() {
                var socket = new SockJS('/ws'); 
                stompClient = Stomp.over(socket);
                stompClient.debug = null; 
                stompClient.connect({}, function() {
                    stompClient.subscribe('/user/queue/notifications', function(payload) {
                        const noti = JSON.parse(payload.body);
                        handleNewNotification(noti);
                    });
                });
            }

            function fetchNotifications() {
                fetch('/social/api/notifications')
                    .then(res => res.json())
                    .then(data => {
                        allNotifications = data;
                        renderList(); // Render list trước
                        updateBadgeUI(); // Update badge sau
                    })
                    .catch(err => console.error(err));
            }

            function handleNewNotification(noti) {
                allNotifications.unshift(noti);
                renderList();
                updateBadgeUI();
                
                // Rung chuông & Phát tiếng
                const bellWrapper = document.querySelector('.bell-wrapper');
                if(bellWrapper) {
                    bellWrapper.classList.add('shaking', 'has-new');
                    setTimeout(() => bellWrapper.classList.remove('shaking'), 500);
                }
                const audio = new Audio('/sounds/notification.mp3');
                audio.play().catch(e => {});
            }

            // --- 3. UI RENDERING (BADGE & LIST) ---

            function updateBadgeUI() {
                const badge = document.getElementById('notiBadge');
                const bellWrapper = document.querySelector('.bell-wrapper');
                
                // Logic Badge VIPRO: 
                // Số Badge = (Tổng số chưa đọc từ Server) - (Số đã Seen ở LocalStorage)
                const serverUnread = allNotifications.filter(n => !n.read);
                const seenIds = getSeenIds();
                
                // Đếm những cái chưa đọc VÀ chưa nằm trong danh sách đã thấy
                const realBadgeCount = serverUnread.filter(n => !seenIds.includes(n.id)).length;
                
                if (realBadgeCount > 0) {
                    badge.innerText = realBadgeCount > 99 ? '99+' : realBadgeCount;
                    badge.style.display = 'flex';
                    if(bellWrapper) bellWrapper.classList.add('has-new');
                } else {
                    badge.style.display = 'none';
                    if(bellWrapper) bellWrapper.classList.remove('has-new');
                }
            }

            function renderList() {
                const listEl = document.getElementById('notiList');
                const loadMoreEl = document.getElementById('loadMoreBtn');

                let filtered = allNotifications;
                if (currentFilter === 'unread') {
                    filtered = allNotifications.filter(n => !n.read);
                }

                if (filtered.length === 0) {
                    listEl.innerHTML = '<div class="noti-empty">Không có thông báo nào</div>';
                    loadMoreEl.style.display = 'none';
                    return;
                }

                const toShow = filtered.slice(0, visibleCount);
                
                listEl.innerHTML = toShow.map(n => {
                    // Logic style: Dựa hoàn toàn vào n.read của server
                    // n.read = false -> Thêm class unread (In đậm, chấm đỏ)
                    const unreadClass = (!n.read) ? 'unread' : '';
                    const avatarUrl = n.senderAvatar || '/images/placeholder-user.jpg';
                    const timeDisplay = n.timeAgo || 'Vừa xong';

                    // Nút kết bạn (chỉ hiện khi type FRIEND_REQUEST và chưa đọc)
                    let actionButtons = '';
                    if (n.type === 'FRIEND_REQUEST' && !n.read) {
                        actionButtons = `
                            <div class="noti-actions" id="action-group-${n.id}">
                                <button class="btn-noti-action btn-accept" onclick="handleFriendAction(event, ${n.senderId}, 'accept', ${n.id})">Chấp nhận</button>
                                <button class="btn-noti-action btn-deny" onclick="handleFriendAction(event, ${n.senderId}, 'deny', ${n.id})">Xóa</button>
                            </div>
                        `;
                    }

                    return `
                        <div class="noti-item ${unreadClass}" onclick="markOneRead(${n.id}, '${n.link}')">
                            <img src="${avatarUrl}" class="noti-item-avatar">
                            <div class="noti-content-wrapper">
                                <div class="noti-text">${n.content}</div>
                                <span class="noti-time">${timeDisplay}</span>
                                ${actionButtons}
                            </div>
                            ${!n.read ? '<div class="noti-dot"></div>' : ''} 
                        </div>
                    `;
                }).join('');

                loadMoreEl.style.display = (visibleCount < filtered.length) ? 'block' : 'none';
            }

            // --- 4. ACTIONS ---

            window.markOneRead = function(id, link, shouldRedirect = true) {
                // 1. Cập nhật local state: Đã đọc
                const noti = allNotifications.find(n => n.id === id);
                if (noti) noti.read = true;
                
                // 2. Render lại để mất in đậm
                renderList();
                // 3. Cập nhật badge (phòng trường hợp click mà chưa open dropdown - hiếm)
                updateBadgeUI();

                // 4. Gọi API báo server đã đọc (quan trọng để F5 vẫn nhớ)
                // Giả sử bạn chưa có API mark-one, có thể dùng mark-all hoặc tạo thêm.
                // Ở đây tạm thời ta chỉ update UI. Nếu có API: 
                // fetch('/social/api/notifications/read/' + id, {method: 'POST'});

                // 5. Chuyển trang
                if (shouldRedirect && link && link !== 'null' && link !== '#') {
                    window.location.href = link;
                }
            }

            window.markAllRead = function() {
                fetch('/social/api/notifications/read-all', { method: 'POST' })
                    .then(() => {
                        allNotifications.forEach(n => n.read = true);
                        renderList();
                        updateBadgeUI();
                    });
            }

            window.loadMoreNoti = function() {
                visibleCount += 10;
                renderList();
                // Khi bấm xem thêm, những tin mới hiện ra cũng được tính là "Đã thấy"
                markVisibleAsSeen();
            }

            window.filterNoti = function(type, btn) {
                currentFilter = type;
                visibleCount = 6;
                document.querySelectorAll('.noti-tab').forEach(t => t.classList.remove('active'));
                btn.classList.add('active');
                renderList();
                markVisibleAsSeen(); // Chuyển tab cũng tính là đã thấy
            }

            window.handleFriendAction = function(e, senderId, action, notiId) {
                e.stopPropagation(); 
                e.preventDefault();

                const url = action === 'accept' ? `/social/accept-friend/${senderId}` : `/social/deny-friend/${senderId}`;
                const container = document.getElementById(`action-group-${notiId}`);
                
                if(container) container.innerHTML = '<span style="font-size:0.8rem; color:#999;">Đang xử lý...</span>';

                fetch(url, { method: 'POST' })
                    .then(res => {
                        if (res.ok) {
                            if(container) {
                                container.innerHTML = action === 'accept' 
                                    ? '<span style="color:#46d369; font-size:0.8rem;"><i class="fas fa-check"></i> Đã kết bạn</span>'
                                    : '<span style="color:#aaa; font-size:0.8rem;">Đã gỡ</span>';
                            }
                            // Tự động mark read thông báo này
                            markOneRead(notiId, null, false);
                        }
                    })
                    .catch(err => console.error(err));
            }
        </script>
    </header>
  </body>
</html>
