<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
  <head>
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
    />
  </head>
  <body>
    <header class="main-header" th:fragment="header" style="--accent: #e50914">
      <div class="logo">
        <img src="/images/footer/logo.jpg" alt="" />
        <span>FFilm</span>
      </div>

      <nav class="main-nav">
        <a href="/" class="active"><i class="fas fa-home"></i>Trang chủ</a>
        <a href="/discover?isFree=true" class="genre-item-flat" th:classappend="${isFree == true} ? 'active'">
          <i class="fas fa-gift"></i> Phim Miễn Phí
        </a>

        <div class="genre-nav-wrapper">
          <a href="#" class="genre-toggle">
            <i class="fas fa-layer-group" style="margin-right: 5px;"></i> Thể loại <i class="fas fa-caret-down" style="margin-left: 5px;"></i>
          </a>
          <div class="genre-dropdown" id="genreDropdown">
            <div class="genre-grid">
              <a href="/discover?genres=28" class="genre-item" data-genre="28"><i class="fas fa-fist-raised"></i> Hành động</a>
              <a href="/discover?genres=12" class="genre-item" data-genre="12"><i class="fas fa-compass"></i> Phiêu lưu</a>
              <a href="/discover?genres=16" class="genre-item" data-genre="16"><i class="fas fa-palette"></i> Hoạt hình</a>
              <a href="/discover?genres=35" class="genre-item" data-genre="35"><i class="fas fa-laugh-beam"></i> Hài</a>
              
              <a href="/discover?genres=80" class="genre-item" data-genre="80"><i class="fas fa-user-secret"></i> Hình sự</a>
              <a href="/discover?genres=99" class="genre-item" data-genre="99"><i class="fas fa-book-open"></i> Tài liệu</a>
              <a href="/discover?genres=18" class="genre-item" data-genre="18"><i class="fas fa-theater-masks"></i> Chính kịch</a>
              <a href="/discover?genres=10751" class="genre-item" data-genre="10751"><i class="fas fa-home"></i> Gia đình</a>
              
              <a href="/discover?genres=14" class="genre-item" data-genre="14"><i class="fas fa-dragon"></i> Giả tưởng</a>
              <a href="/discover?genres=36" class="genre-item" data-genre="36"><i class="fas fa-landmark"></i> Lịch sử</a>
              <a href="/discover?genres=27" class="genre-item" data-genre="27"><i class="fas fa-ghost"></i> Kinh dị</a>
              <a href="/discover?genres=10402" class="genre-item" data-genre="10402"><i class="fas fa-music"></i> Nhạc</a>
              
              <a href="/discover?genres=9648" class="genre-item" data-genre="9648"><i class="fas fa-search"></i> Bí ẩn</a>
              <a href="/discover?genres=10749" class="genre-item" data-genre="10749"><i class="fas fa-heart"></i> Lãng mạn</a>
              <a href="/discover?genres=878" class="genre-item" data-genre="878"><i class="fas fa-rocket"></i> Khoa học viễn tưởng</a>
              <a href="/discover?genres=53" class="genre-item" data-genre="53"><i class="fas fa-exclamation-triangle"></i> Gây cấn</a>
            </div>
          </div>
        </div>
      </nav>

      <div class="header-actions">
        
        <div class="notification-box" id="notiContainer" th:if="${session.user != null}">
                <div class="bell-wrapper" onclick="toggleNotiDropdown(event)">
                    <i class="fas fa-bell"></i>
                    <span id="notiBadge" class="noti-badge">0</span>
                </div>
                
                <div class="noti-dropdown" id="notiDropdown">
                    <div class="noti-header-row">
                        <h3>Thông báo</h3>
                        <span style="color:#aaa; cursor:pointer;" onclick="markAllRead()"><i class="fas fa-check-double"></i></span>
                    </div>
                    
                    <div class="noti-tabs">
                        <button class="noti-tab active" onclick="filterNoti('all', this)">Tất cả</button>
                        <button class="noti-tab" onclick="filterNoti('unread', this)">Chưa đọc</button>
                    </div>

                    <div class="noti-scroll-area custom-scrollbar" id="notiList">
                        <div class="noti-empty">Đang tải thông báo...</div>
                    </div>
                    
                    <div class="noti-footer" id="loadMoreBtn" onclick="loadMoreNoti()" style="display:none;">
                        Xem cũ hơn
                    </div>
                </div>
            </div>
        <div class="search-box">
          <a
            href="/search"
            class="search-toggle"
            aria-label="Tìm kiếm"
            title="Tìm kiếm"
          >
            <i class="fas fa-search"></i>
          </a>
        </div>

        <a th:if="${session.user}" th:href="@{/favorites/my-list}" class="btn-buy">Yêu thích</a>
        <a th:unless="${session.user}" th:href="@{/login}" class="btn-buy">Yêu thích</a>

        <a th:href="@{/subscriptionPlan}" class="btn-buy">Mua gói</a>

        <div th:unless="${session.user}" class="auth-buttons">
          <a th:href="@{/login}" class="btn-login">Đăng nhập</a>
          <a th:href="@{/register}" class="btn-register">Đăng ký</a>
        </div>

        <div th:if="${session.user}" class="user-dropdown-wrapper">
          <div class="user-avatar-btn" id="userAvatarBtn" role="button" tabindex="0">
            <span class="avatar-initials" th:text="${@userService.getInitials(session.user.userName)}"></span>
          </div>

          <div class="user-dropdown-menu" id="userDropdownMenu" hidden>
            <div class="dropdown-header">
              Xin chào, <span th:text="${session.user.userName}">Minh Cường</span>
            </div>
            <a th:href="@{/profile}" class="dropdown-item"><i class="fas fa-user-circle"></i> Profile</a>
            <a th:href="@{/payment/history}" class="dropdown-item"><i class="fas fa-file-invoice-dollar"></i> Gói & Thanh toán</a>
            <a th:href="@{/history}" class="dropdown-item"><i class="fas fa-history"></i> Lịch sử xem</a>
            <a th:href="@{/recommnended}" class="dropdown-item"><i class="fas fa-film"></i> Gợi ý phim</a>
            <div class="dropdown-divider"></div>
            <a href="/watch-party" class="dropdown-item" style="color: #46d369;"><i class="fas fa-users"></i> Sảnh Xem Chung</a>
            <a href="/my-rooms" class="dropdown-item" style="color: #e50914;"><i class="fas fa-video"></i> Quản Lý Phòng</a>
            <div class="dropdown-divider"></div>
            <a th:href="@{/logout}" class="dropdown-item logout-item"><i class="fas fa-sign-out-alt"></i> Đăng xuất</a>
          </div>
        </div>
      </div>

      <style>
          /* Bell Icon & Badge */
          .bell-wrapper { position: relative; cursor: pointer; padding: 5px; transition: 0.2s; }
          .bell-wrapper i { font-size: 1.3rem; color: #ddd; }
          .bell-wrapper:hover i { color: #fff; }
          
          .noti-badge {
              position: absolute; top: -2px; right: -2px;
              background-color: #e50914; color: white;
              font-size: 0.7rem; font-weight: bold;
              padding: 2px 5px; border-radius: 50%;
              border: 2px solid #141414; /* Border trùng màu nền header để cắt góc đẹp */
              min-width: 18px; text-align: center;
          }

          /* Dropdown Menu */
          .noti-dropdown {
              width: 360px; background: #242526; border: 1px solid #333;
              box-shadow: 0 4px 20px rgba(0,0,0,0.5); padding: 0;
          }
          .dropdown-header {
              display: flex; justify-content: space-between; align-items: center;
              padding: 10px 15px; border-bottom: 1px solid #333;
              background: #242526; color: #fff; font-weight: bold;
          }

          /* Notification Item Style */
          .noti-item {
              display: flex; align-items: center; gap: 12px;
              padding: 10px 15px; color: #e4e6eb; text-decoration: none;
              border-bottom: 1px solid #2f3031; transition: background 0.2s;
          }
          .noti-item:hover { background-color: #3a3b3c; color: #fff; }
          
          /* [QUAN TRỌNG] Style tin chưa đọc (Nền đậm hơn/khác biệt) */
          .noti-item.unread {
              background-color: #2f3542; /* Màu xanh đen nhẹ hoặc sáng hơn nền */
              border-left: 3px solid #e50914; /* Vạch đỏ đánh dấu */
          }
          .noti-item.unread .noti-content { font-weight: 600; color: #fff; }
          
          .noti-avatar { width: 40px; height: 40px; border-radius: 50%; object-fit: cover; }
          .noti-content { font-size: 0.9rem; line-height: 1.3; }
          .noti-time { font-size: 0.75rem; color: #b0b3b8; display: block; margin-top: 2px; }

          





          /* --- NOTIFICATION BELL (FACEBOOK STYLE) --- */
        .notification-box { position: relative; }
        .bell-wrapper { 
            width: 40px; height: 40px; border-radius: 50%; background: #333;
            display: flex; align-items: center; justify-content: center;
            cursor: pointer; transition: 0.2s; position: relative; color: #fff;
        }
        .bell-wrapper:hover, .bell-wrapper.active { background: #444; color: #e50914; }
        
        .noti-badge {
            position: absolute; top: -5px; right: -5px;
            background: #e50914; color: white;
            font-size: 0.7rem; font-weight: bold;
            padding: 2px 6px; border-radius: 10px;
            box-shadow: 0 0 0 2px #141414; display: none;
        }

        /* Noti Dropdown */
        .noti-dropdown {
            position: absolute; top: 55px; right: -80px; width: 360px;
            background: #242526; border: 1px solid #333; border-radius: 8px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.5);
            display: none; flex-direction: column; overflow: hidden;
        }
        .noti-dropdown.show { display: flex; animation: fadeIn 0.2s ease; }

        .noti-header-row {
            padding: 15px; border-bottom: 1px solid #333;
            display: flex; justify-content: space-between; align-items: center;
        }
        .noti-header-row h3 { margin: 0; font-size: 1.2rem; color: #fff; }
        
        .noti-tabs { display: flex; padding: 10px 15px; gap: 10px; }
        .noti-tab {
            background: transparent; border: none; color: #bbb;
            font-weight: 600; font-size: 0.9rem; cursor: pointer;
            padding: 5px 10px; border-radius: 15px; transition: 0.2s;
        }
        .noti-tab.active { background: rgba(229, 9, 20, 0.2); color: #e50914; }
        
        .noti-scroll-area { max-height: 400px; overflow-y: auto; }
        
        /* Noti Item */
        .noti-item {
            display: flex; gap: 12px; padding: 12px 15px;
            text-decoration: none; color: #fff; transition: 0.2s; position: relative;
        }
        .noti-item:hover { background: #3a3b3c; }
        .noti-item.unread { background: #2a2d35; }
        .noti-item.unread::after {
            content: ''; position: absolute; right: 15px; top: 50%; transform: translateY(-50%);
            width: 10px; height: 10px; background: #e50914; border-radius: 50%;
        }
        
        .noti-avatar img { width: 50px; height: 50px; border-radius: 50%; object-fit: cover; }
        .noti-info { flex: 1; padding-right: 15px; }
        .noti-text { font-size: 0.9rem; margin-bottom: 4px; line-height: 1.3; }
        .noti-time { font-size: 0.75rem; color: #e50914; font-weight: 600; }
        .noti-time.old { color: #888; font-weight: 400; }

        .noti-footer { 
            text-align: center; padding: 12px; border-top: 1px solid #333;
            color: #e50914; font-weight: 600; cursor: pointer; transition: 0.2s;
        }
        .noti-footer:hover { background: #333; }
        .noti-empty { padding: 30px; text-align: center; color: #888; }
      </style>

      <style>
        /* CSS CHO DROPDOWN THỂ LOẠI (GIỐNG CODE CŨ) */
        .genre-nav-wrapper {
          position: relative;
        }

        .genre-toggle {
          padding: 8px 12px;
          cursor: pointer;
          transition: color 0.3s;
          /* Match other nav links */
          color: #ddd;
          text-decoration: none;
          font-size: 15px;
          font-weight: 500;
          white-space: nowrap;
          display: flex;
          align-items: center;
          gap: 5px;
        }
        .genre-toggle:hover,
        .main-nav a.active {
          /* Thêm .active cho trang chủ */
          color: #e50914;
        }

        .genre-dropdown {
          position: absolute;
          top: 100%;
          left: 50%;
          transform: translateX(-50%);
          background: rgba(20, 20, 20, 0.98);
          border: 1px solid rgba(255, 255, 255, 0.1);
          border-radius: 12px;
          padding: 20px;
          min-width: 750px;
          box-shadow: 0 10px 40px rgba(0, 0, 0, 0.8);
          backdrop-filter: blur(20px);
          opacity: 0;
          visibility: hidden;
          transition: all 0.3s;
          z-index: 1000;
          margin-top: 10px;
        }

        .genre-nav-wrapper:hover .genre-dropdown {
          opacity: 1;
          visibility: visible;
        }

        .genre-grid {
          display: grid;
          grid-template-columns: repeat(4, 1fr);
          gap: 12px;
        }

        .genre-item {
          display: flex;
          align-items: center;
          gap: 10px;
          padding: 12px 16px;
          background: rgba(255, 255, 255, 0.03);
          border: 1px solid rgba(255, 255, 255, 0.08);
          border-radius: 8px;
          transition: all 0.3s;
          color: rgba(255, 255, 255, 0.9);
          text-decoration: none;
          font-size: 0.9rem;
        }

        .genre-item:hover {
          background: #e50914;
          border-color: #e50914;
          color: white;
          transform: translateY(-2px);
        }

        .genre-item i {
          font-size: 1.1rem;
          width: 20px;
          text-align: center;
        }

        @media (max-width: 768px) {
          .genre-dropdown {
            position: fixed;
            left: 10px;
            right: 10px;
            transform: translateX(0);
            width: auto;
            min-width: auto;
          }
          .genre-grid {
            grid-template-columns: repeat(2, 1fr);
          }
        }
      </style>

      <style>
        /* CSS CHO ICON SEARCH ĐÃ ĐIỀU CHỈNH */
        .search-box a.search-toggle {
          cursor: pointer;
          font-size: 18px !important;
          color: #fff !important;
          padding: 8px;
          border-radius: 4px;
          transition: all 0.3s;
          display: flex !important;
          align-items: center;
          justify-content: center;
          min-width: 34px;
          min-height: 34px;
          text-decoration: none;
        }
        .search-box a.search-toggle:hover {
          color: #e50914 !important;
          background: rgba(229, 9, 20, 0.1);
        }
      </style>

      <style>
        /* CSS CHO USER AVATAR VÀ AUTH (GIỮ NGUYÊN) */
        .user-avatar-btn {
          width: 40px;
          height: 40px;
          background-color: #e50914;
          border-radius: 50%;
          display: flex;
          justify-content: center;
          align-items: center;
          cursor: pointer;
          font-size: 16px;
          font-weight: 700;
          color: white;
          box-shadow: 0 0 10px rgba(229, 9, 20, 0.4);
        }
        .user-dropdown-wrapper {
          position: relative;
          z-index: 1000;
        }
        .user-dropdown-menu {
          position: absolute;
          top: 100%;
          right: 0;
          min-width: 150px;
          background: #111;
          border: 1px solid #333;
          border-radius: 8px;
          margin-top: 10px;
          box-shadow: 0 8px 16px rgba(0, 0, 0, 0.5);
        }
        .user-dropdown-menu[hidden] {
          display: none;
        }
        .dropdown-header {
          padding: 10px 15px;
          color: #e50914;
          font-weight: 600;
          border-bottom: 1px solid #333;
          font-size: 0.95rem;
        }
        .dropdown-item {
          padding: 10px 15px;
          display: flex;
          align-items: center;
          gap: 10px;
          color: #ccc;
          text-decoration: none;
          transition: background 0.2s;
          font-size: 0.9rem;
        }
        .dropdown-item:hover {
          background: #e50914;
          color: white;
        }
        .logout-item {
          border-top: 1px solid #333;
          margin-top: 5px;
        }

        .auth-buttons {
          display: flex;
          align-items: center;
          gap: 15px;
        }

        .auth-buttons a {
          color: #fff;
          text-decoration: none;
          font-size: 16px;
          font-weight: 500;
          transition: color 0.3s ease;
          padding: 5px 0;
        }

        .auth-buttons a:hover {
          color: #e50914;
        }

        /* CSS CHO CÁC LINK THỂ LOẠI PHẲNG (ĐÃ BỔ SUNG) */
        .main-nav a.genre-item-flat {
          display: flex;
          align-items: center;
          gap: 8px;
          color: #ddd; /* Màu giống .genre-toggle */
          text-decoration: none;
          padding: 8px 12px;
          font-weight: 500;
          font-size: 15px; /* Kích thước giống .genre-toggle */
          transition: color 0.3s;
          white-space: nowrap;
        }

        .main-nav a.genre-item-flat:hover,
        .main-nav a.genre-item-flat.active {
          color: #e50914; /* var(--accent) */
        }

        .main-nav a.genre-item-flat i {
          font-size: 1rem;
          width: 18px;
          text-align: center;
        }

        /* --- THÊM HIỆU ỨNG VIPRO CHO CHUÔNG --- */
        .bell-wrapper i {
            transition: all 0.3s ease;
        }
        
        /* 1. Chuông vàng khi có thông báo mới */
        .bell-wrapper.has-new i {
            color: #ffd700 !important; /* Vàng kim */
            text-shadow: 0 0 10px rgba(255, 215, 0, 0.6);
        }

        /* 2. Hiệu ứng rung lắc */
        @keyframes bellShake {
            0% { transform: rotate(0); }
            15% { transform: rotate(5deg); }
            30% { transform: rotate(-5deg); }
            45% { transform: rotate(4deg); }
            60% { transform: rotate(-4deg); }
            75% { transform: rotate(2deg); }
            85% { transform: rotate(-2deg); }
            100% { transform: rotate(0); }
        }
        
        .bell-wrapper.shaking i {
            animation: bellShake 0.5s cubic-bezier(.36,.07,.19,.97) both;
        }

        /* 3. Style cho nút Kết bạn trong dropdown */
        .friend-request-actions {
            display: flex; gap: 10px; margin-top: 5px;
        }
        .btn-accept-fr {
            background: #0084ff; border: none; padding: 4px 12px; 
            border-radius: 4px; color: white; font-size: 12px; cursor: pointer;
        }
        .btn-reject-fr {
            background: #3a3b3c; border: none; padding: 4px 12px; 
            border-radius: 4px; color: white; font-size: 12px; cursor: pointer;
        }
      </style>

      <script>
        // Giữ lại: Logic cuộn header
        document.addEventListener("DOMContentLoaded", function () {
          // ---------- small helpers ----------
          const safeQuery = (s) => document.querySelector(s);

          // ---------- Header scroll (guarded) ----------
          try {
            const header = safeQuery(".main-header");
            const hero = safeQuery(".hero-banner");
            if (header && hero) {
              window.addEventListener("scroll", () => {
                const heroHeight = hero.offsetHeight || 450;
                if (window.scrollY > heroHeight - 100)
                  header.classList.add("scrolled");
                else header.classList.remove("scrolled");
              });
            }
          } catch (e) {
            console.error("header scroll error", e);
          }
        });
      </script>

      <script>
        // Giữ lại: Logic dropdown avatar
        document.addEventListener("DOMContentLoaded", function () {
          const avatarBtn = document.getElementById("userAvatarBtn");
          const dropdownMenu = document.getElementById("userDropdownMenu");

          if (avatarBtn && dropdownMenu) {
            avatarBtn.addEventListener("click", (e) => {
              e.stopPropagation();
              dropdownMenu.toggleAttribute("hidden");
            });

            // Đóng dropdown khi nhấp vào nơi khác
            document.addEventListener("click", (e) => {
              if (
                !avatarBtn.contains(e.target) &&
                !dropdownMenu.contains(e.target)
              ) {
                dropdownMenu.hidden = true;
              }
            });
          }
        });
      </script>
      <script th:inline="javascript">
              /*<![CDATA[*/
              /* Biến toàn cục kiểm tra đăng nhập cho AI Agent */
              window.isUserLoggedIn = /*[[${session.user != null}]]*/ false;
              /*]]>*/
      </script>
      <script th:if="${session.user != null}">
            let stompClient = null;
            let allNotifications = [];
            let unreadCount = 0;
            let currentFilter = 'all';
            let visibleCount = 6;

            // --- 1. TOGGLE LOGIC (FIXED) ---
            function toggleNotiDropdown(e) {
                e.stopPropagation();
                document.getElementById('userDropdownMenu').classList.remove('show'); // Đóng user menu
                document.getElementById('notiDropdown').classList.toggle('show');
                document.querySelector('.bell-wrapper').classList.toggle('active');
            }

            function toggleUserDropdown(e) {
                e.stopPropagation();
                document.getElementById('notiDropdown').classList.remove('show'); // Đóng noti
                document.querySelector('.bell-wrapper').classList.remove('active');
                document.getElementById('userDropdownMenu').classList.toggle('show');
            }

            window.onclick = function(e) {
                if (!e.target.closest('#notiContainer')) {
                    document.getElementById('notiDropdown')?.classList.remove('show');
                    document.querySelector('.bell-wrapper')?.classList.remove('active');
                }
                if (!e.target.closest('#userWrapper')) {
                    document.getElementById('userDropdownMenu')?.classList.remove('show');
                }
            }

            // --- 2. NOTIFICATION LOGIC ---
            document.addEventListener('DOMContentLoaded', function() {
                connectSocket();
                fetchNotifications();
            });

            function connectSocket() {
                // Đảm bảo endpoint /ws khớp với cấu hình WebSocketConfig
                var socket = new SockJS('/ws'); 
                stompClient = Stomp.over(socket);
                stompClient.debug = null; 
                stompClient.connect({}, function() {
                    stompClient.subscribe('/user/queue/notifications', function(payload) {
                        const noti = JSON.parse(payload.body);
                        handleNewNotification(noti);
                    });
                });
            }

            function fetchNotifications() {
                fetch('/social/api/notifications') // Gọi đúng API đã tạo ở bước trước
                    .then(res => res.json())
                    .then(data => {
                        allNotifications = data;
                        updateUI();
                    })
                    .catch(err => console.error(err));
            }

            function handleNewNotification(noti) {
                allNotifications.unshift(noti); // Thêm vào đầu danh sách
                updateUI();
                // Play sound
                const audio = new Audio('/sounds/notification.mp3'); // Nếu có file sound
                audio.play().catch(e => {});
            }

            function updateUI() {
              const badge = document.getElementById('notiBadge');
              const bellWrapper = document.querySelector('.bell-wrapper'); // Chọn wrapper cũ của bạn
              
              // Đếm chưa đọc
              const unreadCount = allNotifications.filter(n => !n.read).length;
              
              // Hiển thị số lượng
              if (unreadCount > 0) {
                  badge.innerText = unreadCount > 99 ? '99+' : unreadCount;
                  badge.style.display = 'flex';
                  
                  // [VIPRO] Thêm class vàng + rung
                  if(bellWrapper) {
                      bellWrapper.classList.add('has-new'); 
                      // Chỉ rung khi số lượng thay đổi tăng lên (logic nâng cao) hoặc rung luôn
                      bellWrapper.classList.add('shaking');
                      // Tắt rung sau 0.5s
                      setTimeout(() => bellWrapper.classList.remove('shaking'), 500);
                  }
              } else {
                  badge.style.display = 'none';
                  if(bellWrapper) bellWrapper.classList.remove('has-new');
              }
          }

            function renderList() {
              const listEl = document.getElementById('notiList');
              if (!listEl) return;
              
              listEl.innerHTML = '';

              // Lọc theo tab (Tất cả / Chưa đọc)
              let filtered = allNotifications;
              if (currentFilter === 'unread') {
                  filtered = allNotifications.filter(n => !n.read);
              }

              if (filtered.length === 0) {
                  listEl.innerHTML = '<div class="noti-empty">Không có thông báo nào</div>';
                  document.getElementById('loadMoreBtn').style.display = 'none';
                  return;
              }

              // Cắt danh sách theo visibleCount
              const toShow = filtered.slice(0, visibleCount);

              toShow.forEach(n => {
                  // [VIPRO] Logic nút kết bạn
                  let extraContent = '';
                  if (n.type === 'FRIEND_REQUEST') {
                      // Giả sử link chứa ID user (vd: /profile/5), ta cần parse ID để gọi API
                      // Hoặc tốt nhất Backend trả về senderId trong DTO Notification
                      // Ở đây dùng tạm n.link để xử lý logic UI
                      extraContent = `
                          <div class="friend-request-actions" onclick="event.stopPropagation()">
                              <button class="btn-accept-fr" onclick="handleFriendRequest(${n.id}, '${n.link}', 'ACCEPT', this)">Chấp nhận</button>
                              <button class="btn-reject-fr" onclick="handleFriendRequest(${n.id}, '${n.link}', 'REJECT', this)">Xóa</button>
                          </div>
                      `;
                  }

                  const item = document.createElement('div');
                  item.className = `noti-item ${n.read ? '' : 'unread'}`;
                  
                  // Giữ nguyên logic click cũ: Đánh dấu đọc + Chuyển trang
                  item.onclick = () => {
                      if (!n.read) markAsRead(n.id);
                      if (n.link && n.link !== '#') window.location.href = n.link;
                  };

                  item.innerHTML = `
                      <div class="noti-content">
                          <p class="noti-text">${n.content}</p>
                          <span class="noti-time">${calcTimeAgo(n.timestamp)}</span>
                          ${extraContent}
                      </div>
                      ${!n.read ? '<div class="noti-dot"></div>' : ''}
                  `;
                  listEl.appendChild(item);
              });

              // Nút xem thêm
              const loadMoreBtn = document.getElementById('loadMoreBtn');
              if (loadMoreBtn) {
                  loadMoreBtn.style.display = (filtered.length > visibleCount) ? 'block' : 'none';
              }
          }

            function calcTimeAgo(dateStr) {
                if(!dateStr) return '';
    
                // [FIX] Nếu backend trả về mảng [2025, 12, 6, 10, 30] -> Convert sang string chuẩn ISO
                let date;
                if (Array.isArray(dateStr)) {
                    // Java LocalDateTime array: [year, month, day, hour, minute, second, nano]
                    // JS Month bắt đầu từ 0 (Tháng 1 là 0)
                    date = new Date(dateStr[0], dateStr[1] - 1, dateStr[2], dateStr[3], dateStr[4], dateStr[5] || 0);
                } else {
                    date = new Date(dateStr);
                }
                
                if (isNaN(date.getTime())) return ''; // Vẫn lỗi thì return rỗng thay vì NaN

                const now = new Date();
                const seconds = Math.floor((now - date) / 1000);
                
                if (seconds < 60) return 'Vừa xong';
                const minutes = Math.floor(seconds / 60);
                if (minutes < 60) return `${minutes} phút trước`;
                const hours = Math.floor(minutes / 60);
                if (hours < 24) return `${hours} giờ trước`;
                const days = Math.floor(hours / 24);
                return `${days} ngày trước`;
            }

            window.filterNoti = function(type, btn) {
                currentFilter = type;
                visibleCount = 6;
                document.querySelectorAll('.noti-tab').forEach(t => t.classList.remove('active'));
                btn.classList.add('active');
                renderList();
            }

            window.loadMoreNoti = function() {
                visibleCount += 10;
                renderList();
            }
            
            window.markAllRead = function() {
                fetch('/social/api/notifications/read-all', { method: 'POST' })
                    .then(() => {
                        allNotifications.forEach(n => n.read = true);
                        updateUI();
                    });
            }
        </script>
    </header>
  </body>
</html>
