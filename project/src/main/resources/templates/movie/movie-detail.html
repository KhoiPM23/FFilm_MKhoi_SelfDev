<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title th:text="${movie.title} + ' - FFilm'">Chi ti·∫øt phim</title>
    <meta name="movie-id" th:content="${movieId}" />

    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
    />
    <link rel="stylesheet" href="/css/style.css" />
    <link rel="stylesheet" href="/css/footer.css" />
    <link rel="stylesheet" th:href="@{/css/hover-card.css}" />
    <link rel="stylesheet" th:href="@{/css/ai-agent.css}" />

    <style>
      body {
        background: #0c0c0c;
      }
      .hero-banner {
        height: 85vh;
        max-height: 950px;
        min-height: 650px;
      }
      .movie-main-info {
        max-width: 850px;
        padding-top: 140px;
        position: relative;
        z-index: 2;
      }
      .hero-genres {
        display: flex;
        gap: 10px;
        margin-bottom: 15px;
        flex-wrap: wrap;
      }
      .hero-genre-tag {
        padding: 5px 14px;
        background: rgba(255, 255, 255, 0.1);
        backdrop-filter: blur(5px);
        border-radius: 20px;
        font-size: 0.9rem;
        color: #ddd;
        text-decoration: none;
        transition: all 0.3s;
        border: 1px solid rgba(255, 255, 255, 0.15);
      }
      .hero-genre-tag:hover {
        background: #e50914;
        border-color: #e50914;
        color: #fff;
      }
      .hero-description-container {
        margin-bottom: 30px;
        max-width: 750px;
        position: relative;
      }
      .description-toggle {
        background: none;
        border: none;
        color: #e50914;
        cursor: pointer;
        font-size: 1.4rem;
        padding: 5px;
        transition: transform 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        display: inline-block;
        margin-bottom: 5px;
      }
      .description-toggle:hover {
        transform: scale(1.2);
      }
      .description-toggle.expanded {
        transform: rotate(180deg);
      }
      .hero-description-text {
        font-size: 1.1rem;
        color: rgba(255, 255, 255, 0.9);
        line-height: 1.6;
        overflow: hidden;
        display: -webkit-box;
        -webkit-line-clamp: 3;
        -webkit-box-orient: vertical;
        transition: all 0.5s cubic-bezier(0.25, 0.46, 0.45, 0.94);
        margin-top: 10px;
      }
      .hero-description-text.expanded {
        -webkit-line-clamp: unset;
      }
      .main-content-wrapper {
        max-width: 1600px;
        margin: 0 auto;
        padding: 60px 50px;
        display: flex;
        gap: 70px;
        position: relative;
        z-index: 5;
      }
      .content-primary {
        flex: 1;
        min-width: 0;
      }
      .content-sidebar {
        width: 400px;
        flex-shrink: 0;
        position: sticky;
        top: 100px;
        height: fit-content;
      }
      .info-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
        gap: 30px;
        background: rgba(255, 255, 255, 0.02);
        padding: 30px;
        border-radius: 16px;
        border: 1px solid rgba(255, 255, 255, 0.05);
        margin-bottom: 50px;
        backdrop-filter: blur(10px);
      }
      .info-item {
        display: flex;
        flex-direction: column;
        gap: 8px;
      }
      .info-label {
        color: #888;
        font-size: 0.85rem;
        text-transform: uppercase;
        letter-spacing: 1px;
      }
      .info-value {
        color: #e5e5e5;
        font-weight: 500;
        font-size: 1.1rem;
      }

      .description-wrapper {
        background: #1a1a1a;
        padding: 25px 30px;
        border-radius: 16px;
        border: 1px solid rgba(255, 255, 255, 0.05);
        margin-bottom: 50px;
      }
      .section-title-small {
        font-size: 1.3rem;
        font-weight: 700;
        color: #fff;
        margin-bottom: 15px;
        border-left: 4px solid #e50914;
        padding-left: 10px;
      }
      .description-content {
        position: relative;
        overflow: hidden;
      }
      .description-text {
        font-size: 1.05rem;
        color: #ccc;
        line-height: 1.7;
        transition: all 0.5s ease-in-out;
        max-height: calc(1.05rem * 1.7 * 3); /* 3 d√≤ng */
        overflow: hidden;
      }
      .description-text.expanded {
        max-height: calc(1.05rem * 1.7 * 6);
      } /* 6 d√≤ng */
      .description-content::after {
        content: "";
        position: absolute;
        bottom: 0;
        left: 0;
        right: 0;
        height: 50px;
        background: linear-gradient(to top, #1a1a1a, transparent);
        pointer-events: none;
        transition: opacity 0.3s ease;
      }
      .description-content.expanded::after {
        opacity: 0;
      }
      .description-toggle-btn {
        background: none;
        border: none;
        color: #e50914;
        font-weight: 600;
        cursor: pointer;
        font-size: 1rem;
        padding-top: 10px;
        display: inline-flex;
        align-items: center;
        gap: 5px;
      }
      .description-toggle-btn i {
        transition: transform 0.3s ease;
      }
      .description-toggle-btn.expanded i {
        transform: rotate(180deg);
      }

      .trailer-section {
        margin-bottom: 60px;
      }
      .trailer-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        gap: 20px;
      }
      .trailer-card {
        position: relative;
        aspect-ratio: 16/9;
        border-radius: 10px;
        overflow: hidden;
        cursor: pointer;
        transition: all 0.3s;
        border: 2px solid transparent;
      }
      .trailer-card:hover {
        border-color: #e50914;
        transform: scale(1.03);
        z-index: 5;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
      }
      .trailer-card img {
        width: 100%;
        height: 100%;
        object-fit: cover;
        opacity: 0.8;
        transition: opacity 0.3s;
      }
      .trailer-card:hover img {
        opacity: 1;
      }
      .trailer-play {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%) scale(0.9);
        font-size: 3rem;
        color: rgba(255, 255, 255, 0.8);
        transition: all 0.3s;
      }
      .trailer-card:hover .trailer-play {
        color: #e50914;
        transform: translate(-50%, -50%) scale(1.1);
      }
      .trailer-title {
        position: absolute;
        bottom: 0;
        left: 0;
        right: 0;
        padding: 30px 15px 15px;
        background: linear-gradient(to top, #000 10%, transparent);
        color: #fff;
        font-size: 0.95rem;
        font-weight: 500;
      }

      .cast-section {
        margin-bottom: 60px;
      }
      .cast-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(130px, 1fr));
        gap: 30px 20px;
        max-height: 190px;
        overflow: hidden;
        transition: max-height 0.7s cubic-bezier(0.25, 1, 0.5, 1);
      }
      .cast-grid.expanded {
        max-height: 2000px;
      }
      .cast-card {
        text-align: center;
      }
      .cast-img-wrapper {
        width: 110px;
        height: 110px;
        margin: 0 auto 12px;
        border-radius: 50%;
        overflow: hidden;
        border: 3px solid rgba(255, 255, 255, 0.1);
        transition: all 0.3s ease;
        position: relative;
      }
      .cast-card:hover .cast-img-wrapper {
        border-color: #e50914;
        transform: scale(1.05);
        box-shadow: 0 0 20px rgba(229, 9, 20, 0.3);
      }
      .cast-img {
        width: 100%;
        height: 100%;
        object-fit: cover;
        transition: transform 0.4s ease;
      }
      .cast-card:hover .cast-img {
        transform: scale(1.1);
      }
      .cast-name {
        font-weight: 600;
        font-size: 0.95rem;
        color: #e5e5e5;
        margin-bottom: 4px;
        transition: color 0.3s;
      }
      .cast-card:hover .cast-name {
        color: #e50914;
      }
      .cast-role {
        color: #888;
        font-size: 0.85rem;
      }
      .cast-toggle-btn {
        display: block;
        margin: 30px auto 0;
        padding: 10px 35px;
        background: rgba(255, 255, 255, 0.05);
        color: #ccc;
        border: 1px solid rgba(255, 255, 255, 0.1);
        border-radius: 30px;
        cursor: pointer;
        transition: all 0.3s;
        font-weight: 600;
        letter-spacing: 0.5px;
      }
      .cast-toggle-btn:hover {
        background: #e50914;
        border-color: #e50914;
        color: #fff;
      }

      .sidebar-header {
        font-size: 1.6rem;
        font-weight: 800;
        margin-bottom: 25px;
        border-left: 5px solid #e50914;
        padding-left: 15px;
      }
      .trending-list {
        display: flex;
        flex-direction: column;
        gap: 18px;
        max-height: 650px;
        overflow-y: auto;
        padding-right: 10px;
      }
      .trending-list::-webkit-scrollbar {
        width: 6px;
      }
      .trending-list::-webkit-scrollbar-thumb {
        background: #333;
        border-radius: 10px;
      }
      .trending-list::-webkit-scrollbar-thumb:hover {
        background: #e50914;
      }
      .trending-item {
        display: flex;
        gap: 18px;
        cursor: pointer;
        padding: 10px;
        border-radius: 12px;
        transition: all 0.3s ease;
      }
      .trending-item:hover {
        background: rgba(255, 255, 255, 0.05);
        transform: translateX(5px);
      }
      .trending-thumb {
        width: 150px;
        height: 85px;
        flex-shrink: 0;
        border-radius: 8px;
        overflow: hidden;
        position: relative;
        box-shadow: 0 4px 10px rgba(0, 0, 0, 0.3);
      }
      .trending-thumb img {
        width: 100%;
        height: 100%;
        object-fit: cover;
        transition: transform 0.4s;
      }
      .trending-item:hover .trending-thumb img {
        transform: scale(1.1);
      }

      .trending-thumb::after {
        content: "";
        position: absolute;
        inset: 0;
        opacity: 0.75;
        z-index: 1;
        transition: opacity 0.3s ease;
      }
      .trending-item:hover .trending-thumb::after {
        opacity: 0.9;
      }
      .trending-item.rank-1 .trending-thumb::after {
        background: linear-gradient(90deg, #e50914 0%, transparent 60%);
      }
      .trending-item.rank-2 .trending-thumb::after {
        background: linear-gradient(90deg, #007bff 0%, transparent 60%);
      }
      .trending-item.rank-3 .trending-thumb::after {
        background: linear-gradient(90deg, #28a745 0%, transparent 60%);
      }
      .trending-item.rank-4 .trending-thumb::after {
        background: linear-gradient(90deg, #ffc107 0%, transparent 60%);
      }
      .trending-item.rank-5 .trending-thumb::after {
        background: linear-gradient(90deg, #6f42c1 0%, transparent 60%);
      }

      .trending-thumb .ranking-number {
        font-size: 64px !important;
        bottom: 0px !important;
        left: 5px !important;
      }
      .trending-item:hover .ranking-number {
        transform: scale(1.05) !important;
        color: rgba(255, 255, 255, 0.6) !important;
      }
      .trending-info {
        display: flex;
        flex-direction: column;
        justify-content: center;
      }
      .trending-title {
        font-weight: 600;
        font-size: 1.05rem;
        margin-bottom: 8px;
        line-height: 1.4;
        color: #f0f0f0;
      }
      .trending-meta {
        font-size: 0.9rem;
        color: #aaa;
        font-weight: 500;
      }

      .comments-wrapper {
        background: #121212;
        border-radius: 16px;
        padding: 30px;
        border: 1px solid #222;
        margin-top: 50px;
      }
      .comments-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 30px;
      }
      .comments-title {
        font-size: 1.5rem;
        font-weight: 700;
      }
      .comments-tabs {
        display: flex;
        gap: 10px;
        background: #222;
        padding: 4px;
        border-radius: 30px;
      }
      .comment-tab {
        padding: 8px 20px;
        border-radius: 25px;
        cursor: pointer;
        font-size: 0.9rem;
        font-weight: 600;
        color: #999;
        transition: all 0.3s;
      }
      .comment-tab.active {
        background: #e50914;
        color: #fff;
      }
      .comment-input-box {
        display: flex;
        gap: 15px;
        margin-bottom: 40px;
        position: relative;
      }
      .user-avatar {
        width: 45px;
        height: 45px;
        border-radius: 50%;
        background: linear-gradient(135deg, #ff6b6b, #e50914);
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: bold;
        color: #fff;
        flex-shrink: 0;
      }
      .comment-input-area {
        flex: 1;
        background: transparent;
        border: none;
        border-bottom: 2px solid #333;
        padding: 10px 50px 10px 10px;
        color: #fff;
        font-size: 1rem;
        transition: border-color 0.3s;
      }
      .comment-input-area:focus {
        outline: none;
        border-color: #e50914;
      }
      .emoji-btn {
        position: absolute;
        right: 10px;
        top: 10px;
        color: #999;
        cursor: pointer;
        font-size: 1.3rem;
        transition: color 0.3s;
      }
      .emoji-btn:hover {
        color: #e50914;
      }
      .comment-list {
        display: flex;
        flex-direction: column;
        gap: 25px;
      }
      .comment-item {
        display: flex;
        gap: 15px;
      }
      .comment-author-name {
        font-weight: 700;
        color: #e5e5e5;
        margin-right: 10px;
      }
      .comment-time {
        color: #666;
        font-size: 0.85rem;
      }
      .comment-content {
        color: #ccc;
        line-height: 1.5;
        margin: 6px 0 10px;
      }
      .comment-actions {
        display: flex;
        gap: 20px;
        color: #888;
        font-size: 0.9rem;
      }
      .comment-action {
        cursor: pointer;
        display: flex;
        align-items: center;
        gap: 6px;
        transition: color 0.2s;
      }
      .comment-action:hover {
        color: #e50914;
      }
      .like-count {
        color: #e50914;
        background: rgba(229, 9, 20, 0.1);
        padding: 2px 8px;
        border-radius: 10px;
        font-size: 0.8rem;
      }

      .full-width-section {
        max-width: 100%;
        padding: 50px 0 30px 50px;
        border-top: 1px solid #1a1a1a;
      }

      @media (max-width: 1280px) {
        .main-content-wrapper {
          flex-direction: column;
          gap: 50px;
          padding: 40px 30px;
        }
        .content-sidebar {
          width: 100%;
          position: static;
        }
        .trending-list {
          flex-direction: row;
          overflow-x: auto;
          padding-bottom: 15px;
          scroll-snap-type: x mandatory;
        }
        .trending-item {
          min-width: 320px;
          scroll-snap-align: start;
          background: rgba(255, 255, 255, 0.03);
        }
        .full-width-section {
          padding-left: 30px;
        }
      }
      @media (max-width: 768px) {
        .hero-banner {
          height: 75vh;
          min-height: 550px;
        }
        .movie-main-info {
          padding-top: 100px;
        }
        .hero-title {
          font-size: 2.8rem !important;
        }
        .full-width-section {
          padding-left: 15px;
        }
      }

      /* [G9] CSS cho ph·∫ßn b√¨nh lu·∫≠n */
      .comments-wrapper {
        background: #121212;
        border-radius: 16px;
        padding: 30px;
        border: 1px solid #222;
        margin-top: 50px;
      }
      .comments-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 30px;
      }
      .comments-title {
        font-size: 1.5rem;
        font-weight: 700;
      }
      .comments-tabs {
        display: flex;
        gap: 10px;
        background: #222;
        padding: 4px;
        border-radius: 30px;
      }
      .comment-tab {
        padding: 8px 20px;
        border-radius: 25px;
        cursor: pointer;
        font-size: 0.9rem;
        font-weight: 600;
        color: #999;
        transition: all 0.3s;
      }
      .comment-tab.active {
        background: #e50914;
        color: #fff;
      }
      .comment-input-box {
        display: flex;
        gap: 15px;
        margin-bottom: 40px;
        position: relative;
      }
      .user-avatar {
        width: 45px;
        height: 45px;
        border-radius: 50%;
        background: linear-gradient(135deg, #ff6b6b, #e50914);
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: bold;
        color: #fff;
        flex-shrink: 0;
      }
      .comment-input-area {
        flex: 1;
        background: transparent;
        border: none;
        border-bottom: 2px solid #333;
        padding: 10px 50px 10px 10px;
        color: #fff;
        font-size: 1rem;
        transition: border-color 0.3s;
      }
      .comment-input-area:focus {
        outline: none;
        border-color: #e50914;
      }
      .emoji-btn {
        position: absolute;
        right: 10px;
        top: 10px;
        color: #999;
        cursor: pointer;
        font-size: 1.3rem;
        transition: color 0.3s;
      }
      .emoji-btn:hover {
        color: #e50914;
      }
      .comment-list {
        display: flex;
        flex-direction: column;
        gap: 25px;
      }
      .comment-item {
        display: flex;
        gap: 15px;
      }
      .comment-author-name {
        font-weight: 700;
        color: #e5e5e5;
        margin-right: 10px;
      }
      .comment-time {
        color: #666;
        font-size: 0.85rem;
      }
      .comment-content {
        color: #ccc;
        line-height: 1.5;
        margin: 6px 0 10px;
      }
      .comment-actions {
        display: flex;
        gap: 20px;
        color: #888;
        font-size: 0.9rem;
      }
      .comment-action {
        cursor: pointer;
        display: flex;
        align-items: center;
        gap: 6px;
        transition: color 0.2s;
      }
      .comment-action:hover {
        color: #e50914;
      }
      .like-count {
        color: #e50914;
        background: rgba(229, 9, 20, 0.1);
        padding: 2px 8px;
        border-radius: 10px;
        font-size: 0.8rem;
      }
      /* [G9] Mock Emoji Picker */
      .emoji-picker-mock {
        position: absolute;
        background: #222;
        border: 1px solid #333;
        border-radius: 8px;
        padding: 10px;
        display: flex;
        flex-wrap: wrap;
        gap: 8px;
        width: 200px;
        z-index: 10;
        right: 0;
        top: 50px;
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
      }
      .emoji-mock {
        font-size: 1.5rem;
        cursor: pointer;
        transition: transform 0.2s;
      }
      .emoji-mock:hover {
        transform: scale(1.2);
      }
    </style>
  </head>
  <body>
    <div th:replace="~{fragments/header :: header}"></div>

    <section
      class="hero-banner"
      id="heroBanner"
      th:attr="data-movie-id=${movieId},
                    data-trailer-key=${movie.trailerKey}, 
                    data-logo-path=${movie.logoPath}"
      th:style="'background-image: url(' + ${movie.backdrop} + ')'"
    >
      <div class="hero-video-container" id="heroVideoContainer">
        <div id="heroPlayer"></div>
      </div>
      <div class="hero-overlay"></div>

      <div class="hero-content">
        <div class="movie-main-info">
          <div class="hero-title-container">
            <img
              id="heroLogo"
              src=""
              alt="Movie Logo"
              style="display: none; max-height: 160px; margin-bottom: 25px"
            />
            <h1 class="hero-title" id="heroTitleText" th:text="${movie.title}">
              T√™n Phim
            </h1>
          </div>

          <div class="hero-meta">
            <div class="content-rating" id="contentRating">
              <span>T16</span>
            </div>
            <div class="rating">
              <i class="fas fa-star"></i
              ><span th:text="${movie.rating}">0.0</span>
            </div>
            <div class="year" th:text="${movie.year}">...</div>
            <div class="duration" th:text="${movie.runtime} + ' ph√∫t'">
              0 ph√∫t
            </div>
            <div
              class="quality-badge"
              style="
                background: #e50914;
                padding: 2px 7px;
                border-radius: 4px;
                font-weight: 700;
                font-size: 0.85rem;
              "
            >
              HD
            </div>
            <div class="country" th:text="${movie.country}">‚Äî</div>
          </div>

          <div class="hero-genres">
            <a
              th:each="g : ${movie.genres}"
              th:text="${g}"
              href="#"
              class="hero-genre-tag"
              >Th·ªÉ lo·∫°i</a
            >
          </div>

          <div class="hero-actions">
            <a th:href="@{'/movie/player/' + ${movieId}}" class="btn-play"
              ><i class="fas fa-play"></i> Xem phim</a
            >
            <div class="action-buttons-group">
              <button
                th:attr="data-movie-id=${movieId}"
                class="btn-circle hero-action-icon hover-like-btn"
                onclick="toggleHoverLike(this)"
                title="Y√™u th√≠ch"
              >
                <i class="far fa-heart"></i>
              </button>

              <button
                class="btn-circle hero-action-icon hover-share-btn"
                th:data-movie-id="${movieId}"
                th:data-movie-title="${movie.title}"
                onclick="showShareModal(this)"
                title="Chia s·∫ª"
              >
                <i class="fas fa-share-alt"></i>
              </button>
              <div class="action-divider"></div>
              <button
                class="btn-circle volume-btn"
                id="volumeBtn"
                title="B·∫≠t/T·∫Øt ti·∫øng"
              >
                <i class="fas fa-volume-mute"></i>
              </button>
            </div>
          </div>
        </div>
      </div>
    </section>

    <div class="main-content-wrapper">
      <div class="content-primary">
        <div class="info-grid">
          <div class="info-item">
            <span class="info-label">ƒê·∫°o di·ªÖn</span>
            <span class="info-value" th:text="${movie.director}">‚Äî</span>
          </div>
          <div class="info-item">
            <span class="info-label">Qu·ªëc gia</span>
            <span class="info-value" th:text="${movie.country}">‚Äî</span>
          </div>
          <div class="info-item">
            <span class="info-label">Ph√°t h√†nh</span>
            <span class="info-value" th:text="${movie.releaseDate}">‚Äî</span>
          </div>
          <div class="info-item">
            <span class="info-label">Ng√¥n ng·ªØ</span>
            <span class="info-value" th:text="${movie.language}">‚Äî</span>
          </div>
          <div class="info-item">
            <span class="info-label">Ng√¢n s√°ch</span>
            <span class="info-value" th:text="${movie.budget}">‚Äî</span>
          </div>
          <div class="info-item">
            <span class="info-label">Doanh thu</span>
            <span class="info-value" th:text="${movie.revenue}">‚Äî</span>
          </div>
        </div>

        <div class="description-wrapper">
          <h3 class="section-title-small">N·ªôi dung phim</h3>
          <div class="description-content" id="descContent">
            <p
              class="description-text"
              id="descText"
              th:text="${movie.overview}"
            >
              N·ªôi dung phim ƒëang c·∫≠p nh·∫≠t...
            </p>
          </div>
          <button
            class="description-toggle-btn"
            id="descToggleBtn"
            onclick="toggleFPTDescription()"
          >
            <span>Xem th√™m</span> <i class="fas fa-chevron-down"></i>
          </button>
        </div>

        <div
          class="trailer-section"
          id="trailerSection"
          style="margin-bottom: 60px; display: none"
        >
          <h2
            class="section-title"
            style="
              font-size: 1.6rem;
              margin-bottom: 25px;
              display: flex;
              align-items: center;
              gap: 10px;
            "
          >
            <i class="fab fa-youtube" style="color: #e50914"></i> Trailer & H·∫≠u
            tr∆∞·ªùng
          </h2>

          <div
            class="trailer-grid"
            id="trailerGrid"
            style="display: none"
          ></div>

          <div
            class="fallback-message"
            id="trailerFallback"
            style="
              display: none;
              background: rgba(255, 255, 255, 0.03);
              border: 1px dashed rgba(255, 255, 255, 0.1);
              border-radius: 8px;
              padding: 40px 20px;
              text-align: center;
              color: #888;
            "
          >
            <i
              class="fas fa-video-slash"
              style="font-size: 2rem; margin-bottom: 15px"
            ></i>
            <p style="margin: 0; font-size: 1rem">
              Ch∆∞a c√≥ trailer ho·∫∑c video h·∫≠u tr∆∞·ªùng cho phim n√†y.
            </p>
          </div>
        </div>

        <div
          class="cast-section"
          th:if="${castList != null && !castList.isEmpty()}"
          style="margin-bottom: 60px"
        >
          <h2
            class="section-title"
            style="
              font-size: 1.6rem;
              margin-bottom: 30px;
              display: flex;
              align-items: center;
              gap: 10px;
            "
          >
            <i class="fas fa-users" style="color: #e50914"></i> Di·ªÖn vi√™n
          </h2>
          <div class="cast-grid" id="castGrid">
            <div
              th:each="p : ${castList}"
              class="cast-card"
              th:onclick="'window.location.href=\'/person/detail/' + ${p.id} + '\''"
            >
              <div class="cast-img-wrapper">
                <img
                  class="cast-img"
                  th:src="${p.avatar}"
                  th:alt="${p.name}"
                  onerror="this.src='/images/placeholder-user.jpg'"
                />
              </div>
              <div class="cast-info">
                <span class="cast-name" th:text="${p.name}">Actor Name</span>
                <span class="cast-role" th:text="${p.role}">Character</span>
              </div>
            </div>
          </div>
          <button
            id="castToggleBtn"
            class="cast-toggle-btn"
            th:if="${castList.size() > 6}"
            onclick="toggleCast()"
          >
            Xem t·∫•t c·∫£
          </button>
        </div>

        <div
          class="comments-wrapper"
          style="
            background: #121212;
            border-radius: 16px;
            padding: 30px;
            border: 1px solid #222;
            margin-top: 50px;
          "
        ></div>

<!-- <<<<<<< HEAD
        <div class="comments-header">
          <h3 class="comments-title">B√¨nh lu·∫≠n</h3>
          <div class="comments-tabs">
            <span class="comment-tab active">M·ªõi nh·∫•t</span>
            <span class="comment-tab">Nhi·ªÅu like nh·∫•t</span>
          </div>
======= -->
    <section class="hero-banner" 
            id="heroBanner" 
            th:attr="data-movie-id=${movieId},
                    data-trailer-key=${movie.trailerKey}, 
                    data-logo-path=${movie.logoPath}"
            th:style="'background-image: url(' + ${movie.backdrop} + ')'"> 
        
        <div class="hero-video-container" id="heroVideoContainer"><div id="heroPlayer"></div></div>
        <div class="hero-overlay"></div>
        
        <div class="hero-content">
            <div class="movie-main-info">
                <div class="hero-title-container">
                    <img id="heroLogo" src="" alt="Movie Logo" style="display:none; max-height: 160px; margin-bottom: 25px;">
                    <h1 class="hero-title" id="heroTitleText" th:text="${movie.title}">T√™n Phim</h1>
                </div>
                
                <div class="hero-meta">
                    <div class="content-rating" id="contentRating"><span>T16</span></div>
                    <div class="rating"><i class="fas fa-star"></i><span th:text="${movie.rating}">0.0</span></div>
                    <div class="year" th:text="${movie.year}">...</div>
                    <div class="duration" th:text="${movie.runtime} + ' ph√∫t'">0 ph√∫t</div>
                    <div class="quality-badge" style="background:#e50914;padding:2px 7px;border-radius:4px;font-weight:700;font-size:0.85rem">HD</div>
                    <div class="country" th:text="${movie.country}">‚Äî</div>
                </div>

                <div class="hero-genres">
                    <a th:each="g : ${movie.genres}" th:text="${g}" href="#" class="hero-genre-tag">Th·ªÉ lo·∫°i</a>
                </div>

                <div class="hero-actions">
                    <a th:href="@{'/movie/player/' + ${movie.id}}" class="btn-play"><i class="fas fa-play"></i> Xem phim</a>
                    <div class="action-buttons-group">
                        <button class="btn-circle hero-action-icon hover-like-btn" onclick="toggleHoverLike(this)" title="Y√™u th√≠ch"><i class="far fa-heart"></i></button>
                        <button class="btn-circle hero-action-icon hover-share-btn" 
                                th:data-movie-id="${movieId}" 
                                th:data-movie-title="${movie.title}"
                                onclick="showShareModal(this)" title="Chia s·∫ª">
                            <i class="fas fa-share-alt"></i>
                        </button>
                        <div class="action-divider"></div>
                        <button class="btn-circle volume-btn" id="volumeBtn" title="B·∫≠t/T·∫Øt ti·∫øng"><i class="fas fa-volume-mute"></i></button>
                    </div>
                </div>
            </div>
<!-- >>>>>>> 37ff03da4ef64262f56e11838622435cab46eb44 -->
        </div>

        <div class="comment-input-box">
          <div class="user-avatar">U</div>
          <textarea
            class="comment-input-area"
            placeholder="Vi·∫øt b√¨nh lu·∫≠n c·ªßa b·∫°n..."
            id="commentInput"
          ></textarea>
          <i
            class="fas fa-smile emoji-btn"
            onclick="toggleEmojiPicker(event)"
          ></i>

          <div class="emoji-picker-mock" id="emojiPicker" style="display: none">
            <span class="emoji-mock" onclick="addEmoji('üòÄ')">üòÄ</span>
            <span class="emoji-mock" onclick="addEmoji('üòÇ')">üòÇ</span>
            <span class="emoji-mock" onclick="addEmoji('üòç')">üòç</span>
            <span class="emoji-mock" onclick="addEmoji('ü§î')">ü§î</span>
            <span class="emoji-mock" onclick="addEmoji('üî•')">üî•</span>
            <span class="emoji-mock" onclick="addEmoji('üëç')">üëç</span>
            <span class="emoji-mock" onclick="addEmoji('üëé')">üëé</span>
            <span class="emoji-mock" onclick="addEmoji('üëè')">üëè</span>
          </div>
        </div>

        <div class="comment-list">
          <div class="comment-item">
            <div class="user-avatar" style="background: #007bff">V</div>
            <div class="comment-body">
              <span class="comment-author-name">VƒÉn A</span>
              <span class="comment-time">2 gi·ªù tr∆∞·ªõc</span>
              <p class="comment-content">
                Phim hay qu√°! K·ªπ x·∫£o m√£n nh√£n, n·ªôi dung c≈©ng r·∫•t s√¢u s·∫Øc. üî•
              </p>
              <div class="comment-actions">
                <span class="comment-action"
                  ><i class="fas fa-thumbs-up"></i> 15</span
                >
                <span class="comment-action"
                  ><i class="fas fa-thumbs-down"></i> 1</span
                >
                <span class="comment-action">Tr·∫£ l·ªùi</span>
              </div>
            </div>
          </div>
          <div class="comment-item">
            <div class="user-avatar" style="background: #28a745">T</div>
            <div class="comment-body">
              <span class="comment-author-name">Th·ªã B</span>
              <span class="comment-time">5 gi·ªù tr∆∞·ªõc</span>
              <p class="comment-content">
                C≈©ng b√¨nh th∆∞·ªùng, m√¨nh th·∫•y h∆°i nh√†m ch√°n ƒëo·∫°n gi·ªØa. ü§î
              </p>
              <div class="comment-actions">
                <span class="comment-action"
                  ><i class="fas fa-thumbs-up"></i> 3</span
                >
                <span class="comment-action"
                  ><i class="fas fa-thumbs-down"></i> 0</span
                >
                <span class="comment-action">Tr·∫£ l·ªùi</span>
              </div>
            </div>
          </div>
        </div>
      </div>

      <div class="content-sidebar">
        <div class="sidebar-header">Top Phim Xu H∆∞·ªõng</div>
        <div class="trending-list" id="trendingSidebar">
          <div
            th:each="m, iter : ${trendingMovies}"
            class="trending-item"
            th:classappend="'rank-' + ((${iter.index} % 5) + 1)"
            th:onclick="'window.location.href=\'/movie/detail/' + ${m.id} + '\''"
          >
            <div class="trending-thumb">
              <img
                th:src="${m.backdrop}"
                th:alt="${m.title}"
                onerror="this.src='/images/placeholder.jpg'"
              />
              <div class="ranking-number" th:text="${iter.index + 1}"></div>
            </div>
            <div class="trending-info">
              <div class="trending-title" th:text="${m.title}">Movie Title</div>
              <div
                class="trending-meta"
                th:text="${m.year} + ' ‚Ä¢ ‚≠ê ' + ${m.rating}"
              ></div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <section
      class="movies movie-list-section full-width-section"
      style="margin-top: 0"
      th:if="${similarMovies != null && !similarMovies.isEmpty()}"
    >
      <div class="section-header" style="padding: 0; margin-bottom: 20px">
        <div class="section-title-wrapper">
          <h2 class="section-title" style="font-size: 1.6rem">
            üî• Phim t∆∞∆°ng t·ª±
          </h2>
        </div>
        <div class="carousel-nav">
          <button class="nav-btn prev-btn" id="similarPrevBtn">
            <i class="fas fa-chevron-left"></i>
          </button>
          <button class="nav-btn next-btn" id="similarNextBtn">
            <i class="fas fa-chevron-right"></i>
          </button>
        </div>
      </div>
      <div class="movie-carousel">
        <div class="movie-slider" id="similarSlider">
          <div
            th:each="movie : ${similarMovies}"
            class="movie-card"
            th:attr="data-movie-id=${movie.id}"
          >
            <div class="movie-poster">
              <img
                th:src="${movie.poster}"
                th:alt="${movie.title}"
                onerror="this.src='/images/placeholder.jpg'"
                loading="lazy"
              />
            </div>
            <div class="movie-info">
              <h3 th:text="${movie.title}">Title</h3>
              <p class="movie-rating">
                ‚≠ê <span th:text="${movie.rating}">8.5</span>
              </p>
            </div>
            <div
              th:replace="~{fragments/hover-card :: hoverCard(${movie})}"
            ></div>
          </div>
        </div>
      </div>
    </section>

    <section
      class="movies movie-list-section full-width-section"
      style="border: none"
      th:if="${recommendedMovies != null && !recommendedMovies.isEmpty()}"
    >
      <div class="section-header" style="padding: 0; margin-bottom: 20px">
        <div class="section-title-wrapper">
          <h2
            class_content="section-title"
            style="font-size: 1.6rem"
            th:text="${recommendTitle ?: '‚ú® C√≥ th·ªÉ b·∫°n th√≠ch'}"
          >
            ‚ú® C√≥ th·ªÉ b·∫°n th√≠ch
          </h2>
        </div>
        <div class="carousel-nav">
          <button class="nav-btn prev-btn" id="recommendPrevBtn">
            <i class="fas fa-chevron-left"></i>
          </button>
          <button class="nav-btn next-btn" id="recommendNextBtn">
            <i class="fas fa-chevron-right"></i>
          </button>
        </div>
      </div>
      <div class="movie-carousel">
        <div class="movie-slider" id="recommendSlider">
          <div
            th:each="movie : ${recommendedMovies}"
            class="movie-card"
            th:attr="data-movie-id=${movie.id}"
          >
            <div class="movie-poster">
              <img
                th:src="${movie.poster}"
                th:alt="${movie.title}"
                onerror="this.src='/images/placeholder.jpg'"
                loading="lazy"
              />
            </div>
            <div class="movie-info">
              <h3 th:text="${movie.title}">Title</h3>
              <p class="movie-rating">
                ‚≠ê <span th:text="${movie.rating}">8.5</span>
              </p>
            </div>
            <div
              th:replace="~{fragments/hover-card :: hoverCard(${movie})}"
            ></div>
          </div>
        </div>
      </div>
    </section>

    <div th:replace="~{fragments/footer :: footer}"></div>
    <div th:replace="~{fragments/ai-chat :: ai-chat}"></div>
    <div th:replace="~{fragments/share-modal :: shareModal}"></div>

    <div
      id="globalTrailerModal"
      class="share-modal-overlay"
      style="z-index: 100000"
    >
      <div
        class="share-modal"
        style="
          width: 90vw;
          max-width: 1100px;
          aspect-ratio: 16/9;
          padding: 0;
          background: #000;
        "
      >
        <button
          class="share-modal-close"
          onclick="closeGlobalTrailer()"
          style="
            position: absolute;
            top: -15px;
            right: -15px;
            background: #000;
            border-radius: 50%;
            z-index: 10;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2rem;
          "
        >
          &times;
        </button>
        <iframe
          id="globalTrailerFrame"
          width="100%"
          height="100%"
          src=""
          frameborder="0"
          allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture"
          allowfullscreen
          style="border-radius: 8px"
        >
        </iframe>
      </div>
    </div>

    <script src="https://www.youtube.com/iframe_api"></script>
    <script th:src="@{/js/movie/ai-agent.js}" defer></script>
    <script src="/js/movie/share-modal.js"></script>
    <script src="/js/script.js"></script>
    <script th:inline="javascript">
      const currentMovieId = /*[[${movieId}]]*/ "defaultId";

      window.openGlobalTrailer = function (videoId) {
        document.getElementById("globalTrailerModal").classList.add("active");
        document.getElementById(
          "globalTrailerFrame"
        ).src = `https://www.youtube.com/embed/${videoId}?autoplay=1&rel=0`;
      };
      window.closeGlobalTrailer = function () {
        document
          .getElementById("globalTrailerModal")
          .classList.remove("active");
        document.getElementById("globalTrailerFrame").src = "";
      };
      function toggleCast() {
        document.getElementById("castGrid").classList.toggle("expanded");
        const btn = document.getElementById("castToggleBtn");
        btn.textContent =
          btn.textContent === "Xem t·∫•t c·∫£" ? "Thu g·ªçn" : "Xem t·∫•t c·∫£";
      }
      function toggleFPTDescription() {
        document.getElementById("descContent").classList.toggle("expanded");
        document.getElementById("descText").classList.toggle("expanded");
        const btn = document.getElementById("descToggleBtn");
        btn.classList.toggle("expanded");
        btn.querySelector("span").textContent = btn.classList.contains(
          "expanded"
        )
          ? "·∫®n b·ªõt"
          : "Xem th√™m";
      }

      document.addEventListener("DOMContentLoaded", () => {
        loadTrailers();
      });

      window.toggleEmojiPicker = function (event) {
        event.stopPropagation();
        const picker = document.getElementById("emojiPicker");
        picker.style.display =
          picker.style.display === "none" ? "flex" : "none";
      };
      window.addEmoji = function (emoji) {
        const input = document.getElementById("commentInput");
        input.value += emoji;
        input.focus();
      };

      document.addEventListener("click", function (event) {
        const picker = document.getElementById("emojiPicker");
        if (picker && picker.style.display === "flex") {
          if (
            !picker.contains(event.target) &&
            !event.target.classList.contains("emoji-btn")
          ) {
            picker.style.display = "none";
          }
        }
      });

      async function loadTrailers() {
        // L·∫•y c√°c element DOM
        const sectionEl = document.getElementById("trailerSection");
        const gridEl = document.getElementById("trailerGrid");
        const fallbackEl = document.getElementById("trailerFallback");

        if (!sectionEl || !gridEl || !fallbackEl) return;

        try {
          const currentMovieId = document.querySelector(
            'meta[name="movie-id"]'
          ).content;
          const TMDB_API_KEY_DETAIL = "eac03c4e09a0f5099128e38cb0e67a8f";
          const BASE_URL_DETAIL = "https://api.themoviedb.org/3";
          let res = await fetch(
            `${BASE_URL_DETAIL}/movie/${currentMovieId}/videos?api_key=${TMDB_API_KEY_DETAIL}&language=vi-VN`
          );
          let data = await res.json();
          let videos = (data.results || []).filter(
            (v) =>
              v.site === "YouTube" &&
              ["Trailer", "Teaser", "Featurette"].includes(v.type)
          );

          if (videos.length < 3) {
            let resEn = await fetch(
              `${BASE_URL_DETAIL}/movie/${currentMovieId}/videos?api_key=${TMDB_API_KEY_DETAIL}&language=en-US`
            );
            let dataEn = await resEn.json();
            let videosEn = (dataEn.results || []).filter(
              (v) =>
                v.site === "YouTube" && ["Trailer", "Teaser"].includes(v.type)
            );

            const existing = new Set(videos.map((v) => v.key));
            videos = [
              ...videos,
              ...videosEn.filter((v) => !existing.has(v.key)),
            ];
          }
          const top3 = videos.slice(0, 3);
          sectionEl.style.display = "block";

          if (top3.length > 0) {
            gridEl.innerHTML = top3
              .map(
                (v) => `
                                    <div class="trailer-card" onclick="openGlobalTrailer('${v.key}')">
                                        <img src="https://img.youtube.com/vi/${v.key}/mqdefault.jpg" alt="${v.name}">
                                        <i class="fas fa-play-circle trailer-play"></i>
                                        <div class="trailer-title">${v.name}</div>
                                    </div>
                                `
              )
              .join("");
            gridEl.style.display = "grid";
            fallbackEl.style.display = "none";
          } else {
            gridEl.style.display = "none";
            fallbackEl.style.display = "block";
          }
        } catch (e) {
          console.error("L·ªói t·∫£i trailer:", e);
          if (sectionEl) sectionEl.style.display = "block";
          if (gridEl) gridEl.style.display = "none";
          if (fallbackEl) fallbackEl.style.display = "block";
        }
      }
      function toggleHoverLike(button) {
        // ƒê·ªçc 'data-movie-id' (nh∆∞ ƒë√£ s·ª≠a)
        const movieId = button.getAttribute("data-movie-id");

        if (!movieId) {
          console.error("Kh√¥ng t√¨m th·∫•y movie ID!");
          return;
        }

        // (T√πy ch·ªçn) L·∫•y CSRF token n·∫øu b·∫°n d√πng Spring Security
        const csrfToken = document
          .querySelector("meta[name='_csrf']")
          ?.getAttribute("content");
        const csrfHeader = document
          .querySelector("meta[name='_csrf_header']")
          ?.getAttribute("content");

        const headers = {
          "Content-Type": "application/json",
        };

        if (csrfHeader && csrfToken) {
          headers[csrfHeader] = csrfToken;
        }

        fetch(`/favorites/${movieId}`, {
          method: "POST",
          headers: headers,
          body: JSON.stringify({}),

          // --- GI·∫¢I PH√ÅP CHO V·∫§N ƒê·ªÄ 1 L√Ä D√íNG N√ÄY ---
          // Y√™u c·∫ßu tr√¨nh duy·ªát g·ª≠i k√®m cookie (ch·ª©a session)
          credentials: "include",
          // -----------------------------------------
        })
          .then((response) => {
            if (response.ok) {
              // Thay ƒë·ªïi icon khi th√†nh c√¥ng
              button.querySelector("i").classList.toggle("fas");
              button.querySelector("i").classList.toggle("far");
            } else if (response.status === 401 || response.status === 400) {
              alert("B·∫°n c·∫ßn ƒëƒÉng nh·∫≠p ƒë·ªÉ th·ª±c hi·ªán ch·ª©c nƒÉng n√†y!");
            } else {
              alert("Kh√¥ng th·ªÉ th√™m v√†o y√™u th√≠ch! (L·ªói server)");
            }
          })
          .catch((error) => {
            console.error("Error:", error);
            alert("C√≥ l·ªói x·∫£y ra!");
          });
      }
    </script>
  </body>
</html>
