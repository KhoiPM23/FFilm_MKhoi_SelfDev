<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title th:text="${movie.title} + ' - FFilm'">Chi ti·∫øt phim</title>
    <meta name="movie-id" th:content="${movieId}" />
    <meta name="tmdb-id" th:if="${tmdbId != null}" th:content="${tmdbId}" />

    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
    />
    <link rel="stylesheet" href="/css/style.css" />
    <link rel="stylesheet" href="/css/footer.css" />
    <link rel="stylesheet" th:href="@{/css/hover-card.css}" />
    <link rel="stylesheet" th:href="@{/css/ai-agent.css}" />
    <link rel="stylesheet" th:href="@{/css/movie/movie-detail.css}" />
  </head>
  <body>
    <div th:replace="~{fragments/header :: header}"></div>

    <section
      class="hero-banner"
      id="heroBanner"
      th:attr="data-movie-id=${movieId},
                    data-trailer-key=${movie.trailerKey}, 
                    data-logo-path=${movie.logoPath}"
      th:style="'background-image: url(' + ${movie.backdrop} + ')'"
    >
      <div class="hero-video-container" id="heroVideoContainer">
        <div id="heroPlayer"></div>
      </div>
      <div class="hero-overlay"></div>

      <div class="hero-content">
        <div class="movie-main-info">
          <div class="hero-title-container">
            <img
              id="heroLogo"
              src=""
              alt="Movie Logo"
              style="display: none; max-height: 160px; margin-bottom: 25px"
            />
            <h1 class="hero-title" id="heroTitleText" th:text="${movie.title}">
              T√™n Phim
            </h1>
          </div>

          <div class="hero-meta">
            <div class="content-rating" id="contentRating">
              <span>T16</span>
            </div>
            <div class="rating">
              <i class="fas fa-star"></i
              ><span th:text="${movie.rating}">0.0</span>
            </div>
            <div class="year" th:text="${movie.year}">...</div>
            <div class="duration" th:text="${movie.runtime} + ' ph√∫t'">
              0 ph√∫t
            </div>
            <div
              class="quality-badge"
              style="
                background: #e50914;
                padding: 2px 7px;
                border-radius: 4px;
                font-weight: 700;
                font-size: 0.85rem;
              "
            >
              HD
            </div>
            <div class="country" th:text="${movie.country}">‚Äî</div>
          </div>

          <div class="hero-genres">
            <a
              th:each="g : ${movie.genres}"
              th:text="${g}"
              href="#"
              class="hero-genre-tag"
              >Th·ªÉ lo·∫°i</a
            >
          </div>

          <div class="hero-actions">
            <a th:href="@{'/movie/player/' + ${movie.id}}" class="btn-play"
              ><i class="fas fa-play"></i> Xem phim</a
            >
            <div class="action-buttons-group">
              <button
                th:attr="data-movie-id=${movie.id}"
                class="btn-circle hero-action-icon hover-like-btn"
                th:classappend="${isFavorite} ? 'active' : ''"
                onclick="toggleHoverLike(this)"
                title="Y√™u th√≠ch"
              >
                <i
                  th:class="${isFavorite} ? 'fas fa-heart' : 'far fa-heart'"
                  th:style="${isFavorite} ? 'color: #E50914' : ''"
                ></i>
              </button>
              <button
                class="btn-circle hero-action-icon hover-share-btn"
                th:data-movie-id="${movieId}"
                th:data-movie-title="${movie.title}"
                onclick="showShareModal(this)"
                title="Chia s·∫ª"
              >
                <i class="fas fa-share-alt"></i>
              </button>
              <div class="action-divider"></div>
              <button
                class="btn-circle volume-btn"
                id="volumeBtn"
                title="B·∫≠t/T·∫Øt ti·∫øng"
              >
                <i class="fas fa-volume-mute"></i>
              </button>
            </div>
          </div>
        </div>
      </div>
    </section>

    <div class="main-content-wrapper">
      <div class="content-primary">
        <div class="info-grid">
          <div class="info-item">
            <span class="info-label">ƒê·∫°o di·ªÖn</span>
            <span class="info-value" th:text="${movie.director}">‚Äî</span>
          </div>
          <div class="info-item">
            <span class="info-label">Qu·ªëc gia</span>
            <span class="info-value" th:text="${movie.country}">‚Äî</span>
          </div>
          <div class="info-item">
            <span class="info-label">Ph√°t h√†nh</span>
            <span class="info-value" th:text="${movie.releaseDate}">‚Äî</span>
          </div>
          <div class="info-item">
            <span class="info-label">Ng√¥n ng·ªØ</span>
            <span class="info-value" th:text="${movie.language}">‚Äî</span>
          </div>
          <div class="info-item">
            <span class="info-label">Ng√¢n s√°ch</span>
            <span class="info-value" th:text="${movie.budget}">‚Äî</span>
          </div>
          <div class="info-item">
            <span class="info-label">Doanh thu</span>
            <span class="info-value" th:text="${movie.revenue}">‚Äî</span>
          </div>
        </div>

        <div class="description-wrapper">
          <h3 class="section-title-small">N·ªôi dung phim</h3>
          <div class="description-content" id="descContent">
            <p
              class="description-text"
              id="descText"
              th:text="${movie.overview}"
            >
              N·ªôi dung phim ƒëang c·∫≠p nh·∫≠t...
            </p>
          </div>
          <button
            class="description-toggle-btn"
            id="descToggleBtn"
            onclick="toggleFPTDescription()"
          >
            <span>Xem th√™m</span> <i class="fas fa-chevron-down"></i>
          </button>
        </div>

        <div
          class="trailer-section"
          id="trailerSection"
          style="margin-bottom: 60px; display: none"
        >
          <h2
            class="section-title"
            style="
              font-size: 1.6rem;
              margin-bottom: 25px;
              display: flex;
              align-items: center;
              gap: 10px;
            "
          >
            <i class="fab fa-youtube" style="color: #e50914"></i> Trailer & H·∫≠u
            tr∆∞·ªùng
          </h2>

          <div
            class="trailer-grid"
            id="trailerGrid"
            style="display: none"
          ></div>

          <div
            class="fallback-message"
            id="trailerFallback"
            style="
              display: none;
              background: rgba(255, 255, 255, 0.03);
              border: 1px dashed rgba(255, 255, 255, 0.1);
              border-radius: 8px;
              padding: 40px 20px;
              text-align: center;
              color: #888;
            "
          >
            <i
              class="fas fa-video-slash"
              style="font-size: 2rem; margin-bottom: 15px"
            ></i>
            <p style="margin: 0; font-size: 1rem">
              Ch∆∞a c√≥ trailer ho·∫∑c video h·∫≠u tr∆∞·ªùng cho phim n√†y.
            </p>
          </div>
        </div>

        <div
          class="cast-section"
          th:if="${castList != null && !castList.isEmpty()}"
          style="margin-bottom: 60px"
        >
          <h2
            class="section-title"
            style="
              font-size: 1.6rem;
              margin-bottom: 30px;
              display: flex;
              align-items: center;
              gap: 10px;
            "
          >
            <i class="fas fa-users" style="color: #e50914"></i> Di·ªÖn vi√™n
          </h2>
          <div class="cast-grid" id="castGrid">
            <div
              th:each="p : ${castList}"
              class="cast-card"
              th:onclick="'window.location.href=\'/person/detail/' + ${p.id} + '\''"
            >
              <div class="cast-img-wrapper">
                <img
                  class="cast-img"
                  th:src="${p.avatar}"
                  th:alt="${p.name}"
                  onerror="this.src='/images/placeholder-user.jpg'"
                />
              </div>
              <div class="cast-info">
                <span class="cast-name" th:text="${p.name}">Actor Name</span>
                <span class="cast-role" th:text="${p.role}">Character</span>
              </div>
            </div>
          </div>
          <button
            id="castToggleBtn"
            class="cast-toggle-btn"
            th:if="${castList.size() > 6}"
            onclick="toggleCast()"
          >
            Xem t·∫•t c·∫£
          </button>
        </div>

        <div
          class="comments-wrapper"
          style="
            background: #121212;
            border-radius: 16px;
            padding: 30px;
            border: 1px solid #222;
            margin-top: 50px;
          "
        ></div>

        <div class="comments-header">
          <h3 class="comments-title">B√¨nh lu·∫≠n</h3>
          <div class="comments-tabs">
            <span class="comment-tab active">M·ªõi nh·∫•t</span>
            <span class="comment-tab">Nhi·ªÅu like nh·∫•t</span>
          </div>
        </div>

        <div class="comment-input-box">
          <div class="user-avatar">U</div>
          <textarea
            class="comment-input-area"
            placeholder="Vi·∫øt b√¨nh lu·∫≠n c·ªßa b·∫°n..."
            id="commentInput"
          ></textarea>
          <i
            class="fas fa-smile emoji-btn"
            onclick="toggleEmojiPicker(event)"
          ></i>

          <div class="emoji-picker-mock" id="emojiPicker" style="display: none">
            <span class="emoji-mock" onclick="addEmoji('üòÄ')">üòÄ</span>
            <span class="emoji-mock" onclick="addEmoji('üòÇ')">üòÇ</span>
            <span class="emoji-mock" onclick="addEmoji('üòç')">üòç</span>
            <span class="emoji-mock" onclick="addEmoji('ü§î')">ü§î</span>
            <span class="emoji-mock" onclick="addEmoji('üî•')">üî•</span>
            <span class="emoji-mock" onclick="addEmoji('üëç')">üëç</span>
            <span class="emoji-mock" onclick="addEmoji('üëé')">üëé</span>
            <span class="emoji-mock" onclick="addEmoji('üëè')">üëè</span>
          </div>
        </div>

        <div class="comment-list">
          <div class="comment-item">
            <div class="user-avatar" style="background: #007bff">V</div>
            <div class="comment-body">
              <span class="comment-author-name">VƒÉn A</span>
              <span class="comment-time">2 gi·ªù tr∆∞·ªõc</span>
              <p class="comment-content">
                Phim hay qu√°! K·ªπ x·∫£o m√£n nh√£n, n·ªôi dung c≈©ng r·∫•t s√¢u s·∫Øc. üî•
              </p>
              <div class="comment-actions">
                <span class="comment-action"
                  ><i class="fas fa-thumbs-up"></i> 15</span
                >
                <span class="comment-action"
                  ><i class="fas fa-thumbs-down"></i> 1</span
                >
                <span class="comment-action">Tr·∫£ l·ªùi</span>
              </div>
            </div>
          </div>
          <div class="comment-item">
            <div class="user-avatar" style="background: #28a745">T</div>
            <div class="comment-body">
              <span class="comment-author-name">Th·ªã B</span>
              <span class="comment-time">5 gi·ªù tr∆∞·ªõc</span>
              <p class="comment-content">
                C≈©ng b√¨nh th∆∞·ªùng, m√¨nh th·∫•y h∆°i nh√†m ch√°n ƒëo·∫°n gi·ªØa. ü§î
              </p>
              <div class="comment-actions">
                <span class="comment-action"
                  ><i class="fas fa-thumbs-up"></i> 3</span
                >
                <span class="comment-action"
                  ><i class="fas fa-thumbs-down"></i> 0</span
                >
                <span class="comment-action">Tr·∫£ l·ªùi</span>
              </div>
            </div>
          </div>
        </div>
      </div>

      <div class="content-sidebar">
        <div class="sidebar-header">Top Phim Xu H∆∞·ªõng</div>
        <div class="trending-list" id="trendingSidebar"></div>
      </div>
    </div>

    <section
      class="movies movie-list-section full-width-section"
      style="margin-top: 0; display: none"
      id="similarSection"
    >
      <div class="section-header" style="padding: 0; margin-bottom: 20px">
        <div class="section-title-wrapper">
          <h2 class="section-title" style="font-size: 1.6rem">
            üî• Phim t∆∞∆°ng t·ª±
          </h2>
        </div>
        <div class="carousel-nav">
          <button class="nav-btn prev-btn" id="similarPrevBtn">
            <i class="fas fa-chevron-left"></i>
          </button>
          <button class="nav-btn next-btn" id="similarNextBtn">
            <i class="fas fa-chevron-right"></i>
          </button>
        </div>
      </div>
      <div class="movie-carousel">
        <div class="movie-slider" id="similarSlider"></div>
      </div>
    </section>

    <section
      class="movies movie-list-section full-width-section"
      style="border: none; display: none"
      id="recommendSection"
    >
      <div class="section-header" style="padding: 0; margin-bottom: 20px">
        <div class="section-title-wrapper">
          <h2
            class="section-title"
            style="font-size: 1.6rem"
            id="recommendTitle"
            th:text="${recommendTitle ?: '‚ú® C√≥ th·ªÉ b·∫°n th√≠ch'}"
          >
            ‚ú® C√≥ th·ªÉ b·∫°n th√≠ch
          </h2>
        </div>
        <div class="carousel-nav">
          <button class="nav-btn prev-btn" id="recommendPrevBtn">
            <i class="fas fa-chevron-left"></i>
          </button>
          <button class="nav-btn next-btn" id="recommendNextBtn">
            <i class="fas fa-chevron-right"></i>
          </button>
        </div>
      </div>
      <div class="movie-carousel">
        <div class="movie-slider" id="recommendSlider"></div>
      </div>
    </section>

    <div th:replace="~{fragments/footer :: footer}"></div>
    <div th:replace="~{fragments/ai-chat :: ai-chat}"></div>
    <div th:replace="~{fragments/share-modal :: shareModal}"></div>

    <div
      id="globalTrailerModal"
      class="share-modal-overlay"
      style="z-index: 100000"
    >
      <div
        class="share-modal"
        style="
          width: 90vw;
          max-width: 1100px;
          aspect-ratio: 16/9;
          padding: 0;
          background: #000;
        "
      >
        <button
          class="share-modal-close"
          onclick="closeGlobalTrailer()"
          style="
            position: absolute;
            top: -15px;
            right: -15px;
            background: #000;
            border-radius: 50%;
            z-index: 10;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2rem;
          "
        >
          &times;
        </button>
        <iframe
          id="globalTrailerFrame"
          width="100%"
          height="100%"
          src=""
          frameborder="0"
          allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture"
          allowfullscreen
          style="border-radius: 8px"
        >
        </iframe>
      </div>
    </div>

    <script src="https://www.youtube.com/iframe_api"></script>
    <script th:src="@{/js/movie/ai-agent.js}" defer></script>
    <script src="/js/movie/share-modal.js"></script>
    <script src="/js/script.js"></script>
    <script src="/js/movie/movie-detail.js"></script>
    <script>
      function toggleHoverLike(button) {
        // ƒê·ªçc 'data-movie-id'
        const movieId = button.getAttribute("data-movie-id");

        if (!movieId) {
          console.error("Kh√¥ng t√¨m th·∫•y movie ID!");
          return;
        }

        // Th√™m hi·ªáu ·ª©ng loading t·∫°m th·ªùi ƒë·ªÉ tr√°nh click ƒë√∫p
        const icon = button.querySelector("i");
        const originalIconClass = icon.className;
        const originalColor = icon.style.color;
        icon.className = "fas fa-spinner fa-spin"; // Hi·ªÉn th·ªã spinner
        button.disabled = true; // Kh√≥a n√∫t

        // L·∫•y CSRF token n·∫øu c·∫ßn (hi·ªán t·∫°i controller kh√¥ng d√πng)
        const csrfToken = document
          .querySelector("meta[name='_csrf']")
          ?.getAttribute("content");
        const csrfHeader = document
          .querySelector("meta[name='_csrf_header']")
          ?.getAttribute("content");

        const headers = {
          "Content-Type": "application/json",
        };

        if (csrfHeader && csrfToken) {
          headers[csrfHeader] = csrfToken;
        }

        fetch(`/favorites/${movieId}`, {
          method: "POST",
          headers: headers,
          body: JSON.stringify({}),

          // Y√™u c·∫ßu tr√¨nh duy·ªát g·ª≠i k√®m cookie (ch·ª©a session)
          credentials: "include",
        })
          .then((response) => {
            if (response.status === 401 || response.status === 400) {
              // ƒê·∫£m b·∫£o ƒë·ªçc JSON ƒë·ªÉ l·∫•y status 'unauthorized'
              return response.json().then((data) => {
                if (data.status === "unauthorized") {
                  throw new Error("unauthorized");
                }
                throw new Error(data.message || "L·ªói server");
              });
            }
            if (!response.ok) {
              throw new Error("server_error");
            }
            return response.json(); // ƒê·ªçc JSON n·∫øu status 200 OK
          })
          .then((data) => {
            button.disabled = false;

            // X·ª≠ l√Ω JSON response: {status: "added"} ho·∫∑c {status: "removed"}
            const icon = button.querySelector("i");

            if (data.status === "added") {
              button.classList.add("active");
              icon.classList.remove("far", "fa-spinner", "fa-spin");
              icon.classList.add("fas", "fa-heart");
              icon.style.color = "#E50914";
              // T√πy ch·ªçn: hi·ªÉn th·ªã th√¥ng b√°o toast
              if (typeof window.showToast === "function")
                window.showToast(
                  "ƒê√£ th√™m v√†o danh s√°ch y√™u th√≠ch ‚ù§Ô∏è",
                  "success"
                );
            } else if (data.status === "removed") {
              button.classList.remove("active");
              icon.classList.remove("fas", "fa-spinner", "fa-spin");
              icon.classList.add("far", "fa-heart");
              icon.style.color = "";
              if (typeof window.showToast === "function")
                window.showToast(
                  "ƒê√£ x√≥a kh·ªèi danh s√°ch y√™u th√≠ch üíî",
                  "success"
                );
            }
          })
          .catch((error) => {
            button.disabled = false;
            console.error("Error:", error);

            // Ho√†n t√°c icon v·ªÅ tr·∫°ng th√°i tr∆∞·ªõc khi click (n·∫øu c√≥ l·ªói)
            if (icon) {
              icon.className = originalIconClass;
              icon.style.color = originalColor;
            }

            if (error.message === "unauthorized") {
              alert("B·∫°n c·∫ßn ƒëƒÉng nh·∫≠p ƒë·ªÉ th·ª±c hi·ªán ch·ª©c nƒÉng n√†y!");
            } else {
              alert(
                "Kh√¥ng th·ªÉ thay ƒë·ªïi tr·∫°ng th√°i y√™u th√≠ch! (L·ªói server). Vui l√≤ng th·ª≠ l·∫°i."
              );
            }
          });
      }
    </script>
  </body>
</html>
