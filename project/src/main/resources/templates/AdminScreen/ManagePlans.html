<!DOCTYPE html>
<html lang="vi">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin - Quản Lý Gói Dịch Vụ</title>
    <link rel="stylesheet" href="/css/ManageAccount.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        /* Tinh chỉnh cột hành động để nút bấm đẹp hơn */
        .action-buttons {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 8px; /* Khoảng cách giữa 2 nút */
        }
        
        .table-container table td button {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            padding: 6px 12px;
            white-space: nowrap; /* Không cho chữ xuống dòng */
        }

        .table-container table td button i {
            margin-right: 5px;
        }

        /* Badge riêng cho gói nổi bật */
        .badge-featured {
            background-color: #8e44ad; /* Màu tím cho nổi bật */
            color: white;
        }

        /* Responsive: Ẩn chữ trên nút khi màn hình nhỏ */
        @media (max-width: 1300px) {
            .table-container table td button span {
                display: none;
            }
            .table-container table td button i {
                margin-right: 0;
            }
        }
    </style>
</head>

<body>
    <div th:replace="~{fragments/admin-sidebar :: sidebar}"></div>

    <div class="main-content">
        <div class="header">
            <h1>Quản lý Gói Dịch Vụ</h1>
            <div class="header-actions">
                <div class="search-box">
                    <input type="text" placeholder="Tìm kiếm gói (tên, mô tả)..." id="searchInput">
                    <i class="fas fa-search"></i>
                </div>
                <button class="btn btn-primary" onclick="openModal('add')">
                    <i class="fas fa-plus"></i>
                    <span>Thêm gói mới</span>
                </button>
            </div>
        </div>

        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-card-header">
                    <span class="stat-card-title">Tổng số gói</span>
                    <div class="stat-icon blue">
                        <i class="fas fa-box-open"></i>
                    </div>
                </div>
                <div class="stat-value" id="statTotal">0</div>
                <div class="stat-change">
                    <span style="font-size: 0.9rem; color: #aaa;">Gói hiện có trong hệ thống</span>
                </div>
            </div>

            <div class="stat-card">
                <div class="stat-card-header">
                    <span class="stat-card-title">Đang hoạt động</span>
                    <div class="stat-icon green">
                        <i class="fas fa-check-circle"></i>
                    </div>
                </div>
                <div class="stat-value" id="statActive">0</div>
                <div class="stat-change">
                    <span style="font-size: 0.9rem; color: #aaa;">Gói khả dụng đăng ký</span>
                </div>
            </div>

            <div class="stat-card">
                <div class="stat-card-header">
                    <span class="stat-card-title">Gói Nổi Bật</span>
                    <div class="stat-icon red"> <i class="fas fa-star"></i>
                    </div>
                </div>
                <div class="stat-value" id="statFeatured">0</div>
                <div class="stat-change">
                    <span style="font-size: 0.9rem; color: #aaa;">Gói được ghim trang chủ</span>
                </div>
            </div>
        </div>

        <div class="table-container">
            <div class="table-header">
                <span class="table-title">Danh sách gói dịch vụ</span>
                <div class="filter-group">
                    <select class="filter-select" id="statusFilter" onchange="applySearch()">
                        <option value="">Tất cả trạng thái</option>
                        <option value="true">Hoạt động</option>
                        <option value="false">Không hoạt động</option>
                    </select>
                </div>
            </div>
            <table>
                <thead>
                    <tr>
                        <th style="width: 18%;">Tên Gói</th>
                        <th style="width: 12%;">Giá (VND)</th>
                        <th style="width: 32%;">Mô Tả Chi Tiết</th>
                        <th style="width: 10%;">Nổi Bật</th>
                        <th style="width: 12%;">Trạng Thái</th>
                        <th style="width: 16%; text-align: center;">Hành động</th>
                    </tr>
                </thead>
                <tbody id="planTableBody">
                    </tbody>
            </table>
            
            <div id="emptyState" class="empty-state" style="display: none;">
                <i class="fas fa-box-open" style="font-size: 48px; color: #ccc; margin-bottom: 15px;"></i>
                <h3>Không tìm thấy gói dịch vụ nào</h3>
                <p>Thử thay đổi bộ lọc hoặc thêm gói mới.</p>
            </div>
        </div>
    </div>

    <div class="modal" id="planModal">
        <div class="modal-content">
            <div class="modal-header">
                <span class="modal-title" id="modalTitle">Thêm gói mới</span>
                <button class="close-modal" onclick="closeModal()"><i class="fas fa-times"></i></button>
            </div>
            <div class="modal-body">
                <form id="planForm">
                    <input type="hidden" id="planId">
                    <div class="form-group">
                        <label for="planName">Tên Gói</label>
                        <input type="text" id="planName" required placeholder="Ví dụ: Gói Cơ Bản">
                    </div>
                    <div class="form-group">
                        <label for="price">Giá (VND)</label>
                        <input type="number" id="price" required min="0" placeholder="Ví dụ: 70000">
                    </div>
                    
                    <div class="form-group">
                        <label for="duration">Thời hạn (Tháng)</label>
                        <input type="number" id="duration" required min="1" placeholder="Ví dụ: 1 (cho 1 tháng), 12 (cho 1 năm)">
                        <small style="color: #aaa; font-style: italic;">*Hệ thống sẽ tự động thêm quyền lợi: Không quảng cáo, Thư viện đầy đủ.</small>
                    </div>

                    <div class="form-group">
                        <label for="isFeatured">Đánh dấu Nổi Bật</label>
                        <select id="isFeatured" required>
                            <option value="false">Không</option>
                            <option value="true">Có (Hiện 'Phổ biến')</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="status">Trạng Thái</label>
                        <select id="status" required>
                            <option value="true">Hoạt động</option>
                            <option value="false">Không hoạt động</option>
                        </select>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeModal()">Hủy</button>
                <button class="btn btn-primary" onclick="savePlan()">
                    <i class="fas fa-save"></i> Lưu dữ liệu
                </button>
            </div>
        </div>
    </div>

    <div class="modal" id="deleteConfirmModal">
        <div class="modal-content" style="max-width: 450px;">
            <div class="modal-header">
                <span class="modal-title" style="color: #dc3545;"><i class="fas fa-exclamation-triangle"></i> Xác nhận Vô Hiệu Hóa</span>
                <button class="close-modal" onclick="closeDeleteModal()"><i class="fas fa-times"></i></button>
            </div>
            <div class="modal-body">
                <p>Bạn có chắc muốn vô hiệu hóa gói <strong id="planNameToDelete" style="color: #fff;"></strong>?</p>
                <div style="background: rgba(220, 53, 69, 0.1); padding: 10px; border-radius: 6px; margin-top: 15px; border-left: 3px solid #dc3545;">
                    <p style="color: #e0e0e0; font-size: 13px; margin: 0;">
                        <i class="fas fa-info-circle"></i> Hành động này sẽ ẩn gói khỏi trang đăng ký, nhưng giữ lại lịch sử giao dịch cũ.
                    </p>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeDeleteModal()">Hủy</button>
                <button class="btn btn-danger" onclick="confirmDelete()">
                    <i class="fas fa-ban"></i> Vô hiệu hóa ngay
                </button>
            </div>
        </div>
    </div>

    <div class="toast" id="toast" style="display: none;">
        <i class="toast-icon"></i>
        <span id="toastMessage"></span>
    </div>

    <script>
        let currentMode = 'add';
        let currentId = null;
        let allPlans = [];
        let idToDelete = null;

        document.addEventListener('DOMContentLoaded', () => {
            loadPlans();
            document.getElementById('searchInput').addEventListener('input', applySearch);
        });

        async function loadPlans() {
            try {
                const res = await fetch('/api/admin/plans');
                if (!res.ok) throw new Error('Failed to load plans');
                allPlans = await res.json();
                
                // Cập nhật thống kê (Stats Cards)
                updateStats(allPlans);
                
                applySearch();
            } catch (err) {
                console.error('Load plans error:', err);
                showToast('error', 'Không thể tải danh sách gói.');
            }
        }
        
        function updateStats(plans) {
            // Tính toán số liệu để hiển thị lên Dashboard
            const total = plans.length;
            const active = plans.filter(p => p.status === true).length;
            const featured = plans.filter(p => p.featured === true).length;

            document.getElementById('statTotal').textContent = total;
            document.getElementById('statActive').textContent = active;
            document.getElementById('statFeatured').textContent = featured;
        }

        function applySearch() {
            const statusFilter = document.getElementById('statusFilter').value;
            const searchFilter = document.getElementById('searchInput').value.toLowerCase();

            const filteredPlans = allPlans.filter(plan => {
                const matchesStatus = (statusFilter === "") || (String(plan.status) === statusFilter);
                const matchesSearch = (plan.planName.toLowerCase().includes(searchFilter)) ||
                                      (plan.description.toLowerCase().includes(searchFilter));
                return matchesStatus && matchesSearch;
            });
            renderTable(filteredPlans);
        }

        function renderTable(plans) {
            const tbody = document.getElementById('planTableBody');
            tbody.innerHTML = ''; 

            document.getElementById('emptyState').style.display = plans.length === 0 ? 'block' : 'none';

            plans.forEach(plan => {
                const tr = document.createElement('tr');
                
                tr.innerHTML = `
                    <td><strong>${escapeHtml(plan.planName)}</strong></td>
                    <td style="color: #4cd137;">${new Intl.NumberFormat('vi-VN').format(plan.price)} ₫</td>
                    <td style="color: #aaa;" title="${escapeHtml(plan.description)}">${escapeHtml(plan.description)}</td>
                    <td>${renderFeaturedBadge(plan.featured)}</td>
                    <td>${renderStatusBadge(plan.status)}</td>
                    <td>
                        <div class="action-buttons">
                            <button class="btn btn-edit" onclick="openModal('edit', ${plan.planID})" title="Chỉnh sửa">
                                <i class="fas fa-edit"></i> <span>Sửa</span>
                            </button>
                            <button class="btn btn-danger" onclick="openDeleteModal(${plan.planID}, '${escapeHtml(plan.planName)}')" title="Vô hiệu hóa">
                                <i class="fas fa-trash"></i> <span>Xóa</span>
                            </button>
                        </div>
                    </td>
                `;
                tbody.appendChild(tr);
            });
        }
        
        function renderStatusBadge(status) {
             return status 
                ? '<span class="badge badge-active">Hoạt động</span>' 
                : '<span class="badge badge-inactive">Ngừng KD</span>';
        }

        function renderFeaturedBadge(isFeatured) {
             return isFeatured 
                ? '<span class="badge badge-featured"><i class="fas fa-star" style="font-size:10px; margin-right:3px;"></i> Nổi bật</span>'
                : '<span class="badge">-</span>';
        }

        function escapeHtml(s) {
            if (!s) return '';
            return String(s).replace(/[&<>"']/g, c => ({ '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#39;' }[c]));
        }

        function openModal(mode, id = null) {
    currentMode = mode;
    currentId = id;
    const modal = document.getElementById('planModal');
    const title = document.getElementById('modalTitle');
    document.getElementById('planForm').reset();

    if (mode === 'add') {
        title.textContent = 'Thêm gói mới';
        document.getElementById('isFeatured').value = 'false';
        document.getElementById('status').value = 'true';
        document.getElementById('duration').value = '30'; // Mặc định 30 ngày
    } else {
        title.textContent = 'Cập nhật gói';
        
        fetch(`/api/admin/plans/${id}`)
            .then(r => {
                if (!r.ok) throw new Error('Không tìm thấy gói');
                return r.json();
            })
            .then(plan => {
                document.getElementById('planId').value = plan.planID;
                document.getElementById('planName').value = plan.planName;
                document.getElementById('price').value = plan.price;
                
                // LOAD DURATION TRỰC TIẾP TỪ DB (Không parse string nữa)
                document.getElementById('duration').value = plan.duration;

                document.getElementById('isFeatured').value = String(plan.featured);
                document.getElementById('status').value = String(plan.status);
            })
            .catch(err => {
                showToast('error', 'Không thể tải thông tin gói');
                console.error(err);
            });
    }
    modal.classList.add('active');
}

        function closeModal() {
            document.getElementById('planModal').classList.remove('active');
        }

        async function savePlan() {
            // Validate
            const name = document.getElementById('planName').value.trim();
            const dur = document.getElementById('duration').value;

            if (!name || !dur) {
                showToast('error', 'Vui lòng điền tên gói và thời hạn');
                return;
            }

            
            
            // Payload mới gọn gàng hơn
            const payload = {
                planName: name,
                price: parseFloat(document.getElementById('price').value),
                duration: parseInt(dur), // Gửi số nguyên
                // description: KHÔNG CẦN GỬI, BACKEND TỰ SINH
                featured: document.getElementById('isFeatured').value === 'true',
                status: document.getElementById('status').value === 'true'
            };

            try {
                let url = '/api/admin/plans';
                let method = 'POST';

                if (currentMode === 'edit') {
                    url = `/api/admin/plans/${currentId}`;
                    method = 'PUT';
                }

                const res = await fetch(url, {
                    method: method,
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                if (!res.ok) {
                    const errorData = await res.json().catch(() => ({}));
                    throw new Error(errorData.message || 'Lỗi server');
                }

                showToast('success', currentMode === 'add' ? 'Thêm gói thành công!' : 'Đã cập nhật gói!');
                closeModal();
                loadPlans(); 
            } catch (err) {
                console.error(err);
                showToast('error', 'Lưu thất bại: ' + (err.message || ''));
            }
        }
        
        function openDeleteModal(id, name) {
            idToDelete = id;
            document.getElementById('planNameToDelete').textContent = name;
            document.getElementById('deleteConfirmModal').classList.add('active');
        }

        function closeDeleteModal() {
            document.getElementById('deleteConfirmModal').classList.remove('active');
            idToDelete = null;
        }

        async function confirmDelete() {
            if (idToDelete === null) return;

            try {
                // Gọi API deactivate như yêu cầu
                const res = await fetch(`/api/admin/plans/${idToDelete}/deactivate`, {
                    method: 'PUT'
                });

                if (!res.ok) throw new Error('Không thể vô hiệu hóa gói');
                
                showToast('success', 'Đã vô hiệu hóa gói thành công!');
                closeDeleteModal();
                loadPlans();
                
            } catch (err) {
                console.error(err);
                showToast('error', 'Lỗi: ' + err.message);
                closeDeleteModal();
            }
        }

        function showToast(type, message) {
            const toast = document.getElementById('toast');
            const icon = toast.querySelector('.toast-icon');
            const msg = document.getElementById('toastMessage');

            toast.className = `toast ${type}`;
            if (type === 'success') icon.className = 'toast-icon fas fa-check-circle';
            if (type === 'error') icon.className = 'toast-icon fas fa-exclamation-circle';
            msg.textContent = message;

            toast.style.display = 'flex';
            setTimeout(() => { toast.style.display = 'none'; }, 3000);
        }
    </script>
</body>
</html>