<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title th:text="${query != null ? 'T√¨m ki·∫øm: ' + query : 'T√¨m ki·∫øm - FFilm'}">T√¨m ki·∫øm</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <link rel="stylesheet" href="/css/footer.css">
    <link rel="stylesheet" th:href="@{/css/hover-card.css}">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" th:href="@{/css/ai-agent.css}">
    <link rel="stylesheet" href="/css/style.css" />
    
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { 
            font-family: 'Segoe UI', system-ui, -apple-system, sans-serif; 
            background: #141414; 
            color: #fff; 
            min-height: 100vh;
        }

        .search-page-container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 100px 50px 80px;
        }

        /* Hero Section */
        .search-hero {
            text-align: center;
            margin-bottom: 50px;
        }

        .search-hero h1 {
            font-size: 2.5rem;
            font-weight: 800;
            margin-bottom: 15px;
            background: linear-gradient(135deg, #e50914 0%, #ff6b6b 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .search-hero .query-highlight {
            color: #e50914;
        }

        .search-hero p {
            font-size: 1.1rem;
            color: rgba(255,255,255,0.7);
            margin-bottom: 30px;
        }

        /* Search Box */
        .search-main-box {
            max-width: 700px;
            margin: 0 auto 40px;
            position: relative;
        }

        .search-main-input {
            width: 100%;
            padding: 18px 140px 18px 20px;
            background: rgba(255,255,255,0.05);
            border: 2px solid rgba(255,255,255,0.1);
            border-radius: 12px;
            color: white;
            font-size: 1.1rem;
            transition: all 0.3s;
        }

        .search-main-input:focus {
            outline: none;
            border-color: #e50914;
            background: rgba(255,255,255,0.08);
            box-shadow: 0 0 20px rgba(229,9,20,0.3);
        }

        .search-main-input::placeholder {
            color: rgba(255,255,255,0.4);
        }

        /* live suggestions */
        .live-suggestions { display: none; }
        .live-suggestions.show { display: block; }
        .suggestion-item { display:flex; gap:10px; padding:8px; align-items:center; cursor:pointer; border-radius:8px; }
        .suggestion-item img { width:46px; height:64px; object-fit:cover; border-radius:4px; }
        .suggestion-item:hover { background: rgba(255,255,255,0.03); }
        .suggestion-info { color: rgba(255,255,255,0.9); font-size:0.95rem; }
        .suggestion-title { font-weight:600; }
        .suggestion-meta { font-size:0.85rem; color: rgba(255,255,255,0.6); }


        /* ============ Filters Panel ============ */
        .filters-toggle {
            position: absolute;
            top: 50%;
            right: -30px;              
            transform: translateY(-50%);
            opacity: 0;
            pointer-events: none;
            background: none;
            border: none;
            color: rgba(255,255,255,0.85);
            font-size: 1.05rem;
            cursor: pointer;
            padding: 8px;
            border-radius: 50%;
            transition: all .18s ease;
            z-index: 13000 !important;           /* n·∫±m tr√™n suggestions */
            display: inline-flex;
            align-items: center;
            justify-content: center;
        }

        .search-box:focus-within .filters-toggle,
        .filters-toggle.visible,
        .search-input.active ~ .filters-toggle {
            opacity: 1;
            pointer-events: auto;
        }

        .filters-toggle {
            min-width: 40px;
            min-height: 40px;
            padding: 8px;
        }

        .filters-toggle:hover {
            color: #e50914;
            background: rgba(255,255,255,0.1);
        }

        .filters-toggle.active {
            color: #e50914;
        }

        @media (max-width: 760px) {
            .filters-toggle {
            right: -36px;
            font-size: 1rem;
            }
            .search-input.active { padding-right: 96px; }
        }

        .filters-panel {
            position: fixed;
            top: 70px;
            right: 0;
            width: 320px;
            max-height: calc(100vh - 90px);
            background: rgba(20,20,20,0.98);
            border: 1px solid rgba(255,255,255,0.1);
            border-radius: 12px 0 0 12px;
            box-shadow: -4px 0 20px rgba(0,0,0,0.5);
            z-index: 9998;
            transform: translateX(100%);
            transition: transform 0.3s ease;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }

        .filters-panel.show {
            transform: translateX(0);
        }

        .filters-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 16px 20px;
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }

        .filters-header h3 {
            font-size: 1.1rem;
            font-weight: 600;
            margin: 0;
        }

        .filters-close {
            background: none;
            border: none;
            color: rgba(255,255,255,0.7);
            font-size: 1.2rem;
            cursor: pointer;
            padding: 4px;
            border-radius: 4px;
            transition: all 0.2s;
        }

        .filters-close:hover {
            color: #e50914;
            background: rgba(255,255,255,0.1);
        }

        .filters-body {
            flex: 1;
            overflow-y: auto;
            padding: 16px 20px;
        }

        .filter-group {
            margin-bottom: 24px;
        }

        .filter-label {
            display: block;
            font-size: 0.9rem;
            font-weight: 600;
            color: rgba(255,255,255,0.9);
            margin-bottom: 10px;
        }

        /* Quick Filters */
        .quick-filters {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }

        .quick-filter-chip {
            padding: 6px 12px;
            background: rgba(255,255,255,0.05);
            border: 1px solid rgba(255,255,255,0.1);
            border-radius: 20px;
            color: rgba(255,255,255,0.8);
            font-size: 0.85rem;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .quick-filter-chip:hover {
            background: rgba(255,255,255,0.1);
            border-color: rgba(255,255,255,0.2);
        }

        .quick-filter-chip.active {
            background: #e50914;
            border-color: #e50914;
            color: white;
        }

        /* Genre Filters */
        .genre-filters {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
        }

        .genre-chip {
            padding: 6px 12px;
            background: rgba(255,255,255,0.05);
            border: 1px solid rgba(255,255,255,0.1);
            border-radius: 16px;
            color: rgba(255,255,255,0.8);
            font-size: 0.85rem;
            cursor: pointer;
            transition: all 0.2s;
        }

        .genre-chip:hover {
            background: rgba(255,255,255,0.1);
            border-color: rgba(255,255,255,0.2);
        }

        .genre-chip.active {
            background: #e50914;
            border-color: #e50914;
            color: white;
        }

        /* Year Filter */
        .year-filter {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .year-filter input {
            flex: 1;
            padding: 8px 12px;
            background: rgba(255,255,255,0.05);
            border: 1px solid rgba(255,255,255,0.1);
            border-radius: 6px;
            color: white;
            font-size: 0.9rem;
        }

        .year-filter input::placeholder {
            color: rgba(255,255,255,0.4);
        }

        .year-filter span {
            color: rgba(255,255,255,0.5);
        }

        /* Rating Filter */
        .rating-filter {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .rating-filter input[type="range"] {
            flex: 1;
            height: 4px;
            background: rgba(255,255,255,0.1);
            border-radius: 2px;
            outline: none;
            -webkit-appearance: none;
        }

        .rating-filter input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 16px;
            height: 16px;
            background: #e50914;
            border-radius: 50%;
            cursor: pointer;
        }

        .rating-filter input[type="range"]::-moz-range-thumb {
            width: 16px;
            height: 16px;
            background: #e50914;
            border-radius: 50%;
            cursor: pointer;
            border: none;
        }

        .rating-value {
            min-width: 32px;
            font-weight: 600;
            color: #e50914;
        }


        /* Action Buttons */
        .search-actions {
            position: absolute;
            right: 10px;
            top: 50%;
            transform: translateY(-50%);
            display: flex;
            gap: 8px;
        }

        .search-action-btn {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            border: none;
            background: rgba(255,255,255,0.1);
            color: rgba(255,255,255,0.8);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
        }

        .search-action-btn:hover {
            background: #e50914;
            color: white;
            transform: scale(1.1);
        }

        .search-action-btn.ai {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .search-action-btn.voice.recording {
            background: #e50914;
        }

        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.1); }
        }

        

        /* Pagination */
        .pagination {
            display: flex;
            justify-content: center;
            gap: 8px;
            margin: 40px 0;
        }

        .page-btn {
            min-width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: rgba(255,255,255,0.05);
            border: 1px solid rgba(255,255,255,0.2);
            border-radius: 6px;
            color: white;
            cursor: pointer;
            transition: all 0.2s;
        }

        .page-btn:hover:not(.active):not(.disabled) {
            background: rgba(255,255,255,0.1);
        }

        .page-btn.active {
            background: #e50914;
            border-color: #e50914;
        }

        .page-btn.disabled {
            opacity: 0.3;
            cursor: not-allowed;
        }

        /* B·ªî SUNG L·∫†I ƒê·ªäNH NGHƒ®A GRID CHO K·∫æT QU·∫¢ T√åM KI·∫æM */
        .results-grid {
            display: grid;
            /* ƒê√¢y l√† logic "5 c·ªôt" c·∫≠u mu·ªën: 
            T·ª± ƒë·ªông l·∫•p ƒë·∫ßy, m·ªói c·ªôt t·ªëi thi·ªÉu 200px, t·ªëi ƒëa 1fr (chia ƒë·ªÅu).
            Tr√™n container 1300px, n√≥ s·∫Ω t·ª± ƒë·ªông chia 5 c·ªôt.
            */
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 15px; /* Gi·ªëng gap c·ªßa carousel */
            margin-bottom: 40px; /* Th√™m kho·∫£ng c√°ch v·ªõi pagination */
        }

        /* K·∫ø th·ª´a responsive c≈© */
        @media (max-width: 768px) {
            .results-grid {
                grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
                gap: 16px;
            }
        }

        .movies.movie-list-section {
            position: relative;
            z-index: 1;
            left: 0;
            /* K√©o section ra s√°t m√©p tr√°i container cha (do container cha ƒëang padding 50px) */
            margin-left: -150px;
            /* B√π l·∫°i chi·ªÅu r·ªông ƒë√£ b·ªã k√©o */
            width: calc(100% + 100px);
            /* Padding trong ƒë·ªÉ n·ªôi dung th·∫≥ng h√†ng l·∫°i v·ªõi header */
            padding: 40px 50px;
        }
        /* Responsive cho m√†n h√¨nh nh·ªè */
        @media (max-width: 768px) {
            .movies.movie-list-section {
                margin-left: -20px;
                width: calc(100% + 40px);
                padding: 30px 20px;
            }
        }

        .fire-icon {
            font-size: 2rem;
            animation: fireFlicker 1.5s infinite;
        }

        @keyframes fireFlicker {
            0%, 100% { transform: scale(1); opacity: 1; }
            50% { transform: scale(1.1); opacity: 0.8; }
        }

        /* Empty State */
        .empty-state {
            text-align: center;
            padding: 80px 20px;
        }

        .empty-icon {
            font-size: 4rem;
            color: rgba(255,255,255,0.15);
            margin-bottom: 20px;
        }

        .btn-back {
            padding: 12px 24px;
            background: #e50914;
            color: white;
            border-radius: 8px;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        /* Responsive */
        @media (max-width: 768px) {
            .search-page-container {
                padding: 80px 20px 60px;
            }

            .search-hero h1 {
                font-size: 2rem;
            }

            .results-grid {
                grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            }
        }

        /* ===== UI/UX IMPROVEMENTS CHO SEARCH PAGE ===== */

        /* Fix: CƒÉn l·ªÅ tr√°i cho results grid gi·ªëng index */
        .results-section {
            padding-left: 50px; /* ƒê·ªìng b·ªô v·ªõi index */
        }

        @media (max-width: 768px) {
            .results-section {
                padding-left: 20px;
            }
        }

        /* 2. Better Search Input */
        .search-main-input {
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .search-main-input:focus {
            transform: translateY(-2px);
            box-shadow: 0 8px 30px rgba(229, 9, 20, 0.25);
        }

        /* 3. Enhanced Pagination */
        .page-btn {
            transition: all 0.2s ease;
        }

        .page-btn:hover:not(.active):not(.disabled) {
            background: rgba(229, 9, 20, 0.2);
            transform: translateY(-2px);
        }

        .page-btn.active {
            box-shadow: 0 4px 15px rgba(229, 9, 20, 0.4);
        }

        /* 4. Loading Animation for Movie Cards */
        @keyframes shimmer {
            0% { background-position: -200px 0; }
            100% { background-position: 200px 0; }
        }

        .movie-card.loading {
            background: linear-gradient(
                90deg,
                rgba(255,255,255,0.05) 0%,
                rgba(255,255,255,0.1) 50%,
                rgba(255,255,255,0.05) 100%
            );
            background-size: 200px 100%;
            animation: shimmer 1.5s infinite;
        }

        /* 5. Empty State Enhancement */
        .empty-state {
            animation: fadeIn 0.5s ease-in;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        

        /* 7. Better Suggestion Chips */
        .suggestion-chip {
            transition: all 0.2s ease;
            cursor: pointer;
            padding: 8px 16px;
            background: rgba(255,255,255,0.05);
            border: 1px solid rgba(255,255,255,0.1);
            border-radius: 20px;
            color: white;
            font-size: 0.9rem;
        }

        .suggestion-chip:hover {
            background: rgba(229, 9, 20, 0.2);
            border-color: #e50914;
            transform: translateY(-2px);
        }

        /* 8. Smooth Scroll Behavior */
        html {
            scroll-behavior: smooth;
        }

        /* 9. Better Focus States */
        *:focus-visible {
            outline: 2px solid #e50914;
            outline-offset: 2px;
        }

        /* 10. Responsive Improvements */
        @media (max-width: 768px) {
            .search-page-container {
                padding: 70px 15px 40px;
            }
            
            .search-hero h1 {
                font-size: 1.8rem;
            }
            
            .results-grid {
                grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
                gap: 16px;
            }
            
            .movie-card:hover {
                transform: scale(1.02);
            }
        }
    </style>
</head>
<body>
    <div th:replace="fragments/header :: header"></div>

    <div class="search-page-container">
        <!-- Hero Section -->
        <div class="search-hero">
            <h1 th:if="${query == null}">T√¨m ki·∫øm phim y√™u th√≠ch</h1>
            <h1 th:if="${query != null}">
                K·∫øt qu·∫£ cho "<span class="query-highlight" th:text="${query}"></span>"
            </h1>
            <p th:if="${query == null}">Kh√°m ph√° h√†ng ng√†n b·ªô phim, series v√† anime h·∫•p d·∫´n</p>
            <p th:if="${query != null && totalResults != null}">
                T√¨m th·∫•y <strong th:text="${totalResults}"></strong> k·∫øt qu·∫£
            </p>
        </div>

        <!-- Main Search Box -->
        <div class="search-main-box">
            <form id="searchForm" onsubmit="return false;">
                <input 
                    type="text" 
                    id="mainSearchInput"
                    class="search-main-input" 
                    placeholder="Nh·∫≠p t√™n phim, di·ªÖn vi√™n, ƒë·∫°o di·ªÖn..."
                    autocomplete="off"
                    autofocus
                    th:value="${query}"
                />
                
                <div class="search-actions">
                    <button type="button" class="search-action-btn voice" id="voiceSearchPageBtn" title="Gi·ªçng n√≥i">
                        <i class="fas fa-microphone"></i>
                    </button>
                    <button type="button" class="search-action-btn" id="filterPageBtn" title="B·ªô l·ªçc">
                        <i class="fas fa-filter"></i>
                    </button>
                    <button type="button" class="search-action-btn ai" id="aiSearchPageBtn" title="AI">
                        <i class="fas fa-wand-magic-sparkles"></i>
                    </button>
                </div>
            </form>

            <div id="filtersPanel" class="filters-panel" hidden>
            <div class="filters-header">
              <h3>L·ªçc k·∫øt qu·∫£</h3>
              <button class="filters-close" id="filtersClose">
                <i class="fas fa-times"></i>
              </button>
            </div>
            
            <div class="filters-body">
              <!-- Quick Filters -->
              <div class="filter-group">
                <label class="filter-label">Nhanh</label>
                <div class="quick-filters">
                  <button class="quick-filter-chip" data-filter="trending">
                    <i class="fas fa-fire"></i> Th·ªãnh h√†nh
                  </button>
                  <button class="quick-filter-chip" data-filter="new">
                    <i class="fas fa-star"></i> M·ªõi nh·∫•t
                  </button>
                  <button class="quick-filter-chip" data-filter="top-rated">
                    <i class="fas fa-trophy"></i> ƒê√°nh gi√° cao
                  </button>
                </div>
              </div>
              
              <!-- Genre Filter -->
              <div class="filter-group">
                <label class="filter-label">Th·ªÉ lo·∫°i</label>
                <div class="genre-filters" id="genreFilters">
                  <!-- Will be populated by JS -->
                </div>
              </div>
              
              <!-- Year Filter -->
              <div class="filter-group">
                <label class="filter-label">NƒÉm ph√°t h√†nh</label>
                <div class="year-filter">
                  <input type="number" id="yearFrom" placeholder="T·ª´ nƒÉm" min="1900" max="2025">
                  <span>-</span>
                  <input type="number" id="yearTo" placeholder="ƒê·∫øn nƒÉm" min="1900" max="2025">
                </div>
              </div>
              
              <!-- Rating Filter -->
              <div class="filter-group">
                <label class="filter-label">ƒê√°nh gi√° t·ªëi thi·ªÉu</label>
                <div class="rating-filter">
                  <input type="range" id="minRating" min="0" max="10" step="0.5" value="0">
                  <span class="rating-value" id="ratingValue">0.0</span>
                </div>
              </div>
            </div>
            
            <div class="filters-footer">
              <button class="btn-clear-filters" id="clearFilters">X√≥a b·ªô l·ªçc</button>
              <button class="btn-apply-filters" id="applyFilters">√Åp d·ª•ng</button>
            </div>
          </div>

            <div id="liveSuggestions" class="live-suggestions" style="display:none; position:absolute; left:0; right:0; top:110%; background:rgba(20,20,20,0.95); border:1px solid rgba(255,255,255,0.06); border-radius:10px; padding:8px; z-index:80; max-height: 450px; overflow-y: auto;">
                <!-- JS s·∫Ω render c√°c suggestion items v√†o ƒë√¢y -->
            </div>
        </div>        

        <!-- Results Section (shown when there's a query) -->
        <div class="results-section" th:if="${query != null}" id="resultsSection">
            <div class="results-grid" id="resultsGrid">
                <div th:each="movie : ${searchResults}" 
                    class="movie-card" 
                    th:attr="data-movie-id=${movie.id}">
                    
                    <div class="movie-poster">
                        <img th:src="${movie.poster}" 
                            th:alt="${movie.title}"
                            onerror="this.src='/images/placeholder.jpg'">
                    </div>
                    
                    <div class="movie-info">
                        <h3 th:text="${movie.title}">Movie Title</h3>
                        <p class="movie-rating">
                            ‚≠ê <span th:text="${movie.rating}">8.5</span>
                        </p>
                    </div>
                    
                    <div th:replace="~{fragments/hover-card :: hoverCard(${movie})}"></div>
                </div>
            </div>

            <div class="pagination" 
                th:if="${query != null && totalPages != null && totalPages > 1}" 
                id="pagination"
                th:attr="data-current-page=${currentPage},data-total-pages=${totalPages}">
                <!-- JavaScript s·∫Ω render pagination buttons -->
            </div>
        </div>

        <!-- Empty State -->
        <div class="empty-state" th:if="${query != null && searchResults.isEmpty()}" id="emptyState">
            <div class="empty-icon"><i class="fas fa-search"></i></div>
            <h2>Kh√¥ng t√¨m th·∫•y k·∫øt qu·∫£</h2>
            <p>Kh√¥ng c√≥ k·∫øt qu·∫£ n√†o cho t·ª´ kh√≥a c·ªßa b·∫°n</p>
            <a href="/search" class="btn-back"><i class="fas fa-arrow-left"></i> Th·ª≠ l·∫°i</a>
        </div>

        <!-- Related Movies (shown after search, before AI suggestions) -->
        <section class="movies movie-list-section" th:if="${!relatedMovies.isEmpty()}" id="relatedSection">
            
            <div class="section-header">
                <div class="section-title-wrapper">
                    <h2 class="section-title" style="display: flex; align-items: center; gap: 10px;">
                        <i class="fas fa-film" style="color: #e50914;"></i>
                        Phim li√™n quan
                    </h2>
                </div>
                <div class="carousel-nav">
                    <button class="nav-btn prev-btn" id="relatedCarouselPrev">
                        <i class="fas fa-chevron-left"></i>
                    </button>
                    <button class="nav-btn next-btn" id="relatedCarouselNext">
                        <i class="fas fa-chevron-right"></i>
                    </button>
                </div>
            </div>
            <div class="movie-carousel">
                <div class="movie-slider" id="relatedCarousel">
                    <div th:each="movie : ${relatedMovies}" 
                        class="movie-card" 
                        th:attr="data-movie-id=${movie.id}">
                        
                        <div class="movie-poster">
                            <img th:src="${movie.poster}" 
                                th:alt="${movie.title}"
                                onerror="this.src='/images/placeholder.jpg'">
                        </div>
                        <div class="movie-info">
                            <h3 th:text="${movie.title}">Movie Title</h3>
                            <p class="movie-rating">
                                ‚≠ê <span th:text="${movie.rating}">8.5</span>
                            </p>
                        </div>
                        <div th:replace="~{fragments/hover-card :: hoverCard(${movie})}"></div>
                    </div>
                </div>
            </div>
        </section>

        <!-- AI Suggestions (shown after search) -->
        <section class="movies movie-list-section" th:if="${query != null && !aiSuggestions.isEmpty()}" id="aiSuggestionsSection">
    
            <div class="section-header">
                <div class="section-title-wrapper">
                    <h2 class="section-title" style="display: flex; align-items: center; gap: 10px;">
                        <i class="fas fa-wand-magic-sparkles" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); -webkit-background-clip: text; -webkit-text-fill-color: transparent;"></i>
                        G·ª£i √Ω t·ª´ AI
                    </h2>
                </div>
                
                <div class="carousel-nav">
                    <button class="nav-btn prev-btn" id="aiCarouselPrev">
                        <i class="fas fa-chevron-left"></i>
                    </button>
                    <button class="nav-btn next-btn" id="aiCarouselNext">
                        <i class="fas fa-chevron-right"></i>
                    </button>
                </div>
            </div>
            
            <div class="movie-carousel">
                <div class="movie-slider" id="aiCarousel">
                    
                    <div th:each="movie : ${aiSuggestions}" 
                        class="movie-card" 
                        th:attr="data-movie-id=${movie.id}">
                        
                        <div class="movie-poster">
                            <img th:src="${movie.poster}" 
                                th:alt="${movie.title}"
                                onerror="this.src='/images/placeholder.jpg'">
                        </div>
                        
                        <div class="movie-info">
                            <h3 th:text="${movie.title}">Movie Title</h3>
                            <p class="movie-rating">
                                ‚≠ê <span th:text="${movie.rating}">8.5</span>
                            </p>
                        </div>
                        
                        <div th:replace="~{fragments/hover-card :: hoverCard(${movie})}"></div>
                    </div>

                </div>
            </div>
        </section>

        <!-- Trending Section (shown when no query) -->
        <section class="movies movie-list-section" th:if="${query == null}" id="trendingSection">
    
            <div class="section-header">
                <div class="section-title-wrapper">
                    <h2 class="section-title" style="display: flex; align-items: center; gap: 10px;">
                        <span class="fire-icon" style="font-size: 1.8rem;">üî•</span> 
                        Xu h∆∞·ªõng g·∫ßn ƒë√¢y
                    </h2>
                    <a href="/discover?quickFilter=trending" class="view-more-link" style="margin-left: 20px;">
                        Xem th√™m <i class="fas fa-chevron-right"></i>
                    </a>
                </div>
                
                <div class="carousel-nav">
                    <button class="nav-btn prev-btn" id="trendingCarouselPrev">
                        <i class="fas fa-chevron-left"></i>
                    </button>
                    <button class="nav-btn next-btn" id="trendingCarouselNext">
                        <i class="fas fa-chevron-right"></i>
                    </button>
                </div>
            </div>
            
            <div class="movie-carousel">
                <div class="movie-slider" id="trendingCarousel">
                    </div>
            </div>
        </section>        
    </div>

    <div th:replace="fragments/footer :: footer"></div>
    <div th:replace="fragments/ai-chat :: ai-chat"></div>





    <script>
        // ============ SEARCH PAGE - COMPLETE UNIFIED SCRIPT ============
    (function() {
        'use strict';
        
        const API_KEY = 'eac03c4e09a0f5099128e38cb0e67a8f';
        const API_BASE = 'https://api.themoviedb.org/3';
        const IMG_BASE = 'https://image.tmdb.org/t/p';
        
        // DOM Elements
        const mainInput = document.getElementById('mainSearchInput');
        const voiceBtn = document.getElementById('voiceSearchPageBtn');
        const filterBtn = document.getElementById('filterPageBtn');
        const aiBtn = document.getElementById('aiSearchPageBtn');
        const liveSuggestions = document.getElementById('liveSuggestions');
        const filtersPanel = document.getElementById('filtersPanel');
        const pagination = document.getElementById('pagination');
        const relatedCarousel = document.getElementById('relatedCarousel');
        const aiCarousel = document.getElementById('aiCarousel');
        const trendingCarousel = document.getElementById('trendingCarousel');
        
        // State Management
        const PAGE_SIZE = 6; // Load 6 items per scroll
        let cachedResults = [];
        let displayedCount = 0;
        let nextApiPage = 2;
        let totalApiPages = 1;
        let lastQuery = '';
        let peopleCache = new Map();
        let loadingMore = false;
        let abortController = null;
        
        // Filter State
        const filterState = {
            quickFilter: null,
            genres: [],
            yearFrom: null,
            yearTo: null,
            minRating: 0
        };
        
        const GENRES = [
            {id: 28, name: 'H√†nh ƒë·ªông'}, {id: 12, name: 'Phi√™u l∆∞u'}, {id: 16, name: 'Ho·∫°t h√¨nh'},
            {id: 35, name: 'H√†i'}, {id: 80, name: 'H√¨nh s·ª±'}, {id: 18, name: 'Ch√≠nh k·ªãch'},
            {id: 10751, name: 'Gia ƒë√¨nh'}, {id: 14, name: 'Gi·∫£ t∆∞·ªüng'}, {id: 27, name: 'Kinh d·ªã'},
            {id: 10749, name: 'L√£ng m·∫°n'}, {id: 878, name: 'Khoa h·ªçc vi·ªÖn t∆∞·ªüng'}, 
            {id: 53, name: 'G√¢y c·∫•n'}, {id: 10752, name: 'Chi·∫øn tranh'}
        ];
        
        // ============ LIVE SUGGESTIONS WITH PEOPLE SEARCH ============
        let searchTimeout;
        
        if (mainInput && liveSuggestions) {
            mainInput.addEventListener('input', (e) => {
                clearTimeout(searchTimeout);
                const query = e.target.value.trim();
                
                if (query.length < 2) {
                    hideLiveSuggestions();
                    return;
                }
                
                searchTimeout = setTimeout(() => fetchLiveSuggestions(query), 300);
            });
            
            // Close on click outside
            // document.addEventListener('click', (e) => {
            //     if (!e.target.closest('.search-main-box') && !e.target.closest('.filters-body')) {
            //         hideLiveSuggestions();
            //     }
            // });
            
            // Scroll handler for lazy load
            liveSuggestions.addEventListener('scroll', debounce(async function() {
                if (liveSuggestions.scrollTop + liveSuggestions.clientHeight >= 
                    liveSuggestions.scrollHeight - 50) {
                    await loadMoreSuggestions();
                }
            }, 150));
        }
        
        async function fetchLiveSuggestions(query) {
            // Cancel previous request
            if (abortController) abortController.abort();
            abortController = new AbortController();
            
            try {
                // Reset if new query
                if (query !== lastQuery) {
                    cachedResults = [];
                    displayedCount = 0;
                    nextApiPage = 2;
                    totalApiPages = 1;
                    lastQuery = query;
                }
                
                // Fetch movies (page 1)
                const moviesRes = await fetch(
                    `${API_BASE}/search/multi?api_key=${API_KEY}&language=vi-VN&query=${encodeURIComponent(query)}&page=1&include_adult=false`,
                    { signal: abortController.signal }
                );
                
                if (!moviesRes.ok) throw new Error('API Error');
                
                const moviesData = await moviesRes.json();
                const movieResults = (moviesData.results || []).filter(r => ['movie', 'tv'].includes(r.media_type));
                totalApiPages = moviesData.total_pages || 1;
                
                // Fetch people if query >= 3 chars
                let peopleMovies = [];
                if (query.length >= 3) {
                    const people = await searchPeople(query);
                    if (people.length > 0) {
                        const promises = people.map(p => getMoviesFromPerson(p.id, p.name));
                        const results = await Promise.all(promises);
                        peopleMovies = results.flat();
                    }
                }
                
                // Merge & dedupe
                const uniqueMap = new Map();
                [...movieResults, ...peopleMovies].forEach(item => {
                    const key = `${item.media_type || 'movie'}_${item.id}`;
                    if (!uniqueMap.has(key)) {
                        uniqueMap.set(key, item);
                    } else if (item._personName && !uniqueMap.get(key)._personName) {
                        uniqueMap.set(key, item);
                    }
                });
                
                let results = Array.from(uniqueMap.values());
                
                // Filter by title/person name
                const qNorm = normalizeVietnamese(query);
                results = results.filter(item => {
                    const title = normalizeVietnamese(item.title || item.name || '');
                    const personName = normalizeVietnamese(item._personName || '');
                    return title.includes(qNorm) || personName.includes(qNorm);
                });
                
                // Add relevance & sort
                results = results.map(item => ({
                    ...item,
                    _relevance: calculateRelevance(item, query)
                }));
                results.sort((a, b) => (b._relevance || 0) - (a._relevance || 0));
                
                cachedResults = results;
                displayedCount = 0;
                
                // Render first chunk
                loadMoreSuggestions();
                
            } catch (error) {
                if (error.name !== 'AbortError') {
                    console.error('Live search error:', error);
                    liveSuggestions.innerHTML = '<div style="padding:14px;text-align:center;color:rgba(255,255,255,0.5)">L·ªói t·∫£i d·ªØ li·ªáu</div>';
                    liveSuggestions.style.display = 'block';
                }
            }
        }
        
        async function loadMoreSuggestions() {
            if (loadingMore) return;
            if (!cachedResults || cachedResults.length === 0) return;
            
            loadingMore = true;
            
            // Fetch next API page if needed
            if (displayedCount >= cachedResults.length && nextApiPage <= totalApiPages) {
                await fetchNextApiPageAndAppend(lastQuery);
            }
            
            const start = displayedCount;
            const end = Math.min(cachedResults.length, displayedCount + PAGE_SIZE);
            const chunk = cachedResults.slice(start, end);
            const append = start > 0;
            
            if (chunk.length === 0) {
                if (displayedCount === 0) {
                    liveSuggestions.innerHTML = '<div style="padding:14px;text-align:center;color:rgba(255,255,255,0.6)">Kh√¥ng t√¨m th·∫•y k·∫øt qu·∫£</div>';
                    liveSuggestions.style.display = 'block';
                }
                loadingMore = false;
                return;
            }
            
            renderSuggestionsChunk(chunk, append);
            displayedCount = end;
            loadingMore = false;
        }
        
        async function fetchNextApiPageAndAppend(query) {
            if (nextApiPage > totalApiPages) return;
            
            try {
                const res = await fetch(
                    `${API_BASE}/search/multi?api_key=${API_KEY}&language=vi-VN&query=${encodeURIComponent(query)}&page=${nextApiPage}&include_adult=false`
                );
                
                if (!res.ok) return;
                
                const data = await res.json();
                const more = (data.results || []).filter(r => ['movie', 'tv'].includes(r.media_type));
                nextApiPage++;
                totalApiPages = data.total_pages || totalApiPages;
                
                // Dedupe
                const existingKeys = new Set(cachedResults.map(it => `${it.media_type || 'movie'}_${it.id}`));
                const deduped = more.filter(it => !existingKeys.has(`${it.media_type || 'movie'}_${it.id}`));
                
                cachedResults = cachedResults.concat(deduped);
            } catch (e) {
                console.warn('Fetch next page failed:', e);
            }
        }
        
        function renderSuggestionsChunk(chunk, append = false) {
            const html = chunk.map(item => {
                const poster = item.poster_path ? `${IMG_BASE}/w92${item.poster_path}` : '/images/placeholder.jpg';
                const title = escapeHtml(item.title || item.name || 'Unknown');
                const year = (item.release_date || item.first_air_date || '').substring(0, 4);
                const rating = item.vote_average ? item.vote_average.toFixed(1) : '‚Äî';
                const context = item._personName ? `${item._personRole}: ${escapeHtml(item._personName)}` : '';
                
                return `
                    <div class="suggestion-item" onclick="location.href='/movie/detail/${item.id}'" 
                        style="display:flex;gap:10px;padding:8px;align-items:center;cursor:pointer;border-radius:8px;transition:background 0.2s;">
                        <img src="${poster}" alt="${title}" onerror="this.src='/images/placeholder.jpg'" 
                            style="width:46px;height:64px;object-fit:cover;border-radius:4px;">
                        <div class="suggestion-info" style="flex:1;min-width:0;">
                            <div class="suggestion-title" style="font-weight:600;font-size:0.95rem;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;">${title}</div>
                            <div class="suggestion-meta" style="font-size:0.85rem;color:rgba(255,255,255,0.6);margin-top:4px;">
                                ${year} ${year ? '‚Ä¢' : ''} ‚≠ê ${rating} ${context ? '‚Ä¢ ' + context : ''}
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
            
            if (append) {
                liveSuggestions.insertAdjacentHTML('beforeend', html);
            } else {
                liveSuggestions.innerHTML = html;
            }
            
            liveSuggestions.style.display = 'block';
            
            // Add hover effect
            liveSuggestions.querySelectorAll('.suggestion-item').forEach(item => {
                item.addEventListener('mouseenter', function() {
                    this.style.background = 'rgba(255,255,255,0.05)';
                });
                item.addEventListener('mouseleave', function() {
                    this.style.background = '';
                });
            });
            // [LOGIC M·ªöI] G·ª≠i ID l√™n server ƒë·ªÉ ƒë·ªìng b·ªô
            const idsToSync = chunk.map(item => item.id);
            syncIdsToDatabase(idsToSync);
        }

        /**
         * G·ª≠i m·ªôt danh s√°ch ID phim l√™n API ƒë·ªÉ y√™u c·∫ßu ƒë·ªìng b·ªô v·ªÅ DB.
         * Kh√¥ng c·∫ßn ch·ªù k·∫øt qu·∫£ (fire-and-forget).
         */
        function syncIdsToDatabase(ids) {
            if (!ids || ids.length === 0) return;
            
            // D√πng fetch ƒë·ªÉ g·ª≠i y√™u c·∫ßu POST
            fetch('/api/content/movies/sync', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(ids)
            })
            .then(response => response.json())
            .then(data => {
                if(data.success) {
                    console.log('Sync request sent for IDs:', ids);
                }
            })
            .catch(error => {
                console.error('Error sending sync request:', error);
            });
        }
        
        function hideLiveSuggestions() {
            if (liveSuggestions) {
                liveSuggestions.style.display = 'none';
            }
        }
        
        // ============ PEOPLE SEARCH ============
        async function searchPeople(query) {
            if (peopleCache.has(query)) {
                return peopleCache.get(query);
            }
            
            try {
                const res = await fetch(
                    `${API_BASE}/search/person?api_key=${API_KEY}&language=vi-VN&query=${encodeURIComponent(query)}&page=1`
                );
                
                if (!res.ok) return [];
                
                const data = await res.json();
                const results = (data.results || []).slice(0, 3);
                peopleCache.set(query, results);
                return results;
            } catch (e) {
                console.warn('People search failed:', e);
                return [];
            }
        }
        
        async function getMoviesFromPerson(personId, personName) {
            try {
                const res = await fetch(
                    `${API_BASE}/person/${personId}/movie_credits?api_key=${API_KEY}&language=vi-VN`
                );
                
                if (!res.ok) return [];
                
                const data = await res.json();
                const castMovies = (data.cast || []).slice(0, 3).map(m => ({
                    ...m,
                    media_type: 'movie',
                    _personName: personName,
                    _personRole: 'Di·ªÖn vi√™n'
                }));
                
                const crewMovies = (data.crew || [])
                    .filter(m => m.job === 'Director')
                    .slice(0, 2)
                    .map(m => ({
                        ...m,
                        media_type: 'movie',
                        _personName: personName,
                        _personRole: 'ƒê·∫°o di·ªÖn'
                    }));
                
                return [...crewMovies, ...castMovies].slice(0, 3);
            } catch (e) {
                console.warn('Person credits failed:', e);
                return [];
            }
        }
        
        // ============ FILTERS SYSTEM ============
        function initFilters() {
            if (!filtersPanel || !filterBtn) return;
            
            const filtersClose = document.getElementById('filtersClose');
            const clearFiltersBtn = document.getElementById('clearFilters');
            const applyFiltersBtn = document.getElementById('applyFilters');
            const minRatingSlider = document.getElementById('minRating');
            const ratingValue = document.getElementById('ratingValue');
            
            renderGenres();
            
            // Toggle panel
            filterBtn.addEventListener('click', (e) => {
                e.stopPropagation();
                filtersPanel.hidden = !filtersPanel.hidden;
                filtersPanel.classList.toggle('show');
                filterBtn.classList.toggle('active');
            });
            
            filtersClose?.addEventListener('click', () => {
                filtersPanel.hidden = true;
                filtersPanel.classList.remove('show');
                filterBtn.classList.remove('active');
            });
            
            // Rating slider
            minRatingSlider?.addEventListener('input', (e) => {
                if (ratingValue) {
                    ratingValue.textContent = parseFloat(e.target.value).toFixed(1);
                }
            });
            
            // Clear filters
            clearFiltersBtn?.addEventListener('click', () => {
                filterState.quickFilter = null;
                filterState.genres = [];
                filterState.yearFrom = null;
                filterState.yearTo = null;
                filterState.minRating = 0;
                
                document.querySelectorAll('.quick-filter-chip').forEach(c => c.classList.remove('active'));
                document.querySelectorAll('.genre-chip').forEach(c => c.classList.remove('active'));
                
                const yearFrom = document.getElementById('yearFrom');
                const yearTo = document.getElementById('yearTo');
                if (yearFrom) yearFrom.value = '';
                if (yearTo) yearTo.value = '';
                if (minRatingSlider) minRatingSlider.value = 0;
                if (ratingValue) ratingValue.textContent = '0.0';
            });
            
            // Apply filters
            applyFiltersBtn?.addEventListener('click', () => {
                applyFilters();
            });
            
            // [FIX] X·ª≠ l√Ω s·ª± ki·ªán click to√†n c·ª•c
            document.addEventListener('click', (e) => {
                const liveSuggestions = document.getElementById('liveSuggestions');
                const mainInput = document.getElementById('mainSearchInput');
                const filtersPanel = document.getElementById('filtersPanel');
                const filterBtn = document.getElementById('filterPageBtn');

                // 1. X·ª≠ l√Ω Live Suggestions
                // Ch·ªâ ƒë√≥ng n·∫øu click ra ngo√†i √¥ input V√Ä ra ngo√†i suggestions V√Ä ra ngo√†i filter panel
                if (liveSuggestions && liveSuggestions.style.display === 'block') {
                    if (!mainInput.contains(e.target) && 
                        !liveSuggestions.contains(e.target) && 
                        (!filtersPanel || !filtersPanel.contains(e.target))) {
                        liveSuggestions.style.display = 'none';
                    }
                }

                // 2. X·ª≠ l√Ω ƒë√≥ng Filter Panel (khi click ra ngo√†i n√≥)
                if (filtersPanel && filtersPanel.classList.contains('show')) {
                    if (!filtersPanel.contains(e.target) && !filterBtn.contains(e.target)) {
                        closeFilters();
                    }
                }
            });
        }
        
        function renderGenres() {
            const container = document.getElementById('genreFilters');
            if (!container) return;
            
            container.innerHTML = GENRES.map(g => 
                `<button class="genre-chip" data-genre="${g.id}">${g.name}</button>`
            ).join('');
            
            // Quick filters
            document.querySelectorAll('.quick-filter-chip').forEach(chip => {
                chip.addEventListener('click', function() {
                    document.querySelectorAll('.quick-filter-chip').forEach(c => c.classList.remove('active'));
                    this.classList.add('active');
                    filterState.quickFilter = this.dataset.filter;
                });
            });
            
            // Genre chips
            container.querySelectorAll('.genre-chip').forEach(chip => {
                chip.addEventListener('click', function() {
                    const genreId = parseInt(this.dataset.genre);
                    this.classList.toggle('active');
                    
                    if (filterState.genres.includes(genreId)) {
                        filterState.genres = filterState.genres.filter(id => id !== genreId);
                    } else {
                        filterState.genres.push(genreId);
                    }
                });
            });
        }
        
        // ============ FIX: applyFilters - Check mainInput value ============
        async function applyFilters() {
            // CHECK INPUT VALUE, NOT query variable
            const mainInput = document.getElementById('mainSearchInput');
            const query = mainInput?.value?.trim() || '';
            
            // Ch·ªâ b√°o l·ªói n·∫øu √¥ input th·ª±c s·ª± tr·ªëng
            if (!mainInput.value.trim()) {
                alert("Vui l√≤ng nh·∫≠p t·ª´ kh√≥a t√¨m ki·∫øm tr∆∞·ªõc khi l·ªçc.");
                if (mainInput) mainInput.focus();
                return;
            }
            
            // Collect filter values
            const yearFrom = document.getElementById('yearFrom')?.value;
            const yearTo = document.getElementById('yearTo')?.value;
            const minRating = parseFloat(document.getElementById('minRating')?.value || 0);
            
            filterState.yearFrom = yearFrom || null;
            filterState.yearTo = yearTo || null;
            filterState.minRating = minRating;
            
            try {
                // Ensure we have data
                if (lastQuery !== query || cachedResults.length === 0) {
                    await fetchLiveSuggestions(query);
                }
                
                let results = cachedResults.slice();
                
                // Apply genre filter
                if (filterState.genres.length > 0) {
                    results = results.filter(item => {
                        const genreIds = item.genre_ids || [];
                        return filterState.genres.every(g => genreIds.includes(g));
                    });
                }
                
                // Apply year filter
                if (filterState.yearFrom) {
                    results = results.filter(item => {
                        const year = (item.release_date || item.first_air_date || '').substring(0, 4);
                        return year && parseInt(year) >= parseInt(filterState.yearFrom);
                    });
                }
                
                if (filterState.yearTo) {
                    results = results.filter(item => {
                        const year = (item.release_date || item.first_air_date || '').substring(0, 4);
                        return year && parseInt(year) <= parseInt(filterState.yearTo);
                    });
                }
                
                // Apply rating filter
                if (filterState.minRating > 0) {
                    results = results.filter(item => (item.vote_average || 0) >= filterState.minRating);
                }
                
                // Apply quick filter sorting
                if (filterState.quickFilter === 'trending') {
                    results.sort((a, b) => (b.popularity || 0) - (a.popularity || 0));
                } else if (filterState.quickFilter === 'new') {
                    results.sort((a, b) => {
                        const dateA = new Date(a.release_date || a.first_air_date || 0).getTime();
                        const dateB = new Date(b.release_date || b.first_air_date || 0).getTime();
                        return dateB - dateA;
                    });
                } else if (filterState.quickFilter === 'top-rated') {
                    results = results.filter(r => (r.vote_count || 0) >= 20);
                    results.sort((a, b) => (b.vote_average || 0) - (a.vote_average || 0));
                }
                
                cachedResults = results;
                displayedCount = 0;
                nextApiPage = totalApiPages + 1;
                
                if (results.length === 0) {
                    liveSuggestions.innerHTML = '<div style="padding:14px;text-align:center;color:rgba(255,255,255,0.6)">Kh√¥ng c√≥ k·∫øt qu·∫£ ph√π h·ª£p</div>';
                    liveSuggestions.style.display = 'block';
                    return;
                }
                
                loadMoreSuggestions();
                
                // Close filters panel
                if (filtersPanel) {
                    filtersPanel.hidden = true;
                    filtersPanel.classList.remove('show');
                }
                if (filterBtn) {
                    filterBtn.classList.remove('active');
                }
                
            } catch (error) {
                console.error('Apply filters error:', error);
                liveSuggestions.innerHTML = '<div style="padding:14px;text-align:center;color:rgba(255,255,255,0.5)">L·ªói khi √°p d·ª•ng b·ªô l·ªçc</div>';
                liveSuggestions.style.display = 'block';
            }
        }
        
        // ============ SEARCH ON ENTER ============
        mainInput?.addEventListener('keydown', (e) => {
            if (e.key === 'Enter') {
                e.preventDefault();
                performSearch();
            }
        });
        
        function performSearch() {
            const query = mainInput?.value.trim();
            if (query) {
                window.location.href = `/search?query=${encodeURIComponent(query)}`;
            }
        }
        
        
        
        
        
        // Load Trending Carousel
        if (trendingCarousel) {
            loadTrendingCarousel();
        }
        
        async function loadTrendingCarousel() {
            try {
                const response = await fetch(`${API_BASE}/trending/movie/week?api_key=${API_KEY}&language=vi-VN`);
                const data = await response.json();
                
                // S·ª¨A ·ªû ƒê√ÇY: D√πng h√†m helper m·ªõi, isRanked = true
                trendingCarousel.innerHTML = data.results.slice(0, 20).map((movie, index) => {
                    // C·∫≠u mu·ªën layout ranked, n√™n ta ƒë·∫∑t isRanked = true
                    return createMovieCardHTML(movie, index, true); 
                }).join('');
                
                // [TH√äM] K√çCH HO·∫†T L·∫†I HOVER CHO CARD M·ªöI
                // (Gi·ªëng h·ªát h√†m loadRelatedMovies)
                if (typeof initHoverCards === 'function') {
                    console.log('Re-initializing hover cards for Trending Movies...');
                    initHoverCards();
                }

                // [TH√äM] K√çCH HO·∫†T N√öT B·∫§M CAROUSEL
                if (typeof initCarousel === 'function') {
                    initCarousel('trendingCarousel', 'trendingCarouselPrev', 'trendingCarouselNext');
                }

            } catch (error) {
                console.error('Error loading trending:', error);
            }
        }

        // ============ UTILITY FUNCTIONS ============
        function debounce(fn, wait = 250) {
            let timeout;
            return function(...args) {
                clearTimeout(timeout);
                timeout = setTimeout(() => fn.apply(this, args), wait);
            };
        }
        
        function escapeHtml(str) {
            if (!str) return '';
            const map = {
                '&': '&amp;',
                '<': '&lt;',
                '>': '&gt;',
                '"': '&quot;',
                "'": '&#39;'
            };
            return str.replace(/[&<>"']/g, m => map[m]);
        }

        /**
         * H√ÄM M·ªöI: T·∫†O CHU·ªñI HTML CHO MOVIE CARD CHU·∫®N
         * H√†m n√†y t√°i t·∫°o 1-1 c·∫•u tr√∫c t·ª´ index.html v√† hover-card.html
         * @param {object} movie - Object phim t·ª´ API TMDB
         * @param {number} index - V·ªã tr√≠ trong danh s√°ch (cho ranked)
         * @param {boolean} isRanked - √Åp d·ª•ng style 'ranked' hay kh√¥ng
         */
        function createMovieCardHTML(movie, index, isRanked = false) {
            const poster = movie.poster_path ? `${IMG_BASE}/w500${movie.poster_path}` : '/images/placeholder.jpg';
            const backdrop = movie.backdrop_path ? `${IMG_BASE}/original${movie.backdrop_path}` : '/images/placeholder.jpg';
            const rating = movie.vote_average ? movie.vote_average.toFixed(1) : '‚Äî';
            const year = (movie.release_date || '').substring(0, 4) || '‚Äî';
            const safeTitle = escapeHtml(movie.title || movie.name || 'Unknown');
            const safeOverview = escapeHtml(movie.overview || 'ƒêang t·∫£i m√¥ t·∫£...');
            const playerId = `hover-player-search-${movie.id}-${index}`; // ID duy nh·∫•t

            // Logic cho ranked
            const rankClass = isRanked ? `ranked rank-${((index % 5) + 1)}` : '';
            const rankOverlay = isRanked ? '<div class="ranking-overlay"></div>' : '';
            const rankNumber = isRanked ? `<div class="ranking-number">${index + 1}</div>` : '';

            return `
            <div class="movie-card ${rankClass}" data-movie-id="${movie.id}">
                
                <div class="movie-poster">
                    <img src="${poster}" alt="${safeTitle}" onerror="this.src='/images/placeholder.jpg'">
                    ${rankOverlay}
                    ${rankNumber}
                </div>
                
                <div class="movie-info">
                    <h3>${safeTitle}</h3>
                    <p class="movie-rating">‚≠ê <span>${rating}</span></p>
                </div>
                
                <div class="movie-hover-card" data-movie-id="${movie.id}">
                    <div class="hover-card-media">
                        <img class="hover-card-image" src="${backdrop}" alt="${safeTitle}" onerror="this.src='/images/placeholder.jpg'">
                        <div class="hover-player-container">
                            <div class="hover-player" id="${playerId}"></div>
                        </div>
                        <button class="hover-volume-btn" type="button" title="B·∫≠t/T·∫Øt ti·∫øng">
                            <i class="fas fa-volume-mute"></i>
                        </button>
                    </div>
                    <div class="hover-card-content">
                        <div class="hover-card-actions">
                            <button class="hover-play-btn" type="button" data-movie-id="${movie.id}" onclick="event.stopPropagation(); goToMovieDetail(this)">
                                <i class="fas fa-play"></i> Xem ngay
                            </button>
                            <button class="hover-action-icon hover-like-btn" type="button" onclick="event.stopPropagation(); toggleHoverLike(this)" title="Th√™m v√†o danh s√°ch">
                                <i class="far fa-heart"></i>
                            </button>
                            <button class="hover-action-icon hover-share-btn" type="button"
                                    data-movie-id="${movie.id}" data-movie-title="${safeTitle}"
                                    onclick="event.stopPropagation(); showShareModal(this)" title="Chia s·∫ª">
                                <i class="fas fa-share-alt"></i>
                            </button>
                        </div>
                        <h3 class="hover-card-title">${safeTitle}</h3>
                        <div class="hover-card-meta">
                            <span class="meta-rating"><i class="fas fa-star"></i> <span>${rating}</span></span>
                            <span class="meta-year">${year}</span>
                            <span class="meta-quality">HD</span>
                        </div>
                        <div class="hover-card-meta-extra">
                            <span class="meta-extra-rating loading-meta">T</span>
                            <span class="meta-extra-runtime loading-meta">‚Äî ph√∫t</span>
                            <span class="meta-extra-country loading-meta">Qu·ªëc gia</span>
                        </div>
                        <div class="hover-card-genres">
                            <span class="genre-tag loading-genre">ƒêang t·∫£i...</span>
                        </div>
                        <p class="hover-card-description">${safeOverview}</p>
                    </div>
                </div>
                </div>
            `;
        }
        
        function normalizeVietnamese(str) {
            if (!str) return '';
            return str.normalize('NFD').replace(/[\u0300-\u036f]/g, '').toLowerCase();
        }
        
        function calculateRelevance(item, query) {
            const q = normalizeVietnamese(query);
            const title = normalizeVietnamese(item.title || item.name || '');
            const overview = normalizeVietnamese(item.overview || '');
            
            let score = 0;
            
            // Title matching
            if (title === q) score += 100;
            else if (title.startsWith(q)) score += 80;
            else if (title.includes(q)) score += 50;
            
            // Overview matching
            if (overview.includes(q)) score += 20;
            
            // Popularity & rating boost
            score += (item.popularity || 0) * 0.1;
            score += (item.vote_average || 0) * 2;
            
            return score;
        }
        
        // ============ VOICE SEARCH ============
        if (voiceBtn) {
            if ('webkitSpeechRecognition' in window || 'SpeechRecognition' in window) {
                const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
                const recognition = new SpeechRecognition();
                recognition.lang = 'vi-VI';
                recognition.interimResults = false;
                
                voiceBtn.addEventListener('click', (e) => {
                    e.preventDefault();
                    e.stopPropagation();
                    
                    if (voiceBtn.classList.contains('recording')) {
                        recognition.stop();
                    } else {
                        try {
                            recognition.start();
                        } catch (err) {
                            console.warn('Voice recognition error:', err);
                        }
                    }
                });
                
                recognition.onstart = () => {
                    voiceBtn.classList.add('recording');
                };
                
                recognition.onend = () => {
                    voiceBtn.classList.remove('recording');
                };
                
                recognition.onresult = (event) => {
                    const transcript = event.results[0][0].transcript;
                    if (mainInput) {
                        mainInput.value = transcript;
                        mainInput.focus();
                        fetchLiveSuggestions(transcript);
                    }
                };
                
                recognition.onerror = (event) => {
                    voiceBtn.classList.remove('recording');
                    console.warn('Voice recognition error:', event.error);
                };
            } else {
                voiceBtn.style.display = 'none';
            }
        }
        
        // ============ AI SEARCH BUTTON ============
        if (aiBtn) {
            aiBtn.addEventListener('click', () => {
                // Open AI modal (assuming it exists in header fragment)
                const aiModal = document.getElementById('aiSearchModal');
                if (aiModal) {
                    aiModal.hidden = false;
                    document.body.style.overflow = 'hidden';
                }
            });
        }
        
        // ============ INITIALIZE ============
        initFilters();

        // ‚úÖ Kh·ªüi t·∫°o hover cards V√Ä CAROUSELS sau khi DOM load
        document.addEventListener('DOMContentLoaded', function() {
            // Import functions t·ª´ script.js
            if (typeof initHoverCards === 'function') {
                initHoverCards();
            }
            
            // ƒê·∫£m b·∫£o genre map ƒë√£ load
            if (typeof loadGenreMap === 'function') {
                loadGenreMap();
            }

            // [TH√äM] K√çCH HO·∫†T C√ÅC CAROUSEL RENDER B·ªûI JAVA
            if (typeof initCarousel === 'function') {
                // (trendingCarousel ƒë√£ ƒë∆∞·ª£c init ·ªü h√†m loadTrendingCarousel)
                if (document.getElementById('relatedCarousel')) {
                    initCarousel('relatedCarousel', 'relatedCarouselPrev', 'relatedCarouselNext');
                }
                if (document.getElementById('aiCarousel')) {
                    initCarousel('aiCarousel', 'aiCarouselPrev', 'aiCarouselNext');
                }
            }
        });
        
        // Debug helpers
        window.__searchDebug = {
            getCached: () => cachedResults,
            getDisplayedCount: () => displayedCount,
            getFilterState: () => filterState,
            loadMore: loadMoreSuggestions,
            applyFilters: applyFilters
        };
        
        console.log('‚úÖ Search page script initialized successfully');
        
    })();
    </script>
    <script src="https://www.youtube.com/iframe_api"></script>
    <script th:src="@{/js/movie/ai-agent.js}" defer></script>
    <script src="/js/movie/share-modal.js"></script>
    <script src="/js/script.js"></script>

    <div th:replace="fragments/share-modal :: shareModal"></div>
</body>
</html>