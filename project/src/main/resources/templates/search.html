<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title th:text="${query != null ? 'T√¨m ki·∫øm: ' + query : 'T√¨m ki·∫øm - FFilm'}">T√¨m ki·∫øm</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <link rel="stylesheet" href="/css/footer.css">
    <link rel="stylesheet" th:href="@{/css/hover-card.css}">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" th:href="@{/css/ai-agent.css}">
    <link rel="stylesheet" href="/css/style.css" />
    <link rel="stylesheet" th:href="@{/css/search.css}" />
</head>
<body>
    <div th:replace="fragments/header :: header"></div>

    <div class="search-page-container">
        <!-- Hero Section -->
        <div class="search-hero">
            <h1 th:if="${query == null}">T√¨m ki·∫øm phim y√™u th√≠ch</h1>
            <h1 th:if="${query != null}">
                K·∫øt qu·∫£ cho "<span class="query-highlight" th:text="${query}"></span>"
            </h1>
            <p th:if="${query == null}">Kh√°m ph√° h√†ng ng√†n b·ªô phim, series v√† anime h·∫•p d·∫´n</p>
            <p th:if="${query != null && totalResults != null}">
                T√¨m th·∫•y <strong th:text="${totalResults}"></strong> k·∫øt qu·∫£
            </p>
        </div>

        <!-- Main Search Box -->
        <div class="search-main-box">
            <form id="searchForm" onsubmit="return false;">
                <input 
                    type="text" 
                    id="mainSearchInput"
                    class="search-main-input" 
                    placeholder="Nh·∫≠p t√™n phim, di·ªÖn vi√™n, ƒë·∫°o di·ªÖn..."
                    autocomplete="off"
                    autofocus
                    th:value="${query}"
                />
                
                <div class="search-actions">
                    <button type="button" class="search-action-btn voice" id="voiceSearchPageBtn" title="Gi·ªçng n√≥i">
                        <i class="fas fa-microphone"></i>
                    </button>
                    <button type="button" class="search-action-btn filter" id="filterPageBtn" title="B·ªô l·ªçc">
                        <i class="fas fa-filter"></i>
                    </button>
                    <button type="button" class="search-action-btn ai" id="aiSearchPageBtn" title="AI">
                        <i class="fas fa-wand-magic-sparkles"></i>
                    </button>
                </div>
            </form>

            <div id="filtersPanel" class="filters-panel" hidden>
            <div class="filters-header">
              <h3>L·ªçc k·∫øt qu·∫£</h3>
              <button class="filters-close" id="filtersClose">
                <i class="fas fa-times"></i>
              </button>
            </div>
            
            <div class="filters-body">
              <!-- Quick Filters -->
              <div class="filter-group">
                <label class="filter-label">Nhanh</label>
                <div class="quick-filters">
                  <button class="quick-filter-chip" data-filter="trending">
                    <i class="fas fa-fire"></i> Th·ªãnh h√†nh
                  </button>
                  <button class="quick-filter-chip" data-filter="new">
                    <i class="fas fa-star"></i> M·ªõi nh·∫•t
                  </button>
                  <button class="quick-filter-chip" data-filter="top-rated">
                    <i class="fas fa-trophy"></i> ƒê√°nh gi√° cao
                  </button>
                </div>
              </div>
              
              <!-- Genre Filter -->
              <div class="filter-group">
                <label class="filter-label">Th·ªÉ lo·∫°i</label>
                <div class="genre-filters" id="genreFilters">
                  <!-- Will be populated by JS -->
                </div>
              </div>
              
              <!-- Year Filter -->
              <div class="filter-group">
                <label class="filter-label">NƒÉm ph√°t h√†nh</label>
                <div class="year-filter">
                  <input type="number" id="yearFrom" placeholder="T·ª´ nƒÉm" min="1900" max="2025">
                  <span>-</span>
                  <input type="number" id="yearTo" placeholder="ƒê·∫øn nƒÉm" min="1900" max="2025">
                </div>
              </div>
              
              <!-- Rating Filter -->
              <div class="filter-group">
                <label class="filter-label">ƒê√°nh gi√° t·ªëi thi·ªÉu</label>
                <div class="rating-filter">
                  <input type="range" id="minRating" min="0" max="10" step="0.5" value="0">
                  <span class="rating-value" id="ratingValue">0.0</span>
                </div>
              </div>
            </div>
            
            <div class="filters-footer">
              <button class="btn-clear-filters" id="clearFilters">X√≥a b·ªô l·ªçc</button>
              <button class="btn-apply-filters" id="applyFilters">√Åp d·ª•ng</button>
            </div>
          </div>

            <div id="liveSuggestions" class="live-suggestions" style="display:none; position:absolute; left:0; right:0; top:110%; background:rgba(20,20,20,0.95); border:1px solid rgba(255,255,255,0.06); border-radius:10px; padding:8px; z-index:80; max-height: 450px; overflow-y: auto;">
                <!-- JS s·∫Ω render c√°c suggestion items v√†o ƒë√¢y -->
            </div>
        </div>        

        <!-- Results Section (shown when there's a query) -->
        <div class="results-section" th:if="${query != null}" id="resultsSection">
            <div class="results-grid" id="resultsGrid">
                <div th:each="movie : ${searchResults}" 
                    class="movie-card" 
                    th:attr="data-movie-id=${movie.id}">
                    
                    <div class="movie-poster">
                        <img th:src="${movie.poster}" 
                            th:alt="${movie.title}"
                            onerror="this.src='/images/placeholder.jpg'">
                    </div>
                    
                    <div class="movie-info">
                        <h3 th:text="${movie.title}">Movie Title</h3>
                        <p class="movie-rating">
                            ‚≠ê <span th:text="${movie.rating}">8.5</span>
                        </p>
                    </div>
                    
                    <div th:replace="~{fragments/hover-card :: hoverCard(${movie})}"></div>
                </div>
            </div>

            <div class="pagination" 
                th:if="${query != null && totalPages != null && totalPages > 1}" 
                id="pagination"
                th:attr="data-current-page=${currentPage},data-total-pages=${totalPages}">
                <!-- JavaScript s·∫Ω render pagination buttons -->
            </div>
        </div>

        <!-- Empty State -->
        <div class="empty-state" th:if="${query != null && searchResults.isEmpty()}" id="emptyState">
            <div class="empty-icon"><i class="fas fa-search"></i></div>
            <h2>Kh√¥ng t√¨m th·∫•y k·∫øt qu·∫£</h2>
            <p>Kh√¥ng c√≥ k·∫øt qu·∫£ n√†o cho t·ª´ kh√≥a c·ªßa b·∫°n</p>
            <a href="/search" class="btn-back"><i class="fas fa-arrow-left"></i> Th·ª≠ l·∫°i</a>
        </div>

        <!-- AI Search Modal -->
        <div id="aiSearchModal" class="ai-search-modal" hidden>
          <div class="ai-modal-overlay"></div>
          <div class="ai-modal-content">
            <div class="ai-modal-header">
              <div class="ai-header-title">
                <i class="fas fa-wand-magic-sparkles"></i>
                <h3>T√¨m ki·∫øm b·∫±ng AI</h3>
              </div>
              <button class="ai-modal-close" id="aiModalClose">
                <i class="fas fa-times"></i>
              </button>
            </div>
            
            <div class="ai-modal-body">
              <p class="ai-description">
                M√¥ t·∫£ b·ªô phim b·∫°n mu·ªën xem, AI s·∫Ω gi√∫p b·∫°n t√¨m ki·∫øm!
              </p>
              
              <textarea 
                id="aiSearchInput" 
                placeholder="V√≠ d·ª•: T√¥i mu·ªën xem phim v·ªÅ ng∆∞·ªùi s·∫Øt, c√≥ robot chi·∫øn ƒë·∫•u, ƒë·∫°o di·ªÖn n·ªïi ti·∫øng, h√†nh ƒë·ªông m√£n nh√£n..."
                rows="5"
              ></textarea>
              
              <div class="ai-examples">
                <p class="examples-label">G·ª£i √Ω:</p>
                <button class="example-chip" data-example="Phim v·ªÅ si√™u anh h√πng Marvel, c√≥ Chris Evans">
                  Phim Marvel v·ªõi Chris Evans
                </button>
                <button class="example-chip" data-example="Phim kinh d·ªã t√¢m l√Ω, ƒë·∫°o di·ªÖn Christopher Nolan">
                  Kinh d·ªã t√¢m l√Ω Nolan
                </button>
                <button class="example-chip" data-example="Phim ho·∫°t h√¨nh Disney v·ªÅ gia ƒë√¨nh">
                  Ho·∫°t h√¨nh Disney gia ƒë√¨nh
                </button>
              </div>
              
              <div class="ai-loading" id="aiLoading" hidden>
                <div class="loading-spinner"></div>
                <p>AI ƒëang ph√¢n t√≠ch m√¥ t·∫£ c·ªßa b·∫°n...</p>
              </div>
              
              <!-- X√ìA ph·∫ßn ai-results c≈©, TH√äM M·ªöI: -->
              <div class="ai-movie-results" id="aiMovieResults" hidden>
                <p class="results-label">
                  <i class="fas fa-film"></i>
                  Phim g·ª£i √Ω cho b·∫°n:
                </p>
                <div class="ai-movie-grid" id="aiMovieGrid"></div>
              </div>
              
              <div class="ai-error" id="aiError" hidden>
                <i class="fas fa-exclamation-circle"></i>
                <span id="aiErrorMessage"></span>
              </div>
            </div>
            
            <div class="ai-modal-footer">
              <button class="btn-cancel" id="aiCancelBtn">H·ªßy</button>
              <button class="btn-search-ai" id="aiSearchBtn">
                <i class="fas fa-search"></i>
                T√¨m ki·∫øm
              </button>
            </div>
          </div>
        </div>

        <!-- Related Movies (shown after search, before AI suggestions) -->
        <section class="movies movie-list-section" th:if="${!relatedMovies.isEmpty()}" id="relatedSection">
            
            <div class="section-header">
                <div class="section-title-wrapper">
                    <h2 class="section-title" style="display: flex; align-items: center; gap: 10px;">
                        <i class="fas fa-film" style="color: #e50914;"></i>
                        Phim li√™n quan
                    </h2>
                </div>
                <div class="carousel-nav">
                    <button class="nav-btn prev-btn" id="relatedCarouselPrev">
                        <i class="fas fa-chevron-left"></i>
                    </button>
                    <button class="nav-btn next-btn" id="relatedCarouselNext">
                        <i class="fas fa-chevron-right"></i>
                    </button>
                </div>
            </div>
            <div class="movie-carousel">
                <div class="movie-slider" id="relatedCarousel">
                    <div th:each="movie : ${relatedMovies}" 
                        class="movie-card" 
                        th:attr="data-movie-id=${movie.id}">
                        
                        <div class="movie-poster">
                            <img th:src="${movie.poster}" 
                                th:alt="${movie.title}"
                                onerror="this.src='/images/placeholder.jpg'">
                        </div>
                        <div class="movie-info">
                            <h3 th:text="${movie.title}">Movie Title</h3>
                            <p class="movie-rating">
                                ‚≠ê <span th:text="${movie.rating}">8.5</span>
                            </p>
                        </div>
                        <div th:replace="~{fragments/hover-card :: hoverCard(${movie})}"></div>
                    </div>
                </div>
            </div>
        </section>

        <!-- AI Suggestions (shown after search) -->
        <section class="movies movie-list-section" th:if="${query != null && !aiSuggestions.isEmpty()}" id="aiSuggestionsSection">
    
            <div class="section-header">
                <div class="section-title-wrapper">
                    <h2 class="section-title" style="display: flex; align-items: center; gap: 10px;">
                        <i class="fas fa-wand-magic-sparkles" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); -webkit-background-clip: text; -webkit-text-fill-color: transparent;"></i>
                        G·ª£i √Ω t·ª´ AI
                    </h2>
                </div>
                
                <div class="carousel-nav">
                    <button class="nav-btn prev-btn" id="aiCarouselPrev">
                        <i class="fas fa-chevron-left"></i>
                    </button>
                    <button class="nav-btn next-btn" id="aiCarouselNext">
                        <i class="fas fa-chevron-right"></i>
                    </button>
                </div>
            </div>
            
            <div class="movie-carousel">
                <div class="movie-slider" id="aiCarousel">
                    
                    <div th:each="movie : ${aiSuggestions}" 
                        class="movie-card" 
                        th:attr="data-movie-id=${movie.id}">
                        
                        <div class="movie-poster">
                            <img th:src="${movie.poster}" 
                                th:alt="${movie.title}"
                                onerror="this.src='/images/placeholder.jpg'">
                        </div>
                        
                        <div class="movie-info">
                            <h3 th:text="${movie.title}">Movie Title</h3>
                            <p class="movie-rating">
                                ‚≠ê <span th:text="${movie.rating}">8.5</span>
                            </p>
                        </div>
                        
                        <div th:replace="~{fragments/hover-card :: hoverCard(${movie})}"></div>
                    </div>

                </div>
            </div>
        </section>

        <!-- Trending Section (shown when no query) -->
        <section class="movies movie-list-section" th:if="${query == null}" id="trendingSection">
    
            <div class="section-header">
                <div class="section-title-wrapper">
                    <h2 class="section-title" style="display: flex; align-items: center; gap: 10px;">
                        <span class="fire-icon" style="font-size: 1.8rem;">üî•</span> 
                        Xu h∆∞·ªõng g·∫ßn ƒë√¢y
                    </h2>
                    <a href="/discover?quickFilter=trending" class="view-more-link" style="margin-left: 20px;">
                        Xem th√™m <i class="fas fa-chevron-right"></i>
                    </a>
                </div>
                
                <!-- [V·∫§N ƒê·ªÄ 4] TH√äM N√öT ƒêI·ªÄU H∆Ø·ªöNG -->
                <div class="carousel-nav">
                    <button class="nav-btn prev-btn" id="trendingCarouselPrev">
                        <i class="fas fa-chevron-left"></i>
                    </button>
                    <button class="nav-btn next-btn" id="trendingCarouselNext">
                        <i class="fas fa-chevron-right"></i>
                    </button>
                </div>
            </div>
            
            <div class="movie-carousel">
                <div class="movie-slider" id="trendingCarousel">
                    </div>
            </div>
        </section>        
    </div>

    <div th:replace="fragments/footer :: footer"></div>
    <div th:replace="fragments/ai-chat :: ai-chat"></div>
    <script src="https://www.youtube.com/iframe_api"></script>
    <script th:src="@{/js/movie/ai-agent.js}" defer></script>
    <script src="/js/movie/share-modal.js"></script>
    <script src="/js/script.js"></script>
    <script src="/js/search.js"></script>

    <div th:replace="fragments/share-modal :: shareModal"></div>
</body>
</html>