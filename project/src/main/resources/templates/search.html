<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title th:text="'Kết quả tìm kiếm: ' + ${query}">Tìm kiếm</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <link rel="stylesheet" href="/css/style.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
/* --- base --- */
* { margin: 0; padding: 0; box-sizing: border-box; }
body { font-family: 'Segoe UI', system-ui, -apple-system, sans-serif; background:#141414; color:#fff; min-height:100vh; padding-top:70px; }
a { color: inherit; text-decoration: none; }

/* container */
.search-container { max-width:1400px; margin:0 auto; padding: 20px 50px 80px; }

/* Search header + filter bar */
.search-header { margin-bottom: 18px; }
.search-title { font-size: 1.7rem; font-weight:700; margin-bottom:6px; }
.search-title .query { color:#e50914; }

.filter-bar {
    display:flex;
    gap:12px;
    align-items:center;
    flex-wrap:wrap;
    margin: 14px 0 26px;
    position: sticky;
    top:70px;
    z-index: 30;
    padding: 12px;
    border-radius: 10px;
    background: linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));
    border: 1px solid rgba(255,255,255,0.03);
}

/* search input in result page */
.filter-search {
    display:flex;
    gap:8px;
    align-items:center;
    flex: 1 1 320px;
}
.filter-search input[type="search"] {
    width:100%;
    padding:10px 12px;
    border-radius:8px;
    border: 1px solid rgba(255,255,255,0.08);
    background: rgba(255,255,255,0.02);
    color: white;
    outline: none;
}
.filter-search button { padding:10px 12px; border-radius:8px; border:none; background:#e50914; color:white; cursor:pointer; }

/* selects / controls */
.filter-controls {
    display:flex;
    gap:10px;
    align-items:center;
    flex-wrap:wrap;
}
.select, .small-input {
    background: rgba(255,255,255,0.02);
    border:1px solid rgba(255,255,255,0.06);
    color: white;
    padding:8px 10px;
    border-radius:8px;
    font-size:0.9rem;
}
.select[multiple] { min-width: 200px; max-height: 160px; overflow:auto; }

/* quick filters */
.quick-filters { display:flex; gap:8px; align-items:center; }
.qf-btn {
    padding:8px 12px;
    border-radius:8px;
    border:1px solid rgba(255,255,255,0.06);
    background: transparent;
    cursor:pointer;
    color: rgba(255,255,255,0.9);
    font-size:0.9rem;
}
.qf-btn.active { background:#e50914; border-color:#e50914; font-weight:600; color:white; }

/* grid results */
.results-grid { display:grid; grid-template-columns: repeat(auto-fill, minmax(200px,1fr)); gap:24px; margin-top:18px; }
@media (max-width:1200px) { .results-grid { grid-template-columns: repeat(4,1fr); } }
@media (max-width:900px) { .results-grid { grid-template-columns: repeat(3,1fr); } }
@media (max-width:600px) { .results-grid { grid-template-columns: repeat(2,1fr); } .search-container{ padding: 24px 14px; } }

.movie-card { cursor:pointer; transition: transform .22s; position:relative; }
.movie-card:hover { transform: scale(1.05); }
.movie-poster { position:relative; border-radius:8px; overflow:hidden; aspect-ratio:2/3; background:#222; }
.movie-poster img { width:100%; height:100%; object-fit:cover; display:block; }
.movie-overlay { position:absolute; inset:0; background:linear-gradient(to top, rgba(0,0,0,0.9), transparent); opacity:0; transition:opacity .22s; display:flex; align-items:center; justify-content:center; }
.movie-card:hover .movie-overlay{ opacity:1; }
.play-icon { width:48px; height:48px; border-radius:50%; background:rgba(229,9,20,0.95); display:flex; align-items:center; justify-content:center; font-size:1.1rem; color:white; }

.movie-info { padding:10px 0; }
.movie-title { font-size:0.95rem; font-weight:600; margin-bottom:6px; overflow:hidden; text-overflow:ellipsis; display:-webkit-box; -webkit-line-clamp:2; -webkit-box-orient:vertical; line-height:1.25; }
.movie-meta { display:flex; justify-content:space-between; font-size:0.85rem; color:rgba(255,255,255,0.7); }
.movie-rating { color:#ffd700; }

/* pagination */
.pagination { display:flex; justify-content:center; align-items:center; gap:8px; margin:36px 0 12px; flex-wrap:wrap; }
.page-btn { min-width:40px; height:40px; border:1px solid rgba(255,255,255,0.2); background:rgba(255,255,255,0.05); color:white; border-radius:6px; cursor:pointer; display:flex; align-items:center; justify-content:center; text-decoration:none; }
.page-btn:hover:not(.active):not(.disabled) { background:rgba(255,255,255,0.08); border-color:rgba(255,255,255,0.4); }
.page-btn.active { background:#e50914; border-color:#e50914; font-weight:600; }
.page-btn.disabled { opacity:0.35; pointer-events:none; cursor:default; }
.page-ellipsis { color:rgba(255,255,255,0.5); padding:0 8px; }

/* related section, empty, error same as before */
.related-section { margin-top: 80px; padding-top: 40px; border-top: 1px solid rgba(255,255,255,0.1); }
.section-title { font-size:1.3rem; font-weight:700; margin-bottom:16px; }
.related-carousel { display:grid; grid-template-columns: repeat(auto-fill, minmax(160px, 1fr)); gap:12px; }
.related-card img { width:100%; aspect-ratio:2/3; object-fit:cover; border-radius:8px; margin-bottom:8px; }

/* empty / error / buttons */
.empty-state { text-align:center; padding:80px 20px; }
.empty-icon { font-size:4rem; color: rgba(255,255,255,0.15); margin-bottom:20px; }
.btn-back { padding:10px 20px; background:#e50914; color:white; border-radius:8px; display:inline-block; text-decoration:none; border:none; }

/* small responsive tweaks */
@media (max-width:900px) {
    .filter-bar { top:62px; padding:10px; gap:8px; }
    .select[multiple] { min-width: 160px; }
}
    </style>
</head>
<body>
    <!-- Header (site header fragment) -->
    <div th:replace="fragments/header :: header"></div>

    <div class="search-container">
        <!-- Error Banner -->
        <div th:if="${error}" class="error-banner" style="padding:12px 14px; background: rgba(229,9,20,0.12); border-left:4px solid #e50914; border-radius:6px; margin-bottom:12px;">
            <i class="fas fa-exclamation-circle" style="margin-right:8px;"></i>
            <span th:text="${error}">Có lỗi xảy ra</span>
        </div>

        <!-- Search Header -->
        <div class="search-header" th:if="${hasResults}">
            <h1 class="search-title">
                Tìm thấy <span th:text="${totalResults}">0</span> kết quả cho
                <span class="query" th:text="'&quot;' + ${query} + '&quot;'">""</span>
            </h1>

            <!-- Active Filters Display -->
            <div class="filter-tags" th:if="${!selectedGenres.isEmpty() || !yearFrom.isEmpty() || !yearTo.isEmpty() || minRating != '0' || !quickFilter.isEmpty()}">
                <div class="filter-tag" th:if="${!selectedGenres.isEmpty()}">
                    <i class="fas fa-tag"></i> <span th:text="${#strings.join(selectedGenres, ', ')}">Thể loại đã chọn</span>
                </div>
                <div class="filter-tag" th:if="${!yearFrom.isEmpty() || !yearTo.isEmpty()}">
                    <i class="fas fa-calendar"></i>
                    <span th:text="${yearFrom + ' - ' + yearTo}">Năm</span>
                </div>
                <div class="filter-tag" th:if="${minRating != '0'}">
                    <i class="fas fa-star"></i>
                    <span th:text="'Đánh giá ≥ ' + ${minRating}">Rating</span>
                </div>
                <div class="filter-tag" th:if="${quickFilter == 'trending'}">
                    <i class="fas fa-fire"></i><span>Thịnh hành</span>
                </div>
                <div class="filter-tag" th:if="${quickFilter == 'new'}">
                    <i class="fas fa-star"></i><span>Mới nhất</span>
                </div>
                <div class="filter-tag" th:if="${quickFilter == 'top-rated'}">
                    <i class="fas fa-trophy"></i><span>Đánh giá cao</span>
                </div>
            </div>
        </div>

        <!-- FILTER BAR (same filters as search page) -->
        <form id="result-filter-form" class="filter-bar" method="get" action="/search" th:action="@{/search}">
            <div class="filter-search">
                <input id="result-search-input" type="search" name="query" placeholder="Tìm phim, diễn viên, đạo diễn..." class="select" th:value="${query}" aria-label="Tìm kiếm">
                <button type="submit" title="Tìm kiếm"><i class="fas fa-search"></i></button>
            </div>

            <div class="filter-controls">
                <!-- Genres (multi-select). Expects server variable allGenres -->
                <select id="genres-select" name="genres" multiple class="select" th:if="${allGenres != null}">
                    <option th:each="g : ${allGenres}" th:value="${g}" th:text="${g}" th:selected="${selectedGenres != null} ? ${selectedGenres.contains(g)} : false"></option>
                </select>
                <!-- If server didn't supply allGenres, we still render selected genres as single select for fallback -->
                <select id="genres-select-fallback" name="genres" multiple class="select" th:if="${allGenres == null}">
                    <option th:each="g : ${selectedGenres}" th:value="${g}" th:text="${g}" selected></option>
                </select>

                <input id="year-from" name="yearFrom" type="number" min="1900" max="2100" placeholder="Năm từ" class="small-input" style="width:100px;" th:value="${yearFrom}">
                <input id="year-to" name="yearTo" type="number" min="1900" max="2100" placeholder="đến" class="small-input" style="width:100px;" th:value="${yearTo}">

                <select id="minRating" name="minRating" class="select" style="width:110px;">
                    <option value="0" th:selected="${minRating == '0'}">Mọi rating</option>
                    <option th:each="r : ${#numbers.sequence(1,10)}" th:value="${r}" th:text="'≥ ' + ${r}" th:selected="${minRating == ${r}}"></option>
                </select>

                <div class="quick-filters" role="tablist" aria-label="Quick filters">
                    <input type="hidden" id="quickFilterInput" name="quickFilter" th:value="${quickFilter}">
                    <button type="button" class="qf-btn" data-filter="trending" title="Thịnh hành"><i class="fas fa-fire"></i></button>
                    <button type="button" class="qf-btn" data-filter="new" title="Mới nhất"><i class="fas fa-star"></i></button>
                    <button type="button" class="qf-btn" data-filter="top-rated" title="Đánh giá cao"><i class="fas fa-trophy"></i></button>
                </div>
            </div>

            <!-- keep page param so server receives it if provided -->
            <input type="hidden" name="page" id="page-input" th:value="${currentPage}">
        </form>

        <!-- Results Grid -->
        <div class="results-grid" th:if="${hasResults}">
            <div th:each="movie : ${searchResults}" class="movie-card" 
                 th:onclick="'location.href=\'/movie/detail/' + ${movie.id} + '\''">
                <div class="movie-poster">
                    <img th:src="${movie.poster}" th:alt="${movie.title}" loading="lazy">
                    <div class="movie-overlay">
                        <div class="play-icon">
                            <i class="fas fa-play"></i>
                        </div>
                    </div>
                </div>
                <div class="movie-info">
                    <div class="movie-title" th:text="${movie.title}">Movie Title</div>
                    <div class="movie-meta">
                        <span class="movie-year" th:text="${movie.year}">2024</span>
                        <span class="movie-rating">
                            <i class="fas fa-star"></i>
                            <span th:text="${movie.rating}">8.5</span>
                        </span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Pagination -->
        <div class="pagination" th:if="${hasResults && totalPages > 1}">
            <!-- Previous -->
            <a th:if="${currentPage > 1}" href="#" class="page-btn" data-target-page="${currentPage - 1}">
                <i class="fas fa-chevron-left"></i>
            </a>
            <span th:unless="${currentPage > 1}" class="page-btn disabled">
                <i class="fas fa-chevron-left"></i>
            </span>

            <th:block th:with="startPage=${currentPage > 3 ? currentPage - 2 : 1}, endPage=${currentPage + 2 < totalPages ? currentPage + 2 : totalPages}">
                <a th:if="${startPage > 1}" href="#" class="page-btn" data-target-page="1">1</a>
                <span th:if="${startPage > 2}" class="page-ellipsis">...</span>

                <th:block th:each="pageNum : ${#numbers.sequence(startPage, endPage)}">
                    <a href="#" class="page-btn" th:classappend="${pageNum == currentPage} ? ' active' : ''" th:text="${pageNum}" th:attr="data-target-page=${pageNum}">1</a>
                </th:block>

                <span th:if="${endPage < totalPages - 1}" class="page-ellipsis">...</span>
                <a th:if="${endPage < totalPages}" href="#" class="page-btn" th:attr="data-target-page=${totalPages}" th:text="${totalPages}">10</a>
            </th:block>

            <!-- Next -->
            <a th:if="${currentPage < totalPages}" href="#" class="page-btn" data-target-page="${currentPage + 1}">
                <i class="fas fa-chevron-right"></i>
            </a>
            <span th:unless="${currentPage < totalPages}" class="page-btn disabled">
                <i class="fas fa-chevron-right"></i>
            </span>
        </div>

        <!-- Related Movies -->
        <div class="related-section" th:if="${hasResults && !relatedMovies.isEmpty()}">
            <h2 class="section-title">Có thể bạn cũng thích</h2>
            <div class="related-carousel">
                <div th:each="movie : ${relatedMovies}" class="related-card" th:onclick="'location.href=\'/movie/detail/' + ${movie.id} + '\''">
                    <img th:src="${movie.poster}" th:alt="${movie.title}" loading="lazy">
                    <div class="title" th:text="${movie.title}">Title</div>
                    <div class="rating"><i class="fas fa-star"></i> <span th:text="${movie.rating}">8.5</span></div>
                </div>
            </div>
        </div>

        <!-- Empty State -->
        <div class="empty-state" th:unless="${hasResults}">
            <div class="empty-icon"><i class="fas fa-search"></i></div>
            <h2 class="empty-title">Không tìm thấy kết quả</h2>
            <p class="empty-message" th:if="${query}">
                Không có kết quả nào cho từ khóa "<strong th:text="${query}"></strong>"
            </p>
            <p class="empty-message" th:unless="${query}">
                Vui lòng nhập từ khóa để tìm kiếm
            </p>
            <a href="/" class="btn-back"><i class="fas fa-home"></i> Về trang chủ</a>
        </div>
    </div>

    <!-- Hidden server-data for robust client-side parsing -->
    <div id="server-data" style="display:none;"
         th:attr="data-selected-genres=${selectedGenres}, data-year-from=${yearFrom}, data-year-to=${yearTo}, data-min-rating=${minRating}, data-quick-filter=${quickFilter}, data-query=${query}"></div>

    <!-- JS: sync filters, pagination, debounce search -->
    <script>
    (function(){
        // Utility parse robustly arrays rendered by Thymeleaf: try JSON, fallback to CSV.
        function parseServerArray(str){
            if(!str && str !== "") return [];
            try {
                // If Thymeleaf rendered as Java-list -> [a,b], maybe with single quotes. Normalize.
                if(typeof str !== 'string') return [];
                let s = str.trim();
                // If already JSON string e.g. ["a","b"]
                try { return JSON.parse(s); } catch(e) {}
                // replace single quotes with double quotes then parse
                try { return JSON.parse(s.replace(/'/g, '"')); } catch(e) {}
                // fallback: remove brackets then split
                s = s.replace(/^\[|\]$/g,'');
                if(!s) return [];
                return s.split(',').map(x => x.trim().replace(/^"|"$/g,'').replace(/^'|'$/g,'')).filter(Boolean);
            } catch(e) { return []; }
        }

        // Get server-side values
        const sd = document.getElementById('server-data');
        const serverSelectedGenres = sd ? parseServerArray(sd.getAttribute('data-selected-genres')) : [];
        const serverYearFrom = sd ? (sd.getAttribute('data-year-from') || '') : '';
        const serverYearTo = sd ? (sd.getAttribute('data-year-to') || '') : '';
        const serverMinRating = sd ? (sd.getAttribute('data-min-rating') || '0') : '0';
        const serverQuickFilter = sd ? (sd.getAttribute('data-quick-filter') || '') : '';
        const serverQuery = sd ? (sd.getAttribute('data-query') || '') : '';

        // Elements
        const form = document.getElementById('result-filter-form');
        const qInput = document.getElementById('result-search-input');
        const genresSelect = document.getElementById('genres-select') || document.getElementById('genres-select-fallback');
        const yearFromInput = document.getElementById('year-from');
        const yearToInput = document.getElementById('year-to');
        const minRatingSelect = document.getElementById('minRating');
        const quickFilterInput = document.getElementById('quickFilterInput');
        const qfButtons = document.querySelectorAll('.qf-btn');
        const pageInput = document.getElementById('page-input');

        // Init UI with server values (only if inputs exist)
        if(qInput) qInput.value = serverQuery || '';
        if(yearFromInput) yearFromInput.value = serverYearFrom || '';
        if(yearToInput) yearToInput.value = serverYearTo || '';
        if(minRatingSelect) minRatingSelect.value = serverMinRating || '0';
        if(quickFilterInput) quickFilterInput.value = serverQuickFilter || '';

        // mark quick-filter button active
        qfButtons.forEach(btn => {
            const f = btn.getAttribute('data-filter');
            if(f && f === serverQuickFilter) btn.classList.add('active');
            btn.addEventListener('click', function(){
                // toggle active state - allow off
                const target = this.getAttribute('data-filter');
                if(quickFilterInput.value === target){
                    quickFilterInput.value = '';
                    this.classList.remove('active');
                } else {
                    quickFilterInput.value = target;
                    // reset others
                    qfButtons.forEach(b => b.classList.toggle('active', b === this));
                }
                // submit form to refresh results with chosen quickFilter
                pageInput && (pageInput.value = 1);
                form.submit();
            });
        });

        // Pre-select genres from serverSelectedGenres (helps if rendered options not auto-selected)
        if(genresSelect && serverSelectedGenres.length){
            // ensure multiple options selected
            try {
                const opts = Array.from(genresSelect.options || []);
                opts.forEach(o => {
                    o.selected = serverSelectedGenres.some(s => {
                        return String(o.value).trim().toLowerCase() === String(s).trim().toLowerCase();
                    });
                });
            } catch(e) {}
        }

        // Debounce for search input to auto-submit (but keep behavior simple)
        let debounceTimer = null;
        if(qInput){
            qInput.addEventListener('input', function(e){
                // do not auto-submit on every keystroke if user is interacting with other filters; debounce
                clearTimeout(debounceTimer);
                debounceTimer = setTimeout(() => {
                    // when typing new query, go to page 1
                    pageInput && (pageInput.value = 1);
                    form.submit();
                }, 600);
            });
        }

        // Intercept form submit: normalize multi-select values (so Spring/Thymeleaf receives genres repeatedly)
        form.addEventListener('submit', function(e){
            // nothing special required; browser handles multiple selects as repeated query params.
            // But ensure page resets if needed
            pageInput && (pageInput.value = pageInput.value || 1);
        });

        // Handle pagination: all page buttons have data-target-page attribute
        document.querySelectorAll('.pagination .page-btn[data-target-page]').forEach(btn => {
            btn.addEventListener('click', function(e){
                e.preventDefault();
                const target = this.getAttribute('data-target-page');
                if(!target) return;
                // set page and submit form while preserving current client-side filter state
                pageInput && (pageInput.value = target);
                // Build a URL that preserves multiple genres properly then navigate (to improve UX)
                // We'll create a GET form submission programmatically to avoid losing multi-select values
                const tempForm = document.createElement('form');
                tempForm.method = 'get';
                tempForm.action = (form.getAttribute('action') || '/search');

                // helper add input
                function add(name, value) {
                    if(value === undefined || value === null || value === '') return;
                    const i = document.createElement('input');
                    i.type = 'hidden';
                    i.name = name;
                    i.value = value;
                    tempForm.appendChild(i);
                }

                // query
                add('query', qInput ? qInput.value.trim() : '');

                // genres: add each selected option as repeated param
                if(genresSelect){
                    const sel = Array.from(genresSelect.selectedOptions || []);
                    if(sel.length){
                        sel.forEach(opt => add('genres', opt.value));
                    }
                }

                add('yearFrom', yearFromInput ? yearFromInput.value : '');
                add('yearTo', yearToInput ? yearToInput.value : '');
                add('minRating', minRatingSelect ? minRatingSelect.value : '');
                add('quickFilter', quickFilterInput ? quickFilterInput.value : '');
                add('page', target);

                document.body.appendChild(tempForm);
                tempForm.submit();
            });
        });

        // UX: keyboard accessibility for multi-select (optional)
        if(genresSelect){
            genresSelect.addEventListener('keydown', function(e){
                // Enter on select will submit
                if(e.key === 'Enter'){
                    e.preventDefault();
                    pageInput && (pageInput.value = 1);
                    form.submit();
                }
            });
        }

        // If header has a search input (from fragment), keep it synchronized with this page input
        try {
            const headerSearch = document.querySelector('header input[name="query"], [name="query"]');
            if(headerSearch && qInput){
                // set header to server query
                headerSearch.value = qInput.value || '';
                // when header is submitted, keep filters (if header submit is a regular form, it's okay; otherwise:
                headerSearch.addEventListener('keydown', function(e){
                    if(e.key === 'Enter'){
                        // submit the current page's form with header value
                        qInput.value = headerSearch.value;
                        pageInput && (pageInput.value = 1);
                        form.submit();
                    }
                });
            }
        } catch(e){ /* ignore */ }

        // Small performance note: if results grid is > 200 items, server should paginate. Client-side rendering kept light.
    })();
    </script>
</body>
</html>
<script>
    // ============ Search Suggestions Logic ============
    // This script is included in header.html fragment and works on all pages with search input

    // Elements
    const searchInput = document.querySelector('header input[name="query"], [name="query"]');
    const suggestionsPanel = document.createElement('div');
    suggestionsPanel.className = 'search-suggestions-panel';
    suggestionsPanel.style.position = 'absolute';
    suggestionsPanel.style.top = '100%';
    suggestionsPanel.style.left = '0';
    suggestionsPanel.style.right = '0';
    suggestionsPanel.style.background = '#141414';
    suggestionsPanel.style.border = '1px solid rgba(255,255,255,0.1)';
    suggestionsPanel.style.borderTop = 'none';
    suggestionsPanel.style.zIndex = '50';
    suggestionsPanel.style.maxHeight = '300px';
    suggestionsPanel.style.overflowY = 'auto';
    suggestionsPanel.style.display = 'none'; // hidden by default
    suggestionsPanel.style.fontSize = '0.9rem';
    suggestionsPanel.style.boxShadow = '0 4px 12px rgba(0,0,0,0.3)';
    if (searchInput) {
        searchInput.parentNode.style.position = 'relative'; // ensure parent is positioned
        searchInput.parentNode.appendChild(suggestionsPanel);
    }

    let isFetching = false;         // to prevent concurrent fetches
    let currentFocusIndex = -1;     // for keyboard navigation
    let currentSuggestions = [];     // current list of suggestions
    let currentTypeCounts = { movie: 0, tv: 0, person: 0 }; // counts of each type in current suggestions
    let currentTotalCount = 0;      // total number of current suggestions
    let currentPage = 1;            // current page of results (for infinite scroll)
    let isEndOfResults = false;     // whether we've reached the end of available results
    const SUGGESTIONS_PER_PAGE = 10; // number of suggestions to fetch per page
    const MAX_SUGGESTIONS = 30;     // maximum number of suggestions to keep

    const TMDB_API_KEY = 'eac03c4e09a0f5099128e38cb0e67a8f'; 
    const TMDB_BASE_URL = 'https://api.themoviedb.org/3';

    // State for pagination and caching 