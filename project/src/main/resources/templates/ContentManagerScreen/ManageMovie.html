<!DOCTYPE html>
<html lang="vi">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Content Manager - Quản Lý Phim</title>
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
    />
    <style>
      @import url("https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap");

      :root {
        --primary-color: #e50914;
        --background-dark: #0a0a0a;
        --background-light: #141414;
        --background-surface: #1a1a1a;
        --border-color: #2a2a2a;
        --text-primary: #ffffff;
        --text-secondary: #b3b3b3;
        --red-hover: #ff6b6b;
        --red-shadow: rgba(229, 9, 20, 0.4);
      }

      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: "Roboto", "Segoe UI", sans-serif;
        background: var(--background-dark);
        color: var(--text-primary);
        overflow-x: hidden;
        line-height: 1.5;
      }

      


      

      .nav-item {
        display: flex;
        align-items: center;
        gap: 12px;
        padding: 14px 16px;
        margin-bottom: 8px;
        color: var(--text-secondary);
        text-decoration: none;
        border-radius: 8px;
        transition: all 0.3s;
        cursor: pointer;
        position: relative;
      }

      .nav-item::before {
        content: "";
        position: absolute;
        left: 0;
        top: 50%;
        transform: translateY(-50%);
        height: 60%;
        width: 4px;
        background: var(--primary-color);
        border-radius: 0 2px 2px 0;
        opacity: 0;
        transition: all 0.3s;
      }

      .nav-item:hover {
        background: var(--background-surface);
        color: var(--text-primary);
      }

      .nav-item.active {
        background: linear-gradient(
          90deg,
          rgba(229, 9, 20, 0.2) 0%,
          transparent 100%
        );
        color: var(--text-primary);
      }
      .nav-item.active::before {
        opacity: 1;
      }

      .nav-item i {
        width: 20px;
        text-align: center;
      }

      /* Main Content */
      /* Thêm vào thẻ style của ManageMovie.html nếu chưa có */
.main-content {
    margin-left: 260px; /* Bằng width của sidebar */
    padding: 20px;
}
      .header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 30px;
        flex-wrap: wrap;
        gap: 20px;
      }

      .header h1 {
        font-size: 32px;
        font-weight: 600;
        background: linear-gradient(
          135deg,
          var(--text-primary) 0%,
          var(--primary-color) 100%
        );
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
      }

      .header-actions {
    display: flex;
    gap: 10px; /* Giảm gap một chút để tiết kiệm diện tích */
    align-items: center;
    flex-wrap: wrap; /* [QUAN TRỌNG] Cho phép xuống dòng */
    width: 100%; /* Chiếm hết chiều rộng phần còn lại */
    justify-content: flex-end; /* Đẩy về bên phải trên màn hình to */
}

      .import-group {
        display: flex;
      }

      .import-group input {
        background: var(--background-surface);
        border: 1px solid var(--border-color);
        padding: 10px 16px;
        border-radius: 8px 0 0 8px;
        color: var(--text-primary);
        width: 150px;
        outline: none;
        transition: all 0.3s;
      }
      .import-group input:focus {
        border-color: var(--primary-color);
        box-shadow: 0 0 0 3px rgba(229, 9, 20, 0.1);
      }

      .btn {
        padding: 10px 20px;
        border: none;
        border-radius: 8px;
        cursor: pointer;
        font-size: 14px;
        font-weight: 500;
        transition: all 0.3s;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        gap: 8px;
        text-decoration: none;
      }

      .btn-primary {
        background: linear-gradient(
          135deg,
          var(--primary-color) 0%,
          var(--red-hover) 100%
        );
        color: var(--text-primary);
      }

      .btn-primary:hover {
        transform: translateY(-2px);
        box-shadow: 0 8px 20px var(--red-shadow);
      }

      .btn-secondary {
        background: var(--border-color);
        color: var(--text-primary);
      }
      .btn-secondary:hover {
        background: #3a3a3a;
      }

      .import-group .btn-secondary {
        border-radius: 0 8px 8px 0;
        border-left: 0;
      }

      .btn-edit {
        background: linear-gradient(135deg, #ffc107 0%, #ff9800 100%);
        color: #000;
        padding: 8px 16px;
        font-size: 13px;
      }
      .btn-edit:hover {
        transform: translateY(-2px);
      }

      .btn-danger {
        background: linear-gradient(135deg, #dc3545 0%, #c82333 100%);
        color: #fff;
        padding: 8px 16px;
        font-size: 13px;
      }

      .btn-danger:hover {
        transform: translateY(-2px);
        box-shadow: 0 8px 20px rgba(220, 53, 69, 0.4);
      }

      /* Table */
      .table-container {
        background: var(--background-light);
        border-radius: 12px;
        overflow: hidden;
        border: 1px solid var(--border-color);
        box-shadow: 0 8px 32px rgba(0, 0, 0, 0.4);
      }

      table {
        width: 100%;
        border-collapse: collapse;
        table-layout: fixed;
      }

      thead {
        background: rgba(26, 26, 26, 0.8);
      }

      th {
        padding: 16px 12px;
        text-align: left;
        font-weight: 600;
        color: var(--text-secondary);
        font-size: 13px;
        text-transform: uppercase;
        letter-spacing: 0.5px;
      }

      td {
        padding: 14px 12px;
        border-bottom: 1px solid var(--border-color);
        vertical-align: middle;
      }

      /* Cột độ rộng */
      th:nth-child(1),
      td:nth-child(1) {
        width: 6%;
        text-align: center;
      } /* ID */
      th:nth-child(2),
      td:nth-child(2) {
        width: 30%;
      } /* Tiêu đề */
      th:nth-child(3),
      td:nth-child(3) {
        width: 12%;
      } /* Ảnh */
      th:nth-child(4),
      td:nth-child(4) {
        width: 10%;
        text-align: center;
      } /* Thời lượng */
      th:nth-child(5),
      td:nth-child(5) {
        width: 12%;
        text-align: center;
      } /* Miễn phí */
      th:nth-child(6),
      td:nth-child(6) {
        width: 10%;
        text-align: center;
      } /* TMDB ID */
      th:nth-child(7),
      td:nth-child(7) {
        width: 20%;
        text-align: center;
      } /* Hành động */

      /* Cột tiêu đề (cho phép truncate) */
      td:nth-child(2) {
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
        font-weight: 500;
      }

      /* Cột ảnh poster */
      .table-poster {
        width: 45px;
        height: 60px;
        object-fit: cover;
        border-radius: 4px;
        background: var(--background-surface);
      }

      tbody tr:hover {
        background: rgba(229, 9, 20, 0.05);
      }

      tbody tr:last-child td {
        border-bottom: none;
      }

      .badge {
        display: inline-block;
        padding: 6px 12px;
        border-radius: 20px;
        font-size: 12px;
        font-weight: 600;
        text-transform: uppercase;
      }

      .badge-active {
        background: linear-gradient(
          135deg,
          rgba(40, 167, 69, 0.2),
          rgba(40, 167, 69, 0.4)
        );
        color: #28a745;
        border: 1px solid rgba(40, 167, 69, 0.3);
      }

      .badge-inactive {
        background: linear-gradient(
          135deg,
          rgba(220, 53, 69, 0.2),
          rgba(220, 53, 69, 0.4)
        );
        color: #dc3545;
        border: 1px solid rgba(220, 53, 69, 0.3);
      }

      .action-buttons {
        display: flex;
        gap: 8px;
        justify-content: center;
      }
.search-box {
    position: relative;
    /* Không set margin-right cứng nữa, dùng gap của flex cha */
    flex-grow: 1; /* Tự động giãn nở */
    max-width: 300px; /* Giới hạn độ rộng tối đa */
    min-width: 200px; /* Giới hạn độ rộng tối thiểu */
}

.search-box input {
    background: var(--background-surface);
    border: 1px solid var(--border-color);
    padding: 10px 40px 10px 16px;
    border-radius: 8px;
    color: var(--text-primary);
    width: 100%; /* [QUAN TRỌNG] Ăn theo thẻ cha search-box */
    outline: none;
    transition: all 0.3s;
}
/* Style lại Select box cho đồng bộ chiều cao */
.filter-select {
    padding: 10px; 
    border-radius: 8px; 
    background: #1a1a1a; 
    color: white; 
    border: 1px solid #333;
    /* margin-right xóa đi vì đã dùng gap */
    height: 42px; /* Fix chiều cao bằng với input để thẳng hàng */
}

.search-box input:focus {
    border-color: var(--primary-color);
    box-shadow: 0 0 0 3px rgba(229, 9, 20, 0.1);
}

.search-box i {
    position: absolute;
    right: 14px;
    top: 50%;
    transform: translateY(-50%);
    color: var(--text-secondary);
    pointer-events: none;
}

      /* Modal */
      .modal {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.85);
        backdrop-filter: blur(5px);
        z-index: 1000;
        align-items: center;
        justify-content: center;
      }

      .modal.active {
        display: flex;
        animation: fadeIn 0.3s ease;
      }

      @keyframes fadeIn {
        from {
          opacity: 0;
        }
        to {
          opacity: 1;
        }
      }

      .modal-content {
        background: var(--background-light);
        border-radius: 12px;
        width: 90%;
        max-width: 700px; /* Rộng hơn cho form nhiều trường */
        border: 1px solid var(--border-color);
        animation: modalSlide 0.3s ease-out;
        box-shadow: 0 20px 60px rgba(0, 0, 0, 0.8);
        display: flex;
        flex-direction: column;
      }

      @keyframes modalSlide {
        from {
          opacity: 0;
          transform: translateY(-30px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }

      .modal-header {
        padding: 20px 24px;
        border-bottom: 1px solid var(--border-color);
        display: flex;
        justify-content: space-between;
        align-items: center;
      }

      .modal-title {
        font-size: 22px;
        font-weight: 600;
        color: var(--text-primary);
      }

      .close-modal {
        background: var(--border-color);
        border: none;
        color: var(--text-secondary);
        font-size: 16px;
        cursor: pointer;
        width: 32px;
        height: 32px;
        display: flex;
        align-items: center;
        justify-content: center;
        border-radius: 50%;
        transition: all 0.3s;
      }

      .close-modal:hover {
        background: var(--primary-color);
        color: var(--text-primary);
        transform: rotate(90deg);
      }

      .modal-body {
        padding: 24px;
        max-height: 70vh;
        overflow-y: auto;
      }

      /* Scrollbar */
      .modal-body::-webkit-scrollbar {
        width: 8px;
      }
      .modal-body::-webkit-scrollbar-track {
        background: var(--background-dark);
        border-radius: 4px;
      }
      .modal-body::-webkit-scrollbar-thumb {
        background: var(--primary-color);
        border-radius: 4px;
      }

      /* Form Grid (from ManageAccount) */
      .form-grid {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 20px;
      }

      .form-group {
        margin-bottom: 0; /* Xóa margin vì grid đã có gap */
      }

      .form-group.full-width {
        grid-column: 1 / -1;
      }

      .form-group label {
        display: block;
        margin-bottom: 8px;
        color: var(--text-secondary);
        font-size: 14px;
        font-weight: 500;
      }

      .form-group input,
      .form-group select,
      .form-group textarea {
        width: 100%;
        padding: 12px 16px;
        background: var(--background-dark);
        border: 1px solid var(--border-color);
        border-radius: 8px;
        color: var(--text-primary);
        font-size: 14px;
        outline: none;
        font-family: inherit;
        transition: all 0.3s;
      }

      .form-group input:focus,
      .form-group select:focus,
      .form-group textarea:focus {
        border-color: var(--primary-color);
        box-shadow: 0 0 0 3px rgba(229, 9, 20, 0.1);
      }

      .form-group input::placeholder,
      .form-group textarea::placeholder {
        color: #555;
      }

      /* CSS cho validation */
      .form-group input:invalid {
        border-color: var(--primary-color);
      }

      .form-group textarea {
        min-height: 100px;
        resize: vertical;
      }

      .modal-footer {
        padding: 20px 24px;
        border-top: 1px solid var(--border-color);
        display: flex;
        justify-content: flex-end;
        gap: 12px;
        background: rgba(10, 10, 10, 0.5);
      }

      /* Toast (from ManageAccount) */
      .toast {
        position: fixed;
        top: 20px;
        right: 20px;
        background: var(--background-surface);
        color: var(--text-primary);
        padding: 16px 24px;
        border-radius: 8px;
        box-shadow: 0 8px 32px rgba(0, 0, 0, 0.6);
        z-index: 2000;
        display: none; /* Thay đổi: mặc định là none */
        align-items: center;
        gap: 12px;
        min-width: 300px;
      }

      .toast.show {
        display: flex;
        animation: slideIn 0.3s ease, fadeOut 0.3s ease 2.7s forwards;
      }

      @keyframes slideIn {
        from {
          transform: translateX(100%);
          opacity: 0;
        }
        to {
          transform: translateX(0);
          opacity: 1;
        }
      }

      @keyframes fadeOut {
        from {
          opacity: 1;
        }
        to {
          opacity: 0;
        }
      }

      .toast.success {
        border-left: 4px solid #28a745;
      }
      .toast.error {
        border-left: 4px solid #dc3545;
      }

      .toast-icon {
        font-size: 24px;
      }
      .toast.success .toast-icon {
        color: #28a745;
      }
      .toast.error .toast-icon {
        color: #dc3545;
      }

      /* Empty State (from ManageAccount) */
      .empty-state {
        text-align: center;
        padding: 60px 20px;
        color: #666;
        display: none; /* Mặc định ẩn */
      }
      .empty-state i {
        font-size: 64px;
        margin-bottom: 20px;
        opacity: 0.5;
      }
      .empty-state h3 {
        font-size: 20px;
        margin-bottom: 10px;
      }

      @media (max-width: 992px) {
    /* Khi màn hình bắt đầu hơi nhỏ (Tablet ngang) */
    .header {
        flex-direction: column;
        align-items: stretch; /* Kéo giãn full chiều ngang */
        gap: 15px;
    }
    
    .header-actions {
        justify-content: flex-start; /* Canh trái khi xuống dòng */
    }
}
     @media (max-width: 768px) {
    /* Mobile và Tablet dọc */
    .sidebar {
        transform: translateX(-100%); /* Ẩn sidebar */
        position: fixed;
        z-index: 1000;
        height: 100%;
    }
    
    .main-content {
        margin-left: 0;
        padding: 15px; /* Giảm padding một chút */
    }

    /* Header biến thành dạng Stack (xếp chồng) */
    .header h1 {
        font-size: 24px;
        text-align: center;
        margin-bottom: 10px;
    }

    .header-actions {
        display: grid; /* Chuyển sang Grid để dễ chia cột */
        grid-template-columns: 1fr 1fr; /* Chia 2 cột cho các nút */
        gap: 10px;
    }

    /* Các phần tử chiếm trọn 1 hàng (full-width) */
    .search-box, 
    .import-group,
    #filterFree { 
        grid-column: 1 / -1; /* Chiếm hết 2 cột */
        max-width: 100%;
        width: 100%;
    }
    
    .import-group input {
        width: 100%; /* Input import giãn ra */
        flex: 1;
    }

    /* Button Import chỉnh lại cho đẹp */
    .import-group .btn-secondary {
        white-space: nowrap;
    }
    
    /* Các nút chức năng (Smart, Daily, Add...) sẽ tự chia 2 cột */
    .btn {
        width: 100%; /* Nút giãn full ô grid */
        justify-content: center;
    }

    /* Table responsive */
    .table-container {
        overflow-x: auto;
        -webkit-overflow-scrolling: touch; /* Mượt mà trên iOS */
    }
    
    /* Ẩn bớt cột không quan trọng trên mobile nếu cần (tùy chọn) */
    /* th:nth-child(4), td:nth-child(4), */ /* Thời lượng */
    /* th:nth-child(6), td:nth-child(6) { display: none; } */ /* TMDB ID */
}
/* Container phân trang */
#pagination {
    display: flex;
    justify-content: center;
    align-items: center;
    gap: 8px;
    padding: 20px 0;
    flex-wrap: wrap;
}

/* Các nút trang số */
.page-link {
    min-width: 36px;
    height: 36px;
    padding: 0 6px;
    border-radius: 6px;
    background: var(--background-surface);
    border: 1px solid var(--border-color);
    color: var(--text-secondary);
    font-size: 14px;
    font-weight: 500;
    cursor: pointer;
    transition: all 0.2s;
    display: flex;
    align-items: center;
    justify-content: center;
}
.page-link:hover:not(:disabled):not(.active) {
    background: #333;
    color: var(--text-primary);
    border-color: #555;
}
/* Nút trang hiện tại */
.page-link.active {
    background: var(--primary-color);
    color: white;
    border-color: var(--primary-color);
    pointer-events: none; /* Không click lại trang đang đứng */
}
/* Dấu ... */
.page-ellipsis {
    color: var(--text-secondary);
    padding: 0 4px;
}
/* Input nhảy trang nhanh */
.page-jump-input {
    width: 50px;
    height: 36px;
    background: var(--background-dark);
    border: 1px solid var(--border-color);
    border-radius: 6px;
    color: white;
    text-align: center;
    margin-left: 10px;
    outline: none;
}
.page-jump-input:focus {
    border-color: var(--primary-color);
}

@media (max-width: 480px) {
    /* Mobile nhỏ (iPhone SE...) */
    .header-actions {
        grid-template-columns: 1fr; /* Về 1 cột duy nhất */
    }
}
/* Badge trạng thái hệ thống */
.scan-status-badge {
    display: inline-flex;
    align-items: center;
    gap: 8px;
    padding: 8px 12px;
    background: rgba(255, 255, 255, 0.1);
    border-radius: 20px;
    border: 1px solid var(--border-color);
    margin-right: 10px;
    font-size: 13px;
    color: var(--text-secondary);
}

.status-dot {
    width: 8px;
    height: 8px;
    border-radius: 50%;
    background-color: #666;
    transition: all 0.3s ease;
}

/* Hiệu ứng khi đang chạy */
.status-dot.running {
    background-color: #28a745; /* Màu xanh */
    box-shadow: 0 0 8px #28a745;
    animation: pulse 1.5s infinite;
}

@keyframes pulse {
    0% { opacity: 0.5; }
    50% { opacity: 1; }
    100% { opacity: 0.5; }
}

/* Ẩn hiện nút mượt mà */
.btn-scan {
    transition: all 0.3s ease;
}
    </style>
  </head>
  <body>
    <div th:replace="~{fragments/manager-sidebar :: sidebar('content')}"></div>

    <div class="main-content">
      <div class="header">
        <h1>Quản lý phim</h1>
        <div class="header-actions">
        
          <div class="scan-status-badge">
            <div id="statusDot" class="status-dot"></div>
            <span id="statusText">Hệ thống nghỉ</span>
          </div>
        
          <button id="btnSmart" class="btn btn-scan" onclick="confirmScanAction('scan-smart')"
            style="background: linear-gradient(135deg, #0061ff, #60efff); color: white; border: none;">
            <i class="fas fa-brain"></i> <span class="hide-on-mobile">Quét 5000 Phim</span>
          </button>
        
          <button id="btnDaily" class="btn btn-scan" onclick="confirmScanAction('scan-daily')"
            style="background: linear-gradient(135deg, #ff9966, #ff5e62); color: white; border: none;">
            <i class="fas fa-sync-alt"></i> <span class="hide-on-mobile">Update Daily</span>
          </button>
        
          <button id="btnStop" class="btn btn-scan" onclick="confirmScanAction('stop-scan')"
            style="background: #dc3545; color: white; border: none; display: none;">
            <i class="fas fa-ban"></i> Dừng Quét
          </button>
        
          <div class="import-group">
            <input type="text" id="tmdbIdInput" placeholder="TMDB ID..." style="min-width: 100px;">
            <button class="btn btn-secondary" onclick="importFromTmdb()">
              <i class="fas fa-cloud-download-alt"></i>
            </button>
          </div>
        
          <select id="filterFree" class="filter-select" onchange="resetAndLoad()"
            style="padding: 10px; border-radius: 8px; background: #1a1a1a; color: white; border: 1px solid #333;">
            <option value="">Tất cả</option>
            <option value="true">Miễn phí</option>
            <option value="false">Trả phí</option>
          </select>
        
          <div class="search-box">
            <input type="text" id="localSearchInput" placeholder="Tìm kiếm..." onkeyup="handleLocalSearch()">
            <i class="fas fa-search"></i>
          </div>
        
          <button class="btn btn-primary" onclick="openModal('add')">
            <i class="fas fa-plus"></i> Thêm
          </button>
        </div>
      </div>

      <div class="table-container">
        <table>
          <thead>
            <tr>
              <th>ID</th>
              <th>Tiêu đề</th>
              <th>Poster</th>
              <th>Thời lượng</th>
              <th>Miễn phí</th>
              <th>TMDB ID</th>
              <th>Hành động</th>
            </tr>
          </thead>
          <tbody id="movieTableBody"></tbody>
        </table>
        <div id="emptyState" class="empty-state">
          <i class="fas fa-video-slash"></i>
          <h3>Chưa có phim nào</h3>
          <p>Hãy thêm phim mới hoặc import từ TMDB.</p>
        </div>
      </div>
      <div id="pagination" style="padding: 20px; display: flex; justify-content: center; align-items: center; gap: 10px;"></div>
    </div>

    <div class="modal" id="scanModal">
    <div class="modal-content" style="max-width: 400px;">
        <div class="modal-header">
            <span class="modal-title">Quét Phim Hàng Loạt</span>
            <button class="close-modal" onclick="closeScanModal()"><i class="fas fa-times"></i></button>
        </div>
        <div class="modal-body">
            <p style="color: #bbb; margin-bottom: 15px; font-size: 0.9rem;">
                Quét phim từ danh sách "Popular" của TMDB. <br>
                (1 trang ~ 20 phim. Quét 500 trang = 10.000 phim).
            </p>
            <div class="form-group">
                <label>Từ trang (Start Page)</label>
                <input type="number" id="scanFrom" value="1" min="1">
            </div>
            <div class="form-group">
                <label>Đến trang (End Page)</label>
                <input type="number" id="scanTo" value="5" min="1">
            </div>
        </div>
        <div class="modal-footer">
            <button class="btn btn-secondary" onclick="closeScanModal()">Đóng</button>
            <button class="btn btn-primary" onclick="startBulkScan()">Bắt đầu Quét</button>
        </div>
    </div>
</div>
    <div class="modal" id="movieModal">
      <div class="modal-content">
        <div class="modal-header">
          <span class="modal-title" id="modalTitle">Thêm phim mới</span>
          <button class="close-modal" onclick="closeModal()">
            <i class="fas fa-times"></i>
          </button>
        </div>
        <div class="modal-body">
          <form id="movieForm" onsubmit="event.preventDefault(); saveMovie();">
            <input type="hidden" id="movieId" />
            <div class="form-grid">
              <div class="form-group">
                <label for="title">Tiêu đề *</label>
                <input
                  type="text"
                  id="title"
                  required
                  placeholder="Vd: Avengers: Endgame"
                />
              </div>
              <div class="form-group">
                <label for="releaseDate">Ngày phát hành *</label>
                <input type="date" id="releaseDate" required />
              </div>
              <div class="form-group">
                <label for="duration">Thời lượng (phút) *</label>
                <input type="number" id="duration" value="0" min="0" required />
              </div>
              <div class="form-group">
                <label for="rating">Rating (0-10) *</label>
                <input type="number" id="rating" step="any" value="0.0" min="0" max="10" required />
              </div>

              <div class="form-group full-width">
                <label for="description">Mô tả</label>
                <textarea
                  id="description"
                  rows="3"
                  placeholder="Nhập mô tả phim..."
                ></textarea>
              </div>

              <div class="form-group full-width">
                <label for="url">URL Video *</label>
                <input
                  type="text"
                  id="url"
                  required
                  placeholder="Vd: https://.../video.m3u8 hoặc CHƯA CẬP NHẬT"
                />
              </div>

              <div class="form-group">
                <label for="posterPath">Poster Path</label>
                <input
                  type="text"
                  id="posterPath"
                  placeholder="Vd: /abc.jpg (lấy từ TMDB) hoặc https://..."
                />
              </div>
              <div class="form-group">
                <label for="backdropPath">Backdrop Path</label>
                <input
                  type="text"
                  id="backdropPath"
                  placeholder="Vd: /xyz.jpg (lấy từ TMDB) hoặc https://..."
                />
              </div>

              <div class="form-group">
                <label for="isFree">Loại phim</label>
                <select id="isFree">
                  <option value="false">Trả phí</option>
                  <option value="true">Miễn phí</option>
                </select>
              </div>
            </div>
          </form>
        </div>
        <div class="modal-footer">
          <button
            type="button"
            class="btn btn-secondary"
            onclick="closeModal()"
          >
            Hủy
          </button>
          <button type="submit" form="movieForm" class="btn btn-primary">
            <i class="fas fa-save"></i> Lưu
          </button>
        </div>
      </div>
    </div>

    <div class="modal" id="deleteConfirmModal">
      <div class="modal-content" style="max-width: 500px">
        <div class="modal-header">
          <span class="modal-title">Xác nhận xóa phim</span>
          <button class="close-modal" onclick="closeDeleteModal()">
            <i class="fas fa-times"></i>
          </button>
        </div>
        <div class="modal-body">
          <p id="deleteConfirmMessage"></p>
          <p style="color: #ffc107; margin-top: 10px; font-weight: 500">
            <i class="fas fa-exclamation-triangle"></i> Hành động này không thể
            hoàn tác.
          </p>
        </div>
        <div class="modal-footer">
          <button
            type="button"
            class="btn btn-secondary"
            onclick="closeDeleteModal()"
          >
            Hủy
          </button>
          <button
            type="button"
            class="btn btn-danger"
            id="confirmDeleteBtn"
            onclick="confirmDelete()"
          >
            <i class="fas fa-trash"></i> Xóa vĩnh viễn
          </button>
        </div>
      </div>
    </div>
    <div class="modal" id="scanConfirmModal">
      <div class="modal-content" style="max-width: 450px; background: #1a1a1a; border: 1px solid #333;">
        <div class="modal-header" style="border-bottom: 1px solid #333;">
          <span class="modal-title"><i class="fas fa-robot" style="color: #0061ff;"></i> Xác nhận tác vụ</span>
          <button class="close-modal" onclick="closeScanConfirmModal()"><i class="fas fa-times"></i></button>
        </div>
        <div class="modal-body">
          <p id="scanConfirmMessage" style="font-size: 15px; color: #ddd; line-height: 1.6;"></p>
        </div>
        <div class="modal-footer" style="border-top: 1px solid #333; background: transparent;">
          <button class="btn btn-secondary" onclick="closeScanConfirmModal()">Hủy bỏ</button>
          <button class="btn btn-primary" id="btnExecuteScan">
            <i class="fas fa-check"></i> Xác nhận chạy
          </button>
        </div>
      </div>
    </div>

    <div class="toast" id="toast">
      <i class="toast-icon fas fa-check-circle"></i>
      <span id="toastMessage"></span>
    </div>

    <script>
      const API_URL = "/api/content/movies";
      let currentMode = "add";
      let currentId = null;

      document.addEventListener('DOMContentLoaded', () => loadMovies(0));
      // Khai báo biến controller ở phạm vi ngoài hàm (Global variable)
let currentRequestController = null;

async function loadMovies(page = 0) {
    // 1. [XỬ LÝ THAM SỐ AN TOÀN] 
    // Nếu page không được truyền vào (undefined/null) hoặc không phải số -> Gán mặc định về 0 (trang đầu)
    if (page === undefined || page === null || isNaN(page)) {
        page = 0;
    }

    // 2. [HỦY REQUEST CŨ] (Debounce/Cancel previous request)
    // Nếu đang có một request loadMovies khác đang chạy, hủy nó ngay lập tức
    if (currentRequestController) {
        currentRequestController.abort();
    }
    // Tạo controller mới cho request lần này
    currentRequestController = new AbortController();
    const signal = currentRequestController.signal;

    // Cập nhật biến toàn cục currentPage để dùng cho phân trang
    currentPage = page;

    const keyword = document.getElementById('localSearchInput').value.trim();
    const isFree = document.getElementById('filterFree').value;
    const tbody = document.getElementById('movieTableBody');
    
    // Hiệu ứng mờ bảng để người dùng biết đang tải
    if (tbody) tbody.style.opacity = '0.5';

    // Xây dựng URL
    let url = `/api/content/movies/manage?page=${page}&size=${pageSize}&sortBy=movieID&direction=desc`;
    if (keyword) url += `&keyword=${encodeURIComponent(keyword)}`;
    if (isFree) url += `&isFree=${isFree}`;

    try {
        // Truyền 'signal' vào fetch để có thể hủy nếu cần
        const res = await fetch(url, { signal });
        
        if (!res.ok) throw new Error('Load failed'); 
        
        const data = await res.json();
        
        // Render dữ liệu
        renderTable(data.content);
        
        // Render phân trang
        if (typeof renderPagination === 'function') {
            renderPagination(data);
        }
        
    } catch (error) {
        // [QUAN TRỌNG] Nếu lỗi do mình chủ động hủy (AbortError) thì bỏ qua, không báo lỗi đỏ
        if (error.name === 'AbortError') {
            console.log('Hủy request cũ để ưu tiên request mới.');
            return; 
        }
        
        console.error("Chi tiết lỗi:", error);
        // Chỉ hiện thông báo lỗi nếu không phải do hủy request
        if (typeof showToast === 'function') {
            showToast('error', 'Lỗi tải dữ liệu: ' + error.message);
        }
    } finally {
        // Chỉ tắt hiệu ứng loading nếu request này KHÔNG bị hủy
        if (!signal.aborted) {
            if (tbody) tbody.style.opacity = '1';
            currentRequestController = null; // Reset controller
        }
    }
}
      /**
       * Đây là hàm đã được sửa lỗi logic hiển thị poster
       */
      function renderTable(movies) {
    const tbody = document.getElementById("movieTableBody");
    const emptyState = document.getElementById("emptyState");
    tbody.innerHTML = "";

    // 1. Kiểm tra dữ liệu đầu vào
    if (!movies || movies.length === 0) {
        emptyState.style.display = "block"; // Sửa thành 'block' hoặc 'table-row' tùy CSS của bạn, thường là 'block' cho div
        return;
    }
    emptyState.style.display = "none";

    // 2. Sắp xếp ID mới nhất lên đầu
    movies.sort((a, b) => b.movieID - a.movieID);

    // 3. Render từng hàng
    movies.forEach((movie) => {
        const tr = document.createElement("tr");
        const deleteAction = `openDeleteModal(${movie.movieID}, '${escapeHtml(movie.title)}')`;

        // === XỬ LÝ LOGIC POSTER (GIỮ NGUYÊN) ===
        let posterUrl = "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7"; // Placeholder
        if (movie.posterPath) {
            const path = movie.posterPath.trim();
            if (path.startsWith("http://") || path.startsWith("https://")) {
                posterUrl = path;
            } else {
                const tmdbPath = path.startsWith("/") ? path : "/" + path;
                posterUrl = `https://image.tmdb.org/t/p/w92${tmdbPath}`;
            }
        }

        // === [MỚI] XỬ LÝ HIỂN THỊ TMDB ID ===
        // Nếu ID > 0: Hiển thị số ID kèm link sang trang TMDB (tiện lợi cho việc tra cứu)
        // Nếu ID <= 0 hoặc null: Hiển thị badge "Thủ công"
        let tmdbDisplay = "";
        if (movie.tmdbId && movie.tmdbId > 0) {
            tmdbDisplay = `<a href="https://www.themoviedb.org/movie/${movie.tmdbId}" target="_blank" 
                              style="color: #e50914; text-decoration: none; font-weight: 500;" title="Xem trên TMDB">
                              ${movie.tmdbId} <i class="fas fa-external-link-alt" style="font-size: 10px; margin-left: 3px;"></i>
                           </a>`;
        } else {
            tmdbDisplay = `<span class="badge" style="background: #444; color: #ccc; border: 1px solid #666;">Thủ công</span>`;
        }

        // === RENDER HTML CỦA HÀNG ===
        tr.innerHTML = `
            <td style="text-align: center;">${movie.movieID}</td>
            
            <td title="${escapeHtml(movie.title)}" style="font-weight: 500;">
                ${escapeHtml(movie.title)}
            </td>
            
            <td style="text-align: center;">
                <img src="${posterUrl}" alt="Poster" class="table-poster" 
                     style="width: 45px; height: 65px; object-fit: cover; border-radius: 4px; background: #222;"
                     onerror="this.src='data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7'; this.style.opacity=0.3;">
            </td>
            
            <td style="text-align: center;">${movie.duration} phút</td>
            
            <td style="text-align: center;">
                ${movie.free 
                    ? '<span class="badge badge-active">Miễn phí</span>' 
                    : '<span class="badge badge-inactive">Trả phí</span>'}
            </td>
            
            <td style="text-align: center;">
                ${tmdbDisplay} </td>
            
            <td style="text-align: center;">
                <div class="action-buttons" style="justify-content: center;">
                    <button class="btn btn-edit" onclick="openModal('edit', ${movie.movieID})">
                        <i class="fas fa-edit"></i> Sửa
                    </button>
                    <button class="btn btn-danger" onclick="${deleteAction}">
                        <i class="fas fa-trash"></i> Xóa
                    </button>
                </div>
            </td>
        `;
        tbody.appendChild(tr);
    });
}
      function openModal(mode, id = null) {
        currentMode = mode;
        currentId = id;
        const modal = document.getElementById("movieModal");
        const title = document.getElementById("modalTitle");
        document.getElementById("movieForm").reset();

        if (mode === "add") {
          title.textContent = "Thêm phim mới";
        } else {
          title.textContent = "Cập nhật phim";
          fetch(`${API_URL}/${id}`)
            .then((res) => {
              if (!res.ok) throw new Error("Không tìm thấy phim");
              return res.json();
            })
            .then((movie) => {
              document.getElementById("movieId").value = movie.movieID;
              document.getElementById("title").value = movie.title;
              document.getElementById("description").value = movie.description;
              document.getElementById("releaseDate").value = movie.releaseDate
                ? movie.releaseDate.split("T")[0]
                : "";
              document.getElementById("duration").value = movie.duration;
              document.getElementById("rating").value = movie.rating;
              document.getElementById("url").value = movie.url;
              document.getElementById("posterPath").value = movie.posterPath;
              document.getElementById("backdropPath").value =
                movie.backdropPath;
              document.getElementById("isFree").value = movie.free
                ? "true"
                : "false";
            })
            .catch((err) => {
              console.error(err);
              showToast("error", "Không thể tải chi tiết phim.");
              closeModal();
            });
        }
        modal.classList.add("active");
      }

      function closeModal() {
        document.getElementById("movieModal").classList.remove("active");
      }

      // ================= VALIDATION =================
      function validateForm() {
        const title = document.getElementById("title").value.trim();
        const releaseDate = document.getElementById("releaseDate").value;
        const duration = parseInt(document.getElementById("duration").value);
        const rating = parseFloat(document.getElementById("rating").value);
        const url = document.getElementById("url").value.trim();

        if (!title) {
          showToast("error", "Tiêu đề phim không được để trống.");
          return false;
        }
        if (!releaseDate) {
          showToast("error", "Ngày phát hành không được để trống.");
          return false;
        }
        if (isNaN(duration) || duration < 0) {
          showToast("error", "Thời lượng phải là một số không âm.");
          return false;
        }
        if (isNaN(rating) || rating < 0 || rating > 10) {
          showToast("error", "Rating phải là một số từ 0 đến 10.");
          return false;
        }
        if (!url) {
          showToast("error", "URL Video không được để trống.");
          return false;
        }
        // Khi thêm mới, không chấp nhận URL mặc định "CHƯA CẬP NHẬT"
        if (currentMode === "add" && url.toUpperCase() === "CHƯA CẬP NHẬT") {
          showToast("error", "Vui lòng cung cấp URL video cụ thể.");
          return false;
        }
        return true;
      }

      async function saveMovie() {
        // Chạy validation trước
        if (!validateForm()) {
          return;
        }

        // Lấy dữ liệu (sau khi đã validate)
        const movieRequest = {
          title: document.getElementById("title").value.trim(),
          description: document.getElementById("description").value.trim(),
          releaseDate: document.getElementById("releaseDate").value || null,
          duration: parseInt(document.getElementById("duration").value) || 0,
          rating: parseFloat(document.getElementById("rating").value) || 0,
          url: document.getElementById("url").value.trim(),
          posterPath: document.getElementById("posterPath").value.trim(),
          backdropPath: document.getElementById("backdropPath").value.trim(),
          free: document.getElementById("isFree").value === "true",
          categoryIds: [], // Sẽ cập nhật ở bước sau
          personIds: [], // Sẽ cập nhật ở bước sau
        };

        let url = API_URL;
        let method = "POST";

        if (currentMode === "edit") {
          url = `${API_URL}/${currentId}`;
          method = "PUT";
        }

        try {
          const response = await fetch(url, {
            method: method,
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(movieRequest),
          });

          if (!response.ok) {
            // Cố gắng đọc lỗi JSON từ server (do GlobalExceptionHandler trả về)
            let errorMsg = "Lỗi lưu phim";
            try {
              // Thử parse JSON trước
              const errorData = await response.json();
              // Lấy lỗi từ validation
              if (errorData.errors) {
                errorMsg = Object.values(errorData.errors).join(", ");
              } else {
                errorMsg = errorData.message || "Lỗi không xác định";
              }
            } catch (e) {
              // Nếu không phải JSON, đọc text
              errorMsg = await response.text();
            }
            throw new Error(errorMsg);
          }

          showToast(
            "success",
            currentMode === "add"
              ? "Thêm phim thành công!"
              : "Cập nhật phim thành công!"
          );
          closeModal();
          loadMovies(currentPage);
        } catch (error) {
          console.error("Save error:", error);
          showToast("error", error.message);
        }
      }

    async function importFromTmdb() {
    const tmdbIdInput = document.getElementById('tmdbIdInput').value; 
    
    if (!tmdbIdInput) {
        alert("Vui lòng nhập TMDB ID");
        return;
    }

    const verifyBtn = document.querySelector('.import-group .btn-secondary'); // Selector chính xác hơn
    const originalText = verifyBtn.innerHTML;
    verifyBtn.disabled = true;
    verifyBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Đang xử lý...';

    try {
        // [FIX QUAN TRỌNG] Sửa đường dẫn từ /content-manager... thành /api/content...
        const response = await fetch(`/api/content/movies/import-tmdb?tmdbId=${tmdbIdInput}`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            }
        });

        // Đọc JSON an toàn
        let data;
        const contentType = response.headers.get("content-type");
        if (contentType && contentType.indexOf("application/json") !== -1) {
            data = await response.json();
        } else {
            // Nếu server trả về lỗi HTML (ví dụ 404, 500 trang mặc định)
            throw new Error("Server trả về phản hồi không hợp lệ (không phải JSON). Kiểm tra đường dẫn API.");
        }

        if (response.ok) {
            showToast("success", data.message || "Import thành công!");
            // Đợi 1s rồi load lại bảng
            setTimeout(() => {
                location.reload();
            }, 1000);
        } else {
            // Hiển thị lỗi từ Backend (ví dụ: Phim đã tồn tại)
            showToast("error", data.error || "Có lỗi xảy ra");
        }

    } catch (error) {
        console.error('Error:', error);
        showToast("error", "Lỗi: " + error.message);
    } finally {
        verifyBtn.disabled = false;
        verifyBtn.innerHTML = originalText;
    }
}

      // --- Delete Modal Functions ---
      function openDeleteModal(id, title) {
        document.getElementById("confirmDeleteBtn").dataset.movieId = id;
        document.getElementById(
          "deleteConfirmMessage"
        ).innerHTML = `Bạn có chắc chắn muốn xóa phim <strong style="color: var(--primary-color)">"${escapeHtml(
          title
        )}"</strong>?`;
        document.getElementById("deleteConfirmModal").classList.add("active");
      }

      function closeDeleteModal() {
        document
          .getElementById("deleteConfirmModal")
          .classList.remove("active");
      }

      async function confirmDelete() {
        const id = document.getElementById("confirmDeleteBtn").dataset.movieId;
        if (!id) return;

        try {
          const response = await fetch(`${API_URL}/${id}`, {
            method: "DELETE",
          });

          if (!response.ok) {
            let errorMsg = "Lỗi xóa phim";
            try {
              const errorData = await response.json();
              errorMsg = errorData.message || "Lỗi không xác định";
            } catch (e) {
              errorMsg = await response.text();
            }
            throw new Error(errorMsg);
          }

          closeDeleteModal();
          showToast("success", "Xóa phim thành công!");
          loadMovies(currentPage);
        } catch (error) {
          console.error("Delete error:", error);
          closeDeleteModal();
          showToast("error", error.message);
        }
      }

      // --- Utilities ---
      let toastTimeout;
      function showToast(type, message) {
        const toast = document.getElementById("toast");
        const icon = toast.querySelector(".toast-icon");
        const msg = document.getElementById("toastMessage");

        toast.className = `toast ${type}`;
        if (type === "success")
          icon.className = "toast-icon fas fa-check-circle";
        if (type === "error")
          icon.className = "toast-icon fas fa-exclamation-circle";
        msg.textContent = message;

        toast.classList.add("show");

        // Clear
        if (toastTimeout) clearTimeout(toastTimeout);
        toastTimeout = setTimeout(() => {
          toast.classList.remove("show");
        }, 3000);
      }

      function escapeHtml(s) {
        if (!s) return "";
        return s.replace(
          /[&<>"']/g,
          (c) =>
            ({
              "&": "&amp;",
              "<": "&lt;",
              ">": "&gt;",
              '"': "&quot;",
              "'": "&#39;",
            }[c])
        );
      }
      function openScanModal() {
        document.getElementById('scanModal').classList.add('active');
    }
    function closeScanModal() {
        document.getElementById('scanModal').classList.remove('active');
    }

    async function startBulkScan() {
        const from = document.getElementById('scanFrom').value;
        const to = document.getElementById('scanTo').value;
        
        closeScanModal();
        showToast('info', 'Đang gửi yêu cầu quét...');

        try {
            const res = await fetch(`/api/content/movies/scan-bulk?fromPage=${from}&toPage=${to}`, {
                method: 'POST'
            });
            const data = await res.json();
            
            if (res.ok) {
                showToast('success', 'Đã bắt đầu quét ngầm! Server sẽ tự động tải phim.');
            } else {
                showToast('error', data.message || 'Lỗi khi gọi lệnh quét');
            }
        } catch (e) {
            console.error(e);
            showToast('error', 'Không thể kết nối Server');
        }
    }
    // [MỚI] Xử lý tìm kiếm local
    let searchTimeout = null;

    function handleLocalSearch() {
        const query = document.getElementById('localSearchInput').value.trim();
        
        // Xóa timeout cũ nếu người dùng vẫn đang gõ
        if (searchTimeout) clearTimeout(searchTimeout);

        // Đặt timeout mới (chờ 500ms sau khi ngừng gõ)
        searchTimeout = setTimeout(() => {
            performSearch(query);
        }, 500);
    }

    async function performSearch(query) {
        const tbody = document.getElementById('movieTableBody');
        
        // Hiệu ứng loading nhẹ (tùy chọn)
        tbody.style.opacity = '0.5';

        try {
            let url = API_URL; // Mặc định lấy tất cả (/api/content/movies)
            
            if (query) {
                // Nếu có từ khóa, gọi endpoint search mới
                url = `${API_URL}/search?query=${encodeURIComponent(query)}`;
            }

            const response = await fetch(url);
            if (!response.ok) throw new Error("Search failed");
            
            const movies = await response.json();
            renderTable(movies);
            
        } catch (error) {
            console.error(error);
            showToast("error", "Lỗi khi tìm kiếm phim.");
        } finally {
            tbody.style.opacity = '1';
        }
    } 
    // --- BIẾN TOÀN CỤC ---
    let currentPage = 0;
    const pageSize = 20;
   

    // --- KHỞI TẠO ---
document.addEventListener('DOMContentLoaded', () => {
    loadMovies(0);     // Tải danh sách phim
    checkScanStatus(); // Kiểm tra ngay xem server có đang quét không
    
    // [QUAN TRỌNG] Tạo nhịp tim: Kiểm tra trạng thái mỗi 3 giây
    // Giúp nút tự động bật/tắt mà không cần reload trang
    setInterval(checkScanStatus, 3000); 
});

    // --- HÀM RESET VÀ LOAD (Dùng khi đổi filter/search) ---
    function resetAndLoad() {
        loadMovies(0);
    }

    function handleLocalSearch() {
        if (searchTimeout) clearTimeout(searchTimeout);
        searchTimeout = setTimeout(() => loadMovies(0), 500); // Debounce 500ms
    }

    // --- HÀM LOAD DATA CHÍNH (GỌI API /manage) ---
    async function loadMovies(page) {
        currentPage = page;
        const keyword = document.getElementById('localSearchInput').value.trim();
        const isFree = document.getElementById('filterFree').value;
        const tbody = document.getElementById('movieTableBody');
        
        tbody.style.opacity = '0.5'; // Hiệu ứng loading

        // Xây dựng URL
        let url = `/api/content/movies/manage?page=${page}&size=${pageSize}&sortBy=movieID&direction=desc`;
        if (keyword) url += `&keyword=${encodeURIComponent(keyword)}`;
        if (isFree) url += `&isFree=${isFree}`;

        try {
            const res = await fetch(url);
            if (!res.ok) throw new Error('Load failed');
            
            const data = await res.json(); // data là Page object {content: [], totalPages: ...}
            
            renderTable(data.content); // Render bảng từ content
            renderPagination(data);    // Render nút phân trang
            
        } catch (error) {
            console.error(error);
            showToast('error', 'Lỗi tải dữ liệu');
        } finally {
            tbody.style.opacity = '1';
        }
    }

    // Thay thế hàm renderPagination cũ bằng hàm này
function renderPagination(pageData) {
    const container = document.getElementById('pagination');
    if (!container) return;
    
    container.innerHTML = '';
    
    // Nếu chỉ có 1 trang thì ẩn luôn cho gọn
    if (pageData.totalPages <= 1) return;

    const currentPage = pageData.number; // Bắt đầu từ 0
    const totalPages = pageData.totalPages;

    // --- Helper tạo nút ---
    const createBtn = (label, page, isActive = false, isDisabled = false, icon = null) => {
        const btn = document.createElement('button');
        btn.className = `page-link ${isActive ? 'active' : ''}`;
        if (icon) {
            btn.innerHTML = icon;
        } else {
            btn.innerText = label;
        }
        
        if (isDisabled) {
            btn.disabled = true;
            btn.style.opacity = '0.5';
            btn.style.cursor = 'not-allowed';
        } else {
            btn.onclick = () => loadMovies(page);
        }
        return btn;
    };

    // 1. Nút First (<<)
    container.appendChild(createBtn(null, 0, false, pageData.first, '<i class="fas fa-angle-double-left"></i>'));

    // 2. Nút Prev (<)
    container.appendChild(createBtn(null, currentPage - 1, false, pageData.first, '<i class="fas fa-angle-left"></i>'));

    // 3. Logic hiển thị các số trang (Window Sliding)
    // Hiển thị tối đa 5 trang xung quanh trang hiện tại
    // Ví dụ: 1 ... 4 5 [6] 7 8 ... 20
    
    const delta = 2; // Số trang hiển thị 2 bên trang hiện tại
    const range = [];
    const rangeWithDots = [];
    let l;

    range.push(1); // Luôn thêm trang 1
    
    for (let i = currentPage - delta; i <= currentPage + delta; i++) {
        // Cộng 1 vì pageData.number từ 0, hiển thị từ 1
        if (i < totalPages && i > 0) {
            range.push(i + 1);
        }
    }
    
    range.push(totalPages); // Luôn thêm trang cuối

    // Lọc trùng và sắp xếp
    const uniqueRange = [...new Set(range)].sort((a, b) => a - b);

    // Thêm dấu ...
    for (let i of uniqueRange) {
        if (l) {
            if (i - l === 2) {
                rangeWithDots.push(l + 1);
            } else if (i - l !== 1) {
                rangeWithDots.push('...');
            }
        }
        rangeWithDots.push(i);
        l = i;
    }

    // Render dãy số
    rangeWithDots.forEach(p => {
        if (p === '...') {
            const span = document.createElement('span');
            span.className = 'page-ellipsis';
            span.innerText = '...';
            container.appendChild(span);
        } else {
            // p là số trang hiển thị (bắt đầu từ 1), cần -1 để gọi API
            container.appendChild(createBtn(p, p - 1, (p - 1) === currentPage));
        }
    });

    // 4. Nút Next (>)
    container.appendChild(createBtn(null, currentPage + 1, false, pageData.last, '<i class="fas fa-angle-right"></i>'));

    // 5. Nút Last (>>)
    container.appendChild(createBtn(null, totalPages - 1, false, pageData.last, '<i class="fas fa-angle-double-right"></i>'));

    // 6. [Tính năng mới] Input Go to page
    const jumpInput = document.createElement('input');
    jumpInput.type = 'number';
    jumpInput.className = 'page-jump-input';
    jumpInput.min = 1;
    jumpInput.max = totalPages;
    jumpInput.placeholder = 'Trang...';
    jumpInput.title = 'Nhập số trang và nhấn Enter';
    
    jumpInput.addEventListener('keypress', function (e) {
        if (e.key === 'Enter') {
            let p = parseInt(this.value);
            if (!isNaN(p) && p >= 1 && p <= totalPages) {
                loadMovies(p - 1); // API dùng index 0
            } else {
                showToast('error', `Vui lòng nhập trang từ 1 đến ${totalPages}`);
            }
        }
    });
    
    container.appendChild(jumpInput);
}

    function createPageBtn(html, onClick, disabled) {
        const btn = document.createElement('button');
        btn.className = 'btn btn-secondary'; // Tận dụng class có sẵn
        btn.innerHTML = html;
        btn.disabled = disabled;
        if(!disabled) btn.onclick = onClick;
        return btn;
    }

    // 1. Hàm gọi API (Không load lại trang)
async function handleScan(type) {
    const btnSmart = document.getElementById('btnSmart');
    const btnDaily = document.getElementById('btnDaily');
    const btnStop = document.getElementById('btnStop');
    
    // Xác nhận trước khi chạy
    let msg = "Bạn có chắc chắn muốn thực hiện hành động này?";
    if (type === 'scan-smart') msg = "Hệ thống sẽ quét và lấp đầy kho phim (Mục tiêu 5000 phim). Tiếp tục?";
    if (type === 'scan-daily') msg = "Cập nhật phim mới và xu hướng trong ngày. Tiếp tục?";
    
    if (!confirm(msg)) return;

    // Hiển thị trạng thái "Đang gửi..."
    showToast('info', 'Đang gửi lệnh đến server...');

    try {
        // Gọi API bằng fetch (Thay vì form submit hay thẻ a)
        const response = await fetch(`/api/content/movies/${type}`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' }
        });
        
        const data = await response.json();

        if (response.ok) {
            showToast('success', data.message);
            // Cập nhật ngay trạng thái giao diện
            checkScanStatus(); 
        } else {
            showToast('error', 'Lỗi: ' + data.message);
        }
    } catch (error) {
        console.error(error);
        showToast('error', 'Không thể kết nối đến Server!');
    }
}
    // 2. Hàm kiểm tra trạng thái Server (Polling)
async function checkScanStatus() {
    try {
        const res = await fetch('/api/content/movies/scan-status');
        const data = await res.json();
        
        const isRunning = data.isRunning;
        
        // DOM Elements
        const btnSmart = document.getElementById('btnSmart');
        const btnDaily = document.getElementById('btnDaily');
        const btnStop = document.getElementById('btnStop');
        const statusDot = document.getElementById('statusDot');
        const statusText = document.getElementById('statusText');

        if (isRunning) {
            // TRẠNG THÁI: ĐANG CHẠY
            if(btnSmart) btnSmart.style.display = 'none'; // Ẩn nút quét
            if(btnDaily) btnDaily.style.display = 'none';
            if(btnStop) btnStop.style.display = 'inline-flex'; // Hiện nút dừng
            
            if(statusDot) {
                statusDot.classList.add('running');
                statusText.innerText = "Đang xử lý...";
                statusText.style.color = "#28a745";
            }
        } else {
            // TRẠNG THÁI: NGHỈ
            if(btnSmart) btnSmart.style.display = 'inline-flex'; // Hiện lại nút quét
            if(btnDaily) btnDaily.style.display = 'inline-flex';
            if(btnStop) btnStop.style.display = 'none'; // Ẩn nút dừng
            
            if(statusDot) {
                statusDot.classList.remove('running');
                statusText.innerText = "Hệ thống nghỉ";
                statusText.style.color = "#aaa";
            }
        }
    } catch (e) {
        console.warn("Không thể lấy trạng thái scan");
    }
}
// 3. Kích hoạt tự động kiểm tra mỗi 3 giây
document.addEventListener('DOMContentLoaded', () => {
    loadMovies(0);     
    checkScanStatus(); // Kiểm tra ngay khi vào trang
    setInterval(checkScanStatus, 3000); // Lặp lại mỗi 3s
});
// --- BIẾN TOÀN CỤC CHO SCAN ---
let pendingScanType = null; // Lưu loại hành động đang chờ xác nhận

// 1. Mở Modal xác nhận (Thay thế confirm() mặc định)
function confirmScanAction(type) {
    pendingScanType = type;
    const modal = document.getElementById('scanConfirmModal');
    const msgElement = document.getElementById('scanConfirmMessage');
    const btnExecute = document.getElementById('btnExecuteScan');
    
    let message = "";
    let btnColor = "";

    if (type === 'scan-smart') {
        message = "Hệ thống sẽ <b>quét sâu</b> để lấp đầy kho phim (Mục tiêu 5000 phim).<br><br>Tiến trình này chạy ngầm trên server, bạn có thể tắt trình duyệt.";
        btnColor = "linear-gradient(135deg, #0061ff, #60efff)";
    } else if (type === 'scan-daily') {
        message = "Cập nhật danh sách <b>Phim Mới</b> và <b>Trending</b> trong 24h qua.<br><br>Nên chạy tính năng này mỗi ngày một lần.";
        btnColor = "linear-gradient(135deg, #ff9966, #ff5e62)";
    } else if (type === 'stop-scan') {
        message = "<span style='color:#ff4d4d'>Dừng ngay lập tức?</span><br>Hệ thống sẽ dừng sau khi xử lý xong phim hiện tại.";
        btnColor = "#dc3545";
    }

    msgElement.innerHTML = message;
    btnExecute.style.background = btnColor;
    btnExecute.style.border = "none";
    
    // Mở modal
    modal.classList.add('active');
}

// 2. Đóng Modal
function closeScanConfirmModal() {
    document.getElementById('scanConfirmModal').classList.remove('active');
    pendingScanType = null;
}

// 3. Sự kiện bấm nút "Xác nhận" trong Modal
document.getElementById('btnExecuteScan').onclick = async function() {
    if (!pendingScanType) return;
    
    const type = pendingScanType;
    closeScanConfirmModal(); // Đóng modal trước
    
    // Hiển thị loading toast
    showToast('info', 'Đang gửi lệnh đến server...');

    try {
        const response = await fetch(`/api/content/movies/${type}`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' }
        });
        
        const data = await response.json();

        if (response.ok) {
            showToast('success', data.message || 'Thao tác thành công!');
            checkScanStatus(); // Cập nhật UI ngay lập tức
        } else {
            showToast('error', 'Lỗi: ' + data.message);
        }
    } catch (error) {
        console.error(error);
        showToast('error', 'Không thể kết nối đến Server!');
    }
};
    </script>
  </body>
</html>