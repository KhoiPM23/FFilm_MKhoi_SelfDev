<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title th:text="${query != null ? 'T√¨m ki·∫øm: ' + query : 'T√¨m ki·∫øm - FFilm'}">T√¨m ki·∫øm</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <link rel="stylesheet" href="/css/footer.css">
    <link rel="stylesheet" th:href="@{/css/hover-card.css}">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" th:href="@{/css/ai-agent.css}">
    <link rel="stylesheet" href="/css/style.css" />
    
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { 
            font-family: 'Segoe UI', system-ui, -apple-system, sans-serif; 
            background: #141414; 
            color: #fff; 
            min-height: 100vh;
        }

        .search-page-container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 100px 50px 80px;
        }

        /* Hero Section */
        .search-hero {
            text-align: center;
            margin-bottom: 50px;
        }

        .search-hero h1 {
            font-size: 2.5rem;
            font-weight: 800;
            margin-bottom: 15px;
            background: linear-gradient(135deg, #e50914 0%, #ff6b6b 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .search-hero .query-highlight {
            color: #e50914;
        }

        .search-hero p {
            font-size: 1.1rem;
            color: rgba(255,255,255,0.7);
            margin-bottom: 30px;
        }

        /* Search Box */
        .search-main-box {
            max-width: 700px;
            margin: 0 auto 40px;
            position: relative;
        }

        .search-main-input {
            width: 100%;
            padding: 18px 140px 18px 20px;
            background: rgba(255,255,255,0.05);
            border: 2px solid rgba(255,255,255,0.1);
            border-radius: 12px;
            color: white;
            font-size: 1.1rem;
            transition: all 0.3s;
        }

        .search-main-input:focus {
            outline: none;
            border-color: #e50914;
            background: rgba(255,255,255,0.08);
            box-shadow: 0 0 20px rgba(229,9,20,0.3);
        }

        .search-main-input::placeholder {
            color: rgba(255,255,255,0.4);
        }

        /* live suggestions */
        .live-suggestions { display: none; }
        .live-suggestions.show { display: block; }
        .suggestion-item { display:flex; gap:10px; padding:8px; align-items:center; cursor:pointer; border-radius:8px; }
        .suggestion-item img { width:46px; height:64px; object-fit:cover; border-radius:4px; }
        .suggestion-item:hover { background: rgba(255,255,255,0.03); }
        .suggestion-info { color: rgba(255,255,255,0.9); font-size:0.95rem; }
        .suggestion-title { font-weight:600; }
        .suggestion-meta { font-size:0.85rem; color: rgba(255,255,255,0.6); }


        /* ============ Filters Panel ============ */
        .filters-toggle {
            position: absolute;
            top: 50%;
            right: -30px;              
            transform: translateY(-50%);
            opacity: 0;
            pointer-events: none;
            background: none;
            border: none;
            color: rgba(255,255,255,0.85);
            font-size: 1.05rem;
            cursor: pointer;
            padding: 8px;
            border-radius: 50%;
            transition: all .18s ease;
            z-index: 13000 !important;           /* n·∫±m tr√™n suggestions */
            display: inline-flex;
            align-items: center;
            justify-content: center;
        }

        .search-box:focus-within .filters-toggle,
        .filters-toggle.visible,
        .search-input.active ~ .filters-toggle {
            opacity: 1;
            pointer-events: auto;
        }

        .filters-toggle {
            min-width: 40px;
            min-height: 40px;
            padding: 8px;
        }

        .filters-toggle:hover {
            color: #e50914;
            background: rgba(255,255,255,0.1);
        }

        .filters-toggle.active {
            color: #e50914;
        }

        @media (max-width: 760px) {
            .filters-toggle {
            right: -36px;
            font-size: 1rem;
            }
            .search-input.active { padding-right: 96px; }
        }

        .filters-panel {
            position: fixed;
            top: 70px;
            right: 0;
            width: 320px;
            max-height: calc(100vh - 90px);
            background: rgba(20,20,20,0.98);
            border: 1px solid rgba(255,255,255,0.1);
            border-radius: 12px 0 0 12px;
            box-shadow: -4px 0 20px rgba(0,0,0,0.5);
            z-index: 9998;
            transform: translateX(100%);
            transition: transform 0.3s ease;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }

        .filters-panel.show {
            transform: translateX(0);
        }

        .filters-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 16px 20px;
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }

        .filters-header h3 {
            font-size: 1.1rem;
            font-weight: 600;
            margin: 0;
        }

        .filters-close {
            background: none;
            border: none;
            color: rgba(255,255,255,0.7);
            font-size: 1.2rem;
            cursor: pointer;
            padding: 4px;
            border-radius: 4px;
            transition: all 0.2s;
        }

        .filters-close:hover {
            color: #e50914;
            background: rgba(255,255,255,0.1);
        }

        .filters-body {
            flex: 1;
            overflow-y: auto;
            padding: 16px 20px;
        }

        .filter-group {
            margin-bottom: 24px;
        }

        .filter-label {
            display: block;
            font-size: 0.9rem;
            font-weight: 600;
            color: rgba(255,255,255,0.9);
            margin-bottom: 10px;
        }

        /* Quick Filters */
        .quick-filters {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }

        .quick-filter-chip {
            padding: 6px 12px;
            background: rgba(255,255,255,0.05);
            border: 1px solid rgba(255,255,255,0.1);
            border-radius: 20px;
            color: rgba(255,255,255,0.8);
            font-size: 0.85rem;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .quick-filter-chip:hover {
            background: rgba(255,255,255,0.1);
            border-color: rgba(255,255,255,0.2);
        }

        .quick-filter-chip.active {
            background: #e50914;
            border-color: #e50914;
            color: white;
        }

        /* Genre Filters */
        .genre-filters {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
        }

        .genre-chip {
            padding: 6px 12px;
            background: rgba(255,255,255,0.05);
            border: 1px solid rgba(255,255,255,0.1);
            border-radius: 16px;
            color: rgba(255,255,255,0.8);
            font-size: 0.85rem;
            cursor: pointer;
            transition: all 0.2s;
        }

        .genre-chip:hover {
            background: rgba(255,255,255,0.1);
            border-color: rgba(255,255,255,0.2);
        }

        .genre-chip.active {
            background: #e50914;
            border-color: #e50914;
            color: white;
        }

        /* Year Filter */
        .year-filter {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .year-filter input {
            flex: 1;
            padding: 8px 12px;
            background: rgba(255,255,255,0.05);
            border: 1px solid rgba(255,255,255,0.1);
            border-radius: 6px;
            color: white;
            font-size: 0.9rem;
        }

        .year-filter input::placeholder {
            color: rgba(255,255,255,0.4);
        }

        .year-filter span {
            color: rgba(255,255,255,0.5);
        }

        /* Rating Filter */
        .rating-filter {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .rating-filter input[type="range"] {
            flex: 1;
            height: 4px;
            background: rgba(255,255,255,0.1);
            border-radius: 2px;
            outline: none;
            -webkit-appearance: none;
        }

        .rating-filter input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 16px;
            height: 16px;
            background: #e50914;
            border-radius: 50%;
            cursor: pointer;
        }

        .rating-filter input[type="range"]::-moz-range-thumb {
            width: 16px;
            height: 16px;
            background: #e50914;
            border-radius: 50%;
            cursor: pointer;
            border: none;
        }

        .rating-value {
            min-width: 32px;
            font-weight: 600;
            color: #e50914;
        }


        /* Action Buttons */
        .search-actions {
            position: absolute;
            right: 10px;
            top: 50%;
            transform: translateY(-50%);
            display: flex;
            gap: 8px;
        }

        .search-action-btn {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            border: none;
            background: rgba(255,255,255,0.1);
            color: rgba(255,255,255,0.8);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
        }

        .search-action-btn:hover {
            background: #e50914;
            color: white;
            transform: scale(1.1);
        }

        .search-action-btn.ai {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .search-action-btn.voice.recording {
            background: #e50914;
        }

        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.1); }
        }

        

        /* Pagination */
        .pagination {
            display: flex;
            justify-content: center;
            gap: 8px;
            margin: 40px 0;
        }

        .page-btn {
            min-width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: rgba(255,255,255,0.05);
            border: 1px solid rgba(255,255,255,0.2);
            border-radius: 6px;
            color: white;
            cursor: pointer;
            transition: all 0.2s;
        }

        .page-btn:hover:not(.active):not(.disabled) {
            background: rgba(255,255,255,0.1);
        }

        .page-btn.active {
            background: #e50914;
            border-color: #e50914;
        }

        .page-btn.disabled {
            opacity: 0.3;
            cursor: not-allowed;
        }

        /* B·ªî SUNG L·∫†I ƒê·ªäNH NGHƒ®A GRID CHO K·∫æT QU·∫¢ T√åM KI·∫æM */
        .results-grid {
            display: grid;
            /* ƒê√¢y l√† logic "5 c·ªôt" c·∫≠u mu·ªën: 
            T·ª± ƒë·ªông l·∫•p ƒë·∫ßy, m·ªói c·ªôt t·ªëi thi·ªÉu 200px, t·ªëi ƒëa 1fr (chia ƒë·ªÅu).
            Tr√™n container 1300px, n√≥ s·∫Ω t·ª± ƒë·ªông chia 5 c·ªôt.
            */
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 15px; /* Gi·ªëng gap c·ªßa carousel */
            margin-bottom: 40px; /* Th√™m kho·∫£ng c√°ch v·ªõi pagination */
        }

        /* K·∫ø th·ª´a responsive c≈© */
        @media (max-width: 768px) {
            .results-grid {
                grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
                gap: 16px;
            }
        }

        .movies.movie-list-section {
            position: relative;
            z-index: 1;
            left: 0;
            /* K√©o section ra s√°t m√©p tr√°i container cha (do container cha ƒëang padding 50px) */
            margin-left: -150px;
            /* B√π l·∫°i chi·ªÅu r·ªông ƒë√£ b·ªã k√©o */
            width: calc(100% + 100px);
            /* Padding trong ƒë·ªÉ n·ªôi dung th·∫≥ng h√†ng l·∫°i v·ªõi header */
            padding: 40px 50px;
        }
        /* Responsive cho m√†n h√¨nh nh·ªè */
        @media (max-width: 768px) {
            .movies.movie-list-section {
                margin-left: -20px;
                width: calc(100% + 40px);
                padding: 30px 20px;
            }
        }

        /* Empty State */
        .empty-state {
            text-align: center;
            padding: 80px 20px;
        }

        .empty-icon {
            font-size: 4rem;
            color: rgba(255,255,255,0.15);
            margin-bottom: 20px;
        }

        .btn-back {
            padding: 12px 24px;
            background: #e50914;
            color: white;
            border-radius: 8px;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        /* Responsive */
        @media (max-width: 768px) {
            .search-page-container {
                padding: 80px 20px 60px;
            }

            .search-hero h1 {
                font-size: 2rem;
            }

            .results-grid {
                grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            }
        }

        /* ===== UI/UX IMPROVEMENTS CHO SEARCH PAGE ===== */

        /* Fix: CƒÉn l·ªÅ tr√°i cho results grid gi·ªëng index */
        .results-section {
            padding-left: 50px; /* ƒê·ªìng b·ªô v·ªõi index */
        }

        @media (max-width: 768px) {
            .results-section {
                padding-left: 20px;
            }
        }

        /* 2. Better Search Input */
        .search-main-input {
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .search-main-input:focus {
            transform: translateY(-2px);
            box-shadow: 0 8px 30px rgba(229, 9, 20, 0.25);
        }

        /* 3. Enhanced Pagination */
        .page-btn {
            transition: all 0.2s ease;
        }

        .page-btn:hover:not(.active):not(.disabled) {
            background: rgba(229, 9, 20, 0.2);
            transform: translateY(-2px);
        }

        .page-btn.active {
            box-shadow: 0 4px 15px rgba(229, 9, 20, 0.4);
        }

        /* 4. Loading Animation for Movie Cards */
        @keyframes shimmer {
            0% { background-position: -200px 0; }
            100% { background-position: 200px 0; }
        }

        .movie-card.loading {
            background: linear-gradient(
                90deg,
                rgba(255,255,255,0.05) 0%,
                rgba(255,255,255,0.1) 50%,
                rgba(255,255,255,0.05) 100%
            );
            background-size: 200px 100%;
            animation: shimmer 1.5s infinite;
        }

        /* 5. Empty State Enhancement */
        .empty-state {
            animation: fadeIn 0.5s ease-in;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        

        /* 7. Better Suggestion Chips */
        .suggestion-chip {
            transition: all 0.2s ease;
            cursor: pointer;
            padding: 8px 16px;
            background: rgba(255,255,255,0.05);
            border: 1px solid rgba(255,255,255,0.1);
            border-radius: 20px;
            color: white;
            font-size: 0.9rem;
        }

        .suggestion-chip:hover {
            background: rgba(229, 9, 20, 0.2);
            border-color: #e50914;
            transform: translateY(-2px);
        }

        /* 8. Smooth Scroll Behavior */
        html {
            scroll-behavior: smooth;
        }

        /* 9. Better Focus States */
        *:focus-visible {
            outline: 2px solid #e50914;
            outline-offset: 2px;
        }

        /* 10. Responsive Improvements */
        @media (max-width: 768px) {
            .search-page-container {
                padding: 70px 15px 40px;
            }
            
            .search-hero h1 {
                font-size: 1.8rem;
            }
            
            .results-grid {
                grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
                gap: 16px;
            }
            
            .movie-card:hover {
                transform: scale(1.02);
            }
        }

        /* [TH√äM M·ªöI] CSS CHO C√ÅC N√öT B·∫§M C·ª¶A B·ªò L·ªåC (S·ª≠a l·ªói image_18e0ac.png) */
        .filters-footer {
            display: flex;
            gap: 10px;
            padding: 16px 20px;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
            background: rgba(10, 10, 10, 0.5);
        }

        .btn-clear-filters,
        .btn-apply-filters {
            flex: 1; /* Chia ƒë·ªÅu */
            padding: 12px;
            border: none;
            border-radius: 8px;
            font-size: 0.95rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }

        .btn-clear-filters {
            background: rgba(255, 255, 255, 0.1);
            color: white;
        }
        .btn-clear-filters:hover {
            background: rgba(255, 255, 255, 0.2);
        }

        .btn-apply-filters {
            background: #e50914;
            color: white;
        }
        .btn-apply-filters:hover {
            background: #f40612;
            transform: translateY(-1px);
        }

        .fire-icon {
            font-size: 2rem;
            animation: fireFlicker 1.5s infinite;
        }

        @keyframes fireFlicker {
            0%, 100% { transform: scale(1); opacity: 1; }
            50% { transform: scale(1.1); opacity: 0.8; }
        }


        /* ============ AI Search Modal ============ */
        .ai-search-modal {
            position: fixed;
            inset: 0;
            z-index: 99999;
            display: flex;
            align-items: center;
            justify-content: center;
            animation: fadeIn 0.2s;
        }

        .ai-modal-overlay {
            position: absolute;
            inset: 0;
            background: rgba(0, 0, 0, 0.85);
            backdrop-filter: blur(4px);
        }

        .ai-modal-content {
            position: relative;
            width: 90%;
            max-width: 600px;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            border-radius: 16px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.8);
            animation: slideUp 0.3s ease-out;
            border: 1px solid rgba(102, 126, 234, 0.2);
        }

        @keyframes slideUp {
            from { transform: translateY(20px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }

        .ai-modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 24px 28px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .ai-header-title {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .ai-header-title i {
            font-size: 1.5rem;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .ai-header-title h3 {
            font-size: 1.3rem;
            font-weight: 600;
            margin: 0;
        }

        .ai-modal-close {
            background: none;
            border: none;
            color: rgba(255, 255, 255, 0.7);
            font-size: 1.3rem;
            cursor: pointer;
            width: 36px;
            height: 36px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
        }

        .ai-modal-close:hover {
            background: rgba(255, 255, 255, 0.1);
            color: white;
        }

        .ai-modal-body {
            padding: 28px;
        }

        .ai-description {
            color: rgba(255, 255, 255, 0.8);
            margin-bottom: 16px;
            font-size: 0.95rem;
        }

        #aiSearchInput {
            width: 100%;
            padding: 14px 16px;
            background: rgba(255, 255, 255, 0.05);
            border: 2px solid rgba(102, 126, 234, 0.3);
            border-radius: 10px;
            color: white;
            font-size: 0.95rem;
            font-family: inherit;
            resize: vertical;
            transition: all 0.2s;
        }

        #aiSearchInput:focus {
            outline: none;
            border-color: #667eea;
            background: rgba(255, 255, 255, 0.08);
        }

        #aiSearchInput::placeholder {
            color: rgba(255, 255, 255, 0.4);
        }

        .ai-examples {
            margin-top: 16px;
        }

        .examples-label {
            font-size: 0.85rem;
            color: rgba(255, 255, 255, 0.6);
            margin-bottom: 10px;
        }

        .example-chip {
            padding: 8px 14px;
            background: rgba(102, 126, 234, 0.15);
            border: 1px solid rgba(102, 126, 234, 0.3);
            border-radius: 20px;
            color: rgba(255, 255, 255, 0.9);
            font-size: 0.85rem;
            cursor: pointer;
            transition: all 0.2s;
            margin-right: 8px;
            margin-bottom: 8px;
        }

        .example-chip:hover {
            background: rgba(102, 126, 234, 0.25);
            border-color: rgba(102, 126, 234, 0.5);
            transform: translateY(-2px);
        }

        .ai-loading {
            text-align: center;
            padding: 24px;
            margin-top: 16px;
        }

        .loading-spinner {
            width: 40px;
            height: 40px;
            margin: 0 auto 12px;
            border: 3px solid rgba(102, 126, 234, 0.2);
            border-top-color: #667eea;
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }

        .ai-loading p {
            color: rgba(255, 255, 255, 0.7);
            font-size: 0.9rem;
        }

        .ai-answer-box {
            padding: 18px;
            background: rgba(102, 126, 234, 0.1);
            border: 1px solid rgba(102, 126, 234, 0.3);
            border-radius: 10px;
            margin-bottom: 16px;
        }

        .ai-answer-header {
            display: flex;
            align-items: center;
            gap: 8px;
            color: #667eea;
            font-weight: 600;
            margin-bottom: 10px;
            font-size: 0.95rem;
        }

        .ai-answer-text {
            color: rgba(255,255,255,0.9);
            line-height: 1.6;
            font-size: 0.95rem;
            margin: 0;
        }

        .ai-suggestions-box {
            padding: 16px;
            background: rgba(70, 211, 105, 0.08);
            border: 1px solid rgba(70, 211, 105, 0.25);
            border-radius: 10px;
        }

        .suggestions-label {
            display: flex;
            align-items: center;
            gap: 8px;
            color: #46d369;
            font-weight: 600;
            margin-bottom: 12px;
            font-size: 0.9rem;
        }

        .ai-suggestions-chips {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
        }

        .ai-suggestion-chip {
            padding: 10px 16px;
            background: rgba(70, 211, 105, 0.15);
            border: 1.5px solid rgba(70, 211, 105, 0.4);
            border-radius: 20px;
            color: #46d369;
            font-size: 0.9rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .ai-suggestion-chip:hover {
            background: rgba(70, 211, 105, 0.25);
            border-color: #46d369;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(70, 211, 105, 0.3);
        }

        .ai-error {
            margin-top: 16px;
            padding: 14px 16px;
            background: rgba(229, 9, 20, 0.1);
            border: 1px solid rgba(229, 9, 20, 0.3);
            border-radius: 8px;
            color: #ff6b6b;
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 0.9rem;
        }

        .ai-modal-footer {
            padding: 20px 28px;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
            display: flex;
            gap: 12px;
            justify-content: flex-end;
        }

        .btn-cancel {
            padding: 10px 24px;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 8px;
            color: rgba(255, 255, 255, 0.8);
            font-size: 0.95rem;
            cursor: pointer;
            transition: all 0.2s;
        }

        .btn-cancel:hover {
            background: rgba(255, 255, 255, 0.1);
        }

        .btn-search-ai {
            padding: 10px 28px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border: none;
            border-radius: 8px;
            color: white;
            font-size: 0.95rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 8px;
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
        }

        .btn-search-ai:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(102, 126, 234, 0.4);
        }

        .btn-search-ai:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .ai-search-modal[hidden] {
            display: none !important;
        }

        @media (max-width: 600px) {
            .ai-modal-content { width: 95%; margin: 20px; }
            .ai-modal-header, .ai-modal-body, .ai-modal-footer { padding: 20px; }
        }
    </style>
</head>
<body>
    <div th:replace="fragments/header :: header"></div>

    <div class="search-page-container">
        <!-- Hero Section -->
        <div class="search-hero">
            <h1 th:if="${query == null}">T√¨m ki·∫øm phim y√™u th√≠ch</h1>
            <h1 th:if="${query != null}">
                K·∫øt qu·∫£ cho "<span class="query-highlight" th:text="${query}"></span>"
            </h1>
            <p th:if="${query == null}">Kh√°m ph√° h√†ng ng√†n b·ªô phim, series v√† anime h·∫•p d·∫´n</p>
            <p th:if="${query != null && totalResults != null}">
                T√¨m th·∫•y <strong th:text="${totalResults}"></strong> k·∫øt qu·∫£
            </p>
        </div>

        <!-- Main Search Box -->
        <div class="search-main-box">
            <form id="searchForm" onsubmit="return false;">
                <input 
                    type="text" 
                    id="mainSearchInput"
                    class="search-main-input" 
                    placeholder="Nh·∫≠p t√™n phim, di·ªÖn vi√™n, ƒë·∫°o di·ªÖn..."
                    autocomplete="off"
                    autofocus
                    th:value="${query}"
                />
                
                <div class="search-actions">
                    <button type="button" class="search-action-btn voice" id="voiceSearchPageBtn" title="Gi·ªçng n√≥i">
                        <i class="fas fa-microphone"></i>
                    </button>
                    <button type="button" class="search-action-btn" id="filterPageBtn" title="B·ªô l·ªçc">
                        <i class="fas fa-filter"></i>
                    </button>
                    <button type="button" class="search-action-btn ai" id="aiSearchPageBtn" title="AI">
                        <i class="fas fa-wand-magic-sparkles"></i>
                    </button>
                </div>
            </form>

            <div id="filtersPanel" class="filters-panel" hidden>
            <div class="filters-header">
              <h3>L·ªçc k·∫øt qu·∫£</h3>
              <button class="filters-close" id="filtersClose">
                <i class="fas fa-times"></i>
              </button>
            </div>
            
            <div class="filters-body">
              <!-- Quick Filters -->
              <div class="filter-group">
                <label class="filter-label">Nhanh</label>
                <div class="quick-filters">
                  <button class="quick-filter-chip" data-filter="trending">
                    <i class="fas fa-fire"></i> Th·ªãnh h√†nh
                  </button>
                  <button class="quick-filter-chip" data-filter="new">
                    <i class="fas fa-star"></i> M·ªõi nh·∫•t
                  </button>
                  <button class="quick-filter-chip" data-filter="top-rated">
                    <i class="fas fa-trophy"></i> ƒê√°nh gi√° cao
                  </button>
                </div>
              </div>
              
              <!-- Genre Filter -->
              <div class="filter-group">
                <label class="filter-label">Th·ªÉ lo·∫°i</label>
                <div class="genre-filters" id="genreFilters">
                  <!-- Will be populated by JS -->
                </div>
              </div>
              
              <!-- Year Filter -->
              <div class="filter-group">
                <label class="filter-label">NƒÉm ph√°t h√†nh</label>
                <div class="year-filter">
                  <input type="number" id="yearFrom" placeholder="T·ª´ nƒÉm" min="1900" max="2025">
                  <span>-</span>
                  <input type="number" id="yearTo" placeholder="ƒê·∫øn nƒÉm" min="1900" max="2025">
                </div>
              </div>
              
              <!-- Rating Filter -->
              <div class="filter-group">
                <label class="filter-label">ƒê√°nh gi√° t·ªëi thi·ªÉu</label>
                <div class="rating-filter">
                  <input type="range" id="minRating" min="0" max="10" step="0.5" value="0">
                  <span class="rating-value" id="ratingValue">0.0</span>
                </div>
              </div>
            </div>
            
            <div class="filters-footer">
              <button class="btn-clear-filters" id="clearFilters">X√≥a b·ªô l·ªçc</button>
              <button class="btn-apply-filters" id="applyFilters">√Åp d·ª•ng</button>
            </div>
          </div>

            <div id="liveSuggestions" class="live-suggestions" style="display:none; position:absolute; left:0; right:0; top:110%; background:rgba(20,20,20,0.95); border:1px solid rgba(255,255,255,0.06); border-radius:10px; padding:8px; z-index:80; max-height: 450px; overflow-y: auto;">
                <!-- JS s·∫Ω render c√°c suggestion items v√†o ƒë√¢y -->
            </div>
        </div> 
        
        <!-- AI Search Modal -->
        <div id="aiSearchModal" class="ai-search-modal" hidden>
          <div class="ai-modal-overlay"></div>
          <div class="ai-modal-content">
            <div class="ai-modal-header">
              <div class="ai-header-title">
                <i class="fas fa-wand-magic-sparkles"></i>
                <h3>T√¨m ki·∫øm b·∫±ng AI</h3>
              </div>
              <button class="ai-modal-close" id="aiModalClose">
                <i class="fas fa-times"></i>
              </button>
            </div>
            
            <div class="ai-modal-body">
              <p class="ai-description">
                M√¥ t·∫£ b·ªô phim b·∫°n mu·ªën xem, AI s·∫Ω gi√∫p b·∫°n t√¨m ki·∫øm!
              </p>
              
              <textarea 
                id="aiSearchInput" 
                placeholder="V√≠ d·ª•: T√¥i mu·ªën xem phim v·ªÅ ng∆∞·ªùi s·∫Øt, c√≥ robot chi·∫øn ƒë·∫•u, ƒë·∫°o di·ªÖn n·ªïi ti·∫øng, h√†nh ƒë·ªông m√£n nh√£n..."
                rows="5"
              ></textarea>
              
              <div class="ai-examples">
                <p class="examples-label">G·ª£i √Ω:</p>
                <button class="example-chip" data-example="Phim v·ªÅ si√™u anh h√πng Marvel, c√≥ Chris Evans">
                  Phim Marvel v·ªõi Chris Evans
                </button>
                <button class="example-chip" data-example="Phim kinh d·ªã t√¢m l√Ω, ƒë·∫°o di·ªÖn Christopher Nolan">
                  Kinh d·ªã t√¢m l√Ω Nolan
                </button>
                <button class="example-chip" data-example="Phim ho·∫°t h√¨nh Disney v·ªÅ gia ƒë√¨nh">
                  Ho·∫°t h√¨nh Disney gia ƒë√¨nh
                </button>
              </div>
              
              <div class="ai-loading" id="aiLoading" hidden>
                <div class="loading-spinner"></div>
                <p>AI ƒëang ph√¢n t√≠ch m√¥ t·∫£ c·ªßa b·∫°n...</p>
              </div>
              
              <!-- X√ìA ph·∫ßn ai-results c≈©, TH√äM M·ªöI: -->
              <div class="ai-movie-results" id="aiMovieResults" hidden>
                <p class="results-label">
                  <i class="fas fa-film"></i>
                  Phim g·ª£i √Ω cho b·∫°n:
                </p>
                <div class="ai-movie-grid" id="aiMovieGrid"></div>
              </div>
              
              <div class="ai-error" id="aiError" hidden>
                <i class="fas fa-exclamation-circle"></i>
                <span id="aiErrorMessage"></span>
              </div>
            </div>
            
            <div class="ai-modal-footer">
              <button class="btn-cancel" id="aiCancelBtn">H·ªßy</button>
              <button class="btn-search-ai" id="aiSearchBtn">
                <i class="fas fa-search"></i>
                T√¨m ki·∫øm
              </button>
            </div>
          </div>
        </div>


        <!-- Results Section (shown when there's a query) -->
        <div class="results-section" th:if="${query != null}" id="resultsSection">
            <div class="results-grid" id="resultsGrid">
                <div th:each="movie : ${searchResults}" 
                    class="movie-card" 
                    th:attr="data-movie-id=${movie.id}">
                    
                    <div class="movie-poster">
                        <img th:src="${movie.poster}" 
                            th:alt="${movie.title}"
                            onerror="this.src='/images/placeholder.jpg'">
                    </div>
                    
                    <div class="movie-info">
                        <h3 th:text="${movie.title}">Movie Title</h3>
                        <p class="movie-rating">
                            ‚≠ê <span th:text="${movie.rating}">8.5</span>
                        </p>
                    </div>
                    
                    <div th:replace="~{fragments/hover-card :: hoverCard(${movie})}"></div>
                </div>
            </div>

            <div class="pagination" 
                th:if="${query != null && totalPages != null && totalPages > 1}" 
                id="pagination"
                th:attr="data-current-page=${currentPage},data-total-pages=${totalPages}">
                <!-- JavaScript s·∫Ω render pagination buttons -->
            </div>
        </div>

        <!-- Empty State -->
        <div class="empty-state" th:if="${query != null && searchResults.isEmpty()}" id="emptyState">
            <div class="empty-icon"><i class="fas fa-search"></i></div>
            <h2>Kh√¥ng t√¨m th·∫•y k·∫øt qu·∫£</h2>
            <p>Kh√¥ng c√≥ k·∫øt qu·∫£ n√†o cho t·ª´ kh√≥a c·ªßa b·∫°n</p>
            <a href="/search" class="btn-back"><i class="fas fa-arrow-left"></i> Th·ª≠ l·∫°i</a>
        </div>

        <!-- Related Movies (shown after search, before AI suggestions) -->
        <section class="movies movie-list-section" th:if="${!relatedMovies.isEmpty()}" id="relatedSection">
            
            <div class="section-header">
                <div class="section-title-wrapper">
                    <h2 class="section-title" style="display: flex; align-items: center; gap: 10px;">
                        <i class="fas fa-film" style="color: #e50914;"></i>
                        Phim li√™n quan
                    </h2>
                </div>
                <div class="carousel-nav">
                    <button class="nav-btn prev-btn" id="relatedCarouselPrev">
                        <i class="fas fa-chevron-left"></i>
                    </button>
                    <button class="nav-btn next-btn" id="relatedCarouselNext">
                        <i class="fas fa-chevron-right"></i>
                    </button>
                </div>
            </div>
            <div class="movie-carousel">
                <div class="movie-slider" id="relatedCarousel">
                    <div th:each="movie : ${relatedMovies}" 
                        class="movie-card" 
                        th:attr="data-movie-id=${movie.id}">
                        
                        <div class="movie-poster">
                            <img th:src="${movie.poster}" 
                                th:alt="${movie.title}"
                                onerror="this.src='/images/placeholder.jpg'">
                        </div>
                        <div class="movie-info">
                            <h3 th:text="${movie.title}">Movie Title</h3>
                            <p class="movie-rating">
                                ‚≠ê <span th:text="${movie.rating}">8.5</span>
                            </p>
                        </div>
                        <div th:replace="~{fragments/hover-card :: hoverCard(${movie})}"></div>
                    </div>
                </div>
            </div>
        </section>

        <!-- AI Suggestions (shown after search) -->
        <section class="movies movie-list-section" th:if="${query != null && !aiSuggestions.isEmpty()}" id="aiSuggestionsSection">
    
            <div class="section-header">
                <div class="section-title-wrapper">
                    <h2 class="section-title" style="display: flex; align-items: center; gap: 10px;">
                        <i class="fas fa-wand-magic-sparkles" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); -webkit-background-clip: text; -webkit-text-fill-color: transparent;"></i>
                        G·ª£i √Ω t·ª´ AI
                    </h2>
                </div>
                
                <div class="carousel-nav">
                    <button class="nav-btn prev-btn" id="aiCarouselPrev">
                        <i class="fas fa-chevron-left"></i>
                    </button>
                    <button class="nav-btn next-btn" id="aiCarouselNext">
                        <i class="fas fa-chevron-right"></i>
                    </button>
                </div>
            </div>
            
            <div class="movie-carousel">
                <div class="movie-slider" id="aiCarousel">
                    
                    <div th:each="movie : ${aiSuggestions}" 
                        class="movie-card" 
                        th:attr="data-movie-id=${movie.id}">
                        
                        <div class="movie-poster">
                            <img th:src="${movie.poster}" 
                                th:alt="${movie.title}"
                                onerror="this.src='/images/placeholder.jpg'">
                        </div>
                        
                        <div class="movie-info">
                            <h3 th:text="${movie.title}">Movie Title</h3>
                            <p class="movie-rating">
                                ‚≠ê <span th:text="${movie.rating}">8.5</span>
                            </p>
                        </div>
                        
                        <div th:replace="~{fragments/hover-card :: hoverCard(${movie})}"></div>
                    </div>

                </div>
            </div>
        </section>

        <!-- Trending Section (shown when no query) -->
        <section class="movies movie-list-section" th:if="${query == null}" id="trendingSection">
    
            <div class="section-header">
                <div class="section-title-wrapper">
                    <h2 class="section-title" style="display: flex; align-items: center; gap: 10px;">
                        <span class="fire-icon" style="font-size: 1.8rem;">üî•</span> 
                        Xu h∆∞·ªõng g·∫ßn ƒë√¢y
                    </h2>
                    <a href="/discover?quickFilter=trending" class="view-more-link" style="margin-left: 20px;">
                        Xem th√™m <i class="fas fa-chevron-right"></i>
                    </a>
                </div>
                
                <div class="carousel-nav">
                    <button class="nav-btn prev-btn" id="trendingCarouselPrev">
                        <i class="fas fa-chevron-left"></i>
                    </button>
                    <button class="nav-btn next-btn" id="trendingCarouselNext">
                        <i class="fas fa-chevron-right"></i>
                    </button>
                </div>
            </div>
            
            <div class="movie-carousel">
                <div class="movie-slider" id="trendingCarousel">
                    </div>
            </div>
        </section>        
    </div>

    <div th:replace="fragments/footer :: footer"></div>
    <div th:replace="fragments/ai-chat :: ai-chat"></div>





    <script>
        // ============ SEARCH PAGE - COMPLETE UNIFIED SCRIPT (V7 - ƒê√É S·ª¨A T·∫§T C·∫¢ L·ªñI) ============
    (function() {
        'use strict';
        
        // =========================================================================
        // 1. C·∫§U H√åNH V√Ä BI·∫æN TO√ÄN C·ª§C
        // =========================================================================
        const API_KEY = 'eac03c4e09a0f5099128e38cb0e67a8f';
        const API_BASE = 'https://api.themoviedb.org/3';
        const IMG_BASE = 'https://image.tmdb.org/t/p';
        
        // DOM Elements
        const mainInput = document.getElementById('mainSearchInput');
        const voiceBtn = document.getElementById('voiceSearchPageBtn');
        const filterBtn = document.getElementById('filterPageBtn');
        const aiBtn = document.getElementById('aiSearchPageBtn');
        const liveSuggestions = document.getElementById('liveSuggestions');
        const filtersPanel = document.getElementById('filtersPanel');
        const pagination = document.getElementById('pagination');
        const relatedCarousel = document.getElementById('relatedCarousel');
        const aiCarousel = document.getElementById('aiCarousel');
        const trendingCarousel = document.getElementById('trendingCarousel');
        
        // State Management
        const PAGE_SIZE = 6; // Load 6 items per scroll
        
        // [S·ª¨A] T√°ch cache phim v√† di·ªÖn vi√™n
        let cachedMovies = [];
        let cachedPeople = [];
        let displayedMoviesCount = 0;
        let displayedPeopleCount = 0;
        
        let nextApiPage = 1; 
        let totalApiPages = 1;
        let lastQuery = '';
        let peopleCache = new Map();
        let loadingMore = false;
        let abortController = null;
        
        // Filter State
        const filterState = {
            quickFilter: null,
            genres: [],
            yearFrom: null,
            yearTo: null,
            minRating: 0
        };
        
        const GENRES = [
            {id: 28, name: 'H√†nh ƒë·ªông'}, {id: 12, name: 'Phi√™u l∆∞u'}, {id: 16, name: 'Ho·∫°t h√¨nh'},
            {id: 35, name: 'H√†i'}, {id: 80, name: 'H√¨nh s·ª±'}, {id: 18, name: 'Ch√≠nh k·ªãch'},
            {id: 10751, name: 'Gia ƒë√¨nh'}, {id: 14, name: 'Gi·∫£ t∆∞·ªüng'}, {id: 27, name: 'Kinh d·ªã'},
            {id: 10749, name: 'L√£ng m·∫°n'}, {id: 878, name: 'Khoa h·ªçc vi·ªÖn t∆∞·ªüng'}, 
            {id: 53, name: 'G√¢y c·∫•n'}, {id: 10752, name: 'Chi·∫øn tranh'}
        ];

        // =========================================================================
        // 2. KH√îI PH·ª§C LOGIC AI SEARCH (T·ª™ HEADER_OLD.DOCX)
        // =========================================================================
        function initAISearch() {
            // L·∫•y ƒë√∫ng ID n√∫t trong trang Search
            const aiToggle = document.getElementById('aiSearchPageBtn'); 
            const aiModal = document.getElementById('aiSearchModal');
            const aiClose = document.getElementById('aiModalClose');
            const aiCancel = document.getElementById('aiCancelBtn');
            const aiSearchBtn = document.getElementById('aiSearchBtn');
            const aiInput = document.getElementById('aiSearchInput');
            const aiLoading = document.getElementById('aiLoading');
            const aiError = document.getElementById('aiError');
            
            // Container k·∫øt qu·∫£ (ƒë·∫£m b·∫£o ID ƒë√∫ng trong HTML)
            const aiMovieResults = document.getElementById('aiMovieResults');

            // Open modal
            aiToggle?.addEventListener('click', (e) => {
                e.stopPropagation();
                if(aiModal) {
                    aiModal.hidden = false;
                    // Reset tr·∫°ng th√°i
                    aiInput.value = '';
                    if(aiMovieResults) aiMovieResults.hidden = true;
                    if(aiLoading) aiLoading.hidden = true;
                    if(aiError) aiError.hidden = true;
                    if(aiSearchBtn) aiSearchBtn.disabled = false;
                    
                    document.body.style.overflow = 'hidden'; // Kh√≥a cu·ªôn trang
                    setTimeout(() => aiInput.focus(), 100);
                }
            });

            // Close modal logic
            const closeModal = () => {
                if(aiModal) {
                    aiModal.hidden = true;
                    document.body.style.overflow = '';
                }
            };

            aiClose?.addEventListener('click', closeModal);
            aiCancel?.addEventListener('click', closeModal);
            aiModal?.querySelector('.ai-modal-overlay')?.addEventListener('click', closeModal);

            // Example chips (G·ª£i √Ω nhanh)
            document.querySelectorAll('.example-chip').forEach(chip => {
                chip.addEventListener('click', function() {
                    aiInput.value = this.dataset.example;
                    aiInput.focus();
                });
            });

            // AI Search Submit Logic (Kh√¥i ph·ª•c t·ª´ header_old)
            aiSearchBtn?.addEventListener('click', async () => {
                const description = aiInput.value.trim();

                if (!description) {
                    showAIError('Vui l√≤ng nh·∫≠p m√¥ t·∫£ v·ªÅ b·ªô phim b·∫°n mu·ªën t√¨m');
                    return;
                }

                // UI Loading state
                if(aiLoading) aiLoading.hidden = false;
                if(aiError) aiError.hidden = true;
                if(aiMovieResults) aiMovieResults.hidden = true;
                aiSearchBtn.disabled = true;

                try {
                    // G·ªçi API backend
                    const response = await fetch('/api/ai-search/suggest', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ description })
                    });

                    const data = await response.json();

                    if (!data.success) {
                        throw new Error(data.message || 'AI failed');
                    }

                    // T·∫Øt loading
                    if(aiLoading) aiLoading.hidden = true;

                    // Hi·ªÉn th·ªã k·∫øt qu·∫£
                    if (aiMovieResults) {
                        aiMovieResults.hidden = false;
                        renderAIRecommendation(data.answer, data.suggestions || []);
                    }

                } catch (error) {
                    if(aiLoading) aiLoading.hidden = true;
                    showAIError(error.message);
                } finally {
                    aiSearchBtn.disabled = false;
                }
            });

            // H√†m render giao di·ªán chat ƒë·∫πp (t·ª´ header_old)
            function renderAIRecommendation(answer, suggestions) {
                if (!aiMovieResults) return;

                let html = `
                    <div class="ai-answer-box">
                        <div class="ai-answer-header">
                            <i class="fas fa-robot"></i>
                            <strong>G·ª£i √Ω t·ª´ AI:</strong>
                        </div>
                        <p class="ai-answer-text">${escapeHtml(answer)}</p>
                    </div>
                `;

                if (suggestions && suggestions.length > 0) {
                    html += `
                        <div class="ai-suggestions-box">
                            <p class="suggestions-label">
                                <i class="fas fa-lightbulb"></i>
                                T√¨m ki·∫øm c√°c t·ª´ kh√≥a n√†y:
                            </p>
                            <div class="ai-suggestions-chips">
                                ${suggestions.map(s => `
                                    <button class="ai-suggestion-chip" data-query="${escapeHtml(s)}">
                                        <i class="fas fa-search"></i>
                                        ${escapeHtml(s)}
                                    </button>
                                `).join('')}
                            </div>
                        </div>
                    `;
                }

                aiMovieResults.innerHTML = html;

                // G√°n s·ª± ki·ªán click cho c√°c chip g·ª£i √Ω -> Chuy·ªÉn sang trang search
                aiMovieResults.querySelectorAll('.ai-suggestion-chip').forEach(chip => {
                    chip.addEventListener('click', function() {
                        const query = this.dataset.query;
                        closeModal(); // ƒê√≥ng modal
                        // ƒêi·ªÅn v√†o √¥ search ch√≠nh v√† t√¨m ki·∫øm
                        if(mainInput) {
                            mainInput.value = query;
                            performSearch(); 
                        }
                    });
                });
            }

            function showAIError(message) {
                if(aiError) {
                    aiError.hidden = false;
                    const msgEl = document.getElementById('aiErrorMessage');
                    if(msgEl) msgEl.textContent = message;
                }
            }
        }
        
        // =========================================================================
        // 2. LOGIC LIVE SUGGESTIONS (V·ªöI T·∫¢I KHI CU·ªòN V√Ä DB-FIRST)
        // =========================================================================
        let searchTimeout;
        
        if (mainInput && liveSuggestions) {
            // [S·ª¨A L·ªñI 1] Live suggestions listen khi g√µ (ƒê√É GI·ªÆ NGUY√äN)
            mainInput.addEventListener('input', (e) => {
                clearTimeout(searchTimeout);
                const query = e.target.value.trim();
                
                if (query.length < 2) {
                    hideLiveSuggestions();
                    return;
                }
                
                searchTimeout = setTimeout(() => {
                    // [S·ª¨A] Reset state cho 2 cache ri√™ng bi·ªát
                    cachedMovies = [];
                    cachedPeople = [];
                    displayedMoviesCount = 0;
                    displayedPeopleCount = 0;
                    
                    nextApiPage = 1; 
                    totalApiPages = 1;
                    lastQuery = query;
                    liveSuggestions.innerHTML = ''; 
                    
                    fetchNextApiPageAndAppend(query, true); 
                }, 300);
            });
            
            // Khi ng∆∞·ªùi d√πng cu·ªôn √¥ suggestions (ƒê√É S·ª¨A)
            liveSuggestions.addEventListener('scroll', debounce(async function() {
                if (loadingMore) return; 
                
                if (liveSuggestions.scrollTop + liveSuggestions.clientHeight >= liveSuggestions.scrollHeight - 100) {
                    
                    if (displayedMoviesCount < cachedMovies.length || displayedPeopleCount < cachedPeople.length) {
                        // N·∫øu v·∫´n c√≤n item trong cache ch∆∞a render, render n√≥
                        loadMoreSuggestions();
                    } 
                    else if (nextApiPage <= totalApiPages) {
                        // N·∫øu ƒë√£ render h·∫øt cache, t·∫£i trang API ti·∫øp theo
                        await fetchNextApiPageAndAppend(lastQuery, false);
                    }
                }
            }, 150));
        }
        
        /**
         * [S·ª¨A] H√†m n√†y ∆∞u ti√™n render phim tr∆∞·ªõc, di·ªÖn vi√™n sau
         */
        function loadMoreSuggestions() {
            if (loadingMore) return;
            loadingMore = true;

            const chunkToRender = [];
            let needed = PAGE_SIZE; // C·∫ßn 6 item

            // 1. L·∫•y t·ª´ Movie Cache
            if (displayedMoviesCount < cachedMovies.length) {
                const movieStart = displayedMoviesCount;
                const movieEnd = Math.min(cachedMovies.length, movieStart + needed);
                const movieChunk = cachedMovies.slice(movieStart, movieEnd);
                
                chunkToRender.push(...movieChunk);
                displayedMoviesCount = movieEnd;
                needed -= movieChunk.length; // Gi·∫£m s·ªë l∆∞·ª£ng item c√≤n c·∫ßn
            }

            // 2. N·∫øu v·∫´n c√≤n "ch·ªó", l·∫•y t·ª´ People Cache
            if (needed > 0 && displayedPeopleCount < cachedPeople.length) {
                const peopleStart = displayedPeopleCount;
                const peopleEnd = Math.min(cachedPeople.length, peopleStart + needed);
                const peopleChunk = cachedPeople.slice(peopleStart, peopleEnd);
                
                chunkToRender.push(...peopleChunk);
                displayedPeopleCount = peopleEnd;
                needed -= peopleChunk.length;
            }

            // 3. Render
            // (Ki·ªÉm tra "Kh√¥ng t√¨m th·∫•y" - logic n√†y ph·∫£i check c·∫£ hai cache)
            if (chunkToRender.length === 0 && displayedMoviesCount === 0 && displayedPeopleCount === 0) {
                 if (filterState.genres.length > 0 || filterState.yearFrom || filterState.minRating > 0) {
                    liveSuggestions.innerHTML = '<div style="padding:14px;text-align:center;color:rgba(255,255,255,0.6)">Kh√¥ng c√≥ k·∫øt qu·∫£ ph√π h·ª£p v·ªõi b·ªô l·ªçc</div>';
                 } else {
                    liveSuggestions.innerHTML = '<div style="padding:14px;text-align:center;color:rgba(255,255,255,0.6)">Kh√¥ng t√¨m th·∫•y k·∫øt qu·∫£ n√†o</div>';
                 }
                 liveSuggestions.style.display = 'block';
            } else if (chunkToRender.length > 0) {
                // D√πng h√†m render b·∫°n cung c·∫•p
                renderSuggestionsChunk(chunkToRender, true); // true = append
            }
            
            loadingMore = false;
        }

        /**
         * [S·ª¨A L·ªñI 2] H√†m n√†y g·ªçi API (ch·∫≠m), h·ª£p nh·∫•t (merge) v√† th√™m v√†o cache
         */
        async function fetchNextApiPageAndAppend(query, isFirstPage = false) {
            if (loadingMore || nextApiPage > totalApiPages) return;
            
            loadingMore = true;
            if (abortController) abortController.abort();
            abortController = new AbortController();

            try {
                // --- B∆Ø·ªöC 1: G·ªçi API TMDB (Trang 1, 2, 3...) ---
                const apiUrl = `${API_BASE}/search/multi?api_key=${API_KEY}&language=vi-VN&query=${encodeURIComponent(query)}&page=${nextApiPage}&include_adult=false`;
                const apiResponse = await fetch(apiUrl, { signal: abortController.signal });
                if (!apiResponse.ok) throw new Error('API Error');
                
                const apiData = await apiResponse.json();
                const apiResults = (apiData.results || []);
                
                nextApiPage++;
                totalApiPages = apiData.total_pages || totalApiPages;

                // --- B∆Ø·ªöC 2: T√°ch ID Phim/TV v√† Di·ªÖn vi√™n ---
                const movieTmdbIds = [];
                const peopleResults = [];
                const movieResults = [];

                apiResults.forEach(item => {
                    if (item.media_type === 'movie' || item.media_type === 'tv') {
                        if(item.id) movieTmdbIds.push(item.id);
                        movieResults.push(item);
                    } else if (item.media_type === 'person') {
                        peopleResults.push(item);
                    }
                });

                // --- B∆Ø·ªöC 3: KI·ªÇM TRA DATABASE C·ª¶A B·∫†N ---
                // (Kh√¥ng thay ƒë·ªïi, gi·ªØ nguy√™n)
                let dbMoviesMap = {};
                if (movieTmdbIds.length > 0) {
                    const dbCheckResponse = await fetch('/api/movie/check-db', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(movieTmdbIds)
                    });
                    if (dbCheckResponse.ok) {
                        dbMoviesMap = await dbCheckResponse.json(); 
                    } else {
                        console.warn('API /check-db th·∫•t b·∫°i');
                    }
                }

                let dbMoviesByName = [];
                if (isFirstPage) {
                    const dbNameResponse = await fetch(`/api/movie/search-db?query=${encodeURIComponent(query)}`);
                    if (dbNameResponse.ok) {
                        dbMoviesByName = await dbNameResponse.json();
                    } else {
                        console.warn('API /search-db th·∫•t b·∫°i, b·ªè qua t√¨m ki·∫øm theo t√™n.');
                    }
                }
                
                let peopleMovies = [];
                if (isFirstPage && query.length >= 3) {
                    const people = await searchPeople(query);
                    if (people.length > 0) {
                        const promises = people.map(p => getMoviesFromPerson(p.id, p.name));
                        const results = await Promise.all(promises);
                        peopleMovies = results.flat(); 
                    }
                }

                // --- B∆Ø·ªöC 4: H·ª£p nh·∫•t (Merge) [ƒê√É S·ª¨A L·ªñI LOGIC] ---
                const movieChunk = []; 
                const personChunk = [];
                const addedIds = new Set(); 
                
                // ∆Øu ti√™n 1: Phim t√¨m th·∫•y theo T√äN trong DB
                // (Gi·ªØ nguy√™n, v√¨ dbMoviesByName ƒë√£ ƒë∆∞·ª£c n√¢ng c·∫•p t·ª´ API)
                dbMoviesByName.forEach(dbMovie => {
                    const tmdbId = dbMovie.tmdbId || dbMovie.id;
                    if (tmdbId && !addedIds.has(tmdbId)) {
                        dbMovie.isPerson = false;
                        movieChunk.push(dbMovie); 
                        addedIds.add(tmdbId);
                    }
                });
                
                // ∆Øu ti√™n 2: Phim c·ªßa Di·ªÖn vi√™n/ƒê·∫°o di·ªÖn (API-First, DB-Overwrite)
                peopleMovies.forEach(apiItem => {
                    const tmdbId = apiItem.id;
                    if (!tmdbId || addedIds.has(tmdbId)) return;
                    
                    // 1. T·∫°o b·∫£n ƒë·ªì t·ª´ API (l√†m n·ªÅn)
                    const movieMap = {
                        id: apiItem.id, tmdbId: apiItem.id,
                        title: apiItem.title || apiItem.name,
                        poster: apiItem.poster_path ? `${IMG_BASE}/w500${apiItem.poster_path}` : '/images/placeholder.jpg',
                        rating: (apiItem.vote_average || 0).toFixed(1),
                        year: (apiItem.release_date || apiItem.first_air_date || '').substring(0, 4) || '‚Äî',
                        isPerson: false,
                        genre_ids: apiItem.genre_ids || [],
                        context: `${apiItem._personRole}: ${escapeHtml(apiItem._personName)}`
                    };
                    
                    // 2. L·∫•y d·ªØ li·ªáu DB
                    const dbMovie = dbMoviesMap[tmdbId]; 
                    
                    if (dbMovie) {
                        // 3. [S·ª¨A] H·ª£p nh·∫•t: D·ªØ li·ªáu DB (t·ªët) GHI ƒê√à l√™n API (x·∫•u)
                        const mergedMovie = Object.assign({}, movieMap, dbMovie);
                        mergedMovie.context = movieMap.context; // ƒê·∫£m b·∫£o gi·ªØ l·∫°i context
                        movieChunk.push(mergedMovie);
                    } else {
                        // 4. Kh√¥ng c√≥ DB, d√πng API
                        movieChunk.push(movieMap); 
                        syncIdsToDatabase([tmdbId]);
                    }
                    addedIds.add(tmdbId);
                });
                
                // ∆Øu ti√™n 3: Phim/TV th√¥ng th∆∞·ªùng (API-First, DB-Overwrite)
                movieResults.forEach(apiItem => {
                    const tmdbId = apiItem.id;
                    if (!tmdbId || addedIds.has(tmdbId)) return; 

                    // 1. T·∫°o b·∫£n ƒë·ªì t·ª´ API (l√†m n·ªÅn)
                    const movieMap = {
                        id: apiItem.id, tmdbId: apiItem.id,
                        title: apiItem.title || apiItem.name,
                        poster: apiItem.poster_path ? `${IMG_BASE}/w500${apiItem.poster_path}` : '/images/placeholder.jpg',
                        rating: (apiItem.vote_average || 0).toFixed(1),
                        year: (apiItem.release_date || apiItem.first_air_date || '').substring(0, 4) || '‚Äî',
                        isPerson: false,
                        genre_ids: apiItem.genre_ids || [] 
                    };
                    
                    // 2. L·∫•y d·ªØ li·ªáu DB
                    const dbMovie = dbMoviesMap[tmdbId]; 
                    
                    if (dbMovie) {
                        // 3. [S·ª¨A] H·ª£p nh·∫•t: D·ªØ li·ªáu DB (t·ªët) GHI ƒê√à l√™n API (x·∫•u)
                        const mergedMovie = Object.assign({}, movieMap, dbMovie);
                        movieChunk.push(mergedMovie);
                    } else {
                        // 4. Kh√¥ng c√≥ DB, d√πng API
                        movieChunk.push(movieMap); 
                        syncIdsToDatabase([tmdbId]);
                    }
                    addedIds.add(tmdbId);
                });
                
                // ∆Øu ti√™n 4: Di·ªÖn vi√™n (Person)
                peopleResults.forEach(apiItem => {
                    if (apiItem.id && !addedIds.has(apiItem.id)) { 
                        const personMap = {
                            id: apiItem.id, tmdbId: apiItem.id,
                            title: apiItem.name,
                            poster: apiItem.profile_path ? `${IMG_BASE}/w500${apiItem.profile_path}` : '/images/placeholder-user.jpg',
                            rating: (apiItem.popularity || 0).toFixed(1),
                            year: 'Di·ªÖn vi√™n',
                            isPerson: true
                        };
                        personChunk.push(personMap);
                        addedIds.add(apiItem.id); 
                    }
                });

                // B∆Ø·ªöC 5: Th√™m chunk m·ªõi v√†o cache (RI√äNG BI·ªÜT)
                cachedMovies = cachedMovies.concat(movieChunk);
                cachedPeople = cachedPeople.concat(personChunk);
                loadMoreSuggestions(); // K√≠ch ho·∫°t render

            } catch (error) {
                if (error.name !== 'AbortError') console.error('L·ªói fetchNextApiPage:', error);
            } finally {
                loadingMore = false;
            }
        }
        
        /**
         * [S·ª¨A ƒê·ªîI - PH·∫¶N 2 & 3]
         * S·ª≠a onClickUrl ƒë·ªÉ tr·ªè ƒë√∫ng ID
         */
        function renderSuggestionsChunk(chunk, append = false) {
            const html = chunk.map(item => {
                const isPerson = item.isPerson === true;
                
                const title = escapeHtml(item.title || 'Unknown');
                const year = item.year || '‚Äî'; 
                const rating = item.rating || '‚Äî';
                const poster = item.poster 
                    ? item.poster.replace('/w500/', '/w92/') 
                    : (isPerson ? '/images/placeholder-user.jpg' : '/images/placeholder.jpg');
                const context = item.context || '';
                
                let meta, onClickUrl, onErrorSrc;

                // 2. X·ª¨ L√ù CHO PHIM (MOVIE)
                if (!isPerson) {
                    // THAY ƒê·ªîI: item.id b√¢y gi·ªù l√† movieID (PK) t·ª´ dbMoviesMap/dbMoviesByName
                    onClickUrl = `/movie/detail/${item.id}`; // <-- ƒê√£ ƒë√∫ng (tr·ªè ƒë·∫øn PK)
                    onErrorSrc = '/images/placeholder.jpg';
                    
                    meta = `${year} ${year !== '‚Äî' ? '‚Ä¢' : ''} ‚≠ê ${rating}`;
                    if (context) {
                        meta += ` ‚Ä¢ <span style="color:#ffc107;font-weight:500;">${context}</span>`;
                    }
                    
                    // ... (HTML cho movie gi·ªØ nguy√™n) ...
                    return `
                        <div class="suggestion-item" onclick="location.href='${onClickUrl}'" 
                            style="display:flex;gap:10px;padding:8px;align-items:center;cursor:pointer;border-radius:8px;transition:background 0.2s;">
                            <img src="${poster}" alt="${title}" onerror="this.src='${onErrorSrc}'" 
                                style="width:46px;height:64px;object-fit:cover;border-radius:4px;">
                            <div class="suggestion-info" style="flex:1;min-width:0;">
                                <div class="suggestion-title" style="font-weight:600;font-size:0.95rem;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;">${title}</div>
                                <div class="suggestion-meta" style="font-size:0.85rem;color:rgba(255,255,255,0.6);margin-top:4px;">
                                    ${meta}
                                </div>
                            </div>
                        </div>
                    `;
                } 
                
                // 3. X·ª¨ L√ù CHO DI·ªÑN VI√äN (PERSON)
                else {
                    // THAY ƒê·ªîI: item.id ·ªü ƒë√¢y l√† tmdbId (t·ª´ personChunk)
                    // Ch√∫ng ta ph·∫£i tr·ªè ƒë·∫øn ?id= (Query Param) ƒë·ªÉ PersonDetailController b·∫Øt
                    onClickUrl = `/person/detail?id=${item.id}`; // <-- S·ª¨A: D√πng Query Param
                    onErrorSrc = '/images/placeholder-user.jpg';
                    meta = `‚≠ê ${rating} (ƒê·ªô n·ªïi ti·∫øng)`;

                    // ... (HTML cho person gi·ªØ nguy√™n) ...
                    return `
                        <div class="suggestion-item" onclick="location.href='${onClickUrl}'" 
                            style="display:flex;gap:10px;padding:8px;align-items:center;cursor:pointer;border-radius:8px;transition:background 0.2s;">
                            <img src="${poster}" alt="${title}" onerror="this.src='${onErrorSrc}'" 
                                style="width:46px;height:64px;object-fit:cover;border-radius:4px;">
                            <div class="suggestion-info" style="flex:1;min-width:0;">
                                <div class="suggestion-title" style="font-weight:600;font-size:0.95rem;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;">${title}</div>
                                <div class="suggestion-meta" style="font-size:0.85rem;color:rgba(255,255,255,0.6);margin-top:4px;">
                                    ${meta}
                                f</div>
                            </div>
                        </div>
                    `;
                }
            }).join('');
            
            if (append) {
                liveSuggestions.insertAdjacentHTML('beforeend', html);
            } else {
                liveSuggestions.innerHTML = html;
            }
            
            liveSuggestions.style.display = 'block';
            
            // Add hover effect
            liveSuggestions.querySelectorAll('.suggestion-item').forEach(item => {
                item.addEventListener('mouseenter', function() { this.style.background = 'rgba(255,255,255,0.05)'; });
                item.addEventListener('mouseleave', function() { this.style.background = ''; });
            });
            
            // Kh√¥ng c·∫ßn g·ªçi syncIdsToDatabase ·ªü ƒë√¢y
        }

        /**
         * H√†m sync (ƒë·ªÉ ƒë·ªìng b·ªô phim m·ªõi)
         */
        function syncIdsToDatabase(ids) {
            if (!ids || ids.length === 0) return;
            
            fetch('/api/content/movies/sync', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(ids)
            })
            .then(response => response.json())
            .then(data => {
                if(data.success) {
                    console.log('Sync request sent for IDs:', ids);
                }
            })
            .catch(error => {
                console.error('Error sending sync request:', error);
            });
        }
        
        function hideLiveSuggestions() {
            if (liveSuggestions) {
                liveSuggestions.style.display = 'none';
            }
        }
        
        /**
         * [GI·ªÆ NGUY√äN] H√†m t√¨m di·ªÖn vi√™n
         */
        async function searchPeople(query) {
            if (peopleCache.has(query)) {
                return peopleCache.get(query);
            }
            try {
                const res = await fetch(
                    `${API_BASE}/search/person?api_key=${API_KEY}&language=vi-VN&query=${encodeURIComponent(query)}&page=1`
                );
                if (!res.ok) return [];
                const data = await res.json();
                const results = (data.results || []).slice(0, 3); 
                peopleCache.set(query, results);
                return results;
            } catch (e) {
                console.warn('People search failed:', e);
                return [];
            }
        }
        
        /**
         * [GI·ªÆ NGUY√äN] H√†m l·∫•y phim t·ª´ di·ªÖn vi√™n
         */
        async function getMoviesFromPerson(personId, personName) {
            try {
                const res = await fetch(
                    `${API_BASE}/person/${personId}/movie_credits?api_key=${API_KEY}&language=vi-VN`
                );
                if (!res.ok) return [];
                const data = await res.json();
                const castMovies = (data.cast || []).slice(0, 3).map(m => ({
                    ...m, media_type: 'movie', _personName: personName, _personRole: 'Di·ªÖn vi√™n'
                }));
                const crewMovies = (data.crew || [])
                    .filter(m => m.job === 'Director').slice(0, 2).map(m => ({
                        ...m, media_type: 'movie', _personName: personName, _personRole: 'ƒê·∫°o di·ªÖn'
                    }));
                return [...crewMovies, ...castMovies].slice(0, 3); 
            } catch (e) {
                console.warn('Person credits failed:', e);
                return [];
            }
        }
        
        // =========================================================================
        // 3. LOGIC FILTERS (ƒê√É S·ª¨A L·ªñI)
        // =========================================================================
        /**
         * [KH√îI PH·ª§C & S·ª¨A L·ªñI] Logic x·ª≠ l√Ω n√∫t T√¨m ki·∫øm trong Modal AI
         */
        async function submitAiSearch() {
            // L·∫•y c√°c element DOM c·∫ßn thi·∫øt (ƒë∆∞·ª£c ƒë·ªãnh nghƒ©a trong IIFE)
            const mainInput = document.getElementById('mainSearchInput');
            const input = document.getElementById('aiSearchInput');
            const description = input.value.trim();
            
            // Ki·ªÉm tra input
            if (!description) {
                alert('Vui l√≤ng nh·∫≠p m√¥ t·∫£');
                return;
            }
            
            const loadingEl = document.getElementById('aiLoading');
            const errorEl = document.getElementById('aiError');
            const submitBtn = document.getElementById('aiSearchBtn');
            
            // Hi·ªÉn th·ªã tr·∫°ng th√°i Loading
            if(loadingEl) loadingEl.hidden = false;
            if(errorEl) errorEl.hidden = true;
            if(submitBtn) submitBtn.disabled = true;

            try {
                // G·ªçi API backend
                const response = await fetch('/api/ai-search/suggest', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ description: description })
                });
                
                const data = await response.json();
                
                // T·∫Øt loading
                if(loadingEl) loadingEl.hidden = true;

                if (data.success) {
                    const suggestions = data.suggestions || [];
                    if (suggestions.length > 0) {
                        const firstSuggestion = suggestions[0];
                        window.closeAiSearch(); // ƒê√≥ng modal
                        if(mainInput) mainInput.value = firstSuggestion;
                        window.performSearch(); // Chuy·ªÉn sang trang k·∫øt qu·∫£
                    } else {
                        showAIError("AI kh√¥ng t√¨m th·∫•y g·ª£i √Ω ph√π h·ª£p.");
                    }
                } else {
                    showAIError(data.message || 'C√≥ l·ªói x·∫£y ra');
                }
                
            } catch (err) {
                if(loadingEl) loadingEl.hidden = true;
                showAIError('L·ªói k·∫øt n·ªëi: ' + err.message);
            } finally {
                if(submitBtn) submitBtn.disabled = false;
            }
        }

        // [TH√äM] H√†m helper show l·ªói (b·ªã thi·∫øu)
        function showAIError(message) {
            const aiError = document.getElementById('aiError');
            const msgEl = document.getElementById('aiErrorMessage');
            if(aiError) aiError.hidden = false;
            if(msgEl) msgEl.textContent = message;
        }
        function initFilters() {
            if (!filtersPanel || !filterBtn) return;
            const filtersClose = document.getElementById('filtersClose');
            const clearFiltersBtn = document.getElementById('clearFilters');
            const applyFiltersBtn = document.getElementById('applyFilters');
            const minRatingSlider = document.getElementById('minRating');
            const ratingValue = document.getElementById('ratingValue');
            renderGenres();
            
            // H√†m helper ƒë√≥ng
            function closeFilters(event) {
                 if (event) event.stopPropagation();
                 if (filtersPanel) {
                    filtersPanel.hidden = true;
                    filtersPanel.classList.remove('show');
                 }
                 if (filterBtn) {
                    filterBtn.classList.remove('active');
                 }
            }
            
            filterBtn.addEventListener('click', (e) => {
                e.stopPropagation();
                filtersPanel.hidden = !filtersPanel.hidden;
                filtersPanel.classList.toggle('show');
                filterBtn.classList.toggle('active');
            });
            filtersClose?.addEventListener('click', (e) => {
                closeFilters(e);
            });
            minRatingSlider?.addEventListener('input', (e) => {
                if (ratingValue) ratingValue.textContent = parseFloat(e.target.value).toFixed(1);
            });
            clearFiltersBtn?.addEventListener('click', () => {
                filterState.quickFilter = null;
                filterState.genres = [];
                filterState.yearFrom = null;
                filterState.yearTo = null;
                filterState.minRating = 0;
                document.querySelectorAll('.quick-filter-chip').forEach(c => c.classList.remove('active'));
                document.querySelectorAll('.genre-chip').forEach(c => c.classList.remove('active'));
                const yearFrom = document.getElementById('yearFrom');
                const yearTo = document.getElementById('yearTo');
                if (yearFrom) yearFrom.value = '';
                if (yearTo) yearTo.value = '';
                if (minRatingSlider) minRatingSlider.value = 0;
                if (ratingValue) ratingValue.textContent = '0.0';
            });
            applyFiltersBtn?.addEventListener('click', () => {
                applyFilters();
            });
            document.addEventListener('click', (e) => {
                const liveSuggestions = document.getElementById('liveSuggestions');
                const mainInput = document.getElementById('mainSearchInput');
                const filtersPanel = document.getElementById('filtersPanel');
                const filterBtn = document.getElementById('filterPageBtn');
                if (liveSuggestions && liveSuggestions.style.display === 'block') {
                    if (!mainInput.contains(e.target) && 
                        !liveSuggestions.contains(e.target) && 
                        (!filtersPanel || !filtersPanel.contains(e.target))) {
                        hideLiveSuggestions();
                    }
                }
                if (filtersPanel && filtersPanel.classList.contains('show')) {
                    if (!filtersPanel.contains(e.target) && !filterBtn.contains(e.target)) {
                        closeFilters(e);
                    }
                }
            });
        }
        
        function renderGenres() {
            const container = document.getElementById('genreFilters');
            if (!container) return;
            container.innerHTML = GENRES.map(g => 
                `<button class="genre-chip" data-genre="${g.id}">${g.name}</button>`
            ).join('');
            document.querySelectorAll('.quick-filter-chip').forEach(chip => {
                chip.addEventListener('click', function() {
                    document.querySelectorAll('.quick-filter-chip').forEach(c => c.classList.remove('active'));
                    this.classList.add('active');
                    filterState.quickFilter = this.dataset.filter;
                });
            });
            container.querySelectorAll('.genre-chip').forEach(chip => {
                chip.addEventListener('click', function() {
                    const genreId = parseInt(this.dataset.genre);
                    this.classList.toggle('active');
                    if (filterState.genres.includes(genreId)) {
                        filterState.genres = filterState.genres.filter(id => id !== genreId);
                    } else {
                        filterState.genres.push(genreId);
                    }
                });
            });
        }
        
        async function applyFilters() {
            const mainInput = document.getElementById('mainSearchInput');
            const query = mainInput?.value?.trim() || '';
            
            // [S·ª¨A L·ªñI 7] Y√™u c·∫ßu: Ch·ªâ b√°o l·ªói khi input tr·ªëng
            if (!mainInput.value.trim()) {
                alert("Vui l√≤ng nh·∫≠p t·ª´ kh√≥a t√¨m ki·∫øm tr∆∞·ªõc khi l·ªçc.");
                if (mainInput) mainInput.focus();
                return;
            }
            
            const yearFrom = document.getElementById('yearFrom')?.value;
            const yearTo = document.getElementById('yearTo')?.value;
            const minRating = parseFloat(document.getElementById('minRating')?.value || 0);
            filterState.yearFrom = yearFrom || null;
            filterState.yearTo = yearTo || null;
            filterState.minRating = minRating;
            
            try {
                // T·∫£i l·∫°i d·ªØ li·ªáu n·∫øu query kh√°c ho·∫∑c ch∆∞a c√≥ cache
                if (lastQuery !== query || cachedResults.length === 0) {
                    await fetchNextApiPageAndAppend(query, true); 
                }
                
                let results = cachedResults.slice(); 
                
                // Ch·ªâ l·ªçc phim (b·ªè di·ªÖn vi√™n)
                results = results.filter(item => item.isPerson === false);
                
                if (filterState.genres.length > 0) {
                    results = results.filter(item => {
                        const genreIds = item.genre_ids || []; 
                        return filterState.genres.every(g => genreIds.includes(g));
                    });
                }
                if (filterState.yearFrom) {
                    results = results.filter(item => {
                        const year = (item.year || '0').substring(0, 4);
                        return year && parseInt(year) >= parseInt(filterState.yearFrom);
                    });
                }
                if (filterState.yearTo) {
                    results = results.filter(item => {
                        const year = (item.year || '9999').substring(0, 4);
                        return year && parseInt(year) <= parseInt(filterState.yearTo);
                    });
                }
                if (filterState.minRating > 0) {
                    results = results.filter(item => (item.rating || 0) >= filterState.minRating);
                }
                
                // S·∫Øp x·∫øp
                if (filterState.quickFilter === 'trending') {
                    // S·∫Øp x·∫øp theo popularity (vote_average)
                    results.sort((a, b) => (
                        parseFloat(b.popularity || b.rating || 0) - parseFloat(a.popularity || a.rating || 0)
                    ));
                } else if (filterState.quickFilter === 'new') {
                    // S·∫Øp x·∫øp theo nƒÉm (year)
                    results.sort((a, b) => (
                        parseInt(b.year || 0) - parseInt(a.year || 0)
                    ));
                } else if (filterState.quickFilter === 'top-rated') {
                    // S·∫Øp x·∫øp theo rating (ƒë√°nh gi√°)
                    results.sort((a, b) => (
                        parseFloat(b.rating || 0) - parseFloat(a.rating || 0)
                    ));
                }
                
                // [S·ª¨A] C·∫≠p nh·∫≠t cache ri√™ng bi·ªát
                cachedMovies = results; // `results` ch·ªâ ch·ª©a phim
                cachedPeople = []; // X√≥a h·∫øt di·ªÖn vi√™n khi l·ªçc
                displayedMoviesCount = 0;
                displayedPeopleCount = 0;
                nextApiPage = totalApiPages + 1; // Ng·ª´ng t·∫£i th√™m
                liveSuggestions.innerHTML = ''; // X√≥a c≈©
                
                // [S·ª¨A L·ªñI 8] Hi·ªÉn th·ªã th√¥ng b√°o n·∫øu l·ªçc kh√¥ng c√≤n g√¨
                if (results.length === 0) {
                    liveSuggestions.innerHTML = '<div style="padding:14px;text-align:center;color:rgba(255,255,255,0.6)">Kh√¥ng c√≥ k·∫øt qu·∫£ ph√π h·ª£p v·ªõi b·ªô l·ªçc</div>';
                    liveSuggestions.style.display = 'block';
                } else {
                    loadMoreSuggestions(); // Render l·∫°i
                }
                
                // [S·ª¨A L·ªñI 6] Kh√¥ng ƒë√≥ng c·ª≠a s·ªï filter theo y√™u c·∫ßu
                // (ƒê√£ x√≥a code ƒë√≥ng)
                
            } catch (error) {
                console.error('Apply filters error:', error);
                liveSuggestions.innerHTML = '<div style="padding:14px;text-align:center;color:rgba(255,255,255,0.5)">L·ªói khi √°p d·ª•ng b·ªô l·ªçc</div>';
                liveSuggestions.style.display = 'block';
            }
        }
        
        // =========================================================================
        // 4. C√ÅC H√ÄM KH√ÅC (GI·ªÆ NGUY√äN HO·∫∂C S·ª¨A L·ªñI)
        // =========================================================================
        
        // SEARCH ON ENTER
        mainInput?.addEventListener('keydown', (e) => {
            if (e.key === 'Enter') {
                e.preventDefault();
                performSearch();
            }
        });
        
        function performSearch() {
            const query = mainInput?.value.trim();
            if (query) {
                const urlParams = new URLSearchParams({ query: query });
                // G·ª≠i c·∫£ filter state ƒëi
                if (filterState.genres.length > 0) {
                    urlParams.append('genres', filterState.genres.join(','));
                }
                if (filterState.yearFrom) urlParams.append('yearFrom', filterState.yearFrom);
                if (filterState.yearTo) urlParams.append('yearTo', filterState.yearTo);
                if (filterState.minRating > 0) urlParams.append('minRating', filterState.minRating);
                if (filterState.quickFilter) urlParams.append('quickFilter', filterState.quickFilter);
                
                window.location.href = `/search?${urlParams.toString()}`;
            }
        }
        
        // Load Trending Carousel
        if (trendingCarousel) {
            loadTrendingCarousel();
        }
        
        async function loadTrendingCarousel() {
            try {
                const response = await fetch(`${API_BASE}/trending/movie/week?api_key=${API_KEY}&language=vi-VN`);
                const data = await response.json();
                trendingCarousel.innerHTML = data.results.slice(0, 10).map((movie, index) => {
                    return createMovieCardHTML(movie, index, true); 
                }).join('');
                if (typeof initHoverCards === 'function') {
                    initHoverCards();
                }
                
                // [S·ª¨A L·ªñI 3] K√≠ch ho·∫°t n√∫t b·∫•m carousel
                // H√†m n√†y ƒë·∫øn t·ª´ script.js (file chung)
                const globalInitializeAllCarousels = window.initializeAllCarousels;
                if (typeof globalInitializeAllCarousels === 'function') {
                    globalInitializeAllCarousels();
                } else {
                    console.warn('initializeAllCarousels() not found in script.js. Carousel buttons may not work.');
                }
            } catch (error) {
                console.error('Error loading trending:', error);
            }
        }

        // UTILITY FUNCTIONS
        function debounce(fn, wait = 250) {
            let timeout;
            return function(...args) {
                clearTimeout(timeout);
                timeout = setTimeout(() => fn.apply(this, args), wait);
            };
        }
        
        function escapeHtml(str) {
            if (!str) return '';
            const map = {
                '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#39;'
            };
            return str.replace(/[&<>"']/g, m => map[m]);
        }

        /**
         * H√†m n√†y ƒë·∫£m b·∫£o n√≥ t·ªìn t·∫°i v√† x·ª≠ l√Ω ƒë√∫ng d·ªØ li·ªáu (c·∫£ API v√† DB map)
         */
        function createMovieCardHTML(movie, index, isRanked = false) {
            const movieId = movie.id || movie.tmdbId;
            const movieTitle = escapeHtml(movie.title || movie.name || 'Unknown');
            // [S·ª¨A] ƒê·∫£m b·∫£o poster l·∫•y t·ª´ map (n·∫øu c√≥)
            const poster = movie.poster || (movie.poster_path ? `${IMG_BASE}/w500${movie.poster_path}` : '/images/placeholder.jpg');
            const backdrop = movie.backdrop || (movie.backdrop_path ? `${IMG_BASE}/original${movie.backdrop_path}` : '/images/placeholder.jpg');
            const rating = movie.rating || (movie.vote_average ? movie.vote_average.toFixed(1) : '‚Äî');
            const year = movie.year || (movie.release_date || movie.first_air_date || '').substring(0, 4) || '‚Äî';
            const safeOverview = escapeHtml(movie.overview || 'ƒêang t·∫£i m√¥ t·∫£...');
            
            const playerId = `hover-player-search-${movieId}-${index}`; 
            const rankClass = isRanked ? `ranked rank-${((index % 5) + 1)}` : '';
            const rankOverlay = isRanked ? '<div class="ranking-overlay"></div>' : '';
            const rankNumber = isRanked ? `<div class="ranking-number">${index + 1}</div>` : '';
            
            // L·∫•y c√°c h√†m to√†n c·ª•c t·ª´ script.js (n·∫øu c√≥)
            const globalGoToMovieDetail = window.goToMovieDetail || function(btn) { location.href = `/movie/detail/${btn.dataset.movieId}`; };
            const globalToggleHoverLike = window.toggleHoverLike || function(btn) { btn.classList.toggle('active'); };
            const globalShowShareModal = window.showShareModal || function(btn) { console.warn('showShareModal not defined'); };
            
            return `
            <div class="movie-card ${rankClass}" data-movie-id="${movieId}">
                <div class="movie-poster">
                    <img src="${poster}" alt="${movieTitle}" onerror="this.src='/images/placeholder.jpg'">
                    ${rankOverlay} ${rankNumber}
                </div>
                <div class="movie-info">
                    <h3>${movieTitle}</h3>
                    <p class="movie-rating">‚≠ê <span>${rating}</span></p>
                </div>
                <div class="movie-hover-card" data-movie-id="${movieId}">
                    <div class="hover-card-media">
                        <img class="hover-card-image" src="${backdrop}" alt="${movieTitle}" onerror="this.src='/images/placeholder.jpg'">
                        <div class="hover-player-container"><div class="hover-player" id="${playerId}"></div></div>
                        <button class="hover-volume-btn" type="button" title="B·∫≠t/T·∫Øt ti·∫øng"><i class="fas fa-volume-mute"></i></button>
                    </div>
                    <div class="hover-card-content">
                        <div class="hover-card-actions">
                            <button class="hover-play-btn" type="button" data-movie-id="${movieId}" onclick="event.stopPropagation(); globalGoToMovieDetail(this)">
                                <i class="fas fa-play"></i> Xem ngay
                            </button>
                            <button class="hover-action-icon hover-like-btn" type="button" onclick="event.stopPropagation(); globalToggleHoverLike(this)" title="Th√™m v√†o danh s√°ch">
                                <i class="far fa-heart"></i>
                            </button>
                            <button class="hover-action-icon hover-share-btn" type="button"
                                    data-movie-id="${movieId}" data-movie-title="${movieTitle}"
                                    onclick="event.stopPropagation(); globalShowShareModal(this)" title="Chia s·∫ª">
                                <i class="fas fa-share-alt"></i>
                            </button>
                        </div>
                        <h3 class="hover-card-title">${movieTitle}</h3>
                        <div class="hover-card-meta">
                            <span class="meta-rating"><i class="fas fa-star"></i> <span>${rating}</span></span>
                            <span class="meta-year">${year}</span>
                            <span class="meta-quality">HD</span>
                        </div>
                        <div class="hover-card-meta-extra">
                            <span class="meta-extra-rating loading-meta">T</span>
                            <span class="meta-extra-runtime loading-meta">‚Äî ph√∫t</span>
                            <span class="meta-extra-country loading-meta">Qu·ªëc gia</span>
                        </div>
                        <div class="hover-card-genres">
                            <span class="genre-tag loading-genre">ƒêang t·∫£i...</span>
                        </div>
                        <p class="hover-card-description">${safeOverview}</p>
                    </div>
                </div>
                </div>
            `;
        }
        
        function normalizeVietnamese(str) {
            if (!str) return '';
            return str.normalize('NFD').replace(/[\u0300-\u036f]/g, '').toLowerCase();
        }
        
        function calculateRelevance(item, query) {
             const q = normalizeVietnamese(query);
            const title = normalizeVietnamese(item.title || item.name || '');
            const overview = normalizeVietnamese(item.overview || '');
            let score = 0;
            if (title === q) score += 100;
            else if (title.startsWith(q)) score += 80;
            else if (title.includes(q)) score += 50;
            if (overview.includes(q)) score += 20;
            score += (item.popularity || 0) * 0.1;
            score += (item.vote_average || 0) * 2;
            return score;
        }
        
        // VOICE SEARCH
        if (voiceBtn) {
            if ('webkitSpeechRecognition' in window || 'SpeechRecognition' in window) {
                const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
                const recognition = new SpeechRecognition();
                recognition.lang = 'vi-VI';
                recognition.interimResults = false;
                
                voiceBtn.addEventListener('click', (e) => {
                    e.preventDefault();
                    e.stopPropagation();
                    if (voiceBtn.classList.contains('recording')) {
                        recognition.stop();
                    } else {
                        try { recognition.start(); } catch (err) { console.warn('Voice recognition error:', err); }
                    }
                });
                recognition.onstart = () => { voiceBtn.classList.add('recording'); };
                recognition.onend = () => { voiceBtn.classList.remove('recording'); };
                recognition.onresult = (event) => {
                    const transcript = event.results[0][0].transcript;
                    if (mainInput) {
                        mainInput.value = transcript;
                        mainInput.focus();
                        // K√≠ch ho·∫°t t√¨m ki·∫øm m·ªõi
                        clearTimeout(searchTimeout);
                        cachedResults = [];
                        displayedCount = 0;
                        nextApiPage = 1;
                        totalApiPages = 1;
                        lastQuery = transcript;
                        liveSuggestions.innerHTML = '';
                        fetchNextApiPageAndAppend(transcript, true);
                    }
                };
                recognition.onerror = (event) => {
                    voiceBtn.classList.remove('recording');
                    console.warn('Voice recognition error:', event.error);
                };
            } else {
                voiceBtn.style.display = 'none';
            }
        }
        
        // [S·ª¨A L·ªñI 2] N√öT AI BUTTON (S·ª¨ D·ª§NG LOGIC T·ª™ search_old.docx)
        if (aiBtn) {
            aiBtn.addEventListener('click', () => {
                // M·ªü c·ª≠a s·ªï AI Search (HTML ƒë√£ ƒë∆∞·ª£c th√™m ·ªü B∆∞·ªõc 2)
                openAiSearch();
            });
        }
        
        // =========================================================================
        // 5. [TH√äM M·ªöI] LOGIC CHO AI SEARCH MODAL (T·ª™ search_old.docx)
        // =========================================================================
        
        /**
         * M·ªü Modal AI Search
         */
        function openAiSearch() {
            const modal = document.getElementById('aiSearchModal');
            if (modal) {
                modal.style.display = 'flex'; // Hi·ªán modal
                // Reset form
                const aiInput = document.getElementById('aiSearchInput');
                if(aiInput) aiInput.value = '';
                document.getElementById('aiSearchResults').style.display = 'none';
                document.getElementById('aiSearchLoading').style.display = 'none';
                document.getElementById('aiSearchSubmitBtn').disabled = false;
                if(aiInput) aiInput.focus();
            }
        }
        
        // G√°n h√†m n√†y ra window ƒë·ªÉ HTML (onclick) c√≥ th·ªÉ g·ªçi
        window.closeAiSearch = function() {
            const modal = document.getElementById('aiSearchModal');
            if (modal) modal.style.display = 'none'; // ·∫®n modal
        }
        
        /**
         * X·ª≠ l√Ω submit form AI (g·ªçi AISearchController)
         */
        window.submitAiSearch = async function() {
            const input = document.getElementById('aiSearchInput');
            const description = input.value.trim();
            if (!description) {
                alert('Vui l√≤ng nh·∫≠p m√¥ t·∫£');
                return;
            }
            
            const loadingEl = document.getElementById('aiSearchLoading');
            const resultsEl = document.getElementById('aiSearchResults');
            const submitBtn = document.getElementById('aiSearchSubmitBtn');
            
            loadingEl.style.display = 'block';
            resultsEl.style.display = 'none';
            submitBtn.disabled = true;
            
            try {
                // G·ªçi AISearchController (file n√†y b·∫°n ƒë√£ c√≥)
                const response = await fetch('/api/ai-search/suggest', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ description: description })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    document.getElementById('aiAnswer').textContent = data.answer;
                    const chipsContainer = document.getElementById('aiSuggestionChips');
                    chipsContainer.innerHTML = ''; // X√≥a chip c≈©
                    
                    (data.suggestions || []).forEach(text => {
                        const chip = document.createElement('div');
                        // [S·ª¨A] D√πng class t·ª´ search_old.docx
                        chip.className = 'ai-suggestion-chip'; 
                        chip.textContent = text;
                        chip.onclick = () => {
                            // Khi b·∫•m v√†o chip, ƒë√≥ng modal v√† search
                            closeAiSearch();
                            mainInput.value = text;
                            performSearch(); // Chuy·ªÉn sang trang k·∫øt qu·∫£
                        };
                        chipsContainer.appendChild(chip);
                    });
                    
                    resultsEl.style.display = 'block';
                } else {
                    document.getElementById('aiAnswer').textContent = data.message || 'C√≥ l·ªói x·∫£y ra';
                    document.getElementById('aiSuggestionChips').innerHTML = '';
                    resultsEl.style.display = 'block';
                }
                
            } catch (err) {
                resultsEl.style.display = 'block';
                document.getElementById('aiAnswer').textContent = 'L·ªói k·∫øt n·ªëi: ' + err.message;
                document.getElementById('aiSuggestionChips').innerHTML = '';
            } finally {
                loadingEl.style.display = 'none';
                submitBtn.disabled = false;
            }
        }
        
        // =========================================================================
        // 6. KH·ªûI T·∫†O (INITIALIZE)
        // =========================================================================
        initFilters();
        initAISearch();

        document.addEventListener('DOMContentLoaded', function() {
            // L·∫•y c√°c h√†m t·ª´ script.js (ƒë√£ ƒë∆∞·ª£c t·∫£i tr∆∞·ªõc)
            const globalInitHoverCards = window.initHoverCards;
            const globalInitializeAllCarousels = window.initializeAllCarousels; // T√™n h√†m ƒë√∫ng t·ª´ script.js

            if (typeof globalInitHoverCards === 'function') {
                globalInitHoverCards();
            }
            
            // [S·ª¨A L·ªñI 3] G·ªçi t√™n h√†m ƒë√∫ng ƒë·ªÉ k√≠ch ho·∫°t c√°c n√∫t carousel
            if (typeof globalInitializeAllCarousels === 'function') {
                 globalInitializeAllCarousels();
            } else {
                console.warn('initializeAllCarousels() not found in script.js. Carousel buttons may not work.');
            }
        });
        
        // Debug helpers
        window.__searchDebug = {
            getCached: () => cachedResults,
            getDisplayedCount: () => displayedCount,
            getFilterState: () => filterState,
            loadMore: loadMoreSuggestions,
            applyFilters: applyFilters
        };
        
        console.log('‚úÖ Search page script V7 (All fixes) initialized');
        
    })();
    </script>
    <script src="https://www.youtube.com/iframe_api"></script>
    <script th:src="@{/js/movie/ai-agent.js}" defer></script>
    <script src="/js/movie/share-modal.js"></script>
    <script src="/js/script.js"></script>

    <div th:replace="fragments/share-modal :: shareModal"></div>
</body>
</html>