<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <title>Messenger - FFilm Connect</title>
    <meta charset="UTF-8">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
    <link rel="stylesheet" href="/css/style.css" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/sockjs-client/1.5.1/sockjs.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/stomp.js/2.3.3/stomp.min.js"></script>
    
    <style>
        /* CORE UI */
        body { background-color: #000; color: #e4e6eb; height: 100vh; display: flex; flex-direction: column; overflow: hidden; font-family: 'Segoe UI', sans-serif; }
        .messenger-layout { display: flex; flex: 1; height: 100%; margin-top: 60px; /* Trừ Header */ }
        
        /* SIDEBAR (CONTACTS) */
        .chat-sidebar { width: 360px; background: #1a1a1a; border-right: 1px solid #2f2f2f; display: flex; flex-direction: column; }
        .search-box { padding: 15px; }
        .search-input { background: #2a2a2a; border: none; border-radius: 20px; padding: 10px 20px; color: white; width: 100%; outline: none; transition: 0.2s; }
        .search-input:focus { background: #333; }
        
        .friend-list { flex: 1; overflow-y: auto; padding: 10px; }
        .friend-item { padding: 10px; border-radius: 10px; display: flex; align-items: center; gap: 15px; cursor: pointer; transition: 0.2s; }
        .friend-item:hover, .friend-item.active { background: rgba(255, 255, 255, 0.1); }
        .avatar-wrapper { position: relative; }
        .avatar { width: 50px; height: 50px; border-radius: 50%; object-fit: cover; border: 2px solid #1a1a1a; }
        .status-dot { width: 14px; height: 14px; background: #31a24c; border-radius: 50%; border: 2px solid #1a1a1a; position: absolute; bottom: 0; right: 0; }
        .friend-info h6 { margin: 0; font-weight: 600; font-size: 1rem; }
        .friend-info p { margin: 0; font-size: 0.85rem; color: #b0b3b8; }

        /* MAIN CHAT AREA */
        .chat-main { flex: 1; display: flex; flex-direction: column; background: #000; position: relative; }
        
        /* Header */
        .chat-header { padding: 10px 20px; border-bottom: 1px solid #2f2f2f; display: flex; align-items: center; gap: 15px; background: rgba(26,26,26,0.95); backdrop-filter: blur(10px); }
        .header-avatar { width: 40px; height: 40px; border-radius: 50%; }
        .header-info h5 { margin: 0; font-size: 1.1rem; font-weight: 700; }
        .header-info span { font-size: 0.8rem; color: #31a24c; }

        /* Message List */
        .messages-area { flex: 1; padding: 20px; overflow-y: auto; display: flex; flex-direction: column; gap: 5px; }
        .msg-row { display: flex; gap: 10px; max-width: 70%; margin-bottom: 5px; animation: fadeIn 0.2s ease; }
        .msg-row.mine { align-self: flex-end; flex-direction: row-reverse; }
        
        .msg-bubble { padding: 10px 15px; border-radius: 18px; font-size: 0.95rem; line-height: 1.4; position: relative; word-wrap: break-word; color: #fff; }
        .msg-row.mine .msg-bubble { background: #0084ff; border-bottom-right-radius: 4px; }
        .msg-row.other .msg-bubble { background: #3e4042; border-bottom-left-radius: 4px; }
        .msg-time { font-size: 0.7rem; color: #777; margin-top: 2px; display: none; }
        .msg-row:hover .msg-time { display: block; }

        /* Footer Input */
        .chat-footer { padding: 15px 20px; background: #1a1a1a; display: flex; align-items: center; gap: 15px; }
        .chat-input { flex: 1; background: #3a3b3c; border: none; padding: 10px 15px; border-radius: 20px; color: white; outline: none; }
        .chat-input:focus { background: #4e4f50; }
        .icon-btn { background: none; border: none; color: #0084ff; font-size: 1.4rem; cursor: pointer; transition: 0.2s; padding: 5px; }
        .icon-btn:hover { transform: scale(1.1); color: #fff; }

        /* Helper */
        .empty-chat { flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: center; color: #777; text-align: center; }
        .hidden { display: none !important; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        
        /* Giphy Dropup */
        .sticker-menu { position: absolute; bottom: 70px; left: 20px; width: 320px; height: 350px; background: #242526; border-radius: 10px; border: 1px solid #333; display: none; overflow-y: auto; padding: 10px; z-index: 100; box-shadow: 0 5px 20px rgba(0,0,0,0.5); }

        /* [BLOCK CSS] Messenger Actions & Reactions */
        .msg-row { position: relative; align-items: flex-end; }
        .msg-avatar { width: 28px; height: 28px; border-radius: 50%; margin-right: 8px; }

        .msg-content-wrapper { display: flex; flex-direction: column; max-width: 100%; }

        /* Reply Context */
        .reply-context { font-size: 0.75rem; color: #bbb; margin-bottom: 2px; padding-left: 10px; border-left: 2px solid #555; }

        /* Actions (Ẩn hiện khi hover) */
        .msg-actions { 
            opacity: 0; transition: opacity 0.2s; 
            position: absolute; top: 50%; transform: translateY(-50%);
            background: #2a2a2a; border-radius: 15px; padding: 2px 5px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.3);
        }
        .msg-row.mine .msg-actions { left: -80px; }
        .msg-row.other .msg-actions { right: -80px; }
        .msg-row:hover .msg-actions { opacity: 1; }

        .msg-actions button { background: none; border: none; color: #bbb; cursor: pointer; padding: 5px; }
        .msg-actions button:hover { color: #fff; }

        /* Reaction Display (Trái tim nhỏ dính vào tin nhắn) */
        .reaction-display {
            position: absolute; bottom: -10px; right: 0;
            background: #2a2a2a; border-radius: 10px; padding: 2px 4px;
            font-size: 0.7rem; border: 1px solid #000;
            display: flex; gap: 2px;
        }
        .msg-row.mine .reaction-display { left: 0; right: auto; }
    </style>
</head>
<body>
    <div th:replace="~{fragments/header :: header}"></div>

    <div class="messenger-layout">
        <div class="chat-sidebar">
            <div class="search-box">
                <h3 class="fw-bold mb-3">Đoạn chat</h3>
                <input type="text" class="search-input" placeholder="Tìm kiếm trên Messenger...">
            </div>
            <div class="friend-list">
                <div th:each="contact : ${contacts}" class="friend-item" 
                     th:onclick="'selectUser(\'' + ${contact.userName} + '\')'" 
                     th:id="'user-' + ${contact.userName}">
                    
                    <div class="avatar-wrapper">
                        <img th:src="'https://ui-avatars.com/api/?name=' + ${contact.userName} + '&background=random&color=fff'" class="avatar">
                        <div class="status-dot"></div>
                    </div>
                    <div class="friend-info">
                        <h6 th:text="${contact.userName}">User Name</h6>
                        <p class="text-truncate">Nhắn tin ngay</p>
                    </div>
                </div>
            </div>
        </div>

        <div class="chat-main">
            <div id="emptyState" class="empty-chat">
                <i class="fab fa-facebook-messenger fa-5x mb-3 text-primary"></i>
                <h2>Chào mừng đến với FFilm Messenger</h2>
                <p>Chọn một người bạn để bắt đầu cuộc trò chuyện.</p>
            </div>

            <div id="activeChat" class="d-flex flex-column h-100 hidden">
                <div class="chat-header">
                    <img src="" id="headerAvatar" class="header-avatar">
                    <div class="header-info">
                        <h5 id="headerName">User Name</h5>
                        <span><i class="fas fa-circle x-small"></i> Đang hoạt động</span>
                    </div>
                </div>

                <div class="messages-area" id="msgArea">
                    </div>

                <div id="stickerMenu" class="sticker-menu">
                    </div>

                <div class="chat-footer">
                    <label class="icon-btn" title="Gửi ảnh">
                        <i class="fas fa-image"></i>
                        <input type="file" id="imageInput" hidden accept="image/*" onchange="uploadImage()">
                    </label>
                    <button class="icon-btn" onclick="toggleStickers()"><i class="fas fa-sticky-note"></i></button>
                    
                    <input type="text" id="msgInput" class="chat-input" placeholder="Nhập tin nhắn..." onkeypress="handleEnter(event)">
                    
                    <button class="icon-btn" onclick="sendPrivateMsg()"><i class="fas fa-paper-plane"></i></button>
                </div>
            </div>
        </div>
    </div>

    <script th:inline="javascript">
        const currentUser = /*[[${user.userName}]]*/ 'Me';
    </script>
    <script src="/js/messenger.js"></script>
</body>
</html>