<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <title>Messenger - FFilm Connect</title>
    <meta charset="UTF-8">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="/css/style.css">
    <link rel="stylesheet" href="/css/messenger.css">
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/sockjs-client/1.5.1/sockjs.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/stomp.js/2.3.3/stomp.min.js"></script>
</head>

<body class="messenger-body">
    <!-- HEADER -->
    <div th:replace="fragments/header :: header"></div>

    <!-- MAIN MESSENGER CONTAINER -->
    <div class="messenger-container">
        <!-- LEFT SIDEBAR -->
        <div class="msg-sidebar">
            <div class="sidebar-header">
                <h2>Chats</h2>
                <div class="icon-btn"><i class="fas fa-edit"></i></div>
            </div>

            <div class="search-wrapper">
                <i class="fas fa-search text-muted"></i>
                <input type="text" id="convSearchInput" placeholder="Tìm kiếm trên Messenger" onkeyup="window.filterConversations()">
            </div>

            <div class="conversation-list" id="conversationList">
                <div class="text-center mt-4 text-muted">
                    <i class="fas fa-circle-notch fa-spin"></i> Đang tải...
                </div>
            </div>
        </div>

        <!-- MAIN CHAT AREA -->
        <div class="msg-chat-area">
            <!-- Empty State -->
            <div id="emptyState" class="empty-state">
                <i class="fab fa-facebook-messenger"></i>
                <h3>Chọn một đoạn chat để bắt đầu</h3>
            </div>

            <!-- Chat Interface -->
            <div id="chatInterface" style="display: none;">
                <!-- Chat Header -->
                <div class="chat-header">
                    <div class="chat-user-info">
                        <img id="headerAvatar" src="/images/placeholder-user.jpg" class="avatar-img">
                        <div>
                            <h4 id="headerName">User Name</h4>
                            <small class="text-success">Đang hoạt động</small>
                        </div>
                    </div>
                    <div class="chat-actions">
                        <i class="fas fa-phone-alt" title="Gọi thoại" onclick="window.startVoiceCall()"></i>
                        <i class="fas fa-video" title="Video Call" onclick="window.startVideoCall()"></i>
                        <i class="fas fa-info-circle" id="btnToggleInfo" title="Thông tin hội thoại" onclick="window.toggleChatInfo()"></i>
                    </div>
                </div>

                <!-- Stranger Banner -->
                <div id="strangerBanner" class="stranger-alert-bar" style="display: none;">
                    <div class="stranger-content">
                        <i class="fas fa-user-shield"></i>
                        <span>Tin nhắn từ người lạ. Hãy cẩn thận khi chia sẻ thông tin.</span>
                    </div>
                    <div class="stranger-actions">
                        <button class="btn-stranger-add" onclick="window.sendFriendRequest()">Kết bạn</button>
                        <button class="btn-stranger-block" onclick="alert('Tính năng chặn đang phát triển')">Chặn</button>
                    </div>
                </div>

                <!-- Messages Container -->
                <div class="messages-container" id="messagesContainer">
                    <!-- Messages will be rendered here -->
                </div>

                <!-- Chat Footer -->
                <div class="chat-footer">
                    <!-- Media Preview -->
                    <div id="mediaPreview" class="media-preview" style="display: none;">
                        <div class="preview-content">
                            <img id="previewImg" src="" style="display: none;">
                            <div id="filePreviewIcon" style="display: none;">
                                <i class="fas fa-file fa-2x"></i>
                                <span id="previewFileName"></span>
                            </div>
                            <div class="remove-preview-btn" onclick="window.clearPreview()">
                                <i class="fas fa-times"></i>
                            </div>
                        </div>
                    </div>

                    <!-- Replying Bar -->
                    <div id="replyingBar" class="replying-bar" style="display: none;">
                        <div>
                            <span style="font-weight:bold; color:#e50914;">Trả lời tin nhắn</span>
                            <div id="replyingText" style="font-size:12px; color:#aaa;">Nội dung tin nhắn...</div>
                        </div>
                        <div onclick="window.cancelReply()" style="cursor:pointer;">
                            <i class="fas fa-times"></i>
                        </div>
                    </div>

                    <!-- Input Actions -->
                    <div class="input-actions" id="normalInputState">
                        <label class="footer-btn" title="Gửi ảnh">
                            <i class="fas fa-image"></i>
                            <input type="file" id="imageInput" hidden accept="image/*">
                        </label>

                        <label class="footer-btn" title="Gửi file">
                            <i class="fas fa-paperclip"></i>
                            <input type="file" id="fileInput" hidden>
                        </label>

                        <div class="footer-btn" id="stickerBtn" title="Sticker">
                            <i class="fas fa-sticky-note"></i>
                        </div>

                        <div class="input-group">
                            <input type="text" id="msgInput" placeholder="Nhập tin nhắn..." autocomplete="off">
                            <i class="fas fa-smile emoji-btn" id="emojiTrigger"></i>
                        </div>

                        <div class="footer-btn send-btn" id="sendBtn" title="Gửi">
                            <i class="fas fa-paper-plane"></i>
                        </div>

                        <div class="footer-btn mic-btn" id="micBtn" title="Ghi âm">
                            <i class="fas fa-microphone"></i>
                        </div>
                    </div>

                    <!-- Recording UI -->
                    <div class="recording-ui" id="recordingState" style="display: none;">
                        <div class="footer-btn cancel-record" onclick="window.cancelRecording()">
                            <i class="fas fa-times"></i>
                        </div>
                        <div class="record-display">
                            <div class="record-dot"></div>
                            <span id="recordTimer">00:00</span>
                            <div class="fake-wave">
                                <span></span><span></span><span></span><span></span><span></span>
                            </div>
                        </div>
                        <div class="footer-btn send-record-btn" onclick="window.finishRecording()">
                            <i class="fas fa-paper-plane"></i>
                        </div>
                    </div>

                    <!-- Sticker Suggestions -->
                    <div id="stickerSuggestions" class="sticker-suggestions">
                        <div class="suggestions-header">
                            <span>Gợi ý stickers</span>
                            <i class="fas fa-times close-suggestions" onclick="hideStickerSuggestions()"></i>
                        </div>
                        <div id="suggestionsGrid" class="suggestions-grid"></div>
                    </div>
                </div>

                <!-- Sticker Menu -->
                <div id="stickerMenu" class="sticker-menu">
                    <div class="sticker-header">
                        <div class="sticker-tabs">
                            <button class="tab-btn active">Stickers</button>
                            <button class="tab-btn">GIFs</button>
                        </div>
                        <i class="fas fa-times close-sticker" onclick="window.toggleStickers()"></i>
                    </div>
                    <div class="sticker-search">
                        <input type="text" placeholder="Tìm kiếm stickers...">
                        <i class="fas fa-search"></i>
                    </div>
                    <div class="sticker-grid" id="stickerGrid"></div>
                </div>
            </div>
        </div>

        <!-- RIGHT SIDEBAR (INFO) -->
        <div class="chat-info-sidebar hidden" id="chatInfoSidebar">
            <div class="info-header">
                <img id="infoAvatar" src="/images/placeholder-user.jpg" class="info-avatar-lg">
                <h3 id="infoName">User Name</h3>
                <span class="info-status">Đang hoạt động</span>
                
                <!-- Thêm action buttons -->
                <div class="info-header-actions">
                    <button class="info-action-btn" onclick="viewProfile()" title="Xem trang cá nhân">
                        <i class="fas fa-user-circle"></i>
                    </button>
                    <button class="info-action-btn" onclick="openChatSearch()" title="Tìm kiếm tin nhắn">
                        <i class="fas fa-search"></i>
                    </button>
                    <button class="info-action-btn" onclick="toggleNotifications()" title="Tắt thông báo">
                        <i class="fas fa-bell"></i>
                    </button>
                    <button class="info-action-btn" onclick="openPinnedMessagesModal()" title="Tin nhắn đã ghim">
                        <i class="fas fa-thumbtack"></i>
                    </button>
                </div>
            </div>

            <div class="info-body custom-scrollbar">
                <div class="accordion-item">
                    <div class="accordion-header" onclick="window.toggleAccordion(this)">
                        <span>Tùy chỉnh đoạn chat</span>
                        <i class="fas fa-chevron-down"></i>
                    </div>
                    <div class="accordion-content">
                        <div class="info-action-btn" onclick="window.openThemePicker()">
                            <i class="fas fa-palette" style="color: #0084ff;"></i> Đổi chủ đề
                        </div>
                        <div class="info-action-btn" onclick="window.openNicknameModal()">
                            <i class="fas fa-font"></i> Chỉnh sửa biệt danh
                        </div>
                        <div class="info-action-btn" onclick="window.openBackgroundPicker()">
                            <i class="fas fa-image"></i> Đổi nền chat
                        </div>
                        <div class="info-action-btn" onclick="window.viewChatStats()">
                            <i class="fas fa-chart-bar"></i> Thống kê đoạn chat
                        </div>
                    </div>
                </div>

                <div class="accordion-item">
                    <div class="accordion-header" onclick="window.toggleAccordion(this)">
                        <span>File phương tiện & file</span>
                        <i class="fas fa-chevron-down"></i>
                    </div>
                    <div class="accordion-content">
                        <div class="media-tabs">
                            <span class="media-tab active" onclick="window.switchMediaTab('img')">Ảnh</span>
                            <span class="media-tab" onclick="window.switchMediaTab('file')">File</span>
                        </div>

                        <div id="sharedImagesGrid" class="media-grid">
                            <div class="text-muted small text-center w-100 mt-2">Đang tải...</div>
                        </div>

                        <div id="sharedFilesList" class="file-list" style="display:none;"></div>
                    </div>
                </div>

                <div class="accordion-item">
                    <div class="accordion-header" onclick="window.toggleAccordion(this)">
                        <span>Quyền riêng tư & hỗ trợ</span>
                        <i class="fas fa-chevron-down"></i>
                    </div>
                    <div class="accordion-content">
                        <div class="info-action-btn text-warning">
                            <i class="fas fa-bell-slash"></i> Tắt thông báo
                        </div>
                        <div class="info-action-btn text-danger" onclick="alert('Chức năng chặn')">
                            <i class="fas fa-ban"></i> Chặn
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- VIDEO CALL MODAL -->
    <div id="videoCallModal" class="call-modal" style="display: none;">
        <div class="call-background" id="callBackground"></div>
        
        <div class="call-container">
            <!-- Remote Video (Partner) -->
            <div class="remote-video-container">
                <video id="remoteVideo" autoplay playsinline></video>
                <div class="remote-info-overlay">
                    <div class="partner-avatar-large" id="callPartnerAvatar"></div>
                    <div class="partner-name" id="callPartnerName"></div>
                    <div class="call-status" id="callStatusText">Đang kết nối...</div>
                    <div class="call-timer" id="callDuration">00:00</div>
                </div>
            </div>
            
            <!-- Local Video (Self) -->
            <div class="local-video-container">
                <video id="localVideo" autoplay playsinline muted></video>
                <div class="local-info-overlay">
                    <span class="local-name">Bạn</span>
                </div>
            </div>
            
            <!-- Call Controls -->
            <div class="call-controls">
                <button class="call-control-btn" id="btnToggleMic" onclick="toggleCallMic()">
                    <i class="fas fa-microphone"></i>
                    <span class="control-label">Tắt mic</span>
                </button>
                
                <button class="call-control-btn" id="btnToggleCam" onclick="toggleCallCam()">
                    <i class="fas fa-video"></i>
                    <span class="control-label">Tắt camera</span>
                </button>
                
                <button class="call-control-btn switch-camera-btn" onclick="switchCamera()" style="display: none;">
                    <i class="fas fa-sync-alt"></i>
                    <span class="control-label">Đổi camera</span>
                </button>
                
                <button class="call-control-btn end-call-btn" onclick="endCall()">
                    <i class="fas fa-phone-slash"></i>
                    <span class="control-label">Kết thúc</span>
                </button>
            </div>
        </div>
    </div>

    <!-- INCOMING CALL MODAL -->
    <div id="incomingCallModal" class="incoming-call-modal" style="display: none;">
        <div class="incoming-call-content">
            <div class="caller-avatar">
                <img id="incomingAvatar" src="" alt="">
                <div class="caller-ring">
                    <div class="ring-circle"></div>
                    <div class="ring-circle"></div>
                    <div class="ring-circle"></div>
                </div>
            </div>
            
            <div class="caller-info">
                <h3 id="incomingName">Đang gọi...</h3>
                <p id="incomingCallType">Cuộc gọi video</p>
            </div>
            
            <div class="incoming-call-actions">
                <button class="call-action-btn decline-btn" onclick="rejectCall()">
                    <i class="fas fa-phone-slash"></i>
                    <span>Từ chối</span>
                </button>
                
                <button class="call-action-btn accept-btn" onclick="acceptCall()">
                    <i class="fas fa-phone"></i>
                    <span>Trả lời</span>
                </button>
            </div>
        </div>
    </div>

    <script th:inline="javascript">
        const currentUser = /*[[${userJson}]]*/ {};
    </script>

    <!-- Full Emoji Picker with Categories & Search -->
    <!-- <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/emoji-picker-element@1.0.0/styles.css">
    <script src="https://unpkg.com/emoji-picker-element"></script> -->

    <!-- <script src="https://cdn.jsdelivr.net/npm/emoji-picker-element@1.0.0/index.js"></script> -->
    <script src="https://unpkg.com/peerjs@1.5.1/dist/peerjs.min.js"></script>
    <script src="/js/emoji-data.js"></script>
    <script src="/js/script.js"></script>
    <script src="/js/stickers.js"></script>
    <script src="/js/messenger.js"></script>
    
    <script>
        $(document).ready(function() {
            if (typeof window.messengerInit === 'function') {
                window.messengerInit();
            }
        });
    </script>
    <script>
    // Debug: Kiểm tra xem emoji data có được tải không
    window.addEventListener('load', function() {
        console.log('Page loaded, checking emoji data...');
        console.log('EMOJI_DATA exists:', !!window.EMOJI_DATA);
        console.log('EMOJI_CATEGORIES exists:', !!window.EMOJI_CATEGORIES);
        
        if (window.EMOJI_DATA) {
            console.log('EMOJI_DATA length:', window.EMOJI_DATA.length);
            console.log('First emoji:', window.EMOJI_DATA[0]);
        }
        
        if (window.EMOJI_CATEGORIES) {
            console.log('EMOJI_CATEGORIES length:', window.EMOJI_CATEGORIES.length);
        }
    });
    </script>
</body>
</html>