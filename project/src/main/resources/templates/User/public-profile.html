<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <title th:text="${profile.name} + ' - Profile'">Profile</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <div th:replace="~{fragments/header :: header}"></div>
    <link rel="stylesheet" href="/css/footer.css">
    <link rel="stylesheet" href="/css/style.css">
    <link rel="stylesheet" href="/css/hover-card.css">
    
    <style>
        body { background-color: #141414; color: #fff; padding-top: 60px; }
        
        /* COVER & HEADER */
        .profile-cover {
            height: 350px; background: linear-gradient(to bottom, #555, #111); position: relative;
        }
        .profile-main { max-width: 1200px; margin: 0 auto; padding: 0 20px; position: relative; top: -60px; }
        
        .profile-header { display: flex; align-items: flex-end; gap: 30px; padding-bottom: 20px; border-bottom: 1px solid #333; }
        .avatar-lg {
            width: 160px; height: 160px; border-radius: 50%; 
            border: 4px solid #141414; background: #333; object-fit: cover;
            box-shadow: 0 5px 15px rgba(0,0,0,0.5);
        }
        .info-col { flex: 1; padding-bottom: 10px; }
        .user-name { font-size: 2.2rem; font-weight: 800; margin: 0; display: flex; align-items: center; gap: 10px; }
        .stats-row { display: flex; gap: 25px; color: #bbb; margin-top: 8px; font-size: 1rem; }
        .stats-row strong { color: #fff; }

        /* BUTTONS */
        .btn-group-social { display: flex; gap: 10px; margin-bottom: 10px; }
        .btn-social {
            padding: 8px 20px; border-radius: 6px; border: none; font-weight: 600; cursor: pointer;
            display: flex; align-items: center; gap: 8px; font-size: 0.95rem; transition: 0.2s; text-decoration: none;
        }
        .btn-blue { background: #0084ff; color: #fff; }
        .btn-blue:hover { background: #0073e6; }
        .btn-dark { background: #3a3b3c; color: #e4e6eb; }
        .btn-dark:hover { background: #4e4f50; }

        /* SECTIONS */
        .section-box { margin-top: 40px; }
        .section-title { 
            font-size: 1.5rem; font-weight: 700; margin-bottom: 20px; 
            border-left: 4px solid #e50914; padding-left: 15px; 
        }
        
        /* FRIEND GRID */
        .friend-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(100px, 1fr)); gap: 15px; }
        .friend-card { text-align: center; cursor: pointer; }
        .friend-card:hover img { transform: scale(1.05); }
        .friend-card img { width: 100%; aspect-ratio: 1/1; border-radius: 50%; object-fit: cover; transition: 0.2s; border: 2px solid #333; }
        .friend-card span { font-size: 0.9rem; font-weight: 500; margin-top: 5px; display: block; }

        /* MOVIE GRID (Reuse Style Index) */
        .movie-list-container {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 20px;
            padding-bottom: 20px;
        }
        
        /* Ghi đè CSS Hover Card cho Profile để không bị vỡ */
        .movie-card { width: 100%; }
        .movie-poster { width: 100%; aspect-ratio: 2/3; }
        .movie-poster img { width: 100%; height: 100%; object-fit: cover; border-radius: 8px; }
    </style>
</head>
<body>

    <div class="profile-cover"></div>

    <div class="profile-main">
        <div class="profile-header">
            <img th:src="${profile.avatar}" class="avatar-lg">
            
            <div class="info-col">
                <h1 class="user-name">
                    <span th:text="${profile.name}">Name</span>
                    <i class="fas fa-check-circle text-primary" style="font-size: 1.2rem;" title="Xác minh"></i>
                </h1>
                <div class="stats-row">
                    <span><strong th:text="${profile.friendCount}">0</strong> Bạn bè</span>
                    <span><strong th:text="${profile.followerCount}">0</strong> Người theo dõi</span>
                    <span><strong th:text="${profile.followingCount}">0</strong> Đang theo dõi</span>
                </div>
            </div>

            <div class="btn-group-social">
                <th:block th:if="${profile.relationStatus == 'ME'}">
                    <a href="/profile" class="btn-social btn-dark"><i class="fas fa-pen"></i> Chỉnh sửa trang cá nhân</a>
                </th:block>

                <th:block th:if="${profile.relationStatus != 'ME'}">
                    <button th:if="${profile.relationStatus == 'STRANGER'}" class="btn-social btn-blue" th:onclick="'sendFriendRequest(' + ${profile.id} + ', this)'">
                        <i class="fas fa-user-plus"></i> Thêm bạn bè
                    </button>
                    <button th:if="${profile.relationStatus == 'PENDING_SENT'}" class="btn-social btn-dark">
                        <i class="fas fa-user-clock"></i> Đã gửi
                    </button>
                    <button th:if="${profile.relationStatus == 'PENDING_RECEIVED'}" class="btn-social btn-blue" th:onclick="'acceptFriendRequest(' + ${profile.id} + ', this)'">
                        <i class="fas fa-user-check"></i> Chấp nhận
                    </button>
                    <button th:if="${profile.relationStatus == 'FRIEND'}" class="btn-social btn-dark" th:onclick="'unfriendUser(' + ${profile.id} + ')'">
                        <i class="fas fa-user-check"></i> Bạn bè
                    </button>

                    <button class="btn-social btn-dark" th:onclick="'openChat(' + ${profile.id} + ')'">
                        <i class="fab fa-facebook-messenger"></i> Nhắn tin
                    </button>

                    <button th:if="${!profile.following}" class="btn-social btn-blue" th:onclick="'followUser(' + ${profile.id} + ', this)'">
                        <i class="fas fa-rss"></i> Theo dõi
                    </button>
                    <button th:if="${profile.following}" class="btn-social btn-dark" th:onclick="'unfollowUser(' + ${profile.id} + ', this)'">
                        <i class="fas fa-check"></i> Đang theo dõi
                    </button>
                </th:block>
            </div>
        </div>

        <div class="section-box">
            <div class="section-title">Bạn Bè</div>
            <div class="friend-grid" th:if="${not #lists.isEmpty(profile.friends)}">
                <div th:each="f : ${profile.friends}" class="friend-card" th:onclick="'window.location.href=\'/social/profile/' + ${f.id} + '\''">
                    <img th:src="${f.avatar}">
                    <span th:text="${f.name}">User</span>
                </div>
            </div>
            <div th:if="${#lists.isEmpty(profile.friends)}" class="text-muted p-3 bg-dark rounded">
                <i class="fas fa-lock"></i> Danh sách bạn bè trống hoặc đã ẩn.
            </div>
        </div>

        <div class="section-box" th:if="${not #lists.isEmpty(profile.favoriteMovies)}">
        <div class="section-title">Phim Yêu Thích</div>
        
        <div class="movie-list-container">
            
            <div th:each="movie : ${profile.favoriteMovies}" 
                 class="movie-card" 
                 th:attr="data-movie-id=${movie.id}">
                
                <div class="movie-poster">
                    <img th:src="${movie.poster}" 
                         th:alt="${movie.title}" 
                         onerror="this.src='/images/placeholder.jpg'">
                </div>

                <div class="movie-info">
                    <h3 th:text="${movie.title}">Movie Title</h3>
                    <p class="movie-rating">
                        ⭐ <span th:text="${movie.rating}">0.0</span>
                    </p>
                </div>

                <div th:replace="~{fragments/hover-card :: hoverCard(${movie})}"></div>
            </div>

        </div>
    </div>

    <div class="section-box" th:if="${not #lists.isEmpty(profile.recentWatchedMovies)}">
        <div class="section-title">Hoạt Động Gần Đây</div>
        
        <div class="movie-list-container">
            
            <div th:each="movie : ${profile.recentWatchedMovies}" 
                 class="movie-card" 
                 th:attr="data-movie-id=${movie.id}">
                
                <div class="movie-poster">
                    <img th:src="${movie.poster}" 
                         th:alt="${movie.title}" 
                         onerror="this.src='/images/placeholder.jpg'">
                </div>

                <div class="movie-info">
                    <h3 th:text="${movie.title}">Movie Title</h3>
                    <p class="movie-rating">
                        ⭐ <span th:text="${movie.rating}">0.0</span>
                    </p>
                </div>

                <div th:replace="~{fragments/hover-card :: hoverCard(${movie})}"></div>
            </div>

        </div>
    </div>

    </div>

    <div id="cineModal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.8); z-index:9999; justify-content:center; align-items:center;">
        <div style="background:#1a1a1a; padding:30px; border-radius:12px; width:400px; text-align:center; border:1px solid #333; box-shadow: 0 0 20px rgba(229,9,20,0.5);">
            <h3 style="color:#fff; margin-bottom:15px; font-family:'Segoe UI', sans-serif;">Xác nhận</h3>
            <p id="cineMsg" style="color:#ccc; margin-bottom:25px;"></p>
            <div style="display:flex; justify-content:center; gap:15px;">
                <button onclick="closeCineModal()" style="padding:8px 20px; background:#333; color:#fff; border:none; border-radius:4px; cursor:pointer;">Hủy</button>
                <button id="cineConfirmBtn" style="padding:8px 20px; background:#e50914; color:#fff; border:none; border-radius:4px; font-weight:bold; cursor:pointer;">Đồng ý</button>
            </div>
        </div>
    </div>

    <div th:replace="~{fragments/footer :: footer}"></div>
    
    <script src="https://www.youtube.com/iframe_api"></script>

    <script>
        // Kích hoạt hover card
        document.addEventListener("DOMContentLoaded", () => {
            if (typeof initHoverCards === "function") initHoverCards();
        });
    </script>
    <script src="/js/movie/share-modal.js"></script>
    <script src="/js/script.js"></script>

    <div th:replace="fragments/share-modal :: shareModal"></div>
</body>
</html>